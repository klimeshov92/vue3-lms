services:

  # =====================================================
  # BACKEND — Django + Gunicorn + Channels
  # =====================================================
  backend:
    # Контекст сборки:
    # Dockerfile лежит в light_back/light/Dockerfile
    build: ../light_back/light

    # Явное имя контейнера
    container_name: backend

    # Подгружаем переменные из deploy/.env
    # (SECRET_KEY, DEBUG и т.п.)
    env_file:
      - .env

    # Переменные окружения для Django
    # ИМЕНА postgres / redis — это DNS внутри Docker-сети
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      REDIS_HOST: redis

    # Общие volumes:
    # Django ПИШЕТ → nginx ЧИТАЕТ
    volumes:
      # STATIC_ROOT = /app/staticfiles
      - static_data:/app/staticfiles

      # MEDIA_ROOT = /app/media
      - media_data:/app/media

    # Порядок запуска контейнеров
    # НЕ ждёт готовности БД, только старта
    depends_on:
      - postgres
      - redis


  # =====================================================
  # SCHEDULER — django-apscheduler
  # Отдельный процесс, сервер НЕ поднимает
  # =====================================================
  scheduler:
    # Используем ТОТ ЖЕ Dockerfile, что и backend
    build: ../light_back/light

    container_name: scheduler

    # Переопределяем CMD из Dockerfile
    # Запускается только APScheduler
    command: python manage.py runapscheduler

    env_file:
      - .env

    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      REDIS_HOST: redis

    depends_on:
      - backend
      - redis


  # =====================================================
  # NGINX — фронтенд + reverse proxy
  # =====================================================
  nginx:
    # ВАЖНО:
    # Этот Dockerfile:
    # 1) собирает Vue
    # 2) кладёт dist в nginx
    build: ../light_front/light

    container_name: nginx

    # Пробрасываем порт:
    # http://localhost → nginx:80
    ports:
      - "80:80"

    volumes:
      # Django STATIC
      # nginx ОТДАЁТ, Django НЕ УЧАСТВУЕТ
      - static_data:/usr/share/nginx/html/static

      # Django MEDIA
      - media_data:/usr/share/nginx/html/media

      # Наш nginx.conf
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf

    depends_on:
      - backend


  # =====================================================
  # REDIS — Channels + cache + scheduler
  # =====================================================
  redis:
    image: redis:7
    container_name: redis
    # Конфига не нужно, дефолта достаточно


  # =====================================================
  # POSTGRES — база данных
  # =====================================================
  postgres:
    image: postgres:15
    container_name: postgres

    # Эти переменные использует ТОЛЬКО Postgres
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app

    # Volume для сохранения данных БД
    volumes:
      - pgdata:/var/lib/postgresql/data


# =====================================================
# VOLUMES — живут вне контейнеров
# =====================================================
volumes:
  # Данные PostgreSQL
  pgdata:

  # STATIC_ROOT Django → nginx
  static_data:

  # MEDIA_ROOT Django → nginx
  media_data:
