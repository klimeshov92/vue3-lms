import{r as x,a as V,B as L,k as O,C as z,o as E,c as i,b as d,d as s,t as a,m as l,D as g,H as v,F as M,G as q,i as k,h as j,j as y,q as J,u as F,l as n,I as R}from"./index-D8Gdgylc.js";const U={key:0},G={key:0,class:"detail-page"},H={key:0},K={class:"detail-card"},Q={class:"detail-card-info"},W={class:"detail-header"},X={class:"detail-header-title"},Y={class:"detail-card-text"},Z={key:0,class:"detail-card-text-elem"},ee={class:"detail-card-text-elem"},te={key:1,class:"detail-card-text-elem"},se={class:"detail-card-text-elem"},ae={key:2,class:"detail-card-text-elem"},oe={key:3,class:"detail-card-text-elem"},le={class:"detail-card-text-elem"},ie={class:"detail-card-text-elem"},ne={class:"detail-card-text-elem"},re={class:"detail-card-text-elem"},ce={class:"detail-menu button-group"},de={key:0,class:"modal-overlay"},me={class:"modal"},be={class:"modal-header"},ue={class:"modal-header-h2"},_e={class:"minibutton-group modal-menu"},pe={class:"detail-tabs"},ge={class:"tabs-header"},ve=["onClick"],ke={key:0,class:"tabs-content"},je={key:0,class:"desc-tab"},ye={key:0},Te={key:1},xe={key:1,class:"detail-tab"},he={key:0,class:"detail-tab-elem"},Ae={class:"detail-tab-elem"},fe={key:1,class:"detail-tab-elem"},De={class:"detail-tab-elem"},Pe={key:2,class:"detail-tab-elem"},Se={key:3,class:"detail-tab-elem"},Ie={class:"detail-tab-elem"},$e={class:"detail-tab-elem"},we={class:"detail-tab-elem"},Be={class:"detail-tab-elem"},Ce={class:"detail-tab-elem"},Ne={class:"detail-tab-elem"},Ve={class:"detail-tab-elem"},Le={class:"detail-tab-elem"},Oe={key:1,class:"none-container"},ze={key:1,class:"loading"},Ee={key:1,class:"loading"},Fe={__name:"TaskTemplateAssignmentDetail",setup(Me){const b=O(),p=F(),h=x(!1),e=V({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewTaskTemplateAssignment:!1,canEditTaskTemplateAssignment:!1,canDeleteTaskTemplateAssignment:!1}),S=async()=>{const o=b.params.id;let t=localStorage.getItem("access_token");const r=k(t);t&&!r&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const c=await j.get(`${y}/task_template_assignments/${o}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные задачи:",c.data),e.object=c.data}catch(c){console.error("Ошибка при получении данных задачи:",c)}},T=x(!1),I=()=>{T.value=!0},A=()=>{T.value=!1},$=async()=>{let o=localStorage.getItem("access_token");const t=k(o);if(o&&!t){p.push({name:"Login"});return}const r=b.params.id;try{await j.delete(`${y}/task_template_assignments/${r}/`,{headers:{Authorization:`Bearer ${o}`}}),A(),p.push({name:"TaskTemplateAssignmentList"})}catch(c){console.error("Ошибка удаления задачи:",c)}},w=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let t=localStorage.getItem("access_token");const r=k(t);if(!(!t||!r))try{(await j.get(`${y}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(c){console.error("Ошибка проверки версии прав:",c),localStorage.removeItem("userPermissions")}},B=async()=>{let o=localStorage.getItem("access_token");const t=k(o);o&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{let r=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",r),Object.keys(r).length>0&&(console.log("ID пользователя в разрешениях из памяти:",r.user_id),!t&&r.user_id!==1||t&&t.user_id!==r.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),r={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(r).length===0){const _=await j.get(`${y}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",_.data),r=_.data,localStorage.setItem("userPermissions",JSON.stringify(r))}e.globalPermissionsList=r.global_permissions||[],e.objectPermissionsDict=r.object_permissions||{};const c=b.params.id;console.log("ID объекта:",c),e.canViewTaskTemplateAssignment=e.globalPermissionsList.includes("bpms.view_task_template_assignment")||e.objectPermissionsDict["bpms.view_task_template_assignment"]&&e.objectPermissionsDict["bpms.view_task_template_assignment"].includes(Number(c)),console.log("Права на просмотр задач:",e.canViewTaskTemplateAssignment),e.canEditTaskTemplateAssignment=e.globalPermissionsList.includes("bpms.change_task_template_assignment")||Array.isArray(e.objectPermissionsDict["bpms.change_task_template_assignment"])&&e.objectPermissionsDict["bpms.change_task_template_assignment"].includes(Number(c)),console.log("Права на редактирование задач:",e.canEditTaskTemplateAssignment),e.canDeleteTaskTemplateAssignment=e.globalPermissionsList.includes("bpms.delete_task_template_assignment")||Array.isArray(e.objectPermissionsDict["bpms.delete_task_template_assignment"])&&e.objectPermissionsDict["bpms.delete_task_template_assignment"].includes(Number(c)),console.log("Права на удаление задач:",e.canDeleteTaskTemplateAssignment)}catch(r){console.error("Ошибка при загрузке разрешений пользователя:",r)}},C=()=>{J(p)},N=L(()=>[{name:"details",label:"Детали"},{name:"desc",label:"Описание"}].filter(Boolean)),u=x(b.query.tab||localStorage.getItem(`activeTaskTemplateAssignmentTab-${b.params.id}`)||"desc");return z(u,o=>{localStorage.setItem(`activeTaskTemplateAssignmentTab-${b.params.id}`,o),p.push({query:{tab:o}}),console.log("Загружен таб:",o)}),E(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await S(),await w(),await B(),h.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,t)=>{var r,c,_,f,D,P;return h.value?(n(),i("div",U,[e.canViewTaskTemplateAssignment?(n(),i("div",G,[e.object.id?(n(),i("div",H,[s("div",K,[s("div",Q,[s("div",W,[s("div",X,[s("h1",null,a(e.object.name||"Безымянное назначение шаблона задачи"),1)])]),s("div",Y,[e.object.last_executor_interaction?d("",!0):(n(),i("div",Z,[t[1]||(t[1]=s("span",{class:"detail-card-text-label"},"Взаимодействие:",-1)),l(" "+a(e.object.interaction?e.object.interaction.str:"Нет взаимодействия"),1)])),s("div",ee,[t[2]||(t[2]=s("span",{class:"detail-card-text-label"},"Шаблон задачи:",-1)),l(" "+a(e.object.task_template?e.object.task_template.str:"Нет плана"),1)]),((r=e.object.task_template)==null?void 0:r.term_type)!="none"?(n(),i("div",te,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Начало по плану:",-1)),l(" "+a(e.object.planned_start?g(v)(e.object.planned_start):"Нет данных о начале"),1)])):d("",!0),s("div",se,[t[4]||(t[4]=s("span",{class:"detail-card-text-label"},"Тип исполнителя:",-1)),l(" "+a(e.object.executor_type_display||"Нет типа исполнителя"),1)]),((c=e.object.executor_type)==null?void 0:c.value)=="selected"?(n(),i("div",ae,[t[5]||(t[5]=s("span",{class:"detail-card-text-label"},"Исполнитель:",-1)),l(" "+a(e.object.executor?e.object.executor.str:"Нет исполнителя"),1)])):d("",!0),((_=e.object.executor_type)==null?void 0:_.value)=="group"?(n(),i("div",oe,[t[6]||(t[6]=s("span",{class:"detail-card-text-label"},"Группа исполнителей:",-1)),l(" "+a(e.object.executor_group?e.object.executor_group.str:"Нет группы исполнителей"),1)])):d("",!0),s("div",le,[t[7]||(t[7]=s("span",{class:"detail-card-text-label"},"Контроль руководителей:",-1)),l(" "+a(e.object.manager_control?"Да":"Нет"),1)]),s("div",ie,[t[8]||(t[8]=s("span",{class:"detail-card-text-label"},"Группа контролеров:",-1)),l(" "+a(e.object.controller_group?e.object.controller_group.str:"Нет группы контролеров"),1)]),s("div",ne,[t[9]||(t[9]=s("span",{class:"detail-card-text-label"},"Группа наблюдателей:",-1)),l(" "+a(e.object.observer_group?e.object.observer_group.str:"Нет группы наблюдателей"),1)]),s("div",re,[t[10]||(t[10]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),l(" "+a(e.object.categories.length>0?e.object.categories.map(m=>m.name).join(", "):"Нет категорий"),1)])]),s("div",ce,[e.canDeleteTaskTemplateAssignment?(n(),i("button",{key:0,onClick:I,class:"button"}," Удалить ")):d("",!0),s("button",{type:"button",onClick:C,class:"button"},"Назад")]),T.value?(n(),i("div",de,[s("div",me,[s("div",be,[s("h2",ue,"Удаление "+a(e.object.name||"Безымянный задача"),1)]),s("div",_e,[s("button",{onClick:t[0]||(t[0]=m=>$()),class:"minibutton"},"Подтвердить"),s("button",{onClick:A,class:"minibutton"},"Отменить")])])])):d("",!0)])]),s("div",pe,[s("div",ge,[(n(!0),i(M,null,q(N.value,m=>(n(),i("button",{key:m.name,class:R([{active:u.value===m.name},"tab-button"]),onClick:qe=>u.value=m.name},a(m.label),11,ve))),128))]),u.value?(n(),i("div",ke,[u.value==="desc"?(n(),i("div",je,[e.object.desc?(n(),i("div",ye,a(e.object.desc),1)):(n(),i("div",Te,[...t[11]||(t[11]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):d("",!0),u.value==="details"?(n(),i("div",xe,[e.object.last_executor_interaction?d("",!0):(n(),i("div",he,[t[12]||(t[12]=s("span",{class:"detail-tab-label"},"Взаимодействие:",-1)),l(" "+a(e.object.interaction?e.object.interaction.str:"Нет взаимодействия"),1)])),s("div",Ae,[t[13]||(t[13]=s("span",{class:"detail-tab-label"},"Шаблон задачи:",-1)),l(" "+a(e.object.task_template?e.object.task_template.str:"Нет плана"),1)]),((f=e.object.task_template)==null?void 0:f.term_type)!="none"?(n(),i("div",fe,[t[14]||(t[14]=s("span",{class:"detail-tab-label"},"Начало по плану",-1)),l(" "+a(e.object.planned_start?g(v)(e.object.planned_start):"Нет данных о начале"),1)])):d("",!0),s("div",De,[t[15]||(t[15]=s("span",{class:"detail-tab-label"},"Тип исполнителя:",-1)),l(" "+a(e.object.executor_type_display||"Нет типа исполнителя"),1)]),((D=e.object.executor_type)==null?void 0:D.value)=="selected"?(n(),i("div",Pe,[t[16]||(t[16]=s("span",{class:"detail-tab-label"},"Исполнитель:",-1)),l(" "+a(e.object.executor?e.object.executor.str:"Нет исполнителя"),1)])):d("",!0),((P=e.object.executor_type)==null?void 0:P.value)=="group"?(n(),i("div",Se,[t[17]||(t[17]=s("span",{class:"detail-tab-label"},"Группа исполнителей:",-1)),l(" "+a(e.object.executor_group?e.object.executor_group.str:"Нет группы исполнителей"),1)])):d("",!0),s("div",Ie,[t[18]||(t[18]=s("span",{class:"detail-tab-label"},"Контроль руководителей:",-1)),l(" "+a(e.object.manager_control?"Да":"Нет"),1)]),s("div",$e,[t[19]||(t[19]=s("span",{class:"detail-tab-label"},"Группа контролеров:",-1)),l(" "+a(e.object.controller_group?e.object.controller_group.str:"Нет группы контролеров"),1)]),s("div",we,[t[20]||(t[20]=s("span",{class:"detail-tab-label"},"Группа наблюдателей:",-1)),l(" "+a(e.object.observer_group?e.object.observer_group.str:"Нет группы наблюдателей"),1)]),s("div",Be,[t[21]||(t[21]=s("span",{class:"detail-tab-label"},"Категории:",-1)),l(" "+a(e.object.categories.length>0?e.object.categories.map(m=>m.name).join(", "):"Нет категорий"),1)]),s("div",Ce,[t[22]||(t[22]=s("span",{class:"detail-tab-label"},"Создан:",-1)),l(" "+a(e.object.created?g(v)(e.object.created):"Нет данных о создании"),1)]),s("div",Ne,[t[23]||(t[23]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),l(" "+a(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",Ve,[t[24]||(t[24]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),l(" "+a(e.object.changed?g(v)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Le,[t[25]||(t[25]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),l(" "+a(e.object.editor?e.object.editor:"Нет редактора"),1)])])):d("",!0)])):d("",!0)])])):e.object.id?d("",!0):(n(),i("div",Oe,[...t[26]||(t[26]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(n(),i("div",ze,[...t[27]||(t[27]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),i("div",Ee,[...t[28]||(t[28]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Fe as default};
