import{r as v,a as M,B as z,k as J,C as F,o as R,c as a,b as u,d as s,t as r,m as d,e as h,w as y,F as w,G as A,D as q,H as T,f as x,i as g,h as p,j as k,g as U,q as H,u as K,l as o,I as W}from"./index-CAPuKB9Y.js";import{_ as X,a as Y}from"./AccountsGroupObjectPermissions-Cioy0ns6.js";import{_ as Z}from"./TopicMessages-6jUYDAWt.js";import"./EditorComponent-DipgNh97.js";const ee={key:0},se={key:0,class:"detail-page"},te={key:0},oe={class:"detail-card"},ae={class:"detail-card-info"},ne={class:"detail-header"},ie={class:"detail-header-title"},le={class:"detail-card-text"},ce={class:"detail-card-text-elem"},ue={class:"detail-card-text-elem"},re={class:"detail-menu button-group"},de={key:0,class:"modal-overlay"},be={class:"modal"},me={class:"modal-header"},_e={class:"modal-header-h2"},ve={class:"minibutton-group modal-menu"},ge={class:"detail-tabs"},pe={class:"tabs-header"},ke=["onClick"],je={key:0,class:"tabs-content"},he={key:0,class:"desc-tab"},ye={key:0},Pe={key:1},Qe={key:1,class:"detail-tab"},fe={class:"detail-tab-elem"},we={class:"detail-tab-elem"},Ae={class:"detail-tab-elem"},xe={class:"detail-tab-elem"},De={class:"detail-tab-elem"},Ee={class:"detail-tab-elem"},Oe={key:2,class:"table-tab"},Ve={key:0},qe={key:0,class:"table-tab-table-outer"},Te={class:"table-tab-table-inner"},$e={key:0},Le={class:"table-tab-menu"},Se=["onClick"],Ie={key:2,class:"modal-overlay"},Ce={class:"modal"},Ge={class:"modal-header"},Be={class:"modal-header-h2"},Ne={class:"minibutton-group modal-menu"},Me={key:1},ze={key:1},Je={key:1},Fe={key:2,class:"tab-menu minibutton-group"},Re={key:3,class:"table-tab"},Ue={key:0},He={key:0,class:"table-tab-table-outer"},Ke={class:"table-tab-table-inner"},We={key:1},Xe={key:1},Ye={key:2,class:"tab-menu minibutton-group"},Ze={key:4,class:"topic-tab"},es={key:5,class:"table-tab"},ss={key:6,class:"table-tab"},ts={key:1,class:"none-container"},os={key:1,class:"loading"},as={key:1,class:"loading"},rs={__name:"QueueDetail",setup(ns){const m=J(),_=K(),D=v(!1),e=M({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewQueue:!1,canEditQueue:!1,canDeleteQueue:!1,canAddQueueExecutor:!1,canViewQueueExecutor:!1,canEditQueueExecutor:!1,canDeleteQueueExecutor:!1,canAddQueueTask:!1,canViewQueueTask:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),j=async()=>{const n=m.params.id;let t=localStorage.getItem("access_token");const l=g(t);t&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const c=await p.get(`${k}/queues/${n}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные задачи:",c.data),e.object=c.data}catch(c){console.error("Ошибка при получении данных задачи:",c)}},P=v(!1),$=()=>{P.value=!0},E=()=>{P.value=!1},L=async()=>{let n=localStorage.getItem("access_token");const t=g(n);if(n&&!t){_.push({name:"Login"});return}const l=m.params.id;try{await p.delete(`${k}/queues/${l}/`,{headers:{Authorization:`Bearer ${n}`}}),E(),_.push({name:"QueueList"})}catch(c){console.error("Ошибка удаления задачи:",c)}},Q=v(!1),f=v(null),S=n=>{f.value=n,Q.value=!0},O=()=>{Q.value=!1},I=async n=>{let t=localStorage.getItem("access_token");const l=g(t);if(t&&!l){_.push({name:"Login"});return}try{await p.delete(`${k}/queue_executors/${n}/`,{headers:{Authorization:`Bearer ${t}`}}),await j(),O()}catch(c){console.error("Ошибка удаления аккаунта:",c)}},C=async()=>{console.log("Проверяем версию прав");const n=JSON.parse(localStorage.getItem("userPermissions"));if(!(n!=null&&n.permissions_version))return;console.log("Текущая версия прав:",n.permissions_version);let t=localStorage.getItem("access_token");const l=g(t);if(!(!t||!l))try{(await p.get(`${k}/user_permissions_version/${n.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(c){console.error("Ошибка проверки версии прав:",c),localStorage.removeItem("userPermissions")}},G=async()=>{let n=localStorage.getItem("access_token");const t=g(n);n&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),n=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!t&&l.user_id!==1||t&&t.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const i=await p.get(`${k}/user_permissions/`,{headers:{...n&&{Authorization:`Bearer ${n}`}}});console.log("Разрешения пользователя загружены:",i.data),l=i.data,localStorage.setItem("userPermissions",JSON.stringify(l))}e.globalPermissionsList=l.global_permissions||[],e.objectPermissionsDict=l.object_permissions||{};const c=m.params.id;console.log("ID объекта:",c),e.canViewQueue=e.globalPermissionsList.includes("bpms.view_queue")||e.objectPermissionsDict["bpms.view_queue"]&&e.objectPermissionsDict["bpms.view_queue"].includes(Number(c)),console.log("Права на просмотр очередей:",e.canViewQueue),e.canEditQueue=e.globalPermissionsList.includes("bpms.change_queue")||Array.isArray(e.objectPermissionsDict["bpms.change_queue"])&&e.objectPermissionsDict["bpms.change_queue"].includes(Number(c)),console.log("Права на редактирование очередей:",e.canEditQueue),e.canDeleteQueue=e.globalPermissionsList.includes("bpms.delete_queue")||Array.isArray(e.objectPermissionsDict["bpms.delete_queue"])&&e.objectPermissionsDict["bpms.delete_queue"].includes(Number(c)),console.log("Права на удаление очередей:",e.canDeleteQueue),e.canAddQueueExecutor=e.globalPermissionsList.includes("bpms.add_queue_executor"),console.log("Права на добавление исполнителей:",e.canAddQueueExecutor),e.canViewQueueExecutor=e.globalPermissionsList.includes("bpms.view_queue_executor"),console.log("Права на просмотр исполнителей:",e.canViewQueueExecutor),e.canEditQueueExecutor=e.globalPermissionsList.includes("bpms.change_queue_executor"),console.log("Права на редактирование исполнителей:",e.canEditQueueExecutor),e.canDeleteQueueExecutor=e.globalPermissionsList.includes("bpms.delete_queue_executor"),console.log("Права на удаление исполнителей:",e.canDeleteQueueExecutor),e.canAddQueueTask=e.globalPermissionsList.includes("bpms.add_queue_task"),console.log("Права на добавление задач:",e.canAddQueueTask),e.canViewQueueTask=e.globalPermissionsList.includes("bpms.view_queue_task"),console.log("Права на просмотр задач:",e.canViewQueueTask),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(l){console.error("Ошибка при загрузке разрешений пользователя:",l)}},B=()=>{H(_)},N=z(()=>[{name:"details",label:"Детали"},{name:"desc",label:"Описание"},{name:"queue_executors",label:"Исполнители очереди"},{name:"queue_tasks",label:"Задачи очереди"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=v(m.query.tab||localStorage.getItem(`activeQueueTab-${m.params.id}`)||"details");return F(b,n=>{localStorage.setItem(`activeQueueTab-${m.params.id}`,n),_.push({query:{tab:n}}),console.log("Загружен таб:",n)}),R(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await j(),await C(),await G(),D.value=!0}catch(n){console.error("Ошибка при загрузке данных:",n)}}),(n,t)=>{var c;const l=U("router-link");return D.value?(o(),a("div",ee,[e.canViewQueue?(o(),a("div",se,[e.object.id?(o(),a("div",te,[s("div",oe,[s("div",ae,[s("div",ne,[s("div",ie,[s("h1",null,r(e.object.name||"Безымянная очередь"),1)])]),s("div",le,[s("div",ce,[t[2]||(t[2]=s("span",{class:"detail-card-text-label"},"Автоназначение исполнителя:",-1)),d(" "+r(e.object.auto_assignment?"Да":"Нет"),1)]),s("div",ue,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),d(" "+r(e.object.categories.length>0?e.object.categories.map(i=>i.name).join(", "):"Нет категорий"),1)])]),s("div",re,[e.canEditQueue?(o(),h(l,{key:0,to:{name:"QueueEdit",params:{id:e.object.id}},class:"button"},{default:y(()=>[...t[4]||(t[4]=[d(" Изменить ",-1)])]),_:1},8,["to"])):u("",!0),e.canDeleteQueue?(o(),a("button",{key:1,onClick:$,class:"button"}," Удалить ")):u("",!0),s("button",{type:"button",onClick:B,class:"button"},"Назад")]),P.value?(o(),a("div",de,[s("div",be,[s("div",me,[s("h2",_e,"Удаление "+r(e.object.name||"Безымянная очередь"),1)]),s("div",ve,[s("button",{onClick:t[0]||(t[0]=i=>L()),class:"minibutton"},"Подтвердить"),s("button",{onClick:E,class:"minibutton"},"Отменить")])])])):u("",!0)])]),s("div",ge,[s("div",pe,[(o(!0),a(w,null,A(N.value,i=>(o(),a("button",{key:i.name,class:W([{active:b.value===i.name},"tab-button"]),onClick:V=>b.value=i.name},r(i.label),11,ke))),128))]),b.value?(o(),a("div",je,[b.value==="desc"?(o(),a("div",he,[e.object.desc?(o(),a("div",ye,r(e.object.desc),1)):(o(),a("div",Pe,[...t[5]||(t[5]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):u("",!0),b.value==="details"?(o(),a("div",Qe,[s("div",fe,[t[6]||(t[6]=s("span",{class:"detail-tab-label"},"Автоназначение исполнителя:",-1)),d(" "+r(e.object.auto_assignment?"Да":"Нет"),1)]),s("div",we,[t[7]||(t[7]=s("span",{class:"detail-tab-label"},"Категории:",-1)),d(" "+r(e.object.categories.length>0?e.object.categories.map(i=>i.name).join(", "):"Нет категорий"),1)]),s("div",Ae,[t[8]||(t[8]=s("span",{class:"detail-tab-label"},"Создан:",-1)),d(" "+r(e.object.created?q(T)(e.object.created):"Нет данных о создании"),1)]),s("div",xe,[t[9]||(t[9]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),d(" "+r(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",De,[t[10]||(t[10]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),d(" "+r(e.object.changed?q(T)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Ee,[t[11]||(t[11]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),d(" "+r(e.object.editor?e.object.editor:"Нет редактора"),1)])])):u("",!0),b.value==="queue_executors"?(o(),a("div",Oe,[e.canViewQueueExecutor?(o(),a("div",Ve,[e.object.queue_executors&&e.object.queue_executors.length>0?(o(),a("div",qe,[s("div",Te,[s("table",null,[t[13]||(t[13]=s("thead",null,[s("tr",null,[s("th",null,"Пункт"),s("th",null,"Исполнитель"),s("th",null," Действия ")])],-1)),s("tbody",null,[(o(!0),a(w,null,A(e.object.queue_executors,i=>(o(),a("tr",{key:i.id},[s("td",null,r(i.item?i.item:"Нет данных"),1),s("td",null,r(i.executor?i.executor.str:"Нет данных"),1),s("td",null,[e.canEditQueueExecutor||e.canDeleteQueueExecutor?(o(),a("div",$e,[s("div",Le,[e.canEditQueueExecutor?(o(),h(l,{key:0,to:{name:"QueueExecutorEdit",params:{id:i.id},query:{queueId:e.object.id}},class:"table-tab-button"},{default:y(()=>[...t[12]||(t[12]=[d(" Изменить ",-1)])]),_:1},8,["to"])):u("",!0),e.canDeleteQueueExecutor?(o(),a("button",{key:1,onClick:V=>S(i),class:"table-tab-button"}," Удалить ",8,Se)):u("",!0),Q.value?(o(),a("div",Ie,[s("div",Ce,[s("div",Ge,[s("h2",Be,"Удаление "+r(f.value.str||"Безымянный исполнитель очереди"),1)]),s("div",Ne,[s("button",{onClick:t[1]||(t[1]=V=>I(f.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:O,class:"minibutton"},"Отменить")])])])):u("",!0)])])):(o(),a("div",Me," - "))])]))),128))])])])])):(o(),a("div",ze,[...t[14]||(t[14]=[s("div",{class:"none-border"},"Нет исполнителей",-1)])]))])):(o(),a("div",Je,[...t[15]||(t[15]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])])),e.canAddQueueExecutor?(o(),a("div",Fe,[e.canAddQueueExecutor?(o(),h(l,{key:0,to:{name:"CreateQueueExecutor",query:{queueId:e.object.id}},class:"minibutton"},{default:y(()=>[...t[16]||(t[16]=[d(" Создать ",-1)])]),_:1},8,["to"])):u("",!0)])):u("",!0)])):u("",!0),b.value==="queue_tasks"?(o(),a("div",Re,[e.canViewQueueTask?(o(),a("div",Ue,[e.object.queue_tasks&&e.object.queue_tasks.length>0?(o(),a("div",He,[s("div",Ke,[s("table",null,[t[17]||(t[17]=s("thead",null,[s("tr",null,[s("th",null,"Пункт"),s("th",null,"Задача"),s("th",null,"Исполнитель")])],-1)),s("tbody",null,[(o(!0),a(w,null,A(e.object.queue_tasks,i=>(o(),a("tr",{key:i.id},[s("td",null,r(i.item?i.item:"Нет данных"),1),s("td",null,r(i.task?i.task.str:"Нет данных"),1),s("td",null,r(i.task?i.executor.str:"Нет данных"),1)]))),128))])])])])):(o(),a("div",We,[...t[18]||(t[18]=[s("div",{class:"none-border"},"Нет задач",-1)])]))])):(o(),a("div",Xe,[...t[19]||(t[19]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])])),e.canAddQueueTask?(o(),a("div",Ye,[e.canAddQueueTask?(o(),h(l,{key:0,to:{name:"CreateQueueTask",query:{queueId:e.object.id}},class:"minibutton"},{default:y(()=>[...t[20]||(t[20]=[d(" Создать ",-1)])]),_:1},8,["to"])):u("",!0)])):u("",!0)])):u("",!0),b.value==="messages"?(o(),a("div",Ze,[x(Z,{topic_id:(c=e.object)==null?void 0:c.topic.id},null,8,["topic_id"])])):u("",!0),b.value==="accountsGroupObjectPermissions"?(o(),a("div",es,[x(X,{state:e,fetchObject:j,contentTypeModel:"queue"},null,8,["state"])])):u("",!0),b.value==="accountObjectPermissions"?(o(),a("div",ss,[x(Y,{state:e,fetchObject:j,contentTypeModel:"queue"},null,8,["state"])])):u("",!0)])):u("",!0)])])):e.object.id?u("",!0):(o(),a("div",ts,[...t[21]||(t[21]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),a("div",os,[...t[22]||(t[22]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),a("div",as,[...t[23]||(t[23]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{rs as default};
