import{a as _,r as i,o as z,c as d,d as s,n as A,f as h,w as c,C as w,b as V,t as C,p as P,v as $,i as k,u as I,h as p,j as m,k as L,l as u}from"./index-C8MToAQO.js";import{s as T}from"./custom-multiselect-DcF6BiF3.js";import"./EditorComponent-CNY1fJ-z.js";const N={key:0},M={class:"form-page"},E={class:"form-field"},q={class:"form-field"},J={class:"form-field"},G={key:0,class:"error"},H={class:"form-field"},K={key:0,class:"error"},Q={class:"form-field"},W={key:1,class:"loading"},se={__name:"PublicPlanCreate",setup(X){L();const r=I(),o=_({task_template:null,name:"",desc:"",categories:[]}),y=i(!1),f=i([]),x=async()=>{let a=localStorage.getItem("access_token");const e=k(a);if(a&&!e){r.push({name:"Login"});return}try{const t=await p.get(`${m}/task_templates/`,{headers:{Authorization:`Bearer ${a}`},params:{task_type:"plan_implementation"}});f.value=t.data.results||[],console.log("Шаблоны задач загружены:",f.value)}catch(t){console.error("Ошибка при загрузке шаблонов задач:",t.response?t.response.data:t.message)}},v=i([]),B=async()=>{let a=localStorage.getItem("access_token");const e=k(a);if(a&&!e){r.push({name:"Login"});return}try{const t=await p.get(`${m}/categories/`,{headers:{Authorization:`Bearer ${a}`}});v.value=t.data.results||[],console.log("Категории загружены:",v.value)}catch(t){console.error("Ошибка при загрузке категорий:",t.response?t.response.data:t.message)}},g=i(null),S=a=>{const e=a.target.files[0];e&&(g.value=e)},j=()=>{r.push({name:"PublicPlanList"})},l=_({}),D=()=>(l.task_template=o.task_template?"":"Выбор шаблона задачи обязателен!",l.name=o.name?"":"Название обязательно!",Object.values(l).every(a=>!a)),O=async()=>{var a;if(!D()){console.error("Форма содержит ошибки:",l);return}try{console.log("Отправляем данные для создания объекта:",o);const e={task_template:(a=o.task_template)==null?void 0:a.id,name:o.name,desc:o.desc,categories:o.categories.map(n=>n.id)};console.log("JSON данные перед отправкой:",e);let t=localStorage.getItem("access_token");const R=k(t);if(t&&!R){r.push({name:"Login"});return}const b=await p.post(`${m}/public_plans/`,e,{headers:{Authorization:`Bearer ${t}`}});if(console.log("Объект создан:",b.data),g.value){const n=new FormData;n.append("avatar",g.value);const U=`${m}/public_plans/${b.data.id}/`,F=await p.patch(U,n,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"multipart/form-data"}});console.log("Аватар успешно обновлен:",F.data)}localStorage.removeItem("userPermissions"),r.push({name:"PublicPlanDetail",params:{id:b.data.id}})}catch(e){e.response&&e.response.data?(Object.assign(l,e.response.data),console.error("Ошибка при создании объекта:",e.response.data)):console.error("Ошибка при создании объекта:",e.message)}};return z(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await B(),await x(),y.value=!0}catch(a){console.error("Ошибка при загрузке данных:",a)}}),(a,e)=>y.value?(u(),d("div",N,[s("div",M,[e[14]||(e[14]=s("div",{class:"form-header"},[s("h1",null,"Создание плана")],-1)),s("form",{onSubmit:A(O,["prevent"]),class:"form",id:"form"},[s("div",E,[e[4]||(e[4]=s("label",{for:"avatar",class:"form-label"},"Аватар:",-1)),s("input",{type:"file",id:"avatar",onChange:S,class:"form-input"},null,32)]),s("div",q,[e[7]||(e[7]=s("label",{class:"form-label"},"Категории:",-1)),h(w(T),{modelValue:o.categories,"onUpdate:modelValue":e[0]||(e[0]=t=>o.categories=t),options:v.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:c(()=>[...e[5]||(e[5]=[s("span",null,"Список пуст",-1)])]),noResult:c(()=>[...e[6]||(e[6]=[s("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),s("div",J,[e[10]||(e[10]=s("label",{class:"form-label"},"Шаблон задачи:",-1)),h(w(T),{modelValue:o.task_template,"onUpdate:modelValue":e[1]||(e[1]=t=>o.task_template=t),options:f.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:c(()=>[...e[8]||(e[8]=[s("span",null,"Список пуст",-1)])]),noResult:c(()=>[...e[9]||(e[9]=[s("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),l.task_template?(u(),d("span",G,C(l.task_template),1)):V("",!0)]),s("div",H,[e[11]||(e[11]=s("label",{for:"name",class:"form-label"},"Название:",-1)),P(s("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>o.name=t),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[$,o.name]]),l.name?(u(),d("span",K,C(l.name),1)):V("",!0)]),s("div",Q,[e[12]||(e[12]=s("label",{for:"desc",class:"form-label"},"Описание:",-1)),P(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=t=>o.desc=t),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[$,o.desc]])])],32),s("div",{class:"form-menu button-group"},[e[13]||(e[13]=s("button",{type:"submit",class:"button",form:"form"},"Сохранить",-1)),s("button",{type:"button",onClick:j,class:"button"},"Отмена")])])])):(u(),d("div",W,[...e[15]||(e[15]=[s("div",null,"Загрузка данных...",-1)])]))}};export{se as default};
