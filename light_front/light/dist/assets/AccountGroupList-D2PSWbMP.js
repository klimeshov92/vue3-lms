import{a as F,r as m,k as M,o as E,c as d,d as o,b as x,p as H,v as K,f as g,D as k,w as p,n as Q,F as W,G as X,t as _,e as Y,i as v,h as b,j as f,u as Z,g as ee,l as u,m as w}from"./index-CAPuKB9Y.js";import{s as S}from"./custom-multiselect-BiCJycwk.js";const se={key:0},oe={key:0,class:"list-page"},le={class:"filters-inner"},te={class:"filters-field"},ae={class:"filters-field"},re={class:"filters-field"},ne={class:"filters-field"},ie={class:"filters-field"},ce={class:"filters-field"},ue={class:"filters-menu button-group"},de={key:1,class:"list-items"},pe={class:"list-grid"},me={class:"list-card-header"},ge={class:"list-card-header-title"},ve={class:"list-card-text"},be={class:"list-card-text-elem"},fe={class:"list-card-text-elem"},ye={class:"list-card-menu minibutton-group"},ke={class:"list-pagination"},_e=["disabled"],Se=["disabled"],Ie={key:2,class:"none-card"},Ae={key:3,class:"list-menu button-group"},we={key:1,class:"loading"},Ve={key:1,class:"loading"},$e={__name:"AccountGroupList",setup(Pe){const c=M(),V=Z(),r=F({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddAccountGroup:!1,canViewAccountGroup:!1}),O=m(!1),j=[{label:"Пользовательская",value:"custom"},{label:"Системная",value:"system"},{label:"Организация",value:"organization"},{label:"Подразделение",value:"subdivision"},{label:"Должность",value:"position"},{label:"Назначение",value:"assignment"},{label:"Импорт из Excel",value:"excel_import"},{label:"Импорт по API",value:"api_import"},{label:"Участники мероприятия",value:"event_participants"},{label:"Ответственные мероприятия",value:"event_responsible"}],P=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"}],G=m([]),N=async()=>{let s=localStorage.getItem("access_token");const e=v(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const l=await b.get(`${f}/categories/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});G.value=l.data.results||[],console.log("Категории загружены:",G.value)}catch(l){console.error("Ошибка при загрузке категорий:",l.response?l.response.data:l.message)}},h=m([]),L=async()=>{let s=localStorage.getItem("access_token");const e=v(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const l=await b.get(`${f}/accounts/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});h.value=l.data.results||[],console.log("Аккаунты загружены:",h.value)}catch(l){console.error("Ошибка при загрузке аккаунтов:",l.response?l.response.data:l.message)}},$=m([]),T=async()=>{let s=localStorage.getItem("access_token");const e=v(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const l=await b.get(`${f}/permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});$.value=l.data.results||[],console.log("Разрешения загружены:",$.value)}catch(l){console.error("Ошибка при загрузке разрешений:",l.response?l.response.data:l.message)}},a=F({name:c.query.name||"",type:j.find(s=>s.value===c.query.type||""),categories:c.query.categories?c.query.categories.map(s=>({id:parseInt(s,10)})):[],accounts:c.query.accounts?c.query.accounts.map(s=>({id:parseInt(s,10)})):[],group_permissions:c.query.group_permissions?c.query.group_permissions.map(s=>({id:parseInt(s,10)})):[],order:P.find(s=>s.value===c.query.order||"name")}),z=()=>{const s=localStorage.getItem("accountGroupFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(a,JSON.parse(s)))},n=m(Number(c.query.page)||1),q=m(1),D=()=>{const s=localStorage.getItem("accountGroupPage");s&&(console.log("Загруженная странциа:",s),n.value=parseInt(s,10))},I=async(s,e)=>{console.log("Загрузка групп с фильтрами:",s,"для страницы:",e);let l=localStorage.getItem("access_token");const t=v(l);l&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),l=null),V.push({name:"AccountGroupList",query:{name:s.name||"",type:s.type?s.type.value:"",categories:s.categories.map(i=>i.id)||[],accounts:s.accounts.map(i=>i.id)||[],group_permissions:s.group_permissions.map(i=>i.id)||[],order:s.order.value,page:n.value}}),localStorage.setItem("accountGroupFilters",JSON.stringify(s));try{const i=await b.get(`${f}/account_groups/`,{headers:{...l&&{Authorization:`Bearer ${l}`}},params:{page:e,page_size:12,name:s.name,type:s.type?s.type.value:"",categories:s.categories.map(y=>y.id),user_set:s.accounts.map(y=>y.id),group_permissions:s.group_permissions.map(y=>y.id),ordering:s.order.value}});console.log("Список групп загружен:",i.data),r.items=i.data.results,q.value=Math.ceil(i.data.count/12)}catch(i){console.error("Ошибка при загрузке списка групп:",i)}},B=s=>{console.log("Смена страницы на:",s),n.value=s,V.push({name:"AccountGroupList",query:{...c.query,page:n.value}}),localStorage.setItem("accountGroupPage",n.value),I(a,s)},A=m(!1),C=()=>{A.value=!A.value,console.log("Текущий статус показа фильтров:",A.value)},U=()=>{console.log("Сбрасываем фильтры"),a.name="",a.type="",a.categories=[],a.accounts=[],a.user_permissions=[],a.order=P.find(s=>s.value==="name"),localStorage.removeItem("accountGroupFilters"),localStorage.removeItem("accountGroupPage"),n.value=1,V.push({name:"AccountGroupList",query:{name:"",type:"",categories:[],accounts:[],user_permissions:[],order:a.order.value,page:n.value}}),I(a,n.value)},J=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const l=v(e);if(!(!e||!l))try{(await b.get(`${f}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(t){console.error("Ошибка проверки версии прав:",t),localStorage.removeItem("userPermissions")}},R=async()=>{let s=localStorage.getItem("access_token");const e=v(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!e&&l.user_id!==1||e&&e.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const t=await b.get(`${f}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",t.data),l=t.data,localStorage.setItem("userPermissions",JSON.stringify(l))}r.globalPermissionsList=l.global_permissions||[],r.objectPermissionsDict=l.object_permissions||{},r.canAddAccountGroup=r.globalPermissionsList.includes("core.add_accounts_group"),console.log("Права на добавление групп:",r.canAddAccountGroup),r.canViewAccountGroup=r.globalPermissionsList.includes("core.view_accounts_group")||!!r.objectPermissionsDict["core.view_accounts_group"],console.log("Права на просмотр групп:",r.canViewAccountGroup)}catch(l){console.error("Ошибка при получении разрешений пользователя:",l)}};return E(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await z(),await D(),await N(),await L(),await T(),await J(),await R(),await I(a,n.value),O.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const l=ee("router-link");return O.value?(u(),d("div",se,[r.canViewAccountGroup?(u(),d("div",oe,[e[27]||(e[27]=o("div",{class:"list-header"},[o("h1",null,"Группы")],-1)),o("div",{class:"list-settings"},[o("button",{onClick:C,class:"list-settings-button"}," Параметры ")]),A.value?(u(),d("div",{key:0,class:"filters-overlay",onClick:C},[o("div",{class:"filters-outer",onClick:e[7]||(e[7]=Q(()=>{},["stop"]))},[o("div",{class:"filters-close_button-inner"},[o("button",{onClick:C,class:"filters-close_button"}," × ")]),o("div",le,[o("div",te,[e[10]||(e[10]=o("label",{class:"filters-label"},"Название:",-1)),H(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.username=t),class:"filters-input",placeholder:"Введите название"},null,512),[[K,a.username]])]),o("div",ae,[e[11]||(e[11]=o("label",{class:"filters-label"},"Тип:",-1)),g(k(S),{modelValue:a.type,"onUpdate:modelValue":e[1]||(e[1]=t=>a.type=t),options:j,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"])]),o("div",re,[e[14]||(e[14]=o("label",{class:"filters-label"},"Категории:",-1)),g(k(S),{modelValue:a.categories,"onUpdate:modelValue":e[2]||(e[2]=t=>a.categories=t),options:G.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[12]||(e[12]=[o("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[13]||(e[13]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",ne,[e[17]||(e[17]=o("label",{class:"filters-label"},"Аккаунты:",-1)),g(k(S),{modelValue:a.accounts,"onUpdate:modelValue":e[3]||(e[3]=t=>a.accounts=t),options:h.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[15]||(e[15]=[o("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[16]||(e[16]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",ie,[e[20]||(e[20]=o("label",{class:"filters-label"},"Разрешения:",-1)),g(k(S),{modelValue:a.user_permissions,"onUpdate:modelValue":e[4]||(e[4]=t=>a.user_permissions=t),options:$.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[18]||(e[18]=[o("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[19]||(e[19]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",ce,[e[21]||(e[21]=o("label",{class:"filters-label"},"Сортировка:",-1)),g(k(S),{modelValue:a.order,"onUpdate:modelValue":e[5]||(e[5]=t=>a.order=t),options:P,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),o("div",ue,[o("button",{onClick:e[6]||(e[6]=t=>I(a,n.value.value)),class:"button"},"Применить"),o("button",{onClick:U,class:"button"},"Сбросить")])])])):x("",!0),r.items.length!==0?(u(),d("div",de,[o("div",pe,[(u(!0),d(W,null,X(r.items,t=>(u(),d("div",{key:t.id,class:"list-card"},[o("div",me,[o("div",ge,[o("h2",null,_(t.name||"Нет названия"),1)])]),o("div",ve,[o("div",be,[e[22]||(e[22]=o("span",{class:"list-card-text-label"},"Тип:",-1)),w(" "+_(t.type_display||"Нет типа"),1)]),o("div",fe,[e[23]||(e[23]=o("span",{class:"list-card-text-label"},"Категории:",-1)),w(" "+_(t.categories.length>0?t.categories.map(i=>i.name).join(", "):"Нет категорий"),1)])]),o("div",ye,[g(l,{to:{name:"AccountGroupDetail",params:{id:t.id},query:{tab:"desc"}},class:"minibutton"},{default:p(()=>[...e[24]||(e[24]=[w(" Подробнее ",-1)])]),_:1},8,["to"])])]))),128))]),o("div",ke,[o("button",{disabled:n.value===1,onClick:e[8]||(e[8]=t=>B(n.value-1)),class:"list-settings-button"}," Назад ",8,_e),o("span",null,"Страница "+_(n.value)+" из "+_(q.value),1),o("button",{disabled:n.value===q.value,onClick:e[9]||(e[9]=t=>B(n.value+1)),class:"list-settings-button"}," Вперед ",8,Se)])])):(u(),d("div",Ie,[...e[25]||(e[25]=[o("div",null,"Список пуст",-1)])])),r.canAddAccountGroup?(u(),d("div",Ae,[r.canAddAccountGroup?(u(),Y(l,{key:0,to:{name:"AccountGroupCreate"},class:"button"},{default:p(()=>[...e[26]||(e[26]=[w(" Создать ",-1)])]),_:1})):x("",!0)])):x("",!0)])):(u(),d("div",we,[...e[28]||(e[28]=[o("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(u(),d("div",Ve,[...e[29]||(e[29]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{$e as default};
