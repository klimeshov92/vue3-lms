import{a as C,r as _,B as L,o as H,c as n,d as l,n as K,b as p,f,w as u,C as b,t as g,p as T,v as O,y as Q,i as k,u as W,h as x,j as V,k as X,l as i}from"./index-DyUQrffO.js";import{s as v}from"./custom-multiselect-J6sEttNg.js";import"./EditorComponent-Cf-0EfY6.js";const Y={key:0},Z={class:"form-page"},ee={class:"form-field"},te={key:0,class:"error"},le={class:"form-field"},se={key:0,class:"error"},oe={key:0,class:"form-field"},ae={key:0,class:"error"},re={class:"form-field"},ne={key:0,class:"error"},ie={class:"form-field"},ue={key:0,class:"error"},pe={key:1,class:"form-field"},ce={key:0,class:"error"},de={key:2,class:"form-field"},me={key:0,class:"error"},fe={class:"form-field"},be={class:"form-field"},ge={class:"form-field"},ve={class:"form-field"},ye={key:0,class:"error"},_e={class:"form-field"},ke={key:1,class:"loading"},Ue={__name:"TaskTemplateAssignmentCreate",setup(xe){X();const d=W(),t=C({task_template:null,interaction_type:"",interaction:null,executor_type:"",executor:null,executor_group:null,manager_control:!1,controller_group:null,observer_group:null,planned_start:null,name:"",desc:"",categories:[]}),S=_(!1),j=[{label:"Выбранному исполнителю",value:"selected"},{label:"Группе исполнителей",value:"group"},{label:"Без исполнителей",value:"none"}],z=[{label:"Выбранное взаимодействие",value:"selected"},{label:"Последнее взаимодействие исполнителя",value:"last"},{label:"Новое взаимодействие исполнителя",value:"new"}],U=_([]),D=async()=>{let o=localStorage.getItem("access_token");const e=k(o);if(o&&!e){d.push({name:"Login"});return}try{const s=await x.get(`${V}/task_templates/`,{headers:{Authorization:`Bearer ${o}`}});U.value=(s.data.results||[]).filter(c=>!c.is_child),console.log("Шаблоны задач загружены:",U.value)}catch(s){console.error("Ошибка при загрузке шаблонов задач:",s.response?s.response.data:s.message)}},$=_([]),M=async()=>{let o=localStorage.getItem("access_token");const e=k(o);if(o&&!e){d.push({name:"Login"});return}try{const s=await x.get(`${V}/interactions/`,{headers:{Authorization:`Bearer ${o}`}});$.value=s.data.results||[],console.log("Взаимодействия загружены:",$.value)}catch(s){console.error("Ошибка при загрузке взимодействий:",s.response?s.response.data:s.message)}},A=_([]),N=async()=>{let o=localStorage.getItem("access_token");const e=k(o);if(o&&!e){d.push({name:"Login"});return}try{const s=await x.get(`${V}/accounts/`,{headers:{Authorization:`Bearer ${o}`}});A.value=s.data.results||[],console.log("Аккаунты загружены:",A.value)}catch(s){console.error("Ошибка при загрузке сотрудников:",s.response?s.response.data:s.message)}},w=_([]),E=async()=>{let o=localStorage.getItem("access_token");const e=k(o);if(o&&!e){d.push({name:"Login"});return}try{const s=await x.get(`${V}/account_groups/`,{headers:{Authorization:`Bearer ${o}`}});w.value=s.data.results||[],console.log("Группы загружены:",w.value)}catch(s){console.error("Ошибка при загрузке групп:",s.response?s.response.data:s.message)}},R=_([]),h=async()=>{let o=localStorage.getItem("access_token");const e=k(o);if(o&&!e){d.push({name:"Login"});return}try{const s=await x.get(`${V}/categories/`,{headers:{Authorization:`Bearer ${o}`}});R.value=s.data.results||[],console.log("Категории загружены:",R.value)}catch(s){console.error("Ошибка при загрузке категорий:",s.response?s.response.data:s.message)}};L(()=>t.task_template,(o,e)=>{o&&e&&(t.interaction=null),o==null&&(t.interaction=null)}),L(()=>t.interaction_type,o=>{o.value!="selected"&&(t.interaction=null)});const q=()=>{d.push({name:"TaskTemplateAssignmentList"})},a=C({}),F=()=>{var o,e,s,c;return a.task_template=t.task_template?"":"Выбор шаблона задачи обязателен!",a.interaction_type=t.interaction_type.value?"":"Тип взаимодействий обязателен!",((o=t.interaction_type)==null?void 0:o.value)=="selected"&&(a.interaction=t.interaction?"":"Выбор взаимодейтсвия обязателен!"),((e=t.task_template)==null?void 0:e.term_type)!="none"&&(a.planned_start=t.planned_start?"":"Выбор начала обязателен"),a.executor_type=t.executor_type.value?"":"Тип исполнителя обязателен!",((s=t.executor_type)==null?void 0:s.value)=="selected"&&(a.executor=t.executor?"":"Выбор исполнителя обязателен!"),((c=t.executor_type)==null?void 0:c.value)=="group"&&(a.executor=t.executor_group?"":"Выбор исполнителя обязателен!"),a.name=t.name?"":"Название обязательно!",Object.values(a).every(y=>!y)},G=async()=>{var o,e,s,c,y,r;if(!F()){console.error("Форма содержит ошибки:",a);return}try{console.log("Отправляем данные для создания объекта:",t);const m={task_template:(o=t.task_template)==null?void 0:o.id,interaction_type:t.interaction_type.value,interaction:(e=t.interaction)==null?void 0:e.id,executor_type:t.executor_type.value,executor:(s=t.executor)==null?void 0:s.id,executor_group:(c=t.executor_group)==null?void 0:c.id,manager_control:t.manager_control,controller_group:(y=t.controller_group)==null?void 0:y.id,observer_group:(r=t.observer_group)==null?void 0:r.id,planned_start:t.planned_start,name:t.name,desc:t.desc,categories:t.categories.map(P=>P.id)};console.log("JSON данные перед отправкой:",m);let B=localStorage.getItem("access_token");const J=k(B);if(B&&!J){d.push({name:"Login"});return}const I=await x.post(`${V}/task_template_assignments/`,m,{headers:{Authorization:`Bearer ${B}`}});console.log("Объект создан:",I.data),localStorage.removeItem("userPermissions"),d.push({name:"TaskTemplateAssignmentDetail",params:{id:I.data.id}})}catch(m){m.response&&m.response.data?(Object.assign(a,m.response.data),console.error("Ошибка при создании объекта:",m.response.data)):console.error("Ошибка при создании объекта:",m.message)}};return H(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await M(),await D(),await N(),await E(),await h(),S.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,e)=>{var s,c,y;return S.value?(i(),n("div",Y,[l("div",Z,[e[37]||(e[37]=l("div",{class:"form-header"},[l("h1",null,"Создание назначения шаблона задачи")],-1)),l("form",{onSubmit:K(G,["prevent"]),class:"form",id:"form"},[l("div",ee,[e[14]||(e[14]=l("label",{class:"form-label"},"Шаблон задачи:",-1)),f(b(v),{modelValue:t.task_template,"onUpdate:modelValue":e[0]||(e[0]=r=>t.task_template=r),options:U.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:u(()=>[...e[12]||(e[12]=[l("span",null,"Список пуст",-1)])]),noResult:u(()=>[...e[13]||(e[13]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.task_template?(i(),n("span",te,g(a.task_template),1)):p("",!0)]),l("div",le,[e[15]||(e[15]=l("label",{class:"form-label"},"Тип взаимодействия:",-1)),f(b(v),{modelValue:t.interaction_type,"onUpdate:modelValue":e[1]||(e[1]=r=>t.interaction_type=r),options:z,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип взаимодействия",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),a.interaction_type?(i(),n("span",se,g(a.interaction_type),1)):p("",!0)]),t.task_template&&((s=t.interaction_type)==null?void 0:s.value)=="selected"?(i(),n("div",oe,[e[18]||(e[18]=l("label",{class:"form-label"},"Взаимодействие:",-1)),f(b(v),{modelValue:t.interaction,"onUpdate:modelValue":e[2]||(e[2]=r=>t.interaction=r),options:$.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите взаимодействие",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:u(()=>[...e[16]||(e[16]=[l("span",null,"Список пуст",-1)])]),noResult:u(()=>[...e[17]||(e[17]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.interaction?(i(),n("span",ae,g(a.interaction),1)):p("",!0)])):p("",!0),l("div",re,[e[19]||(e[19]=l("label",{for:"planned_start",class:"form-label"},"Начало по плану:",-1)),T(l("input",{"onUpdate:modelValue":e[3]||(e[3]=r=>t.planned_start=r),id:"planned_start",type:"datetime-local",class:"form-input"},null,512),[[O,t.planned_start]]),a.planned_start?(i(),n("span",ne,g(a.planned_start),1)):p("",!0)]),l("div",ie,[e[20]||(e[20]=l("label",{class:"form-label"},"Тип исполнителя:",-1)),f(b(v),{modelValue:t.executor_type,"onUpdate:modelValue":e[4]||(e[4]=r=>t.executor_type=r),options:j,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип исполнителя",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),a.executor_type?(i(),n("span",ue,g(a.executor_type),1)):p("",!0)]),((c=t.executor_type)==null?void 0:c.value)=="selected"?(i(),n("div",pe,[e[23]||(e[23]=l("label",{class:"form-label"},"Исполнитель:",-1)),f(b(v),{modelValue:t.executor,"onUpdate:modelValue":e[5]||(e[5]=r=>t.executor=r),options:A.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите исполнителя",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:u(()=>[...e[21]||(e[21]=[l("span",null,"Список пуст",-1)])]),noResult:u(()=>[...e[22]||(e[22]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.executor?(i(),n("span",ce,g(a.executor),1)):p("",!0)])):p("",!0),((y=t.executor_type)==null?void 0:y.value)=="group"?(i(),n("div",de,[e[26]||(e[26]=l("label",{class:"form-label"},"Группа исполнителей:",-1)),f(b(v),{modelValue:t.executor_group,"onUpdate:modelValue":e[6]||(e[6]=r=>t.executor_group=r),options:w.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите группу исполнителей",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:u(()=>[...e[24]||(e[24]=[l("span",null,"Список пуст",-1)])]),noResult:u(()=>[...e[25]||(e[25]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.executor_group?(i(),n("span",me,g(a.executor_group),1)):p("",!0)])):p("",!0),l("div",fe,[e[27]||(e[27]=l("label",{for:"manager_control",class:"form-label"},"Контроль руководителей:",-1)),T(l("input",{"onUpdate:modelValue":e[7]||(e[7]=r=>t.manager_control=r),id:"manager_control",type:"checkbox",class:"form-input"},null,512),[[Q,t.manager_control]])]),l("div",be,[e[30]||(e[30]=l("label",{class:"form-label"},"Группа контролеров:",-1)),f(b(v),{modelValue:t.controller_group,"onUpdate:modelValue":e[8]||(e[8]=r=>t.controller_group=r),options:w.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите группу контролеров",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:u(()=>[...e[28]||(e[28]=[l("span",null,"Список пуст",-1)])]),noResult:u(()=>[...e[29]||(e[29]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),l("div",ge,[e[33]||(e[33]=l("label",{class:"form-label"},"Группа наблюдателей:",-1)),f(b(v),{modelValue:t.observer_group,"onUpdate:modelValue":e[9]||(e[9]=r=>t.observer_group=r),options:w.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите группу наблюдателей",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:u(()=>[...e[31]||(e[31]=[l("span",null,"Список пуст",-1)])]),noResult:u(()=>[...e[32]||(e[32]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),l("div",ve,[e[34]||(e[34]=l("label",{for:"name",class:"form-label"},"Название:",-1)),T(l("input",{"onUpdate:modelValue":e[10]||(e[10]=r=>t.name=r),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[O,t.name]]),a.name?(i(),n("span",ye,g(a.name),1)):p("",!0)]),l("div",_e,[e[35]||(e[35]=l("label",{for:"desc",class:"form-label"},"Описание:",-1)),T(l("textarea",{"onUpdate:modelValue":e[11]||(e[11]=r=>t.desc=r),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[O,t.desc]])])],32),l("div",{class:"form-menu button-group"},[e[36]||(e[36]=l("button",{type:"submit",class:"button",form:"form"},"Сохранить",-1)),l("button",{type:"button",onClick:q,class:"button"},"Отмена")])])])):(i(),n("div",ke,[...e[38]||(e[38]=[l("div",null,"Загрузка данных...",-1)])]))}}};export{Ue as default};
