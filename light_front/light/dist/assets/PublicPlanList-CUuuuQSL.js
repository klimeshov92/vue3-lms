import{a as R,r as m,k as es,o as ls,c as i,d as e,b as f,p as ts,v as as,f as k,w as p,C as E,n as os,F as is,E as ns,t as y,e as rs,i as P,h as S,j as w,u as cs,g as G,l as o,m as d}from"./index-D06xwy0Y.js";import{s as H}from"./custom-multiselect-BtpWvcCP.js";const ds={key:0},us={key:0,class:"list-page"},gs={class:"filters-inner"},ms={class:"filters-field"},ps={class:"filters-field"},vs={class:"filters-field"},bs={class:"filters-menu button-group"},_s={key:1,class:"list-items"},fs={class:"list-grid"},ks={class:"list-card-image-outer"},ys={key:0,class:"list-card-image-inner"},Ps=["src"],Ss={key:1,class:"list-card-image-none"},ws={class:"list-card-icons"},Is={key:0,class:"list-card-icon-grey"},hs={key:1,class:"list-card-icon-progress"},Vs={key:2,class:"list-card-icon-progress"},Cs={key:3,class:"list-card-icon-progress"},$s={key:4,class:"list-card-icon-completed"},xs={key:5,class:"list-card-icon-attention"},js={key:6,class:"list-card-icon-grey"},qs={key:7,class:"list-card-icon-grey"},Fs={class:"list-card-header"},Ns={class:"list-card-header-title"},Os={class:"list-card-text"},As={class:"list-card-text-elem"},Ls={class:"list-card-menu minibutton-group"},Bs={class:"list-pagination"},Ds=["disabled"],Ts=["disabled"],zs={key:2,class:"none-card"},Js={key:3,class:"list-menu button-group"},Us={key:1,class:"loading"},Ms={key:1,class:"loading"},Hs={__name:"PublicPlanList",setup(Rs){const g=es(),I=cs(),n=R({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddPublicPlan:!1,canViewPublicPlan:!1}),x=m(!1),h=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"}],V=m([]),K=async()=>{let l=localStorage.getItem("access_token");const s=P(l);l&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),l=null);try{const a=await S.get(`${w}/categories/`,{headers:{...l&&{Authorization:`Bearer ${l}`}}});V.value=a.data.results||[],console.log("Категории загружены:",V.value)}catch(a){console.error("Ошибка при загрузке категорий:",a.response?a.response.data:a.message)}},c=R({name:g.query.name||"",categories:g.query.categories?g.query.categories.map(l=>({id:parseInt(l,10)})):[],order:h.find(l=>l.value===g.query.order||"name")}),Q=()=>{const l=localStorage.getItem("public_planFilters");l&&(console.log("Загруженные фильры:",l),Object.assign(c,JSON.parse(l)))},r=m(Number(g.query.page)||1),C=m(1),W=()=>{const l=localStorage.getItem("public_planPage");l&&(console.log("Загруженная странциа:",l),r.value=parseInt(l,10))},v=async(l,s)=>{console.log("Загрузка планов с фильтрами:",l,"для страницы:",s);let a=localStorage.getItem("access_token");const u=P(a);a&&!u&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),a=null),I.push({name:"PublicPlanList",query:{name:l.name||"",categories:l.categories.map(t=>t.id)||[],order:l.order.value,page:r.value}}),localStorage.setItem("public_planFilters",JSON.stringify(l));try{const t=await S.get(`${w}/public_plans/`,{headers:{...a&&{Authorization:`Bearer ${a}`}},params:{page:s,page_size:12,name:l.name,categories:l.categories.map(_=>_.id),ordering:l.order.value}});console.log("Список планов загружен:",t.data),n.items=t.data.results,C.value=Math.ceil(t.data.count/12)}catch(t){console.error("Ошибка при загрузке списка планов:",t)}},j=l=>{console.log("Смена страницы на:",l),r.value=l,I.push({name:"PublicPlanList",query:{...g.query,page:r.value}}),localStorage.setItem("public_planPage",r.value),v(c,l)},b=m(!1),$=()=>{b.value=!b.value,console.log("Текущий статус показа фильтров:",b.value)},X=()=>{console.log("Сбрасываем фильтры"),c.name="",c.categories=[],c.order=h.find(l=>l.value==="name"),localStorage.removeItem("public_planFilters"),localStorage.removeItem("public_planPage"),r.value=1,I.push({name:"PublicPlanList",query:{name:"",categories:[],page:r.value}}),v(c,r.value)},Y=async()=>{console.log("Проверяем версию прав");const l=JSON.parse(localStorage.getItem("userPermissions"));if(!(l!=null&&l.permissions_version))return;console.log("Текущая версия прав:",l.permissions_version);let s=localStorage.getItem("access_token");const a=P(s);if(!(!s||!a))try{(await S.get(`${w}/user_permissions_version/${l.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(u){console.error("Ошибка проверки версии прав:",u),localStorage.removeItem("userPermissions")}},Z=async()=>{let l=localStorage.getItem("access_token");const s=P(l);l&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),l=null);try{let a=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",a),Object.keys(a).length>0&&(console.log("ID пользователя в разрешениях из памяти:",a.user_id),!s&&a.user_id!==1||s&&s.user_id!==a.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),a={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(a).length===0){const u=await S.get(`${w}/user_permissions/`,{headers:{...l&&{Authorization:`Bearer ${l}`}}});console.log("Разрешения пользователя загружены:",u.data),a=u.data,localStorage.setItem("userPermissions",JSON.stringify(a))}n.globalPermissionsList=a.global_permissions||[],n.objectPermissionsDict=a.object_permissions||{},n.canAddPublicPlan=n.globalPermissionsList.includes("bpms.add_public_plan"),console.log("Права на добавление планов:",n.canAddPublicPlan),n.canViewPublicPlan=n.globalPermissionsList.includes("bpms.view_public_plan")||!!n.objectPermissionsDict["bpms.view_public_plan"],console.log("Права на просмотр планов:",n.canViewPublicPlan)}catch(a){console.error("Ошибка при получении разрешений пользователя:",a)}};return ls(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await Q(),await W(),await K(),await Y(),await Z(),await v(c,r.value),x.value=!0}catch(l){console.error("Ошибка при загрузке данных:",l)}}),(l,s)=>{const a=G("spa"),u=G("router-link");return x.value?(o(),i("div",ds,[n.canViewPublicPlan?(o(),i("div",us,[s[25]||(s[25]=e("div",{class:"list-header"},[e("h1",null,"Планы")],-1)),e("div",{class:"list-settings"},[e("button",{onClick:$,class:"list-settings-button"}," Параметры ")]),b.value?(o(),i("div",{key:0,class:"filters-overlay",onClick:$},[e("div",{class:"filters-outer",onClick:s[4]||(s[4]=os(()=>{},["stop"]))},[e("div",{class:"filters-close_button-inner"},[e("button",{onClick:$,class:"filters-close_button"}," × ")]),e("div",gs,[e("div",ms,[s[7]||(s[7]=e("label",{class:"filters-label"},"Название:",-1)),ts(e("input",{"onUpdate:modelValue":s[0]||(s[0]=t=>c.name=t),class:"filters-input",placeholder:"Введите название"},null,512),[[as,c.name]])]),e("div",ps,[s[10]||(s[10]=e("label",{class:"filters-label"},"Категории:",-1)),k(E(H),{modelValue:c.categories,"onUpdate:modelValue":s[1]||(s[1]=t=>c.categories=t),options:V.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...s[8]||(s[8]=[e("span",null,"Список пуст",-1)])]),noResult:p(()=>[...s[9]||(s[9]=[e("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),e("div",vs,[s[11]||(s[11]=e("label",{class:"filters-label"},"Сортировка:",-1)),k(E(H),{modelValue:c.order,"onUpdate:modelValue":s[2]||(s[2]=t=>c.order=t),options:h,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),e("div",bs,[e("button",{onClick:s[3]||(s[3]=t=>v(c,r.value.value)),class:"button"},"Применить"),e("button",{onClick:X,class:"button"},"Сбросить")])])])):f("",!0),n.items.length!==0?(o(),i("div",_s,[e("div",fs,[(o(!0),i(is,null,ns(n.items,t=>{var _,q,F,N,O,A,L,B,D,T,z,J,U,M;return o(),i("div",{key:t.id,class:"list-card"},[e("div",ks,[t.avatar?(o(),i("div",ys,[e("img",{src:t.avatar,alt:"Аватар"},null,8,Ps)])):(o(),i("div",Ss,[k(a,{class:"none-text"},{default:p(()=>[...s[12]||(s[12]=[d("Нет аватара",-1)])]),_:1})]))]),e("div",ws,[((q=(_=t.last_task)==null?void 0:_.result)==null?void 0:q.status)=="waiting"?(o(),i("div",Is,[...s[13]||(s[13]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-lock"})],-1),d(" В ожидании ",-1)])])):((N=(F=t.last_task)==null?void 0:F.result)==null?void 0:N.status)=="assigned"?(o(),i("div",hs,[...s[14]||(s[14]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-thumbtack"})],-1),d(" Назначено ",-1)])])):((A=(O=t.last_task)==null?void 0:O.result)==null?void 0:A.status)=="in_progress"?(o(),i("div",Vs,[...s[15]||(s[15]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-hourglass-half"})],-1),d(" В процессе ",-1)])])):((B=(L=t.last_task)==null?void 0:L.result)==null?void 0:B.status)=="under_review"?(o(),i("div",Cs,[...s[16]||(s[16]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-magnifying-glass"})],-1),d(" На проверке ",-1)])])):((T=(D=t.last_task)==null?void 0:D.result)==null?void 0:T.status)=="completed"?(o(),i("div",$s,[...s[17]||(s[17]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-circle-check"})],-1),d(" Выполнено ",-1)])])):((J=(z=t.last_task)==null?void 0:z.result)==null?void 0:J.status)=="failed"?(o(),i("div",xs,[...s[18]||(s[18]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-circle-xmark"})],-1),d(" Провалено ",-1)])])):((M=(U=t.last_task)==null?void 0:U.result)==null?void 0:M.status)=="canceled"?(o(),i("div",js,[...s[19]||(s[19]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-ban"})],-1),d(" Отменено ",-1)])])):t.last_task?f("",!0):(o(),i("div",qs,[...s[20]||(s[20]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-ban"})],-1),d(" Не назначено ",-1)])]))]),e("div",Fs,[e("div",Ns,[e("h2",null,y(t.name||"Нет названия"),1)])]),e("div",Os,[e("div",As,[s[21]||(s[21]=e("span",{class:"list-card-text-label"},"Категории:",-1)),d(" "+y(t.categories.length>0?t.categories.map(ss=>ss.name).join(", "):"Нет категорий"),1)])]),e("div",Ls,[k(u,{to:{name:"PublicPlanDetail",params:{id:t.id},query:{tab:"details"}},class:"minibutton"},{default:p(()=>[...s[22]||(s[22]=[d(" Подробнее ",-1)])]),_:1},8,["to"])])])}),128))]),e("div",Bs,[e("button",{disabled:r.value===1,onClick:s[5]||(s[5]=t=>j(r.value-1)),class:"list-settings-button"}," Назад ",8,Ds),e("span",null,"Страница "+y(r.value)+" из "+y(C.value),1),e("button",{disabled:r.value===C.value,onClick:s[6]||(s[6]=t=>j(r.value+1)),class:"list-settings-button"}," Вперед ",8,Ts)])])):(o(),i("div",zs,[...s[23]||(s[23]=[e("div",null,"Список пуст",-1)])])),n.canAddPublicPlan?(o(),i("div",Js,[n.canAddPublicPlan?(o(),rs(u,{key:0,to:{name:"PublicPlanCreate"},class:"button"},{default:p(()=>[...s[24]||(s[24]=[d(" Создать ",-1)])]),_:1})):f("",!0)])):f("",!0)])):(o(),i("div",Us,[...s[26]||(s[26]=[e("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),i("div",Ms,[...s[27]||(s[27]=[e("div",null,"Загрузка данных...",-1)])]))}}};export{Hs as default};
