import{r as v,a as S,k as M,B as N,C as R,o as F,c as r,d as o,b,f as h,D as c,t as T,p as $,z as J,w as _,v as j,n as G,i as g,u as H,h as y,j as w,q as K,l as n}from"./index-CadGroRP.js";import{s as x}from"./custom-multiselect-7oKqqfDz.js";const P={key:0},Q={key:0,class:"form-page"},W={class:"form-field"},X={key:0,class:"error"},Y={class:"form-field"},Z={key:0,class:"form-field"},ee={key:0,class:"error"},te={class:"form-field"},se={key:0,class:"error"},oe={class:"form-field"},ae={class:"form-field"},le={key:1,class:"none-card"},re={key:1,class:"loading"},ue={__name:"ControlElementEdit",setup(ne){const p=M(),i=H(),d=v(null),s=S({type_of_work:"",repeat:!1,task_template:null,name:"",categories:[],desc:""}),B=v(!1),C=[{label:"Итог задачи",value:"task_outcome"},{label:"Триггер",value:"trigger"}],m=v([]),O=async()=>{let a=localStorage.getItem("access_token");const e=g(a);if(a&&!e){i.push({name:"Login"});return}try{const t=await y.get(`${w}/task_templates/`,{headers:{Authorization:`Bearer ${a}`}});m.value=t.data.results||[],console.log("Шаблоны задач загружены:",m.value)}catch(t){console.error("Ошибка при загрузке шаблонов задач:",t.response?t.response.data:t.message)}},I=p.query.taskId||"",V=v([]),U=async()=>{let a=localStorage.getItem("access_token");const e=g(a);if(a&&!e){i.push({name:"Login"});return}try{const t=await y.get(`${w}/categories/`,{headers:{Authorization:`Bearer ${a}`}});V.value=t.data.results||[],console.log("Категории загружены:",V.value)}catch(t){console.error("Ошибка при загрузке категорий:",t.response?t.response.data:t.message)}},D=async()=>{var f;const a=p.params.id;let e=localStorage.getItem("access_token");const t=g(e);if(e&&!t){i.push({name:"Login"});return}try{const u=await y.get(`${w}/control_elements/${a}/`,{headers:{Authorization:`Bearer ${e}`}});d.value=u.data,console.log("Объект успешно загружен:",d.value),d.value.type_of_work=C.find(k=>k.value===d.value.type_of_work),console.log("Объект нормализован:",d.value),Object.assign(s,d.value)}catch(u){console.error("Ошибка загрузки объекта:",((f=u.response)==null?void 0:f.data)||u.message)}},z=N(()=>{var a;return((a=s.type_of_work)==null?void 0:a.value)==="task_outcome"?m.value.filter(e=>e.task_outcome==!0):m.value});R(()=>s.type_of_work,a=>{a.value!="task_outcome"&&(s.task_outcome=null)});const l=S({}),E=()=>(l.type_of_work=s.type_of_work.value?"":"Тип работы обязателен!",s.type_of_work.value=="task_outcome"&&(l.task_template=s.task_template?"":"Выбор шаблона задачи обязателен!"),Object.values(l).every(a=>!a)),q=async()=>{var a;if(!E()){console.error("Форма содержит ошибки:",l);return}try{const e=p.params.id;let t=localStorage.getItem("access_token");const f=g(t);if(t&&!f){i.push({name:"Login"});return}const u={type_of_work:s.type_of_work.value,repeat:s.repeat,task_template:(a=s.task_template)==null?void 0:a.id,name:s.name,categories:s.categories.map(L=>L.id),desc:s.desc};console.log("JSON данные перед отправкой:",u),await y.patch(`${w}/control_elements/${e}/`,u,{headers:{Authorization:`Bearer ${t}`}}),console.log("Данные обновлены");const k=p.query.taskId||"";k?i.push({name:"TaskTemplateDetail",params:{id:k}}):i.push({name:"ControlElementDetail",params:{id:e}})}catch(e){e.response&&e.response.data?(Object.assign(l,e.response.data),console.error("Ошибка при сохранении изменений:",e.response.data)):console.error("Ошибка при сохранении изменений:",e.message)}},A=()=>{K(i)};return F(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await O(),await U(),await D(),B.value=!0}catch(a){console.error("Ошибка при загрузке данных:",a)}}),(a,e)=>B.value?(n(),r("div",P,[d.value?(n(),r("div",Q,[e[17]||(e[17]=o("div",{class:"form-header"},[o("h1",null,"Редактирование управляющих элементов")],-1)),o("form",{onSubmit:G(q,["prevent"]),class:"form",id:"edit-form"},[o("div",W,[e[6]||(e[6]=o("label",{class:"form-label"},"Тип работы:",-1)),h(c(x),{modelValue:s.type_of_work,"onUpdate:modelValue":e[0]||(e[0]=t=>s.type_of_work=t),options:C,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип работы",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!c(I)},null,8,["modelValue","disabled"]),l.type_of_work?(n(),r("span",X,T(l.type_of_work),1)):b("",!0)]),o("div",Y,[e[7]||(e[7]=o("label",{for:"repeat",class:"form-label"},"Многократное срабатывание:",-1)),$(o("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>s.repeat=t),id:"repeat",type:"checkbox",class:"form-input"},null,512),[[J,s.repeat]])]),s.type_of_work.value=="task_outcome"?(n(),r("div",Z,[e[10]||(e[10]=o("label",{class:"form-label"},"Шаблон задачи:",-1)),h(c(x),{modelValue:s.task_template,"onUpdate:modelValue":e[2]||(e[2]=t=>s.task_template=t),options:z.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!c(I)},{noOptions:_(()=>[...e[8]||(e[8]=[o("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[9]||(e[9]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options","disabled"]),l.task_template?(n(),r("span",ee,T(l.task_template),1)):b("",!0)])):b("",!0),o("div",te,[e[11]||(e[11]=o("label",{for:"name",class:"form-label"},"Название:",-1)),$(o("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>s.name=t),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[j,s.name]]),l.name?(n(),r("span",se,T(l.name),1)):b("",!0)]),o("div",oe,[e[14]||(e[14]=o("label",{class:"form-label"},"Категории:",-1)),h(c(x),{modelValue:s.categories,"onUpdate:modelValue":e[4]||(e[4]=t=>s.categories=t),options:V.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:_(()=>[...e[12]||(e[12]=[o("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[13]||(e[13]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",ae,[e[15]||(e[15]=o("label",{for:"desc",class:"form-label"},"Описание:",-1)),$(o("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>s.desc=t),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[j,s.desc]])])],32),o("div",{class:"form-menu button-group"},[e[16]||(e[16]=o("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),o("button",{type:"button",onClick:A,class:"button"},"Отмена")])])):(n(),r("div",le,[...e[18]||(e[18]=[o("div",null,"Объект не найден",-1)])]))])):(n(),r("div",re,[...e[19]||(e[19]=[o("div",null,"Загрузка данных...",-1)])]))}};export{ue as default};
