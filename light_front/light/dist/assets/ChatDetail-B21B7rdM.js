import{k as K,u as X,r as g,a as U,A as E,B as z,o as Y,Q as le,c as l,l as n,b,d as s,p as ie,v as ce,F as Z,E as ee,H as se,t as _,e as te,C as q,G as T,f as N,n as re,i as V,m as $,w as de,h as L,j as I,g as ue}from"./index-CHXhtgN1.js";import{E as Q}from"./EditorComponent-CQxAyk1_.js";import{_ as me,a as be}from"./AccountsGroupObjectPermissions-BkSYFMWB.js";const _e={key:0,class:"chat"},ve={key:0,class:"tab-search-field"},ge={key:0,class:"messages-list"},he={class:"message-top"},pe={class:"message-title"},ke={class:"message-detail"},fe=["innerHTML"],ye={class:"chat-menu-outer"},je={class:"chat-menu-inner"},Ce=["onClick"],Pe=["onClick"],$e=["onClick"],we=["onClick"],Oe={key:4,class:"modal-overlay"},Se={class:"modal"},Ae={class:"modal-header"},De={class:"modal-header-h2"},Me={class:"minibutton-group modal-menu"},Ve={class:"tab-pagination"},Le=["disabled"],Ie=["disabled"],Ee={key:1},Ne={class:"form-field form-field-full_width"},Te={key:0,class:"error"},Ge={key:1,class:"loading"},M=10,Be={__name:"ChatMessages",props:{chat_id:Number},setup(R){K();const f=X(),C=g(!1),A=R;console.log("Chat ID:",A.chat_id);const e=g(null),v=g([]),w=a=>{var t;return((t=a.sender)==null?void 0:t.id)===e.value?"message-sent":"message-received"},j=U({newMessage:""}),k=g(null);let u=null;const G=()=>{if(u&&u.readyState!==WebSocket.CLOSED)return;const a=A.chat_id;let t=localStorage.getItem("access_token");const m=V(t);t&&!m?f.push({name:"Login"}):(e.value=m.user_id,console.log("ID пользователя:",e.value));const p=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws/chat_rooms/${a}/?token=${t}`;u=new WebSocket(p),u.onopen=()=>{console.log("WebSocket подключен"),W()},u.onmessage=i=>{B(i)},u.onerror=i=>{console.error("WebSocket ошибка:",i),alert("Ошибка при подключении к чату. Пожалуйста, попробуйте позже.")},u.onclose=()=>{console.log("WebSocket отключен")}},B=a=>{try{const t=JSON.parse(a.data);if(t.action==="message_edited"){const m=v.value.find(p=>p.id===t.message_id);m&&(m.content=t.new_content,m.changed=t.changed)}if(t.action==="message_deleted"){v.value=v.value.filter(p=>p.id!==t.message_id);const m=Math.ceil(v.value.length/M);y.value=m>0?m:1}if(t.old_messages){console.log("Загруженные старые сообщения:",t.old_messages),v.value=t.old_messages;const m=Math.ceil(v.value.length/M);y.value=m>0?m:1}t.message&&v.value.push({sender:t.sender,content:t.message,changed:t.changed})}catch(t){console.error("Ошибка при обработке сообщения WebSocket:",t)}},P=U({}),x=()=>(P.newMessage=j.newMessage.trim()?"":"Содержание обязательно!",Object.values(P).every(a=>!a)),W=()=>{u&&u.readyState===WebSocket.OPEN&&u.send(JSON.stringify({action:"load_old_messages"}))},h=()=>{if(!x()){console.error("Форма содержит ошибки:",P);return}if(!u||u.readyState!==WebSocket.OPEN){alert("Соединение с чатом потеряно. Пожалуйста, перезагрузите страницу.");return}const a={action:"send_message",message:j.newMessage};console.log("Отправляемое сообщение:",a),u.send(JSON.stringify(a)),k.value.clearContent()},c=a=>{a.isEditing=!0,a.editedContent=a.content},o=a=>{a.editedContent.trim()&&(u.send(JSON.stringify({action:"edit_message",message_id:a.id,new_content:a.editedContent})),a.isEditing=!1)},d=g(!1),r=g(null),D=a=>{r.value=a,d.value=!0},F=()=>{d.value=!1},oe=async a=>{u.send(JSON.stringify({action:"delete_message",message_id:a})),F()},ae=a=>{k.value&&(console.log("Ответ на сообщение:",a),k.value.editor.chain().focus().toggleBlockquote().run(),k.value.insertContent(`${a.sender.str} - ${T(a.changed)}`),k.value.insertContent(a.content),k.value.editor.chain().focus().splitBlock().run(),k.value.editor.chain().focus().setParagraph().run())},O=g(""),y=g(1),J=E(()=>O.value?v.value.filter(a=>{var t,m,p;return((m=(t=a.sender)==null?void 0:t.str)==null?void 0:m.toLowerCase().includes(O.value.toLowerCase()))||((p=a.content)==null?void 0:p.toLowerCase().includes(O.value.toLowerCase()))}):v.value),H=E(()=>Math.ceil(J.value.length/M)),ne=E(()=>{const a=(y.value-1)*M,t=a+M;return J.value.slice(a,t)});return z(O,()=>{y.value=1}),Y(async()=>{console.log("Компонент для чата смонтирован, начинаем подключение к WebSocket..."),await G(),C.value=!0}),le(()=>{u&&u.close()}),(a,t)=>{var m,p;return C.value?(n(),l("div",_e,[((m=v.value)==null?void 0:m.length)>0?(n(),l("div",ve,[ie(s("input",{"onUpdate:modelValue":t[0]||(t[0]=i=>O.value=i),type:"text",placeholder:"Поиск",class:"tab-search-input"},null,512),[[ce,O.value]])])):b("",!0),s("div",null,[((p=J.value)==null?void 0:p.length)>0?(n(),l("div",ge,[(n(!0),l(Z,null,ee(ne.value,i=>(n(),l("div",{key:i.id,class:se(["message",w(i)])},[s("div",he,[s("div",pe,[s("h2",null,_(i.sender.str?i.sender.str:"Без отправителя"),1)])]),s("div",ke,[i.isEditing?(n(),te(Q,{key:0,modelValue:i.editedContent,"onUpdate:modelValue":S=>i.editedContent=S},null,8,["modelValue","onUpdate:modelValue"])):(n(),l("div",{key:1,innerHTML:i.content,class:"tiptap"},null,8,fe)),s("div",null,[s("p",null,_(i.changed?q(T)(i.changed):"Без даты и времени"),1)])]),s("div",ye,[s("div",je,[i.isEditing?b("",!0):(n(),l("button",{key:0,class:"table-tab-button",onClick:S=>ae(i)},"Ответить",8,Ce)),!i.isEditing&&e.value&&i.sender.id==e.value?(n(),l("button",{key:1,class:"table-tab-button",onClick:S=>c(i)},"Редактировать",8,Pe)):b("",!0),i.isEditing?(n(),l("button",{key:2,class:"table-tab-button",onClick:S=>o(i)},"Сохранить",8,$e)):b("",!0),e.value&&i.sender.id==e.value?(n(),l("button",{key:3,onClick:S=>D(i),class:"table-tab-button"}," Удалить",8,we)):b("",!0),d.value?(n(),l("div",Oe,[s("div",Se,[s("div",Ae,[s("h2",De,"Удаление "+_(r.value.sender.str||"Безымянный исполнитель очереди"),1)]),s("div",Me,[s("button",{onClick:t[1]||(t[1]=S=>oe(r.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:F,class:"minibutton"},"Отменить")])])])):b("",!0)])])],2))),128)),s("div",Ve,[s("button",{disabled:y.value===1,onClick:t[2]||(t[2]=i=>y.value--),class:"tab-settings-button"}," Назад ",8,Le),s("span",null,"Страница "+_(y.value)+" из "+_(H.value),1),s("button",{disabled:y.value===H.value,onClick:t[3]||(t[3]=i=>y.value++),class:"tab-settings-button"}," Вперед ",8,Ie)])])):(n(),l("div",Ee,[...t[5]||(t[5]=[s("div",{class:"none-border"},"Нет сообщений",-1)])]))]),s("form",{onSubmit:re(h,["prevent"]),class:"form",id:"form"},[s("div",Ne,[t[6]||(t[6]=s("label",{for:"desc",class:"form-label"},"Сообщение:",-1)),N(Q,{ref_key:"editorRef",ref:k,modelValue:j.newMessage,"onUpdate:modelValue":t[4]||(t[4]=i=>j.newMessage=i)},null,8,["modelValue"]),P.newMessage?(n(),l("span",Te,_(P.newMessage),1)):b("",!0)])],32),t[7]||(t[7]=s("div",{class:"tab-menu minibutton-group"},[s("button",{type:"submit",class:"minibutton",form:"form"},"Отправить")],-1))])):(n(),l("div",Ge,[...t[8]||(t[8]=[s("div",null,"Загрузка данных...",-1)])]))}}},xe={key:0},We={key:0,class:"detail-page"},Je={key:0},Ue={class:"detail-card"},ze={class:"detail-card-info"},qe={class:"detail-header"},Re={class:"detail-header-title"},Fe={class:"detail-card-text"},He={class:"detail-card-text-elem"},Qe={class:"detail-menu button-group"},Ke={key:0,class:"modal-overlay"},Xe={class:"modal"},Ye={class:"modal-header"},Ze={class:"modal-header-h2"},es={class:"minibutton-group modal-menu"},ss={class:"detail-tabs"},ts={class:"tabs-header"},os=["onClick"],as={key:0,class:"tabs-content"},ns={key:0,class:"desc-tab"},ls={key:0},is={key:1},cs={key:1,class:"detail-tab"},rs={class:"detail-tab-elem"},ds={class:"detail-tab-elem"},us={class:"detail-tab-elem"},ms={class:"detail-tab-elem"},bs={class:"detail-tab-elem"},_s={key:2,class:"chat-tab"},vs={key:3,class:"table-tab"},gs={key:4,class:"table-tab"},hs={key:1,class:"none-container"},ps={key:1,class:"loading"},ks={key:1,class:"loading"},Cs={__name:"ChatDetail",setup(R){const f=K(),C=X(),A=g(!1),e=U({object:null,globalPermissionsList:[],objectPermissionsDict:{},canAddChat:!1,canViewChat:!1,canEditChat:!1,canDeleteChat:!1,canDeleteMessageGlobal:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),v=g(null),w=async()=>{const c=f.params.id;let o=localStorage.getItem("access_token");const d=V(o);o&&!d&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{const r=await L.get(`${I}/chats/${c}/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Данные чата:",r.data),e.object=r.data,v.value=e.object.id,console.log("ID чата:",v.value)}catch(r){console.error("Ошибка при получении данных чата:",r)}},j=g(!1),k=()=>{j.value=!0},u=()=>{j.value=!1},G=async()=>{let c=localStorage.getItem("access_token");const o=V(c);if(c&&!o){C.push({name:"Login"});return}const d=f.params.id;try{await L.delete(`${I}/chats/${d}/`,{headers:{Authorization:`Bearer ${c}`}}),u(),C.push({name:"ChatList"})}catch(r){console.error("Ошибка удаления задачи:",r)}},B=async()=>{console.log("Проверяем версию прав");const c=JSON.parse(localStorage.getItem("userPermissions"));if(!(c!=null&&c.permissions_version))return;console.log("Текущая версия прав:",c.permissions_version);let o=localStorage.getItem("access_token");const d=V(o);if(!(!o||!d))try{(await L.get(`${I}/user_permissions_version/${c.permissions_version}/`,{headers:{Authorization:`Bearer ${o}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(r){console.error("Ошибка проверки версии прав:",r),localStorage.removeItem("userPermissions")}},P=async()=>{let c=localStorage.getItem("access_token");const o=V(c);c&&!o&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),c=null);try{let d=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",d),Object.keys(d).length>0&&(console.log("ID пользователя в разрешениях из памяти:",d.user_id),!o&&d.user_id!==1||o&&o.user_id!==d.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),d={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(d).length===0){const D=await L.get(`${I}/user_permissions/`,{headers:{...c&&{Authorization:`Bearer ${c}`}}});console.log("Разрешения пользователя загружены:",D.data),d=D.data,localStorage.setItem("userPermissions",JSON.stringify(d))}e.globalPermissionsList=d.global_permissions||[],e.objectPermissionsDict=d.object_permissions||{};const r=f.params.id;console.log("ID объекта:",r),e.canAddChat=e.globalPermissionsList.includes("chats.add_chat"),console.log("Права на добавление чат:",e.canAddChat),e.canViewChat=e.globalPermissionsList.includes("chats.view_chat")||e.objectPermissionsDict["chats.view_chat"]&&e.objectPermissionsDict["chats.view_chat"].includes(Number(r)),console.log("Права на просмотр чата:",e.canViewChat),e.canEditChat=e.globalPermissionsList.includes("chats.change_chat")||Array.isArray(e.objectPermissionsDict["chats.change_chat"])&&e.objectPermissionsDict["chats.change_chat"].includes(Number(r)),console.log("Права на редактирование чата:",e.canEditChat),e.canDeleteChat=e.globalPermissionsList.includes("chats.delete_chat")||Array.isArray(e.objectPermissionsDict["chats.delete_chat"])&&e.objectPermissionsDict["chats.delete_chat"].includes(Number(r)),console.log("Права на удаление чата:",e.canDeleteChat),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(d){console.error("Ошибка при загрузке разрешений пользователя:",d)}},x=()=>{C.back()},W=E(()=>[{name:"desc",label:"Описание"},{name:"messages",label:"Содержание"},{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),h=g(f.query.tab||localStorage.getItem(`activeChatTab-${f.params.id}`)||"desc");return z(h,c=>{localStorage.setItem(`activeChatTab-${f.params.id}`,c),C.push({query:{tab:c}}),console.log("Загружен таб:",c)}),Y(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await w(),await B(),await P(),A.value=!0}catch(c){console.error("Ошибка при загрузке данных:",c)}}),z(()=>f.params.id,async c=>{console.log("Параметр id изменился на:",c),await w()}),(c,o)=>{const d=ue("router-link");return A.value?(n(),l("div",xe,[e.canViewChat?(n(),l("div",We,[e.object.id?(n(),l("div",Je,[s("div",Ue,[s("div",ze,[s("div",qe,[s("div",Re,[s("h1",null,_(e.object.name||"Безымянный чат"),1)])]),s("div",Fe,[s("div",He,[o[1]||(o[1]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),$(" "+_(e.object.categories.length>0?e.object.categories.map(r=>r.name).join(", "):"Нет категорий"),1)])]),s("div",Qe,[e.canEditChat?(n(),te(d,{key:0,to:{name:"ChatEdit",params:{id:e.object.id}},class:"button"},{default:de(()=>[...o[2]||(o[2]=[$(" Изменить ",-1)])]),_:1},8,["to"])):b("",!0),e.canDeleteChat?(n(),l("button",{key:1,onClick:k,class:"button"}," Удалить ")):b("",!0),s("button",{type:"button",onClick:x,class:"button"},"Назад")]),j.value?(n(),l("div",Ke,[s("div",Xe,[s("div",Ye,[s("h2",Ze,"Удаление "+_(e.object.name||"Безымянный чат"),1)]),s("div",es,[s("button",{onClick:o[0]||(o[0]=r=>G()),class:"minibutton"},"Подтвердить"),s("button",{onClick:u,class:"minibutton"},"Отменить")])])])):b("",!0)])]),s("div",ss,[s("div",ts,[(n(!0),l(Z,null,ee(W.value,r=>(n(),l("button",{key:r.name,class:se([{active:h.value===r.name},"tab-button"]),onClick:D=>h.value=r.name},_(r.label),11,os))),128))]),h.value?(n(),l("div",as,[h.value==="desc"?(n(),l("div",ns,[e.object.desc?(n(),l("div",ls,_(e.object.desc),1)):(n(),l("div",is,[...o[3]||(o[3]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):b("",!0),h.value==="details"?(n(),l("div",cs,[s("div",rs,[o[4]||(o[4]=s("span",{class:"detail-tab-label"},"Категории:",-1)),$(" "+_(e.object.categories.length>0?e.object.categories.map(r=>r.name).join(", "):"Нет категорий"),1)]),s("div",ds,[o[5]||(o[5]=s("span",{class:"detail-tab-label"},"Создан:",-1)),$(" "+_(e.object.created?q(T)(e.object.created):"Нет данных о создании"),1)]),s("div",us,[o[6]||(o[6]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),$(" "+_(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",ms,[o[7]||(o[7]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),$(" "+_(e.object.changed?q(T)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",bs,[o[8]||(o[8]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),$(" "+_(e.object.editor?e.object.editor:"Нет редактора"),1)])])):b("",!0),h.value==="messages"?(n(),l("div",_s,[N(Be,{chat_id:v.value},null,8,["chat_id"])])):b("",!0),h.value==="accountsGroupObjectPermissions"?(n(),l("div",vs,[N(me,{state:e,fetchObject:w,contentTypeModel:"chat"},null,8,["state"])])):b("",!0),h.value==="accountObjectPermissions"?(n(),l("div",gs,[N(be,{state:e,fetchObject:w,contentTypeModel:"chat"},null,8,["state"])])):b("",!0)])):b("",!0)])])):e.object.id?b("",!0):(n(),l("div",hs,[...o[9]||(o[9]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(n(),l("div",ps,[...o[10]||(o[10]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),l("div",ks,[...o[11]||(o[11]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Cs as default};
