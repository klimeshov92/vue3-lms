import{a as M,r as p,k as X,o as Y,c as n,d as e,b as m,p as Z,v as ss,f as E,C as U,n as es,F as ts,E as ls,t as f,e as os,w as P,i as w,h,j as I,u as as,g as R,l as a,m as c,G as ns}from"./index-B-w4kYl_.js";import{s as is}from"./custom-multiselect-C0r3WR58.js";const rs={key:0},cs={key:0,class:"list-page"},ds={class:"filters-inner"},us={class:"filters-field"},vs={class:"filters-field"},gs={class:"filters-menu button-group"},_s={key:1,class:"list-items"},ps={class:"list-grid"},ms={class:"list-card-image-outer"},fs={key:0,class:"list-card-image-inner"},ks=["src"],bs={key:1,class:"list-card-image-none"},ys={class:"list-card-icons"},Ss={key:0,class:"list-card-icon-grey"},Es={key:1,class:"list-card-icon-progress"},Ps={key:2,class:"list-card-icon-progress"},ws={key:3,class:"list-card-icon-progress"},hs={key:4,class:"list-card-icon-completed"},Is={key:5,class:"list-card-icon-attention"},Cs={key:6,class:"list-card-icon-grey"},Vs={key:7,class:"list-card-icon-grey"},xs={class:"list-card-header"},Fs={class:"list-card-header-title"},Ns={class:"list-card-text"},$s={class:"list-card-text-elem"},js={class:"list-card-menu minibutton-group"},Ls={class:"list-pagination"},Os=["disabled"],qs=["disabled"],As={key:2,class:"none-card"},Ds={key:3,class:"list-menu button-group"},Bs={key:1,class:"loading"},Ts={key:1,class:"loading"},Us={__name:"EventSlotList",setup(Js){const v=X(),k=as(),i=M({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddEventSlot:!1,canViewEventSlot:!1}),C=p(!1),b=[{label:"Планируемое начало: по возрастанию",value:"planned_start"},{label:"Планируемое начало: по убыванию",value:"-planned_start"}],d=M({planned_start:v.query.planned_start||"",order:b.find(t=>t.value===v.query.order||"planned_start")}),G=()=>{const t=localStorage.getItem("EventSlotFilters");t&&(console.log("Загруженные фильры:",t),Object.assign(d,JSON.parse(t)))},r=p(Number(v.query.page)||1),y=p(1),H=()=>{const t=localStorage.getItem("EventSlotPage");t&&(console.log("Загруженная странциа:",t),r.value=parseInt(t,10))},g=async(t,s)=>{console.log("Загрузка шаблонов с фильтрами:",t,"для страницы:",s);let o=localStorage.getItem("access_token");const u=w(o);o&&!u&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null),k.push({name:"EventSlotList",query:{planned_start:t.planned_start||"",order:t.order.value,page:r.value}}),localStorage.setItem("EventSlotFilters",JSON.stringify(t));try{const l=await h.get(`${I}/event_slots/`,{headers:{...o&&{Authorization:`Bearer ${o}`}},params:{page:s,page_size:12,planned_start:t.planned_start,ordering:t.order.value}});console.log("Список шаблонов загружен:",l.data),i.items=l.data.results,y.value=Math.ceil(l.data.count/12)}catch(l){console.error("Ошибка при загрузке списка шаблонов:",l)}},V=t=>{console.log("Смена страницы на:",t),r.value=t,k.push({name:"EventSlotList",query:{...v.query,page:r.value}}),localStorage.setItem("EventSlotPage",r.value),g(d,t)},_=p(!1),S=()=>{_.value=!_.value,console.log("Текущий статус показа фильтров:",_.value)},K=()=>{console.log("Сбрасываем фильтры"),d.planned_start="",d.order=b.find(t=>t.value==="planned_start"),localStorage.removeItem("EventSlotFilters"),localStorage.removeItem("EventSlotPage"),r.value=1,k.push({name:"EventSlotList",query:{planned_start:"",page:r.value}}),g(d,r.value)},Q=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let s=localStorage.getItem("access_token");const o=w(s);if(!(!s||!o))try{(await h.get(`${I}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(u){console.error("Ошибка проверки версии прав:",u),localStorage.removeItem("userPermissions")}},W=async()=>{let t=localStorage.getItem("access_token");const s=w(t);t&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!s&&o.user_id!==1||s&&s.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const u=await h.get(`${I}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",u.data),o=u.data,localStorage.setItem("userPermissions",JSON.stringify(o))}i.globalPermissionsList=o.global_permissions||[],i.objectPermissionsDict=o.object_permissions||{},i.canAddEventSlot=i.globalPermissionsList.includes("events.add_event_slot"),console.log("Права на добавление шаблонов:",i.canAddEventSlot),i.canViewEventSlot=i.globalPermissionsList.includes("events.view_event_slot")||!!i.objectPermissionsDict["events.view_event_slot"],console.log("Права на просмотр шаблонов:",i.canViewEventSlot)}catch(o){console.error("Ошибка при получении разрешений пользователя:",o)}};return Y(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await G(),await H(),await Q(),await W(),await g(d,r.value),C.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,s)=>{const o=R("spa"),u=R("router-link");return C.value?(a(),n("div",rs,[i.canViewEventSlot?(a(),n("div",cs,[s[21]||(s[21]=e("div",{class:"list-header"},[e("h1",null,"Слоты")],-1)),e("div",{class:"list-settings"},[e("button",{onClick:S,class:"list-settings-button"}," Параметры ")]),_.value?(a(),n("div",{key:0,class:"filters-overlay",onClick:S},[e("div",{class:"filters-outer",onClick:s[3]||(s[3]=es(()=>{},["stop"]))},[e("div",{class:"filters-close_button-inner"},[e("button",{onClick:S,class:"filters-close_button"}," × ")]),e("div",ds,[e("div",us,[s[6]||(s[6]=e("label",{class:"filters-label"},"Планируемое начало (после):",-1)),Z(e("input",{"onUpdate:modelValue":s[0]||(s[0]=l=>d.planned_start=l),type:"datetime-local",class:"filters-input"},null,512),[[ss,d.planned_start]])]),e("div",vs,[s[7]||(s[7]=e("label",{class:"filters-label"},"Сортировка:",-1)),E(U(is),{modelValue:d.order,"onUpdate:modelValue":s[1]||(s[1]=l=>d.order=l),options:b,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),e("div",gs,[e("button",{onClick:s[2]||(s[2]=l=>g(d,r.value.value)),class:"button"},"Применить"),e("button",{onClick:K,class:"button"},"Сбросить")])])])):m("",!0),i.items.length!==0?(a(),n("div",_s,[e("div",ps,[(a(!0),n(ts,null,ls(i.items,l=>{var x,F,N,$,j,L,O,q,A,D,B,T,J,z;return a(),n("div",{key:l.id,class:"list-card"},[e("div",ms,[l.avatar?(a(),n("div",fs,[e("img",{src:l.avatar,alt:"Аватар"},null,8,ks)])):(a(),n("div",bs,[E(o,{class:"none-text"},{default:P(()=>[...s[8]||(s[8]=[c("Нет аватара",-1)])]),_:1})]))]),e("div",ys,[((F=(x=l.last_task)==null?void 0:x.result)==null?void 0:F.status)=="waiting"?(a(),n("div",Ss,[...s[9]||(s[9]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-lock"})],-1),c(" В ожидании ",-1)])])):(($=(N=l.last_task)==null?void 0:N.result)==null?void 0:$.status)=="assigned"?(a(),n("div",Es,[...s[10]||(s[10]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-thumbtack"})],-1),c(" Назначено ",-1)])])):((L=(j=l.last_task)==null?void 0:j.result)==null?void 0:L.status)=="in_progress"?(a(),n("div",Ps,[...s[11]||(s[11]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-hourglass-half"})],-1),c(" В процессе ",-1)])])):((q=(O=l.last_task)==null?void 0:O.result)==null?void 0:q.status)=="under_review"?(a(),n("div",ws,[...s[12]||(s[12]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-magnifying-glass"})],-1),c(" На проверке ",-1)])])):((D=(A=l.last_task)==null?void 0:A.result)==null?void 0:D.status)=="completed"?(a(),n("div",hs,[...s[13]||(s[13]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-circle-check"})],-1),c(" Выполнено ",-1)])])):((T=(B=l.last_task)==null?void 0:B.result)==null?void 0:T.status)=="failed"?(a(),n("div",Is,[...s[14]||(s[14]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-circle-xmark"})],-1),c(" Провалено ",-1)])])):((z=(J=l.last_task)==null?void 0:J.result)==null?void 0:z.status)=="canceled"?(a(),n("div",Cs,[...s[15]||(s[15]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-ban"})],-1),c(" Отменено ",-1)])])):l.last_task?m("",!0):(a(),n("div",Vs,[...s[16]||(s[16]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-ban"})],-1),c(" Не назначено ",-1)])]))]),e("div",xs,[e("div",Fs,[e("h2",null,f(l.str||"Нет названия"),1)])]),e("div",Ns,[e("div",$s,[s[17]||(s[17]=e("span",{class:"list-card-text-label"},"Начало по плану:",-1)),c(" "+f(l.planned_start?U(ns)(l.planned_start):"Нет данных о начале"),1)])]),e("div",js,[E(u,{to:{name:"EventSlotDetail",params:{id:l.id},query:{tab:"details"}},class:"minibutton"},{default:P(()=>[...s[18]||(s[18]=[c(" Подробнее ",-1)])]),_:1},8,["to"])])])}),128))]),e("div",Ls,[e("button",{disabled:r.value===1,onClick:s[4]||(s[4]=l=>V(r.value-1)),class:"list-settings-button"}," Назад ",8,Os),e("span",null,"Страница "+f(r.value)+" из "+f(y.value),1),e("button",{disabled:r.value===y.value,onClick:s[5]||(s[5]=l=>V(r.value+1)),class:"list-settings-button"}," Вперед ",8,qs)])])):(a(),n("div",As,[...s[19]||(s[19]=[e("div",null,"Список пуст",-1)])])),i.canAddEventSlot?(a(),n("div",Ds,[i.canAddEventSlot?(a(),os(u,{key:0,to:{name:"EventSlotCreate"},class:"button"},{default:P(()=>[...s[20]||(s[20]=[c(" Создать ",-1)])]),_:1})):m("",!0)])):m("",!0)])):(a(),n("div",Bs,[...s[22]||(s[22]=[e("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),n("div",Ts,[...s[23]||(s[23]=[e("div",null,"Загрузка данных...",-1)])]))}}};export{Us as default};
