import{r as A,a as N,B as z,k as E,C as q,o as J,c as i,b as d,d as t,t as m,m as u,e as w,w as D,F,G as R,D as V,H as $,f as O,i as k,h as f,j as P,g as U,u as H,q as K,l as a,I as Q}from"./index-CAPuKB9Y.js";import{_ as W,a as X}from"./AccountsGroupObjectPermissions-Cioy0ns6.js";import{_ as Y}from"./TopicMessages-6jUYDAWt.js";import"./EditorComponent-DipgNh97.js";const Z={key:0},ee={key:0,class:"detail-page"},se={key:0},te={class:"detail-card"},oe={class:"detail-card-image-outer"},ae={key:0,class:"detail-card-image-inner"},ie=["src"],le={key:1,class:"detail-card-image-none"},ne={class:"detail-card-info"},ce={class:"detail-header"},re={class:"detail-header-title"},de={class:"detail-card-text"},me={class:"detail-card-text-elem"},ue={class:"detail-card-text-elem"},be={class:"detail-menu button-group"},_e={key:0,class:"modal-overlay"},ge={class:"modal"},pe={class:"modal-header"},ve={class:"modal-header-h2"},je={class:"minibutton-group modal-menu"},ke={class:"detail-tabs"},fe={class:"tabs-header"},Pe=["onClick"],he={key:0,class:"tabs-content"},ye={key:0,class:"desc-tab"},Ae={key:0},we={key:1},De={key:1,class:"detail-tab"},Oe={class:"detail-tab-elem"},Me={class:"detail-tab-elem"},Se={class:"detail-tab-elem"},Ve={class:"detail-tab-elem"},$e={class:"detail-tab-elem"},Ie={class:"detail-tab-elem"},Te={key:2,class:"topic-tab"},Le={key:3,class:"table-tab"},Ce={key:4,class:"table-tab"},Ge={key:1,class:"none-container"},Be={key:1,class:"loading"},xe={key:1,class:"loading"},Re={__name:"MaterialDetail",setup(Ne){const g=E(),p=H(),M=A(!1),e=N({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewMaterial:!1,canSelfAssignment:!1,canEditMaterial:!1,canDeleteMaterial:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),h=async()=>{const o=g.params.id;let s=localStorage.getItem("access_token");const c=k(s);s&&!c&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const l=await f.get(`${P}/materials/${o}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные материала:",l.data),e.object=l.data}catch(l){console.error("Ошибка при получении данных материала:",l)}},y=A(!1),I=()=>{y.value=!0},S=()=>{y.value=!1},T=async()=>{let o=localStorage.getItem("access_token");const s=k(o);if(o&&!s){p.push({name:"Login"});return}const c=g.params.id;try{await f.delete(`${P}/materials/${c}/`,{headers:{Authorization:`Bearer ${o}`}}),S(),p.push({name:"MaterialList"})}catch(l){console.error("Ошибка удаления материала:",l)}},L=async o=>{let s=localStorage.getItem("access_token");const c=k(s);if(s&&!c){p.push({name:"Login"});return}try{const l=await f.post(`${P}/self_assignment/${o}/`,{},{headers:{Authorization:`Bearer ${s}`}});console.log("Самоназначение:",l.data),p.push({name:"TaskDetail",params:{id:l.data.id}})}catch(l){console.error("Ошибка самоназначения:",l)}},C=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let s=localStorage.getItem("access_token");const c=k(s);if(!(!s||!c))try{(await f.get(`${P}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(l){console.error("Ошибка проверки версии прав:",l),localStorage.removeItem("userPermissions")}},G=async()=>{var c,l,v,j;let o=localStorage.getItem("access_token");const s=k(o);o&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{let n=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",n),Object.keys(n).length>0&&(console.log("ID пользователя в разрешениях из памяти:",n.user_id),!s&&n.user_id!==1||s&&s.user_id!==n.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),n={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(n).length===0){const r=await f.get(`${P}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",r.data),n=r.data,localStorage.setItem("userPermissions",JSON.stringify(n))}e.globalPermissionsList=n.global_permissions||[],e.objectPermissionsDict=n.object_permissions||{};const _=g.params.id;console.log("ID объекта:",_),e.canViewMaterial=e.globalPermissionsList.includes("materials.view_material")||e.objectPermissionsDict["materials.view_material"]&&e.objectPermissionsDict["materials.view_material"].includes(Number(_)),console.log("Права на просмотр аккаунтов:",e.canViewMaterial),e.canSelfAssignment=e.canViewMaterial&&e.object.self_assignment_task_template&&e.object.self_assignment_task_template&&(!e.object.last_task||((l=(c=e.object.last_task)==null?void 0:c.result)==null?void 0:l.status)=="failed"||((j=(v=e.object.last_task)==null?void 0:v.result)==null?void 0:j.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditMaterial=e.globalPermissionsList.includes("materials.change_material")||Array.isArray(e.objectPermissionsDict["materials.change_material"])&&e.objectPermissionsDict["materials.change_material"].includes(Number(_)),console.log("Права на редактирование аккаунтов:",e.canEditMaterial),e.canDeleteMaterial=e.globalPermissionsList.includes("materials.delete_material")||Array.isArray(e.objectPermissionsDict["materials.delete_material"])&&e.objectPermissionsDict["materials.delete_material"].includes(Number(_)),console.log("Права на удаление аккаунтов:",e.canDeleteMaterial),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(n){console.error("Ошибка при загрузке разрешений пользователя:",n)}},B=()=>{K(p)},x=z(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=A(g.query.tab||localStorage.getItem(`activeMaterialTab-${g.params.id}`)||"details");return q(b,o=>{localStorage.setItem(`activeMaterialTab-${g.params.id}`,o),p.push({query:{tab:o}}),console.log("Загружен таб:",o)}),J(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await h(),await C(),await G(),M.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,s)=>{var l,v,j,n,_;const c=U("router-link");return M.value?(a(),i("div",Z,[e.canViewMaterial?(a(),i("div",ee,[e.object.id?(a(),i("div",se,[t("div",te,[t("div",oe,[e.object.avatar?(a(),i("div",ae,[t("img",{src:e.object.avatar||"/default-avatar.png",alt:"Аватар"},null,8,ie)])):(a(),i("div",le,[...s[2]||(s[2]=[t("span",{class:"none-text"},"Нет аватара",-1)])]))]),t("div",ne,[t("div",ce,[t("div",re,[t("h1",null,m(e.object.name||"Безымянный материал"),1)])]),t("div",de,[t("div",me,[s[3]||(s[3]=t("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),u(" "+m((l=e.object.last_task)!=null&&l.result?(v=e.object.last_task)==null?void 0:v.result.status_display:"Не назначено"),1)]),t("div",ue,[s[4]||(s[4]=t("span",{class:"detail-card-text-label"},"Категории:",-1)),u(" "+m(e.object.categories.length>0?e.object.categories.map(r=>r.name).join(", "):"Нет категорий"),1)])]),t("div",be,[e.object.last_task?(a(),w(c,{key:0,to:{name:"MaterialContent",params:{id:e.object.last_task.id}},class:"button"},{default:D(()=>[...s[5]||(s[5]=[u(" Ознакомиться ",-1)])]),_:1},8,["to"])):d("",!0),e.object.last_task?(a(),w(c,{key:1,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:D(()=>[...s[6]||(s[6]=[u(" Задача ",-1)])]),_:1},8,["to"])):d("",!0),e.canSelfAssignment?(a(),i("button",{key:2,onClick:s[0]||(s[0]=r=>L(e.object.self_assignment_task_template)),class:"button"}," Самоназначение ")):d("",!0),e.canEditMaterial?(a(),w(c,{key:3,to:{name:"MaterialEdit",params:{id:e.object.id}},class:"button"},{default:D(()=>[...s[7]||(s[7]=[u(" Изменить ",-1)])]),_:1},8,["to"])):d("",!0),e.canDeleteMaterial?(a(),i("button",{key:4,onClick:I,class:"button"}," Удалить ")):d("",!0),t("button",{type:"button",onClick:B,class:"button"},"Назад")]),y.value?(a(),i("div",_e,[t("div",ge,[t("div",pe,[t("h2",ve,"Удаление "+m(e.object.username||"Безымянная учетная запись"),1)]),t("div",je,[t("button",{onClick:s[1]||(s[1]=r=>T()),class:"minibutton"},"Подтвердить"),t("button",{onClick:S,class:"minibutton"},"Отменить")])])])):d("",!0)])]),t("div",ke,[t("div",fe,[(a(!0),i(F,null,R(x.value,r=>(a(),i("button",{key:r.name,class:Q([{active:b.value===r.name},"tab-button"]),onClick:ze=>b.value=r.name},m(r.label),11,Pe))),128))]),b.value?(a(),i("div",he,[b.value==="desc"?(a(),i("div",ye,[e.object.desc?(a(),i("div",Ae,m(e.object.desc),1)):(a(),i("div",we,[...s[8]||(s[8]=[t("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):d("",!0),b.value==="details"?(a(),i("div",De,[t("div",Oe,[s[9]||(s[9]=t("span",{class:"detail-tab-label"},"Статус задачи:",-1)),u(" "+m((j=e.object.last_task)!=null&&j.result?(n=e.object.last_task)==null?void 0:n.result.status_display:"Не назначено"),1)]),t("div",Me,[s[10]||(s[10]=t("span",{class:"detail-tab-label"},"Категории:",-1)),u(" "+m(e.object.categories.length>0?e.object.categories.map(r=>r.name).join(", "):"Нет категорий"),1)]),t("div",Se,[s[11]||(s[11]=t("span",{class:"detail-tab-label"},"Создан:",-1)),u(" "+m(e.object.created?V($)(e.object.created):"Нет данных о создании"),1)]),t("div",Ve,[s[12]||(s[12]=t("span",{class:"detail-tab-label"},"Создатель:",-1)),u(" "+m(e.object.creator?e.object.creator:"Нет создателя"),1)]),t("div",$e,[s[13]||(s[13]=t("span",{class:"detail-tab-label"},"Изменён:",-1)),u(" "+m(e.object.changed?V($)(e.object.changed):"Нет данных об изменениях"),1)]),t("div",Ie,[s[14]||(s[14]=t("span",{class:"detail-tab-label"},"Редактор:",-1)),u(" "+m(e.object.editor?e.object.editor:"Нет редактора"),1)])])):d("",!0),b.value==="messages"?(a(),i("div",Te,[O(Y,{topic_id:(_=e.object)==null?void 0:_.topic.id},null,8,["topic_id"])])):d("",!0),b.value==="accountsGroupObjectPermissions"?(a(),i("div",Le,[O(W,{state:e,fetchObject:h,contentTypeModel:"material"},null,8,["state"])])):d("",!0),b.value==="accountObjectPermissions"?(a(),i("div",Ce,[O(X,{state:e,fetchObject:h,contentTypeModel:"material"},null,8,["state"])])):d("",!0)])):d("",!0)])])):e.object.id?d("",!0):(a(),i("div",Ge,[...s[15]||(s[15]=[t("div",{class:"none-card"},[t("div",null,"Объект не найден.")],-1)])]))])):(a(),i("div",Be,[...s[16]||(s[16]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),i("div",xe,[...s[17]||(s[17]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{Re as default};
