import{a as O,r as p,k as M,o as R,c as u,d as l,b as x,p as C,v as $,f as m,D as y,w as _,n as E,F as G,G as H,t as v,e as K,i as k,h as S,j as V,u as Q,g as j,l as c,m as g}from"./index-yfpLmCCm.js";import{s as A}from"./custom-multiselect-BtCJ6pih.js";const W={key:0},X={key:0,class:"list-page"},Y={class:"filters-inner"},Z={class:"filters-field"},ee={class:"filters-field"},se={class:"filters-field"},le={class:"filters-field"},te={class:"filters-field"},ae={class:"filters-field"},oe={class:"filters-field"},ie={class:"filters-menu button-group"},ne={key:1,class:"list-items"},re={class:"list-grid"},ce={class:"list-card-image-outer"},ue={key:0,class:"list-card-image-inner"},de=["src"],me={key:1,class:"list-card-image-none"},ve={class:"list-card-header"},ge={class:"list-card-header-title"},pe={class:"list-card-text"},_e={class:"list-card-text-elem"},be={class:"list-card-text-elem"},fe={class:"list-card-text-elem"},ye={class:"list-card-menu minibutton-group"},ke={class:"list-pagination"},Se=["disabled"],Ve=["disabled"],Ae={key:2,class:"none-card"},Pe={key:3,class:"list-menu button-group"},we={key:1,class:"loading"},Ie={key:1,class:"loading"},Ce={__name:"AccountList",setup(qe){const r=M(),P=Q(),i=O({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddAccount:!1,canViewAccount:!1}),F=p(!1),w=[{label:"Фамилия: по возрастанию",value:"last_name"},{label:"Фамилия: по убыванию",value:"-last_name"},{label:"Имя пользователя: по возрастанию",value:"username"},{label:"Имя пользователя: по убыванию",value:"-username"},{label:"Электронная почта: по возрастанию",value:"email"},{label:"Электронная почта: по убыванию",value:"-email"}],I=p([]),L=async()=>{let s=localStorage.getItem("access_token");const e=k(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const a=await S.get(`${V}/permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});I.value=a.data.results||[],console.log("Разрешения загружены:",I.value)}catch(a){console.error("Ошибка при загрузке разрешений:",a.response?a.response.data:a.message)}},o=O({username:r.query.username||"",email:r.query.email||"",last_name:r.query.last_name||"",is_active:r.query.is_active?{label:r.query.is_active==="true"?"Да":"Нет",value:r.query.is_active}:"",self_registration:r.query.self_registration?{label:r.query.self_registration==="true"?"Да":"Нет",value:r.query.self_registration}:"",user_permissions:r.query.user_permissions?r.query.user_permissions.map(s=>({id:parseInt(s,10)})):[],order:w.find(s=>s.value===r.query.order||"last_name")}),U=()=>{const s=localStorage.getItem("accountFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(o,JSON.parse(s)))},n=p(Number(r.query.page)||1),q=p(1),B=()=>{const s=localStorage.getItem("accountPage");s&&(console.log("Загруженная странциа:",s),n.value=parseInt(s,10))},b=async(s,e)=>{console.log("Загрузка аккаунтов с фильтрами:",s,"для страницы:",e);let a=localStorage.getItem("access_token");const d=k(a);a&&!d&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),a=null),P.push({name:"AccountList",query:{username:s.username||"",email:s.email||"",last_name:s.last_name||"",is_active:s.is_active?s.is_active.value:"",self_registration:s.self_registration?s.self_registration.value:"",user_permissions:s.user_permissions.map(t=>t.id)||[],order:s.order.value,page:n.value}}),localStorage.setItem("accountFilters",JSON.stringify(s));try{const t=await S.get(`${V}/accounts/`,{headers:{...a&&{Authorization:`Bearer ${a}`}},params:{page:e,page_size:12,username:s.username,email:s.email,last_name:s.last_name,is_active:s.is_active?s.is_active.value:"",self_registration:s.self_registration?s.self_registration.value:"",user_permissions:s.user_permissions.map(J=>J.id),ordering:s.order.value}});console.log("Список аккаунтов загружен:",t.data),i.items=t.data.results,q.value=Math.ceil(t.data.count/12)}catch(t){console.error("Ошибка при загрузке списка аккаунтов:",t)}},N=s=>{console.log("Смена страницы на:",s),n.value=s,P.push({name:"AccountList",query:{...r.query,page:n.value}}),localStorage.setItem("accountPage",n.value),b(o,s)},f=p(!1),h=()=>{f.value=!f.value,console.log("Текущий статус показа фильтров:",f.value)},D=()=>{console.log("Сбрасываем фильтры"),o.username="",o.email="",o.last_name="",o.is_active="",o.self_registration="",o.user_permissions=[],o.order=w.find(s=>s.value==="last_name"),localStorage.removeItem("accountFilters"),localStorage.removeItem("accountPage"),n.value=1,P.push({name:"AccountList",query:{username:"",email:"",last_name:"",is_active:"",self_registration:"",user_permissions:[],order:o.order.value,page:n.value}}),b(o,n.value)},T=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const a=k(e);if(!(!e||!a))try{(await S.get(`${V}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(d){console.error("Ошибка проверки версии прав:",d),localStorage.removeItem("userPermissions")}},z=async()=>{let s=localStorage.getItem("access_token");const e=k(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let a=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",a),Object.keys(a).length>0&&(console.log("ID пользователя в разрешениях из памяти:",a.user_id),!e&&a.user_id!==1||e&&e.user_id!==a.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),a={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(a).length===0){const d=await S.get(`${V}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",d.data),a=d.data,localStorage.setItem("userPermissions",JSON.stringify(a))}i.globalPermissionsList=a.global_permissions||[],i.objectPermissionsDict=a.object_permissions||{},i.canAddAccount=i.globalPermissionsList.includes("core.add_account"),console.log("Права на добавление аккаунтов:",i.canAddAccount),i.canViewAccount=i.globalPermissionsList.includes("core.view_account")||!!i.objectPermissionsDict["core.view_account"],console.log("Права на просмотр аккаунтов:",i.canViewAccount)}catch(a){console.error("Ошибка при получении разрешений пользователя:",a)}};return R(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await U(),await B(),await L(),await T(),await z(),await b(o,n.value),F.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const a=j("spa"),d=j("router-link");return F.value?(c(),u("div",W,[i.canViewAccount?(c(),u("div",X,[e[27]||(e[27]=l("div",{class:"list-header"},[l("h1",null,"Аккаунты")],-1)),l("div",{class:"list-settings"},[l("button",{onClick:h,class:"list-settings-button"}," Параметры ")]),f.value?(c(),u("div",{key:0,class:"filters-overlay",onClick:h},[l("div",{class:"filters-outer",onClick:e[8]||(e[8]=E(()=>{},["stop"]))},[l("div",{class:"filters-close_button-inner"},[l("button",{onClick:h,class:"filters-close_button"}," × ")]),l("div",Y,[l("div",Z,[e[11]||(e[11]=l("label",{class:"filters-label"},"Имя пользователя:",-1)),C(l("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>o.username=t),class:"filters-input",placeholder:"Введите имя пользователя"},null,512),[[$,o.username]])]),l("div",ee,[e[12]||(e[12]=l("label",{class:"filters-label"},"Электронная почта:",-1)),C(l("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>o.email=t),class:"filters-input",placeholder:"Введите электронную почту"},null,512),[[$,o.email]])]),l("div",se,[e[13]||(e[13]=l("label",{class:"filters-label"},"Фамилия:",-1)),C(l("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>o.last_name=t),class:"filters-input",placeholder:"Введите фамилию"},null,512),[[$,o.last_name]])]),l("div",le,[e[14]||(e[14]=l("label",{class:"filters-label"},"Активен:",-1)),m(y(A),{modelValue:o.is_active,"onUpdate:modelValue":e[3]||(e[3]=t=>o.is_active=t),options:[{label:"Да",value:"true"},{label:"Нет",value:"false"}],searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"])]),l("div",te,[e[15]||(e[15]=l("label",{class:"filters-label"},"Самостоятельная регистрация:",-1)),m(y(A),{modelValue:o.self_registration,"onUpdate:modelValue":e[4]||(e[4]=t=>o.self_registration=t),options:[{label:"Да",value:"true"},{label:"Нет",value:"false"}],multiple:!1,searchable:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"])]),l("div",ae,[e[18]||(e[18]=l("label",{class:"filters-label"},"Разрешения:",-1)),m(y(A),{modelValue:o.user_permissions,"onUpdate:modelValue":e[5]||(e[5]=t=>o.user_permissions=t),options:I.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:_(()=>[...e[16]||(e[16]=[l("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[17]||(e[17]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),l("div",oe,[e[19]||(e[19]=l("label",{class:"filters-label"},"Сортировка:",-1)),m(y(A),{modelValue:o.order,"onUpdate:modelValue":e[6]||(e[6]=t=>o.order=t),options:w,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),l("div",ie,[l("button",{onClick:e[7]||(e[7]=t=>b(o,n.value.value)),class:"button"},"Применить"),l("button",{onClick:D,class:"button"},"Сбросить")])])])):x("",!0),i.items.length!==0?(c(),u("div",ne,[l("div",re,[(c(!0),u(G,null,H(i.items,t=>(c(),u("div",{key:t.id,class:"list-card"},[l("div",ce,[t.avatar?(c(),u("div",ue,[l("img",{src:t.avatar,alt:"Аватар"},null,8,de)])):(c(),u("div",me,[m(a,{class:"none-text"},{default:_(()=>[...e[20]||(e[20]=[g("Нет аватара",-1)])]),_:1})]))]),l("div",ve,[l("div",ge,[l("h2",null,v(t.username||"Нет имени пользователя"),1)])]),l("div",pe,[l("div",_e,[e[21]||(e[21]=l("span",{class:"list-card-text-label"},"Фамилия:",-1)),g(" "+v(t.last_name||"Нет фамилии"),1)]),l("div",be,[e[22]||(e[22]=l("span",{class:"list-card-text-label"},"Имя:",-1)),g(" "+v(t.first_name||"Нет имени"),1)]),l("div",fe,[e[23]||(e[23]=l("span",{class:"list-card-text-label"},"Отчество:",-1)),g(" "+v(t.fathers_name||"Нет отчества"),1)])]),l("div",ye,[m(d,{to:{name:"AccountDetail",params:{id:t.id},query:{tab:"details"}},class:"minibutton"},{default:_(()=>[...e[24]||(e[24]=[g(" Подробнее ",-1)])]),_:1},8,["to"])])]))),128))]),l("div",ke,[l("button",{disabled:n.value===1,onClick:e[9]||(e[9]=t=>N(n.value-1)),class:"list-settings-button"}," Назад ",8,Se),l("span",null,"Страница "+v(n.value)+" из "+v(q.value),1),l("button",{disabled:n.value===q.value,onClick:e[10]||(e[10]=t=>N(n.value+1)),class:"list-settings-button"}," Вперед ",8,Ve)])])):(c(),u("div",Ae,[...e[25]||(e[25]=[l("div",null,"Список пуст",-1)])])),i.canAddAccount?(c(),u("div",Pe,[i.canAddAccount?(c(),K(d,{key:0,to:{name:"AccountCreate"},class:"button"},{default:_(()=>[...e[26]||(e[26]=[g(" Создать ",-1)])]),_:1})):x("",!0)])):x("",!0)])):(c(),u("div",we,[...e[28]||(e[28]=[l("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(c(),u("div",Ie,[...e[29]||(e[29]=[l("div",null,"Загрузка данных...",-1)])]))}}};export{Ce as default};
