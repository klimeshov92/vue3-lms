import{r as h,a as L,A as G,k as C,B,o as N,c,b as r,d as o,t as l,m as d,e as T,w as x,F as E,E as M,C as y,G as A,f as O,i as _,h as g,j as p,g as z,u as J,l as a,H as q}from"./index-C7lVKHoT.js";import{_ as F,a as R}from"./AccountsGroupObjectPermissions-Bs4p9YWR.js";import"./EditorComponent-vmM3im-r.js";const U={key:0},H={key:0,class:"detail-page"},K={key:0},Q={class:"detail-card"},W={class:"detail-card-info"},X={class:"detail-header"},Y={class:"detail-header-title"},Z={class:"detail-card-text"},ee={class:"detail-card-text-elem"},se={class:"detail-menu button-group"},oe={key:0,class:"modal-overlay"},te={class:"modal"},ie={class:"modal-header"},ne={class:"modal-header-h2"},ae={class:"minibutton-group modal-menu"},ce={class:"detail-tabs"},le={class:"tabs-header"},re=["onClick"],de={key:0,class:"tabs-content"},ue={key:0,class:"detail-tab"},me={class:"detail-tab-elem"},be={class:"detail-tab-elem"},_e={class:"detail-tab-elem"},ge={class:"detail-tab-elem"},pe={class:"detail-tab-elem"},ve={class:"detail-tab-elem"},Pe={key:1,class:"table-tab"},je={key:2,class:"table-tab"},he={key:1,class:"none-container"},ke={key:1,class:"loading"},fe={key:1,class:"loading"},we={__name:"PositionDetail",setup(ye){const m=C(),b=J(),k=h(!1),e=L({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewPosition:!1,canEditPosition:!1,canDeletePosition:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),v=async()=>{const t=m.params.id;let s=localStorage.getItem("access_token");const i=_(s);s&&!i&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const n=await g.get(`${p}/positions/${t}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные подоразделения:",n.data),e.object=n.data}catch(n){console.error("Ошибка при получении данных подоразделения:",n)}},P=h(!1),D=()=>{P.value=!0},f=()=>{P.value=!1},w=async()=>{let t=localStorage.getItem("access_token");const s=_(t);if(t&&!s){b.push({name:"Login"});return}const i=m.params.id;try{await g.delete(`${p}/positions/${i}/`,{headers:{Authorization:`Bearer ${t}`}}),f(),b.push({name:"PositionList"})}catch(n){console.error("Ошибка удаления подразделения:",n)}},S=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let s=localStorage.getItem("access_token");const i=_(s);if(!(!s||!i))try{(await g.get(`${p}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(n){console.error("Ошибка проверки версии прав:",n),localStorage.removeItem("userPermissions")}},V=async()=>{let t=localStorage.getItem("access_token");const s=_(t);t&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{let i=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",i),Object.keys(i).length>0&&(console.log("ID пользователя в разрешениях из памяти:",i.user_id),!s&&i.user_id!==1||s&&s.user_id!==i.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),i={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(i).length===0){const j=await g.get(`${p}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",j.data),i=j.data,localStorage.setItem("userPermissions",JSON.stringify(i))}e.globalPermissionsList=i.global_permissions||[],e.objectPermissionsDict=i.object_permissions||{};const n=m.params.id;console.log("ID объекта:",n),e.canViewPosition=e.globalPermissionsList.includes("core.view_position")||e.objectPermissionsDict["core.view_position"]&&e.objectPermissionsDict["core.view_position"].includes(Number(n)),console.log("Права на просмотр должностей:",e.canViewPosition),e.canEditPosition=e.globalPermissionsList.includes("core.change_position")||Array.isArray(e.objectPermissionsDict["core.change_position"])&&e.objectPermissionsDict["core.change_position"].includes(Number(n)),console.log("Права на редактирование должностей:",e.canEditPosition),e.canDeletePosition=e.globalPermissionsList.includes("core.delete_position")||Array.isArray(e.objectPermissionsDict["core.delete_position"])&&e.objectPermissionsDict["core.delete_position"].includes(Number(n)),console.log("Права на удаление должностей:",e.canDeletePosition),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(i){console.error("Ошибка при загрузке разрешений пользователя:",i)}},$=()=>{b.back()},I=G(()=>[{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),u=h(m.query.tab||localStorage.getItem(`activePositionTab-${m.params.id}`)||"details");return B(u,t=>{localStorage.setItem(`activePositionTab-${m.params.id}`,t),b.push({query:{tab:t}}),console.log("Загружен таб:",t)}),N(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await v(),await S(),await V(),k.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,s)=>{const i=z("router-link");return k.value?(a(),c("div",U,[e.canViewPosition?(a(),c("div",H,[e.object.id?(a(),c("div",K,[o("div",Q,[o("div",W,[o("div",X,[o("div",Y,[o("h1",null,l(e.object.name||"Безымянная должность"),1)])]),o("div",Z,[o("div",ee,[s[1]||(s[1]=o("span",{class:"detail-card-text-label"},"Подразделение:",-1)),d(" "+l(e.object.subdivision?e.object.subdivision.name:"Нет подразделения"),1)])]),o("div",se,[e.canEditPosition?(a(),T(i,{key:0,to:{name:"PositionEdit",params:{id:e.object.id}},class:"button"},{default:x(()=>[...s[2]||(s[2]=[d(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canDeletePosition?(a(),c("button",{key:1,onClick:D,class:"button"}," Удалить ")):r("",!0),o("button",{type:"button",onClick:$,class:"button"},"Назад")]),P.value?(a(),c("div",oe,[o("div",te,[o("div",ie,[o("h2",ne,"Удаление "+l(e.object.name||"Безымянная должность"),1)]),o("div",ae,[o("button",{onClick:s[0]||(s[0]=n=>w()),class:"minibutton"},"Подтвердить"),o("button",{onClick:f,class:"minibutton"},"Отменить")])])])):r("",!0)])]),o("div",ce,[o("div",le,[(a(!0),c(E,null,M(I.value,n=>(a(),c("button",{key:n.name,class:q([{active:u.value===n.name},"tab-button"]),onClick:j=>u.value=n.name},l(n.label),11,re))),128))]),u.value?(a(),c("div",de,[u.value==="details"?(a(),c("div",ue,[o("div",me,[s[3]||(s[3]=o("span",{class:"detail-tab-label"},"Название:",-1)),d(" "+l(e.object.name||"Нет названия"),1)]),o("div",be,[s[4]||(s[4]=o("span",{class:"detail-tab-label"},"Подразделение:",-1)),d(" "+l(e.object.subdivision?e.object.subdivision.name:"Нет подразделения"),1)]),o("div",_e,[s[5]||(s[5]=o("span",{class:"detail-tab-label"},"Создан:",-1)),d(" "+l(e.object.created?y(A)(e.object.created):"Нет данных о создании"),1)]),o("div",ge,[s[6]||(s[6]=o("span",{class:"detail-tab-label"},"Создатель:",-1)),d(" "+l(e.object.creator?e.object.creator:"Нет создателя"),1)]),o("div",pe,[s[7]||(s[7]=o("span",{class:"detail-tab-label"},"Изменён:",-1)),d(" "+l(e.object.changed?y(A)(e.object.changed):"Нет данных об изменениях"),1)]),o("div",ve,[s[8]||(s[8]=o("span",{class:"detail-tab-label"},"Редактор:",-1)),d(" "+l(e.object.editor?e.object.editor:"Нет редактора"),1)])])):r("",!0),u.value==="accountsGroupObjectPermissions"?(a(),c("div",Pe,[O(F,{state:e,fetchObject:v,contentTypeModel:"position"},null,8,["state"])])):r("",!0),u.value==="accountObjectPermissions"?(a(),c("div",je,[O(R,{state:e,fetchObject:v,contentTypeModel:"position"},null,8,["state"])])):r("",!0)])):r("",!0)])])):e.object.id?r("",!0):(a(),c("div",he,[...s[9]||(s[9]=[o("div",{class:"none-card"},[o("div",null,"Объект не найден.")],-1)])]))])):(a(),c("div",ke,[...s[10]||(s[10]=[o("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),c("div",fe,[...s[11]||(s[11]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{we as default};
