import{a as Q,r as g,k as T,o as z,c,d as t,b as w,p as J,v as U,f as I,w as p,C as $,n as M,F as R,E,t as b,e as G,i as f,h as _,j as k,u as H,g as K,l as r,m as q}from"./index-B3ZHU6wM.js";import{s as j}from"./custom-multiselect-DDQ9gWBN.js";const W={key:0},X={key:0,class:"list-page"},Y={class:"filters-inner"},Z={class:"filters-field"},ee={class:"filters-field"},se={class:"filters-field"},te={class:"filters-menu button-group"},oe={key:1,class:"list-items"},le={class:"list-grid"},ae={class:"list-card-image-outer"},ie={key:0,class:"list-card-image-inner"},ne=["src"],re={key:1,class:"list-card-image-none"},ce={class:"list-card-header"},ue={class:"list-card-header-title"},de={class:"list-card-text"},ge={class:"list-card-text-elem"},me={class:"list-card-menu minibutton-group"},ve={class:"list-pagination"},pe=["disabled"],be=["disabled"],fe={key:2,class:"none-card"},_e={key:3,class:"list-menu button-group"},ke={key:1,class:"loading"},ye={key:1,class:"loading"},Pe={__name:"QuestionList",setup(Se){const d=T(),y=H(),a=Q({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddQuestion:!1,canViewQuestion:!1}),V=g(!1),S=[{label:"Текст: по возрастанию",value:"text"},{label:"Текст: по убыванию",value:"-text"}],x=g([]),F=async()=>{let s=localStorage.getItem("access_token");const e=f(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const o=await _.get(`${k}/categories/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});x.value=o.data.results||[],console.log("Категории загружены:",x.value)}catch(o){console.error("Ошибка при загрузке категорий:",o.response?o.response.data:o.message)}},n=Q({text:d.query.text||"",categories:d.query.categories?d.query.categories.map(s=>({id:parseInt(s,10)})):[],order:S.find(s=>s.value===d.query.order||"text")}),N=()=>{const s=localStorage.getItem("questionFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(n,JSON.parse(s)))},i=g(Number(d.query.page)||1),h=g(1),O=()=>{const s=localStorage.getItem("questionPage");s&&(console.log("Загруженная странциа:",s),i.value=parseInt(s,10))},m=async(s,e)=>{console.log("Загрузка вопросов с фильтрами:",s,"для страницы:",e);let o=localStorage.getItem("access_token");const l=f(o);o&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null),y.push({name:"QuestionList",query:{text:s.text||"",categories:s.categories.map(u=>u.id)||[],order:s.order.value,page:i.value}}),localStorage.setItem("questionFilters",JSON.stringify(s));try{const u=await _.get(`${k}/questions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}},params:{page:e,page_size:12,text:s.text,categories:s.categories.map(D=>D.id),ordering:s.order.value}});console.log("Список вопросов загружен:",u.data),a.items=u.data.results,h.value=Math.ceil(u.data.count/12)}catch(u){console.error("Ошибка при загрузке списка вопросов:",u)}},C=s=>{console.log("Смена страницы на:",s),i.value=s,y.push({name:"QuestionList",query:{...d.query,page:i.value}}),localStorage.setItem("questionPage",i.value),m(n,s)},v=g(!1),P=()=>{v.value=!v.value,console.log("Текущий статус показа фильтров:",v.value)},A=()=>{console.log("Сбрасываем фильтры"),n.text="",n.categories=[],n.order=S.find(s=>s.value==="text"),localStorage.removeItem("questionFilters"),localStorage.removeItem("questionPage"),i.value=1,y.push({name:"QuestionList",query:{text:"",categories:[],page:i.value}}),m(n,i.value)},L=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const o=f(e);if(!(!e||!o))try{(await _.get(`${k}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(l){console.error("Ошибка проверки версии прав:",l),localStorage.removeItem("userPermissions")}},B=async()=>{let s=localStorage.getItem("access_token");const e=f(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!e&&o.user_id!==1||e&&e.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const l=await _.get(`${k}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",l.data),o=l.data,localStorage.setItem("userPermissions",JSON.stringify(o))}a.globalPermissionsList=o.global_permissions||[],a.objectPermissionsDict=o.object_permissions||{},a.canAddQuestion=a.globalPermissionsList.includes("tests.add_question"),console.log("Права на добавление вопросов:",a.canAddQuestion),a.canViewQuestion=a.globalPermissionsList.includes("tests.view_question")||!!a.objectPermissionsDict["tests.view_question"],console.log("Права на просмотр вопросов:",a.canViewQuestion)}catch(o){console.error("Ошибка при получении разрешений пользователя:",o)}};return z(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await N(),await O(),await F(),await L(),await B(),await m(n,i.value),V.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const o=K("router-link");return V.value?(r(),c("div",W,[a.canViewQuestion?(r(),c("div",X,[e[17]||(e[17]=t("div",{class:"list-header"},[t("h1",null,"Вопросы")],-1)),t("div",{class:"list-settings"},[t("button",{onClick:P,class:"list-settings-button"}," Параметры ")]),v.value?(r(),c("div",{key:0,class:"filters-overlay",onClick:P},[t("div",{class:"filters-outer",onClick:e[4]||(e[4]=M(()=>{},["stop"]))},[t("div",{class:"filters-close_button-inner"},[t("button",{onClick:P,class:"filters-close_button"}," × ")]),t("div",Y,[t("div",Z,[e[7]||(e[7]=t("label",{class:"filters-label"},"Текст:",-1)),J(t("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>n.text=l),class:"filters-input",placeholder:"Введите название"},null,512),[[U,n.text]])]),t("div",ee,[e[10]||(e[10]=t("label",{class:"filters-label"},"Категории:",-1)),I($(j),{modelValue:n.categories,"onUpdate:modelValue":e[1]||(e[1]=l=>n.categories=l),options:x.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[8]||(e[8]=[t("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[9]||(e[9]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),t("div",se,[e[11]||(e[11]=t("label",{class:"filters-label"},"Сортировка:",-1)),I($(j),{modelValue:n.order,"onUpdate:modelValue":e[2]||(e[2]=l=>n.order=l),options:S,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),t("div",te,[t("button",{onClick:e[3]||(e[3]=l=>m(n,i.value.value)),class:"button"},"Применить"),t("button",{onClick:A,class:"button"},"Сбросить")])])])):w("",!0),a.items.length!==0?(r(),c("div",oe,[t("div",le,[(r(!0),c(R,null,E(a.items,l=>(r(),c("div",{key:l.id,class:"list-card"},[t("div",ae,[l.picture?(r(),c("div",ie,[t("img",{src:l.picture,alt:"Картинка"},null,8,ne)])):(r(),c("div",re,[...e[12]||(e[12]=[t("span",{class:"none-text"},"Нет картинки",-1)])]))]),t("div",ce,[t("div",ue,[t("h2",null,b(l.text||"Нет текста"),1)])]),t("div",de,[t("div",ge,[e[13]||(e[13]=t("span",{class:"list-card-text-label"},"Категории:",-1)),q(" "+b(l.categories.length>0?l.categories.map(u=>u.name).join(", "):"Нет категорий"),1)])]),t("div",me,[I(o,{to:{name:"QuestionDetail",params:{id:l.id},query:{tab:"details"}},class:"minibutton"},{default:p(()=>[...e[14]||(e[14]=[q(" Подробнее ",-1)])]),_:1},8,["to"])])]))),128))]),t("div",ve,[t("button",{disabled:i.value===1,onClick:e[5]||(e[5]=l=>C(i.value-1)),class:"list-settings-button"}," Назад ",8,pe),t("span",null,"Страница "+b(i.value)+" из "+b(h.value),1),t("button",{disabled:i.value===h.value,onClick:e[6]||(e[6]=l=>C(i.value+1)),class:"list-settings-button"}," Вперед ",8,be)])])):(r(),c("div",fe,[...e[15]||(e[15]=[t("div",null,"Список пуст",-1)])])),a.canAddQuestion?(r(),c("div",_e,[a.canAddQuestion?(r(),G(o,{key:0,to:{name:"QuestionCreate"},class:"button"},{default:p(()=>[...e[16]||(e[16]=[q(" Создать ",-1)])]),_:1})):w("",!0)])):w("",!0)])):(r(),c("div",ke,[...e[18]||(e[18]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(r(),c("div",ye,[...e[19]||(e[19]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{Pe as default};
