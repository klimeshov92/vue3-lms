import{r as p,a as $,o as F,c as n,d as t,b as k,t as y,f as C,w as _,D as L,p as j,v as x,n as M,i as h,u as R,h as f,j as v,k as z,q as A,l as i}from"./index-yfpLmCCm.js";import{s as N}from"./custom-multiselect-BtCJ6pih.js";import{E as I}from"./EditorComponent-sX0RyEc9.js";const q={key:0},J={key:0,class:"form-page"},P={class:"form-field"},G={key:0,class:"avatar-preview"},H=["href"],K={class:"form-field"},Q={class:"form-field"},W={key:0,class:"error"},X={lass:"form-field form-field-full_width"},Y={key:0,class:"error"},Z={class:"form-field"},ee={key:1,class:"none-card"},te={key:1,class:"loading"},re={__name:"MaterialEdit",setup(ae){const w=z(),d=R(),c=p(null),s=$({name:"",content:"",desc:"",categories:[]}),V=p(!1),g=p([]),B=async()=>{let a=localStorage.getItem("access_token");const e=h(a);if(a&&!e){d.push({name:"Login"});return}try{const o=await f.get(`${v}/categories/`,{headers:{Authorization:`Bearer ${a}`}});g.value=o.data.results||[],console.log("Категории загружены:",g.value)}catch(o){console.error("Ошибка при загрузке категорий:",o.response?o.response.data:o.message)}},U=async()=>{var m;const a=w.params.id;let e=localStorage.getItem("access_token");const o=h(e);if(e&&!o){d.push({name:"Login"});return}try{const r=await f.get(`${v}/materials/${a}/`,{headers:{Authorization:`Bearer ${e}`}});c.value=r.data,console.log("Объект успешно загружен:",c.value),Object.assign(s,c.value),u.value=c.value.avatar||""}catch(r){console.error("Ошибка загрузки объекта:",((m=r.response)==null?void 0:m.data)||r.message)}},b=p(null),u=p(null),D=a=>{const e=a.target.files[0];e&&(b.value=e,u.value=URL.createObjectURL(e))},l=$({}),O=()=>(l.name=s.name?"":"Название обязательно!",l.content=s.content.trim()?"":"Содержание обязательно!",Object.values(l).every(a=>!a)),S=async()=>{if(!O()){console.error("Форма содержит ошибки:",l);return}try{const a=w.params.id;let e=localStorage.getItem("access_token");const o=h(e);if(e&&!o){d.push({name:"Login"});return}const m={name:s.name,content:s.content||"",desc:s.desc,categories:s.categories.map(r=>r.id)};if(console.log("JSON данные перед отправкой:",m),await f.patch(`${v}/materials/${a}/`,m,{headers:{Authorization:`Bearer ${e}`}}),console.log("Данные обновлены"),b.value){const r=new FormData;r.append("avatar",b.value);const E=`${v}/materials/${a}/`;await f.patch(E,r,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}}),console.log("Аватар успешно обновлен")}console.log("Изменения сохранены"),d.push({name:"MaterialDetail",params:{id:a}})}catch(a){a.response&&a.response.data?(Object.assign(l,a.response.data),console.error("Ошибка при сохранении изменений:",a.response.data)):console.error("Ошибка при сохранении изменений:",a.message)}},T=()=>{A(d)};return F(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await B(),await U(),V.value=!0}catch(a){console.error("Ошибка при загрузке данных:",a)}}),(a,e)=>V.value?(i(),n("div",q,[c.value?(i(),n("div",J,[e[13]||(e[13]=t("div",{class:"form-header"},[t("h1",null,"Редактирование страницы")],-1)),t("form",{onSubmit:M(S,["prevent"]),class:"form",id:"edit-form"},[t("div",P,[e[5]||(e[5]=t("label",{for:"avatar",class:"form-label"},"Аватар:",-1)),t("input",{type:"file",id:"avatar",onChange:D,class:"form-input"},null,32),u.value?(i(),n("div",G,[e[4]||(e[4]=t("span",{class:"avatar-preview-text"},"Текущий аватар:",-1)),t("a",{href:u.value,target:"_blank",class:"link"},y(u.value),9,H)])):k("",!0)]),t("div",K,[e[8]||(e[8]=t("label",{class:"form-label"},"Категории:",-1)),C(L(N),{modelValue:s.categories,"onUpdate:modelValue":e[0]||(e[0]=o=>s.categories=o),options:g.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:_(()=>[...e[6]||(e[6]=[t("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[7]||(e[7]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),t("div",Q,[e[9]||(e[9]=t("label",{for:"name",class:"form-label"},"Название:",-1)),j(t("input",{"onUpdate:modelValue":e[1]||(e[1]=o=>s.name=o),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[x,s.name]]),l.name?(i(),n("span",W,y(l.name),1)):k("",!0)]),t("div",X,[e[10]||(e[10]=t("label",{for:"desc",class:"form-label"},"Содержание:",-1)),C(I,{modelValue:s.content,"onUpdate:modelValue":e[2]||(e[2]=o=>s.content=o)},null,8,["modelValue"]),l.content?(i(),n("span",Y,y(l.content),1)):k("",!0)]),t("div",Z,[e[11]||(e[11]=t("label",{for:"desc",class:"form-label"},"Описание:",-1)),j(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=o=>s.desc=o),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[x,s.desc]])])],32),t("div",{class:"form-menu button-group"},[e[12]||(e[12]=t("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),t("button",{type:"button",onClick:T,class:"button"},"Отмена")])])):(i(),n("div",ee,[...e[14]||(e[14]=[t("div",null,"Объект не найден",-1)])]))])):(i(),n("div",te,[...e[15]||(e[15]=[t("div",null,"Загрузка данных...",-1)])]))}};export{re as default};
