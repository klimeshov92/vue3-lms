import{r as v,a as F,B as k,C as $,k as R,o as H,c as a,b as i,d as o,t as r,m as u,e as f,w as O,F as w,G as D,D as I,H as E,p as Q,v as K,f as T,i as j,h as A,j as y,u as W,g as X,q as Y,l as n,I as Z}from"./index-CAPuKB9Y.js";import{_ as ee,a as te}from"./AccountsGroupObjectPermissions-Cioy0ns6.js";import"./EditorComponent-DipgNh97.js";const oe={key:0},se={key:0,class:"detail-page"},ne={key:0},ae={class:"detail-card"},ce={class:"detail-card-info"},le={class:"detail-header"},re={class:"detail-header-title"},ie={class:"detail-card-text"},ue={class:"detail-card-text-elem"},de={class:"detail-card-text-elem"},be={key:0,class:"detail-card-text-elem"},me={class:"detail-menu button-group"},pe={key:0,class:"modal-overlay"},ge={class:"modal"},_e={class:"modal-header"},ve={class:"modal-header-h2"},je={class:"minibutton-group modal-menu"},Ae={class:"detail-tabs"},ye={class:"tabs-header"},ke=["onClick"],Ge={key:0,class:"tabs-content"},he={key:0,class:"desc-tab"},Pe={key:0},fe={key:1},Oe={key:1,class:"detail-tab"},we={class:"detail-tab-elem"},De={class:"detail-tab-elem"},Ce={class:"detail-tab-elem"},Ve={key:0,class:"detail-tab-elem"},Le={key:1,class:"detail-tab-elem"},Se={key:2,class:"detail-tab-elem"},$e={key:3,class:"detail-tab-elem"},Ie={key:4,class:"detail-tab-elem"},Ee={key:5,class:"detail-tab-elem"},Te={key:6,class:"detail-tab-elem"},Be={key:7,class:"detail-tab-elem"},Me={class:"detail-tab-elem"},Ne={class:"detail-tab-elem"},xe={class:"detail-tab-elem"},ze={class:"detail-tab-elem"},qe={key:2,class:"table-tab"},Je={key:0,class:"tab-search-field"},Ue={key:1,class:"tab-list-inner"},Fe={class:"table-tab-table-outer"},Re={class:"table-tab-table-inner"},He={class:"tab-pagination"},Qe=["disabled"],Ke=["disabled"],We={key:2},Xe={key:3,class:"tab-menu minibutton-group"},Ye={key:3,class:"table-tab"},Ze={key:0},et={key:0,class:"table-tab-table-outer"},tt={class:"table-tab-table-inner"},ot={key:0},st={class:"table-tab-menu"},nt=["onClick"],at={key:1,class:"modal-overlay"},ct={class:"modal"},lt={class:"modal-header"},rt={class:"modal-header-h2"},it={class:"minibutton-group modal-menu"},ut={key:1},dt={key:1},bt={key:4,class:"table-tab"},mt={key:5,class:"table-tab"},pt={key:1,class:"none-card"},gt={key:1,class:"loading"},_t={key:1,class:"loading"},C=10,kt={__name:"AccountGroupDetail",setup(vt){const g=R(),_=W(),V=v(!1),e=F({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewAccountGroup:!1,canEditAccountGroup:!1,canDeleteAccountGroup:!1,canViewAccount:!1,canViewAccountIds:[],canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canAddAccountGroupGenerator:!1,canViewAccountGroupGenerator:!1,canEditAccountGroupGenerator:!1}),G=async()=>{const c=g.params.id;let t=localStorage.getItem("access_token");const l=j(t);t&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const s=await A.get(`${y}/account_groups/${c}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные группы:",s.data),e.object=s.data}catch(s){console.error("Ошибка при получении данных группы:",s)}},h=v(!1),B=()=>{h.value=!0},L=()=>{h.value=!1},M=async()=>{let c=localStorage.getItem("access_token");const t=j(c);if(c&&!t){_.push({name:"Login"});return}const l=g.params.id;try{await A.delete(`${y}/account_groups/${l}/`,{headers:{Authorization:`Bearer ${c}`}}),L(),_.push({name:"AccountGroupList"})}catch(s){console.error("Ошибка удаления группы:",s)}},b=v(""),m=v(1),P=k(()=>b.value?e.object.user_set.filter(c=>c.first_name.toLowerCase().includes(b.value.toLowerCase())||c.last_name.toLowerCase().includes(b.value.toLowerCase())||c.username.toLowerCase().includes(b.value.toLowerCase())):e.object.user_set),S=k(()=>Math.ceil(P.value.length/C)),N=k(()=>{const c=(m.value-1)*C,t=c+C;return P.value.slice(c,t)});$(b,()=>{m.value=1});const x=async()=>{if(!validateForm()){console.error("Форма содержит ошибки:",errors);return}let c=localStorage.getItem("access_token");const t=j(c);if(c&&!t){_.push({name:"Login"});return}try{console.log("Отправляем данные для создания запроса:",form);const l={frontend_url:frontendUrl};console.log("JSON данные перед отправкой:",l);const s=await A.post(`${y}/provide_access_group/${e.object.id}/`,l,{headers:{Authorization:`Bearer ${c}`}});console.log("Запрос создан:",s.data)}catch(l){l.response&&l.response.data?(Object.assign(errors,l.response.data),console.error("Ошибка при создании запроса:",l.response.data)):console.error("Ошибка при создании запроса:",l.message)}},z=async()=>{console.log("Проверяем версию прав");const c=JSON.parse(localStorage.getItem("userPermissions"));if(!(c!=null&&c.permissions_version))return;console.log("Текущая версия прав:",c.permissions_version);let t=localStorage.getItem("access_token");const l=j(t);if(!(!t||!l))try{(await A.get(`${y}/user_permissions_version/${c.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(s){console.error("Ошибка проверки версии прав:",s),localStorage.removeItem("userPermissions")}},q=async()=>{let c=localStorage.getItem("access_token");const t=j(c);c&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),c=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!t&&l.user_id!==1||t&&t.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const p=await A.get(`${y}/user_permissions/`,{headers:{...c&&{Authorization:`Bearer ${c}`}}});console.log("Разрешения пользователя загружены:",p.data),l=p.data,localStorage.setItem("userPermissions",JSON.stringify(l))}e.globalPermissionsList=l.global_permissions||[],e.objectPermissionsDict=l.object_permissions||{};const s=g.params.id;console.log("ID объекта:",s),e.canViewAccountGroup=e.globalPermissionsList.includes("core.view_accounts_group")||e.objectPermissionsDict["core.view_accounts_group"]&&e.objectPermissionsDict["core.view_accounts_group"].includes(Number(s)),console.log("Права на просмотр групп:",e.canViewAccountGroup),e.canEditAccountGroup=e.globalPermissionsList.includes("core.change_accounts_group")||Array.isArray(e.objectPermissionsDict["core.change_accounts_group"])&&e.objectPermissionsDict["core.change_accounts_group"].includes(Number(s)),console.log("Права на редактирование групп:",e.canEditAccountGroup),e.canDeleteAccountGroup=e.globalPermissionsList.includes("core.delete_accounts_group")||Array.isArray(e.objectPermissionsDict["core.delete_accounts_group"])&&e.objectPermissionsDict["core.delete_accounts_group"].includes(Number(s)),console.log("Права на удаление групп:",e.canDeleteAccountGroup),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.canAddAccountGroupGenerator=e.globalPermissionsList.includes("core.add_group_generator")&&e.object.type=="custom",console.log("Права на добавление генератора группы:",e.canAddAccountGroupGenerator),e.canViewAccountGroupGenerator=e.globalPermissionsList.includes("core.view_group_generator"),console.log("Права на просмотр генератора группы:",e.canViewAccountGroupGenerator),e.canEditAccountGroupGenerator=e.globalPermissionsList.includes("core.change_group_generator")&&e.object.type=="custom",console.log("Права на изменение генератора группы:",e.canEditAccountGroupGenerator),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission)}catch(l){console.error("Ошибка при загрузке разрешений пользователя:",l)}},J=()=>{Y(_)},U=k(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},{name:"accounts",label:"Аккаунты"},e.canViewAccountsGroupObjectPermission?{name:"selfObjectPermissions",label:"Объектные права группы"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),d=v(g.query.tab||localStorage.getItem(`activeAccountGroupTab-${g.params.id}`)||"desc");return $(d,c=>{localStorage.setItem(`activeAccountGroupTab-${g.params.id}`,c),_.push({query:{tab:c}}),console.log("Загружен таб:",c)}),H(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await G(),await z(),await q(),V.value=!0}catch(c){console.error("Ошибка при загрузке данных:",c)}}),(c,t)=>{const l=X("router-link");return V.value?(n(),a("div",oe,[e.canViewAccountGroup?(n(),a("div",se,[e.object.id?(n(),a("div",ne,[o("div",ae,[o("div",ce,[o("div",le,[o("div",re,[o("h1",null,r(e.object.name||"Безымянная группа"),1)])]),o("div",ie,[o("div",ue,[t[6]||(t[6]=o("span",{class:"detail-card-text-label"},"Тип:",-1)),u(" "+r(e.object.type_display||"Нет типа"),1)]),o("div",de,[t[7]||(t[7]=o("span",{class:"detail-card-text-label"},"Категории:",-1)),u(" "+r(e.object.categories.length>0?e.object.categories.map(s=>s.name).join(", "):"Нет категорий"),1)]),e.object.type==="custom"?(n(),a("div",be,[t[8]||(t[8]=o("span",{class:"detail-card-text-label"},"Аккаунты добавлены:",-1)),u(" "+r(e.object.generator_group?"Да":"Нет"),1)])):i("",!0)]),o("div",me,[e.canEditAccountGroup?(n(),a("button",{key:0,onClick:x,class:"button"}," Отправить приглашение ")):i("",!0),e.canEditAccountGroup?(n(),f(l,{key:1,to:{name:"AccountGroupEdit",params:{id:e.object.id}},class:"button"},{default:O(()=>[...t[9]||(t[9]=[u(" Изменить ",-1)])]),_:1},8,["to"])):i("",!0),e.canDeleteAccountGroup?(n(),a("button",{key:2,onClick:B,class:"button"}," Удалить ")):i("",!0),o("button",{type:"button",onClick:J,class:"button"},"Назад")]),h.value?(n(),a("div",pe,[o("div",ge,[o("div",_e,[o("h2",ve,"Удаление "+r(e.object.name||"Безымянная группы"),1)]),o("div",je,[o("button",{onClick:t[0]||(t[0]=s=>M()),class:"minibutton"},"Подтвердить"),o("button",{onClick:L,class:"minibutton"},"Отменить")])])])):i("",!0)])]),o("div",Ae,[o("div",ye,[(n(!0),a(w,null,D(U.value,s=>(n(),a("button",{key:s.name,class:Z([{active:d.value===s.name},"tab-button"]),onClick:p=>d.value=s.name},r(s.label),11,ke))),128))]),d.value?(n(),a("div",Ge,[d.value==="desc"?(n(),a("div",he,[e.object.desc?(n(),a("div",Pe,r(e.object.desc),1)):(n(),a("div",fe,[...t[10]||(t[10]=[o("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):i("",!0),d.value==="details"?(n(),a("div",Oe,[o("div",we,[t[11]||(t[11]=o("span",{class:"detail-tab-label"},"Тип:",-1)),u(" "+r(e.object.type_display||"Нет типа"),1)]),o("div",De,[t[12]||(t[12]=o("span",{class:"detail-tab-label"},"Категории:",-1)),u(" "+r(e.object.categories.length>0?e.object.categories.map(s=>s.name).join(", "):"Нет категорий"),1)]),o("div",Ce,[t[13]||(t[13]=o("span",{class:"detail-tab-label"},"Права:",-1)),u(" "+r(e.object.permissions.length>0?e.object.permissions.map(s=>s.name).join(", "):"Нет прав"),1)]),e.object.type==="custom"?(n(),a("div",Ve,[t[14]||(t[14]=o("span",{class:"detail-tab-label"},"Аккаунты добавлены:",-1)),u(" "+r(e.object.generator_group?"Да":"Нет"),1)])):i("",!0),e.object.generator_group?(n(),a("div",Le,[t[15]||(t[15]=o("span",{class:"detail-tab-label"},"Добавляемые аккунты:",-1)),u(" "+r(e.object.generator_group.added_users.length>0?e.object.generator_group.added_users.map(s=>s.str).join(", "):"Нет аккаунтов"),1)])):i("",!0),e.object.generator_group?(n(),a("div",Se,[t[16]||(t[16]=o("span",{class:"detail-tab-label"},"Исключаемые аккунты:",-1)),u(" "+r(e.object.generator_group.excluded_users.length>0?e.object.generator_group.excluded_users.map(s=>s.str).join(", "):"Нет аккаунтов"),1)])):i("",!0),e.object.generator_group?(n(),a("div",$e,[t[17]||(t[17]=o("span",{class:"detail-tab-label"},"Добавляемые группы:",-1)),u(" "+r(e.object.generator_group.added_groups.length>0?e.object.generator_group.added_groups.map(s=>s.name).join(", "):"Нет групп"),1)])):i("",!0),e.object.generator_group?(n(),a("div",Ie,[t[18]||(t[18]=o("span",{class:"detail-tab-label"},"Исключаемые группы:",-1)),u(" "+r(e.object.generator_group.excluded_groups.length>0?e.object.generator_group.excluded_groups.map(s=>s.name).join(", "):"Нет групп"),1)])):i("",!0),e.object.generator_group?(n(),a("div",Ee,[t[19]||(t[19]=o("span",{class:"detail-tab-label"},"Отработано от (дней):",-1)),u(" "+r(e.object.generator_group.days_worked_gte?e.object.generator_group.days_worked_gte:"Не указано"),1)])):i("",!0),e.object.generator_group?(n(),a("div",Te,[t[20]||(t[20]=o("span",{class:"detail-tab-label"},"Отработано до (дней):",-1)),u(" "+r(e.object.generator_group.days_worked_lte?e.object.generator_group.days_worked_lte:"Не указано"),1)])):i("",!0),e.object.generator_group?(n(),a("div",Be,[t[21]||(t[21]=o("span",{class:"detail-tab-label"},"Автообновление:",-1)),u(" "+r(e.object.generator_group.autoupdate?"Да":"Нет"),1)])):i("",!0),o("div",Me,[t[22]||(t[22]=o("span",{class:"detail-tab-label"},"Создан:",-1)),u(" "+r(e.object.created?I(E)(e.object.created):"Нет данных о создании"),1)]),o("div",Ne,[t[23]||(t[23]=o("span",{class:"detail-tab-label"},"Создатель:",-1)),u(" "+r(e.object.creator?e.object.creator:"Нет создателя"),1)]),o("div",xe,[t[24]||(t[24]=o("span",{class:"detail-tab-label"},"Изменён:",-1)),u(" "+r(e.object.changed?I(E)(e.object.changed):"Нет данных об изменениях"),1)]),o("div",ze,[t[25]||(t[25]=o("span",{class:"detail-tab-label"},"Редактор:",-1)),u(" "+r(e.object.editor?e.object.editor:"Нет редактора"),1)])])):i("",!0),d.value==="accounts"?(n(),a("div",qe,[e.object.user_set&&e.object.user_set.length>0?(n(),a("div",Je,[Q(o("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>b.value=s),type:"text",placeholder:"Поиск",class:"tab-search-input"},null,512),[[K,b.value]])])):i("",!0),P.value.length>0?(n(),a("div",Ue,[o("div",Fe,[o("div",Re,[o("table",null,[t[26]||(t[26]=o("thead",null,[o("tr",null,[o("th",null,"Имя пользователя"),o("th",null,"Личные данные")])],-1)),o("tbody",null,[(n(!0),a(w,null,D(N.value,s=>(n(),a("tr",{key:s.id},[o("td",null,r(s.username||"Нет данных"),1),o("td",null,r(s.str||"Нет данных"),1)]))),128))])])])]),o("div",He,[o("button",{disabled:m.value===1,onClick:t[2]||(t[2]=s=>m.value--),class:"tab-settings-button"}," Назад ",8,Qe),o("span",null,"Страница "+r(m.value)+" из "+r(S.value),1),o("button",{disabled:m.value===S.value,onClick:t[3]||(t[3]=s=>m.value++),class:"tab-settings-button"}," Вперед ",8,Ke)])])):(n(),a("div",We,[...t[27]||(t[27]=[o("div",{class:"none-border"},"Нет аккаунтов",-1)])])),e.canAddAccountGroupGenerator||e.canEditAccountGroupGenerator?(n(),a("div",Xe,[e.canAddAccountGroupGenerator&&!e.object.generator_group?(n(),f(l,{key:0,to:{name:"CreateAccountGroupGenerator",query:{groupId:e.object.id}},class:"minibutton"},{default:O(()=>[...t[28]||(t[28]=[u(" Добавить ",-1)])]),_:1},8,["to"])):i("",!0),e.canEditAccountGroupGenerator&&e.object.generator_group?(n(),f(l,{key:1,to:{name:"AccountGroupGeneratorEdit",params:{id:e.object.generator_group.id},query:{groupId:e.object.id}},class:"minibutton"},{default:O(()=>[...t[29]||(t[29]=[u(" Изменить ",-1)])]),_:1},8,["to"])):i("",!0)])):i("",!0)])):i("",!0),d.value==="selfObjectPermissions"?(n(),a("div",Ye,[e.canViewAccountsGroupObjectPermission?(n(),a("div",Ze,[e.object.self_object_permissions&&e.object.self_object_permissions.length>0?(n(),a("div",et,[o("div",tt,[o("table",null,[t[30]||(t[30]=o("thead",null,[o("tr",null,[o("th",null,"Владелец"),o("th",null,"Право"),o("th",null,"Тип контента"),o("th",null,"Объект"),o("th",null,"Действия")])],-1)),o("tbody",null,[(n(!0),a(w,null,D(e.object.self_object_permissions,s=>(n(),a("tr",{key:s.id},[o("td",null,r(s.group.name?s.group.name:"Нет данных"),1),o("td",null,r(s.permission.name?s.permission.name:"Нет данных"),1),o("td",null,r(s.permission.content_type.str?s.permission.content_type.str:"Нет данных"),1),o("td",null,r(s.content_object?s.content_object:"Нет данных"),1),o("td",null,[e.canDeleteAccountsGroupObjectPermission?(n(),a("div",ot,[o("div",st,[e.canDeleteAccountsGroupObjectPermission?(n(),a("button",{key:0,onClick:p=>c.openAccountsGroupObjectPermissionDeleteModal(s),class:"table-tab-button"}," Удалить ",8,nt)):i("",!0),c.showAccountsGroupObjectPermissionDeleteModal?(n(),a("div",at,[o("div",ct,[o("div",lt,[o("h2",rt,"Удаление "+r(c.selectedAccountsGroupObjectPermission.content_object||"Объектное право без пользователя")+" "+r(c.selectedAccountsGroupObjectPermission.permission.name||"Безымянное объектное право"),1)]),o("div",it,[o("button",{onClick:t[4]||(t[4]=p=>c.confirmAccountsGroupObjectPermissionDelete(c.selectedAccountsGroupObjectPermission.id)),class:"minibutton"},"Подтвердить"),o("button",{onClick:t[5]||(t[5]=(...p)=>c.closeAccountsGroupObjectPermissionDeleteModal&&c.closeAccountsGroupObjectPermissionDeleteModal(...p)),class:"minibutton"},"Отменить")])])])):i("",!0)])])):(n(),a("div",ut," - "))])]))),128))])])])])):(n(),a("div",dt,[...t[31]||(t[31]=[o("div",{class:"none-border"},"Нет объектных прав",-1)])]))])):i("",!0)])):i("",!0),d.value==="accountsGroupObjectPermissions"?(n(),a("div",bt,[T(ee,{state:e,fetchObject:G,contentTypeModel:"accountsgroup"},null,8,["state"])])):i("",!0),d.value==="accountObjectPermissions"?(n(),a("div",mt,[T(te,{state:e,fetchObject:G,contentTypeModel:"accountsgroup"},null,8,["state"])])):i("",!0)])):i("",!0)])])):e.object.id?i("",!0):(n(),a("div",pt,[...t[32]||(t[32]=[o("div",null,"Объект не найден",-1)])]))])):(n(),a("div",gt,[...t[33]||(t[33]=[o("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),a("div",_t,[...t[34]||(t[34]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{kt as default};
