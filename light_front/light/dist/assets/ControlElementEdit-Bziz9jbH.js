import{r as v,a as j,k as N,A as R,B as q,o as F,c as r,d as o,b,f as h,C as c,t as T,p as $,y as J,w as _,v as O,n as G,i as y,u as H,h as g,j as w,l as n}from"./index-_TMNgkFu.js";import{s as x}from"./custom-multiselect-M3BzxD5H.js";const K={key:0},P={key:0,class:"form-page"},Q={class:"form-field"},W={key:0,class:"error"},X={class:"form-field"},Y={key:0,class:"form-field"},Z={key:0,class:"error"},ee={class:"form-field"},te={key:0,class:"error"},se={class:"form-field"},oe={class:"form-field"},ae={key:1,class:"none-card"},le={key:1,class:"loading"},de={__name:"ControlElementEdit",setup(re){const p=N(),i=H(),d=v(null),s=j({type_of_work:"",repeat:!1,task_template:null,name:"",categories:[],desc:""}),C=v(!1),B=[{label:"Итог задачи",value:"task_outcome"},{label:"Триггер",value:"trigger"}],m=v([]),S=async()=>{let a=localStorage.getItem("access_token");const e=y(a);if(a&&!e){i.push({name:"Login"});return}try{const t=await g.get(`${w}/task_templates/`,{headers:{Authorization:`Bearer ${a}`}});m.value=t.data.results||[],console.log("Шаблоны задач загружены:",m.value)}catch(t){console.error("Ошибка при загрузке шаблонов задач:",t.response?t.response.data:t.message)}},I=p.query.taskId||"",V=v([]),U=async()=>{let a=localStorage.getItem("access_token");const e=y(a);if(a&&!e){i.push({name:"Login"});return}try{const t=await g.get(`${w}/categories/`,{headers:{Authorization:`Bearer ${a}`}});V.value=t.data.results||[],console.log("Категории загружены:",V.value)}catch(t){console.error("Ошибка при загрузке категорий:",t.response?t.response.data:t.message)}},A=async()=>{var f;const a=p.params.id;let e=localStorage.getItem("access_token");const t=y(e);if(e&&!t){i.push({name:"Login"});return}try{const u=await g.get(`${w}/control_elements/${a}/`,{headers:{Authorization:`Bearer ${e}`}});d.value=u.data,console.log("Объект успешно загружен:",d.value),d.value.type_of_work=B.find(k=>k.value===d.value.type_of_work),console.log("Объект нормализован:",d.value),Object.assign(s,d.value)}catch(u){console.error("Ошибка загрузки объекта:",((f=u.response)==null?void 0:f.data)||u.message)}},D=R(()=>{var a;return((a=s.type_of_work)==null?void 0:a.value)==="task_outcome"?m.value.filter(e=>e.task_outcome==!0):m.value});q(()=>s.type_of_work,a=>{a.value!="task_outcome"&&(s.task_outcome=null)});const l=j({}),E=()=>(l.type_of_work=s.type_of_work.value?"":"Тип работы обязателен!",s.type_of_work.value=="task_outcome"&&(l.task_template=s.task_template?"":"Выбор шаблона задачи обязателен!"),Object.values(l).every(a=>!a)),z=async()=>{var a;if(!E()){console.error("Форма содержит ошибки:",l);return}try{const e=p.params.id;let t=localStorage.getItem("access_token");const f=y(t);if(t&&!f){i.push({name:"Login"});return}const u={type_of_work:s.type_of_work.value,repeat:s.repeat,task_template:(a=s.task_template)==null?void 0:a.id,name:s.name,categories:s.categories.map(M=>M.id),desc:s.desc};console.log("JSON данные перед отправкой:",u),await g.patch(`${w}/control_elements/${e}/`,u,{headers:{Authorization:`Bearer ${t}`}}),console.log("Данные обновлены");const k=p.query.taskId||"";k?i.push({name:"TaskTemplateDetail",params:{id:k}}):i.push({name:"ControlElementDetail",params:{id:e}})}catch(e){e.response&&e.response.data?(Object.assign(l,e.response.data),console.error("Ошибка при сохранении изменений:",e.response.data)):console.error("Ошибка при сохранении изменений:",e.message)}},L=()=>{i.back()};return F(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await S(),await U(),await A(),C.value=!0}catch(a){console.error("Ошибка при загрузке данных:",a)}}),(a,e)=>C.value?(n(),r("div",K,[d.value?(n(),r("div",P,[e[17]||(e[17]=o("div",{class:"form-header"},[o("h1",null,"Редактирование управляющих элементов")],-1)),o("form",{onSubmit:G(z,["prevent"]),class:"form",id:"edit-form"},[o("div",Q,[e[6]||(e[6]=o("label",{class:"form-label"},"Тип работы:",-1)),h(c(x),{modelValue:s.type_of_work,"onUpdate:modelValue":e[0]||(e[0]=t=>s.type_of_work=t),options:B,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип работы",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!c(I)},null,8,["modelValue","disabled"]),l.type_of_work?(n(),r("span",W,T(l.type_of_work),1)):b("",!0)]),o("div",X,[e[7]||(e[7]=o("label",{for:"repeat",class:"form-label"},"Многократное срабатывание:",-1)),$(o("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>s.repeat=t),id:"repeat",type:"checkbox",class:"form-input"},null,512),[[J,s.repeat]])]),s.type_of_work.value=="task_outcome"?(n(),r("div",Y,[e[10]||(e[10]=o("label",{class:"form-label"},"Шаблон задачи:",-1)),h(c(x),{modelValue:s.task_template,"onUpdate:modelValue":e[2]||(e[2]=t=>s.task_template=t),options:D.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!c(I)},{noOptions:_(()=>[...e[8]||(e[8]=[o("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[9]||(e[9]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options","disabled"]),l.task_template?(n(),r("span",Z,T(l.task_template),1)):b("",!0)])):b("",!0),o("div",ee,[e[11]||(e[11]=o("label",{for:"name",class:"form-label"},"Название:",-1)),$(o("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>s.name=t),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[O,s.name]]),l.name?(n(),r("span",te,T(l.name),1)):b("",!0)]),o("div",se,[e[14]||(e[14]=o("label",{class:"form-label"},"Категории:",-1)),h(c(x),{modelValue:s.categories,"onUpdate:modelValue":e[4]||(e[4]=t=>s.categories=t),options:V.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:_(()=>[...e[12]||(e[12]=[o("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[13]||(e[13]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",oe,[e[15]||(e[15]=o("label",{for:"desc",class:"form-label"},"Описание:",-1)),$(o("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>s.desc=t),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[O,s.desc]])])],32),o("div",{class:"form-menu button-group"},[e[16]||(e[16]=o("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),o("button",{type:"button",onClick:L,class:"button"},"Отмена")])])):(n(),r("div",ae,[...e[18]||(e[18]=[o("div",null,"Объект не найден",-1)])]))])):(n(),r("div",le,[...e[19]||(e[19]=[o("div",null,"Загрузка данных...",-1)])]))}};export{de as default};
