import{a as M,r as v,k as se,o as te,c as n,d as s,b as k,p as le,v as ae,f as b,w as m,C as R,n as oe,F as ne,E as ie,t as y,e as re,i as S,h as T,j as w,u as ce,g as G,l as o,m as d}from"./index-C7lVKHoT.js";import{s as H}from"./custom-multiselect-CXprvWzB.js";const de={key:0},ue={key:0,class:"list-page"},ge={class:"filters-inner"},ve={class:"filters-field"},me={class:"filters-field"},pe={class:"filters-field"},fe={class:"filters-menu button-group"},_e={key:1,class:"list-items"},ke={class:"list-grid"},be={class:"list-card-image-outer"},ye={key:0,class:"list-card-image-inner"},Se=["src"],Te={key:1,class:"list-card-image-none"},we={class:"list-card-icons"},Pe={key:0,class:"list-card-icon-grey"},Ie={key:1,class:"list-card-icon-progress"},he={key:2,class:"list-card-icon-progress"},Ee={key:3,class:"list-card-icon-progress"},Ve={key:4,class:"list-card-icon-completed"},Ce={key:5,class:"list-card-icon-attention"},$e={key:6,class:"list-card-icon-grey"},xe={key:7,class:"list-card-icon-grey"},je={class:"list-card-header"},qe={class:"list-card-header-title"},Fe={class:"list-card-text"},Ne={class:"list-card-text-elem"},Oe={class:"list-card-menu minibutton-group"},Ae={class:"list-pagination"},Le=["disabled"],Be=["disabled"],De={key:2,class:"none-card"},ze={key:3,class:"list-menu button-group"},Je={key:1,class:"loading"},Ue={key:1,class:"loading"},He={__name:"EventTemplateList",setup(Me){const g=se(),P=ce(),i=M({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddEventTemplate:!1,canViewEventTemplate:!1}),C=v(!1),I=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"}],h=v([]),K=async()=>{let t=localStorage.getItem("access_token");const e=S(t);t&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const a=await T.get(`${w}/categories/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});h.value=a.data.results||[],console.log("Категории загружены:",h.value)}catch(a){console.error("Ошибка при загрузке категорий:",a.response?a.response.data:a.message)}},c=M({name:g.query.name||"",categories:g.query.categories?g.query.categories.map(t=>({id:parseInt(t,10)})):[],order:I.find(t=>t.value===g.query.order||"name")}),Q=()=>{const t=localStorage.getItem("eventTemplateFilters");t&&(console.log("Загруженные фильры:",t),Object.assign(c,JSON.parse(t)))},r=v(Number(g.query.page)||1),E=v(1),W=()=>{const t=localStorage.getItem("eventTemplatePage");t&&(console.log("Загруженная странциа:",t),r.value=parseInt(t,10))},p=async(t,e)=>{console.log("Загрузка шаблонов с фильтрами:",t,"для страницы:",e);let a=localStorage.getItem("access_token");const u=S(a);a&&!u&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),a=null),P.push({name:"EventTemplateList",query:{name:t.name||"",categories:t.categories.map(l=>l.id)||[],order:t.order.value,page:r.value}}),localStorage.setItem("eventTemplateFilters",JSON.stringify(t));try{const l=await T.get(`${w}/event_templates/`,{headers:{...a&&{Authorization:`Bearer ${a}`}},params:{page:e,page_size:12,name:t.name,categories:t.categories.map(_=>_.id),ordering:t.order.value}});console.log("Список шаблонов загружен:",l.data),i.items=l.data.results,E.value=Math.ceil(l.data.count/12)}catch(l){console.error("Ошибка при загрузке списка шаблонов:",l)}},$=t=>{console.log("Смена страницы на:",t),r.value=t,P.push({name:"EventTemplateList",query:{...g.query,page:r.value}}),localStorage.setItem("eventTemplatePage",r.value),p(c,t)},f=v(!1),V=()=>{f.value=!f.value,console.log("Текущий статус показа фильтров:",f.value)},X=()=>{console.log("Сбрасываем фильтры"),c.name="",c.categories=[],c.order=I.find(t=>t.value==="name"),localStorage.removeItem("eventTemplateFilters"),localStorage.removeItem("eventTemplatePage"),r.value=1,P.push({name:"EventTemplateList",query:{name:"",categories:[],page:r.value}}),p(c,r.value)},Y=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let e=localStorage.getItem("access_token");const a=S(e);if(!(!e||!a))try{(await T.get(`${w}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(u){console.error("Ошибка проверки версии прав:",u),localStorage.removeItem("userPermissions")}},Z=async()=>{let t=localStorage.getItem("access_token");const e=S(t);t&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{let a=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",a),Object.keys(a).length>0&&(console.log("ID пользователя в разрешениях из памяти:",a.user_id),!e&&a.user_id!==1||e&&e.user_id!==a.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),a={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(a).length===0){const u=await T.get(`${w}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",u.data),a=u.data,localStorage.setItem("userPermissions",JSON.stringify(a))}i.globalPermissionsList=a.global_permissions||[],i.objectPermissionsDict=a.object_permissions||{},i.canAddEventTemplate=i.globalPermissionsList.includes("events.add_event_template"),console.log("Права на добавление шаблонов:",i.canAddEventTemplate),i.canViewEventTemplate=i.globalPermissionsList.includes("events.view_event_template")||!!i.objectPermissionsDict["events.view_event_template"],console.log("Права на просмотр шаблонов:",i.canViewEventTemplate)}catch(a){console.error("Ошибка при получении разрешений пользователя:",a)}};return te(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await Q(),await W(),await K(),await Y(),await Z(),await p(c,r.value),C.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,e)=>{const a=G("spa"),u=G("router-link");return C.value?(o(),n("div",de,[i.canViewEventTemplate?(o(),n("div",ue,[e[25]||(e[25]=s("div",{class:"list-header"},[s("h1",null,"Мероприятия")],-1)),s("div",{class:"list-settings"},[s("button",{onClick:V,class:"list-settings-button"}," Параметры ")]),f.value?(o(),n("div",{key:0,class:"filters-overlay",onClick:V},[s("div",{class:"filters-outer",onClick:e[4]||(e[4]=oe(()=>{},["stop"]))},[s("div",{class:"filters-close_button-inner"},[s("button",{onClick:V,class:"filters-close_button"}," × ")]),s("div",ge,[s("div",ve,[e[7]||(e[7]=s("label",{class:"filters-label"},"Название:",-1)),le(s("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>c.name=l),class:"filters-input",placeholder:"Введите название"},null,512),[[ae,c.name]])]),s("div",me,[e[10]||(e[10]=s("label",{class:"filters-label"},"Категории:",-1)),b(R(H),{modelValue:c.categories,"onUpdate:modelValue":e[1]||(e[1]=l=>c.categories=l),options:h.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:m(()=>[...e[8]||(e[8]=[s("span",null,"Список пуст",-1)])]),noResult:m(()=>[...e[9]||(e[9]=[s("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),s("div",pe,[e[11]||(e[11]=s("label",{class:"filters-label"},"Сортировка:",-1)),b(R(H),{modelValue:c.order,"onUpdate:modelValue":e[2]||(e[2]=l=>c.order=l),options:I,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),s("div",fe,[s("button",{onClick:e[3]||(e[3]=l=>p(c,r.value.value)),class:"button"},"Применить"),s("button",{onClick:X,class:"button"},"Сбросить")])])])):k("",!0),i.items.length!==0?(o(),n("div",_e,[s("div",ke,[(o(!0),n(ne,null,ie(i.items,l=>{var _,x,j,q,F,N,O,A,L,B,D,z,J,U;return o(),n("div",{key:l.id,class:"list-card"},[s("div",be,[l.avatar?(o(),n("div",ye,[s("img",{src:l.avatar,alt:"Аватар"},null,8,Se)])):(o(),n("div",Te,[b(a,{class:"none-text"},{default:m(()=>[...e[12]||(e[12]=[d("Нет аватара",-1)])]),_:1})]))]),s("div",we,[((x=(_=l.last_task)==null?void 0:_.result)==null?void 0:x.status)=="waiting"?(o(),n("div",Pe,[...e[13]||(e[13]=[s("span",{class:"list-card-icon"},[s("i",{class:"fa-solid fa-lock"})],-1),d(" В ожидании ",-1)])])):((q=(j=l.last_task)==null?void 0:j.result)==null?void 0:q.status)=="assigned"?(o(),n("div",Ie,[...e[14]||(e[14]=[s("span",{class:"list-card-icon"},[s("i",{class:"fa-solid fa-thumbtack"})],-1),d(" Назначено ",-1)])])):((N=(F=l.last_task)==null?void 0:F.result)==null?void 0:N.status)=="in_progress"?(o(),n("div",he,[...e[15]||(e[15]=[s("span",{class:"list-card-icon"},[s("i",{class:"fa-solid fa-hourglass-half"})],-1),d(" В процессе ",-1)])])):((A=(O=l.last_task)==null?void 0:O.result)==null?void 0:A.status)=="under_review"?(o(),n("div",Ee,[...e[16]||(e[16]=[s("span",{class:"list-card-icon"},[s("i",{class:"fa-solid fa-magnifying-glass"})],-1),d(" На проверке ",-1)])])):((B=(L=l.last_task)==null?void 0:L.result)==null?void 0:B.status)=="completed"?(o(),n("div",Ve,[...e[17]||(e[17]=[s("span",{class:"list-card-icon"},[s("i",{class:"fa-solid fa-circle-check"})],-1),d(" Выполнено ",-1)])])):((z=(D=l.last_task)==null?void 0:D.result)==null?void 0:z.status)=="failed"?(o(),n("div",Ce,[...e[18]||(e[18]=[s("span",{class:"list-card-icon"},[s("i",{class:"fa-solid fa-circle-xmark"})],-1),d(" Провалено ",-1)])])):((U=(J=l.last_task)==null?void 0:J.result)==null?void 0:U.status)=="canceled"?(o(),n("div",$e,[...e[19]||(e[19]=[s("span",{class:"list-card-icon"},[s("i",{class:"fa-solid fa-ban"})],-1),d(" Отменено ",-1)])])):l.last_task?k("",!0):(o(),n("div",xe,[...e[20]||(e[20]=[s("span",{class:"list-card-icon"},[s("i",{class:"fa-solid fa-ban"})],-1),d(" Не назначено ",-1)])]))]),s("div",je,[s("div",qe,[s("h2",null,y(l.name||"Нет названия"),1)])]),s("div",Fe,[s("div",Ne,[e[21]||(e[21]=s("span",{class:"list-card-text-label"},"Категории:",-1)),d(" "+y(l.categories.length>0?l.categories.map(ee=>ee.name).join(", "):"Нет категорий"),1)])]),s("div",Oe,[b(u,{to:{name:"EventTemplateDetail",params:{id:l.id},query:{tab:"details"}},class:"minibutton"},{default:m(()=>[...e[22]||(e[22]=[d(" Подробнее ",-1)])]),_:1},8,["to"])])])}),128))]),s("div",Ae,[s("button",{disabled:r.value===1,onClick:e[5]||(e[5]=l=>$(r.value-1)),class:"list-settings-button"}," Назад ",8,Le),s("span",null,"Страница "+y(r.value)+" из "+y(E.value),1),s("button",{disabled:r.value===E.value,onClick:e[6]||(e[6]=l=>$(r.value+1)),class:"list-settings-button"}," Вперед ",8,Be)])])):(o(),n("div",De,[...e[23]||(e[23]=[s("div",null,"Список пуст",-1)])])),i.canAddEventTemplate?(o(),n("div",ze,[i.canAddEventTemplate?(o(),re(u,{key:0,to:{name:"EventTemplateCreate"},class:"button"},{default:m(()=>[...e[24]||(e[24]=[d(" Создать ",-1)])]),_:1})):k("",!0)])):k("",!0)])):(o(),n("div",Je,[...e[26]||(e[26]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),n("div",Ue,[...e[27]||(e[27]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{He as default};
