import{r as y,a as j,o as P,c as r,b as p,d as n,t as w,k as S,i as l,u as I,h as d,j as u,l as i}from"./index-C7lVKHoT.js";const $={key:0},C={key:0,class:"detail-page"},B={key:0},L={class:"detail-card"},T={class:"detail-card-info"},N={class:"detail-header"},O={class:"detail-header-title"},x={class:"material-content"},D=["innerHTML"],z={class:"detail-menu button-group"},A={key:1,class:"none-container"},V={key:1,class:"loading"},J={key:1,class:"loading"},H={__name:"NewContent",setup(M){const m=S(),c=I(),g=y(!1),s=j({object:null,globalPermissionsList:[],objectPermissionsDict:{},canPerform:!1,canCompleted:!1}),k=async()=>{const t=m.params.id;let e=localStorage.getItem("access_token");const o=l(e);if(e&&!o){c.push({name:"Login"});return}try{const a=await d.get(`${u}/new_content/${t}/`,{headers:{...e&&{Authorization:`Bearer ${e}`}}});console.log("Данные результата:",a.data),s.object=a.data}catch(a){console.error("Ошибка при получении данных результата:",a)}},v=()=>{c.back()},b=async()=>{const t=m.params.id;let e=localStorage.getItem("access_token");const o=l(e);if(e&&!o){c.push({name:"Login"});return}try{const a=await d.patch(`${u}/new_review/${t}/`,{},{headers:{...e&&{Authorization:`Bearer ${e}`}}});console.log("Результат ознакомления:",a.data),s.canCompleted=!1}catch(a){console.error("Ошибка при получении данных результата:",a)}},h=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let e=localStorage.getItem("access_token");const o=l(e);if(!(!e||!o))try{(await d.get(`${u}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(a){console.error("Ошибка проверки версии прав:",a),localStorage.removeItem("userPermissions")}},f=async()=>{let t=localStorage.getItem("access_token");const e=l(t);if(t&&!e){c.push({name:"Login"});return}try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!e&&o.user_id!==1||e&&e.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const _=await d.get(`${u}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",_.data),o=_.data,localStorage.setItem("userPermissions",JSON.stringify(o))}s.globalPermissionsList=o.global_permissions||[],s.objectPermissionsDict=o.object_permissions||{};const a=m.params.id;console.log("ID объекта:",a),s.object.status!="failed"&&s.object.status!="canceled"&&(s.canPerform=s.object.task.executor==e.user_id),console.log("Просмотр результата:",s.canPerform),s.object.status!="completed"&&s.object.status!="failed"&&s.object.status!="canceled"&&(s.canCompleted=s.object.task.executor==e.user_id),console.log("Редактирование результата:",s.canCompleted)}catch(o){console.error("Ошибка при загрузке разрешений пользователя:",o)}};return P(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await k(),await h(),await f(),g.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,e)=>g.value?(i(),r("div",$,[s.canPerform?(i(),r("div",C,[s.object.id?(i(),r("div",B,[n("div",L,[n("div",T,[n("div",N,[n("div",O,[n("h1",null,w(s.object.task.new.name||"Безымянная новость"),1)])]),n("div",x,[n("div",{innerHTML:s.object.task.new.content,class:"tiptap"},null,8,D)]),n("div",z,[s.canCompleted?(i(),r("button",{key:0,onClick:b,class:"button"}," Подтвердить ознакомление ")):p("",!0),n("button",{type:"button",onClick:v,class:"button"},"Назад")]),e[0]||(e[0]=n("div",null,null,-1))])])])):s.object.id?p("",!0):(i(),r("div",A,[...e[1]||(e[1]=[n("div",{class:"none-card"},[n("div",null,"Объект не найден.")],-1)])]))])):(i(),r("div",V,[...e[2]||(e[2]=[n("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),r("div",J,[...e[3]||(e[3]=[n("div",null,"Загрузка данных...",-1)])]))}};export{H as default};
