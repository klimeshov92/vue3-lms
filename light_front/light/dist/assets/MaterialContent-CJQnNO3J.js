import{r as y,a as j,o as P,c as r,b as p,d as a,t as S,k as I,i as l,u as $,h as d,j as u,q as w,l as i}from"./index-Czc3v3Gw.js";const C={key:0},B={key:0,class:"detail-page"},L={key:0},T={class:"detail-card"},O={class:"detail-card-info"},x={class:"detail-header"},D={class:"detail-header-title"},N={class:"material-content"},z=["innerHTML"],A={class:"detail-menu button-group"},M={key:1,class:"none-container"},V={key:1,class:"loading"},J={key:1,class:"loading"},U={__name:"MaterialContent",setup(R){const m=I(),c=$(),g=y(!1),s=j({object:null,globalPermissionsList:[],objectPermissionsDict:{},canPerform:!1,canCompleted:!1}),k=async()=>{const t=m.params.id;let e=localStorage.getItem("access_token");const o=l(e);if(e&&!o){c.push({name:"Login"});return}try{const n=await d.get(`${u}/material_content/${t}/`,{headers:{...e&&{Authorization:`Bearer ${e}`}}});console.log("Данные результата:",n.data),s.object=n.data}catch(n){console.error("Ошибка при получении данных результата:",n)}},v=()=>{w(c)},b=async()=>{const t=m.params.id;let e=localStorage.getItem("access_token");const o=l(e);if(e&&!o){c.push({name:"Login"});return}try{const n=await d.patch(`${u}/material_review/${t}/`,{},{headers:{...e&&{Authorization:`Bearer ${e}`}}});console.log("Результат ознакомления:",n.data),s.canCompleted=!1}catch(n){console.error("Ошибка при получении данных результата:",n)}},h=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let e=localStorage.getItem("access_token");const o=l(e);if(!(!e||!o))try{(await d.get(`${u}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(n){console.error("Ошибка проверки версии прав:",n),localStorage.removeItem("userPermissions")}},f=async()=>{let t=localStorage.getItem("access_token");const e=l(t);if(t&&!e){c.push({name:"Login"});return}try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!e&&o.user_id!==1||e&&e.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const _=await d.get(`${u}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",_.data),o=_.data,localStorage.setItem("userPermissions",JSON.stringify(o))}s.globalPermissionsList=o.global_permissions||[],s.objectPermissionsDict=o.object_permissions||{};const n=m.params.id;console.log("ID объекта:",n),s.object.status!="failed"&&s.object.status!="canceled"&&(s.canPerform=s.object.task.executor==e.user_id),console.log("Просмотр результата:",s.canPerform),s.object.status!="completed"&&s.object.status!="failed"&&s.object.status!="canceled"&&(s.canCompleted=s.object.task.executor==e.user_id),console.log("Редактирование результата:",s.canCompleted)}catch(o){console.error("Ошибка при загрузке разрешений пользователя:",o)}};return P(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await k(),await h(),await f(),g.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,e)=>g.value?(i(),r("div",C,[s.canPerform?(i(),r("div",B,[s.object.id?(i(),r("div",L,[a("div",T,[a("div",O,[a("div",x,[a("div",D,[a("h1",null,S(s.object.task.material.name||"Безымянный материал"),1)])]),a("div",N,[a("div",{innerHTML:s.object.task.material.content,class:"tiptap"},null,8,z)]),a("div",A,[s.canCompleted?(i(),r("button",{key:0,onClick:b,class:"button"}," Подтвердить ознакомление ")):p("",!0),a("button",{type:"button",onClick:v,class:"button"},"Назад")]),e[0]||(e[0]=a("div",null,null,-1))])])])):s.object.id?p("",!0):(i(),r("div",M,[...e[1]||(e[1]=[a("div",{class:"none-card"},[a("div",null,"Объект не найден.")],-1)])]))])):(i(),r("div",V,[...e[2]||(e[2]=[a("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),r("div",J,[...e[3]||(e[3]=[a("div",null,"Загрузка данных...",-1)])]))}};export{U as default};
