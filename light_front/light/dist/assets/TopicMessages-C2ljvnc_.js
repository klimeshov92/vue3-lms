import{k as se,u as oe,r as c,a as P,A as L,B as A,o as ne,Q as ae,c as l,l as r,b as g,d as n,p as le,v as re,F as ie,E as ce,H as de,t as b,f as N,C as ue,G as R,n as ve,i as M,h as w,j as $}from"./index-Bpv6Iqa1.js";import{E as F}from"./EditorComponent-DqOSmE5w.js";const pe={key:0,class:"chat"},ge={key:0,class:"tab-search-field"},me={key:0,class:"messages-list"},he={class:"message-top"},_e={class:"message-title"},fe={class:"message-detail"},be={key:0},ke={key:0,class:"error"},ye=["innerHTML"],Ce={class:"chat-menu-outer"},Me={class:"chat-menu-inner"},we=["onClick"],$e=["onClick"],xe=["onClick"],De=["onClick"],Se={key:0,class:"modal-overlay"},Te={class:"modal"},Ee={class:"modal-header"},Ie={class:"modal-header-h2"},Le={class:"minibutton-group modal-menu"},Be={class:"tab-pagination"},Ve=["disabled"],Oe=["disabled"],je={key:1},Pe={class:"form-field form-field-full_width"},Ae={key:0,class:"error"},Ne={key:1,class:"loading"},x=10,ze={__name:"TopicMessages",props:{topic_id:Number},setup(z){se();const y=oe(),B=c(!1),C=z;console.log("Topic ID:",C.topic_id);const m=c(null),h=c(null),U=e=>{var t;return((t=e.sender)==null?void 0:t.id)===m.value?"message-sent":"message-received"},_=P({newMessage:""}),u=c(null),i=c([]),H=async()=>{let e=localStorage.getItem("access_token");const t=M(e);if(e&&!t){y.push({name:"Login"});return}m.value=t.user_id,console.log("ID пользователя:",m.value);try{const a=await w.get(`${$}/topics/${C.topic_id}/comments/`,{headers:{Authorization:`Bearer ${e}`}});i.value=a.data||[],console.log("Все сообщения загружены:",i.value);const o=Math.ceil(i.value.length/x);p.value=o>0?o:1}catch(a){console.error("Ошибка при загрузке всех сообщений:",a.response?a.response.data:a.message)}},D=async()=>{let e=localStorage.getItem("access_token");const t=M(e);if(e&&!t){y.push({name:"Login"});return}const a=i.value.length?Math.max(...i.value.map(o=>o.id)):0;try{const o=await w.get(`${$}/topics/${C.topic_id}/comments/`,{headers:{Authorization:`Bearer ${e}`},params:{last_id:a}});o.data&&o.data.length?(i.value=i.value.concat(o.data),console.log("Новые сообщения загружены:",o.data)):console.log("Новых сообщений нет")}catch(o){console.error("Ошибка при загрузке новых сообщений:",o.response?o.response.data:o.message)}},v=P({}),J=()=>{var o;const a=(o=new DOMParser().parseFromString(_.newMessage||"","text/html").body.textContent)==null?void 0:o.trim();return v.newMessage=a?"":"Содержание обязательно!",Object.values(v).every(s=>!s)},Q=async()=>{if(!J()){console.error("Форма содержит ошибки:",v);return}try{let e=localStorage.getItem("access_token");const t=M(e);if(e&&!t){y.push({name:"Login"});return}console.log("Отправляем данные для создания объекта:",_);const a={topic:C.topic_id,content:_.newMessage,sender:t.user_id};console.log("JSON данные перед отправкой:",a);const o=await w.post(`${$}/comments/create/`,a,{headers:{Authorization:`Bearer ${e}`}});console.log("Комментарий создан:",o.data),u.value.clearContent(),D()}catch(e){e.response&&e.response.data?(Object.assign(v,e.response.data),console.error("Ошибка при создании комментария:",e.response.data)):console.error("Ошибка при создании комментария:",e.message)}},q=e=>{h.value=e.id,e.editedContent=e.content},G=e=>{var s;e.editErrors={};const o=(s=new DOMParser().parseFromString(e.editedContent||"","text/html").body.textContent)==null?void 0:s.trim();return e.editErrors.editedContent=o?"":"Содержание обязательно!",Object.values(e.editErrors).every(d=>!d)},K=async e=>{if(!G(e)){console.error("Форма содержит ошибки:",v);return}try{let t=localStorage.getItem("access_token");const a=M(t);if(t&&!a){y.push({name:"Login"});return}console.log("Отправляем данные для редактирования комментария:",_);const o={topic:C.topic_id,content:e.editedContent,sender:a.user_id};console.log("JSON данные перед отправкой:",o);const s=await w.patch(`${$}/comments/${e.id}/update/`,o,{headers:{Authorization:`Bearer ${t}`}});console.log("Комментарий отредактирован:",s.data);const d=i.value.find(f=>f.id===e.id);d&&(d.content=s.data.content,d.changed=s.data.changed),console.log("Комментарий обновлен:",d),h.value=null,D()}catch(t){t.response&&t.response.data?(Object.assign(v,t.response.data),console.error("Ошибка при создании объекта:",t.response.data)):console.error("Ошибка при создании объекта:",t.message)}},S=c(!1),T=c(null),W=e=>{T.value=e,S.value=!0},V=()=>{S.value=!1},X=async e=>{let t=localStorage.getItem("access_token");const a=M(t);if(t&&!a){y.push({name:"Login"});return}try{await w.delete(`${$}/comments/${e}/delete/`,{headers:{Authorization:`Bearer ${t}`}}),i.value=i.value.filter(o=>o.id!==e),V()}catch(o){console.error("Ошибка удаления комментария:",o)}},Y=e=>{u.value&&(console.log("Ответ на сообщение:",e),u.value.editor.chain().focus().toggleBlockquote().run(),u.value.insertContent(`${e.sender.str} - ${R(e.created)}`),u.value.insertContent(e.content),u.value.editor.chain().focus().splitBlock().run(),u.value.editor.chain().focus().setParagraph().run())},k=c(""),p=c(1),E=L(()=>k.value?i.value.filter(e=>{var t,a,o;return((a=(t=e.sender)==null?void 0:t.str)==null?void 0:a.toLowerCase().includes(k.value.toLowerCase()))||((o=e.content)==null?void 0:o.toLowerCase().includes(k.value.toLowerCase()))}):i.value),O=L(()=>Math.ceil(E.value.length/x)),Z=L(()=>{const e=(p.value-1)*x,t=e+x;return E.value.slice(e,t)});A(k,()=>{p.value=1});const j=c(null);A(()=>_.newMessage,e=>{var s;const o=(s=new DOMParser().parseFromString(e,"text/html").body.textContent)==null?void 0:s.trim();j.value=!!o});let I=null;const ee=()=>{I=setInterval(()=>{!h.value&&!j.value?(D(),console.log("Запрос на обновление сообщений отправлен:",new Date().toLocaleTimeString())):console.log("Пропуск автообновления (редактирование или набор нового сообщения)")},1e4)},te=()=>{I&&clearInterval(I)};return ne(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных..."),await H(),B.value=!0,ee()}),ae(()=>{te()}),(e,t)=>{var a,o;return B.value?(r(),l("div",pe,[((a=i.value)==null?void 0:a.length)>0?(r(),l("div",ge,[le(n("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>k.value=s),type:"text",placeholder:"Поиск",class:"tab-search-input"},null,512),[[re,k.value]])])):g("",!0),n("div",null,[((o=E.value)==null?void 0:o.length)>0?(r(),l("div",me,[(r(!0),l(ie,null,ce(Z.value,s=>{var d;return r(),l("div",{key:s.id,class:de(["message",U(s)])},[n("div",he,[n("div",_e,[n("h2",null,b(s.sender.str?s.sender.str:"Без отправителя"),1)])]),n("div",fe,[h.value===s.id?(r(),l("div",be,[N(F,{modelValue:s.editedContent,"onUpdate:modelValue":f=>s.editedContent=f},null,8,["modelValue","onUpdate:modelValue"]),(d=s.editErrors)!=null&&d.editedContent?(r(),l("span",ke,b(s.editErrors.editedContent),1)):g("",!0)])):(r(),l("div",{key:1,innerHTML:s.content,class:"tiptap"},null,8,ye)),n("div",null,[n("p",null,b(s.changed?ue(R)(s.changed):"Без даты и времени"),1)])]),n("div",Ce,[n("div",Me,[h.value?g("",!0):(r(),l("button",{key:0,class:"table-tab-button",onClick:f=>Y(s)},"Ответить",8,we)),!h.value&&m.value&&s.sender.id==m.value?(r(),l("button",{key:1,class:"table-tab-button",onClick:f=>q(s)},"Редактировать",8,$e)):g("",!0),h.value===s.id?(r(),l("button",{key:2,class:"table-tab-button",onClick:f=>K(s)},"Сохранить",8,xe)):g("",!0),m.value&&s.sender.id==m.value?(r(),l("button",{key:3,onClick:f=>W(s),class:"table-tab-button"}," Удалить",8,De)):g("",!0)])])],2)}),128)),S.value?(r(),l("div",Se,[n("div",Te,[n("div",Ee,[n("h2",Ie,"Удаление "+b(T.value.sender.str||"Безымянный исполнитель очереди"),1)]),n("div",Le,[n("button",{onClick:t[1]||(t[1]=s=>X(T.value.id)),class:"minibutton"},"Подтвердить"),n("button",{onClick:V,class:"minibutton"},"Отменить")])])])):g("",!0),n("div",Be,[n("button",{disabled:p.value===1,onClick:t[2]||(t[2]=s=>p.value--),class:"tab-settings-button"}," Назад ",8,Ve),n("span",null,"Страница "+b(p.value)+" из "+b(O.value),1),n("button",{disabled:p.value===O.value,onClick:t[3]||(t[3]=s=>p.value++),class:"tab-settings-button"}," Вперед ",8,Oe)])])):(r(),l("div",je,[...t[5]||(t[5]=[n("div",{class:"none-border"},"Нет сообщений",-1)])]))]),n("form",{onSubmit:ve(Q,["prevent"]),class:"form",id:"form"},[n("div",Pe,[t[6]||(t[6]=n("label",{for:"desc",class:"form-label"},"Сообщение:",-1)),N(F,{ref_key:"editorRef",ref:u,modelValue:_.newMessage,"onUpdate:modelValue":t[4]||(t[4]=s=>_.newMessage=s)},null,8,["modelValue"]),v.newMessage?(r(),l("span",Ae,b(v.newMessage),1)):g("",!0)])],32),t[7]||(t[7]=n("div",{class:"tab-menu minibutton-group"},[n("button",{type:"submit",class:"minibutton",form:"form"},"Отправить")],-1))])):(r(),l("div",Ne,[...t[8]||(t[8]=[n("div",null,"Загрузка данных...",-1)])]))}}};export{ze as _};
