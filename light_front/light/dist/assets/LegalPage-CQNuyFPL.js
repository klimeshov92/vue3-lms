import{r as b,a as h,o as y,c as i,b as l,d as a,t as L,e as f,w as _,f as j,g as S,i as c,u as w,h as d,j as g,k as I,l as n,m as p}from"./index-B_YjXf3B.js";const A={key:0},V={key:0,class:"detail-page"},N={key:0},B={class:"detail-card"},E={class:"detail-card-info"},T={class:"detail-header"},$={class:"detail-header-title"},D={class:"material-content"},O=["innerHTML"],x={key:0,class:"detail-menu button-group"},C={key:1,class:"none-container"},z={key:0,class:"detail-menu button-group none-menu-padding"},J={key:1,class:"loading"},M={key:1,class:"loading"},U={__name:"LegalPage",setup(H){I();const u=w(),m=b(!1),o=h({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewLegalPage:!1,canEditLegalPage:!1,canAddLegalPage:!1}),v=async()=>{let t=localStorage.getItem("access_token");const e=c(t);if(t&&!e){u.push({name:"Login"});return}try{const s=await d.get(`${g}/legal_page_content/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные результата:",s.data),o.object=s.data}catch(s){console.error("Ошибка при получении данных страницы:",s)}},P=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let e=localStorage.getItem("access_token");const s=c(e);if(!(!e||!s))try{(await d.get(`${g}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(r){console.error("Ошибка проверки версии прав:",r),localStorage.removeItem("userPermissions")}},k=async()=>{let t=localStorage.getItem("access_token");const e=c(t);if(t&&!e){u.push({name:"Login"});return}try{let s=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",s),Object.keys(s).length>0&&(console.log("ID пользователя в разрешениях из памяти:",s.user_id),!e&&s.user_id!==1||e&&e.user_id!==s.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),s={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(s).length===0){const r=await d.get(`${g}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",r.data),s=r.data,localStorage.setItem("userPermissions",JSON.stringify(s))}o.globalPermissionsList=s.global_permissions||[],o.objectPermissionsDict=s.object_permissions||{},o.canViewLegalPage=!0,o.canAddLegalPage=o.globalPermissionsList.includes("core.add_legal_page"),console.log("Права на добавление страницы:",o.canAddLegalPage),o.canEditLegalPage=o.globalPermissionsList.includes("core.change_legal_page")||Array.isArray(o.objectPermissionsDict["core.change_legal_page"])&&o.objectPermissionsDict["core.change_legal_page"].includes(Number(id)),console.log("Права на редактирование страницы:",o.canEditLegalPage)}catch(s){console.error("Ошибка при загрузке разрешений пользователя:",s)}};return y(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await v(),await P(),await k(),m.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,e)=>{const s=S("router-link");return m.value?(n(),i("div",A,[o.canViewLegalPage?(n(),i("div",V,[o.object.id?(n(),i("div",N,[a("div",B,[a("div",E,[a("div",T,[a("div",$,[a("h1",null,L(o.object.title||"Безымянный материал"),1)])]),a("div",D,[a("div",{innerHTML:o.object.content,class:"tiptap"},null,8,O)]),o.canEditLegalPage?(n(),i("div",x,[o.canEditLegalPage?(n(),f(s,{key:0,to:{name:"LegalPageEdit",params:{id:o.object.id}},class:"button"},{default:_(()=>[...e[0]||(e[0]=[p(" Изменить ",-1)])]),_:1},8,["to"])):l("",!0)])):l("",!0),e[1]||(e[1]=a("div",null,null,-1))])])])):o.object.id?l("",!0):(n(),i("div",C,[e[3]||(e[3]=a("div",{class:"none-card"},[a("div",null,"Объект не найден.")],-1)),o.canAddLegalPage?(n(),i("div",z,[j(s,{to:{name:"LegalPageCreate"},class:"button"},{default:_(()=>[...e[2]||(e[2]=[p(" Создать ",-1)])]),_:1})])):l("",!0)]))])):(n(),i("div",J,[...e[4]||(e[4]=[a("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),i("div",M,[...e[5]||(e[5]=[a("div",null,"Загрузка данных...",-1)])]))}}};export{U as default};
