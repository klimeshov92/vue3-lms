import{r as P,a as $,B as L,k as G,C as B,o as C,c,b as d,d as s,t as l,m as u,e as N,w as T,F as x,G as E,D as f,H as z,f as y,i as g,h as _,j as v,g as M,q,u as J,l as n,I as F}from"./index--35mTu_l.js";import{_ as R,a as U}from"./AccountsGroupObjectPermissions-B5fMngWY.js";import"./EditorComponent-B38G4_Ji.js";const H={key:0},K={key:0,class:"detail-page"},Q={key:0},W={class:"detail-card"},X={class:"detail-card-info"},Y={class:"detail-header"},Z={class:"detail-header-title"},ee={class:"detail-card-text"},oe={class:"detail-card-text-elem"},se={class:"detail-menu button-group"},te={key:0,class:"modal-overlay"},ae={class:"modal"},ie={class:"modal-header"},ne={class:"modal-header-h2"},ce={class:"minibutton-group modal-menu"},le={class:"detail-tabs"},re={class:"tabs-header"},de=["onClick"],ue={key:0,class:"tabs-content"},me={key:0,class:"detail-tab"},be={class:"detail-tab-elem"},ge={class:"detail-tab-elem"},_e={class:"detail-tab-elem"},ve={class:"detail-tab-elem"},pe={class:"detail-tab-elem"},je={class:"detail-tab-elem"},Oe={key:1,class:"table-tab"},Pe={key:2,class:"table-tab"},he={key:1,class:"none-container"},ke={key:1,class:"none-card"},fe={key:1,class:"loading"},we={__name:"OrganizationDetail",setup(ze){const m=G(),b=J(),h=P(!1),e=$({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewOrganization:!1,canEditOrganization:!1,canDeleteOrganization:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),p=async()=>{const t=m.params.id;let o=localStorage.getItem("access_token");const a=g(o);o&&!a&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{const i=await _.get(`${v}/organizations/${t}/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Данные организации:",i.data),e.object=i.data}catch(i){console.error("Ошибка при получении данных организации:",i)}},j=P(!1),A=()=>{j.value=!0},k=()=>{j.value=!1},D=async()=>{let t=localStorage.getItem("access_token");const o=g(t);if(t&&!o){b.push({name:"Login"});return}const a=m.params.id;try{await _.delete(`${v}/organizations/${a}/`,{headers:{Authorization:`Bearer ${t}`}}),k(),b.push({name:"OrganizationList"})}catch(i){console.error("Ошибка удаления организации:",i)}},w=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let o=localStorage.getItem("access_token");const a=g(o);if(!(!o||!a))try{(await _.get(`${v}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${o}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(i){console.error("Ошибка проверки версии прав:",i),localStorage.removeItem("userPermissions")}},S=async()=>{let t=localStorage.getItem("access_token");const o=g(t);t&&!o&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{let a=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",a),Object.keys(a).length>0&&(console.log("ID пользователя в разрешениях из памяти:",a.user_id),!o&&a.user_id!==1||o&&o.user_id!==a.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),a={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(a).length===0){const O=await _.get(`${v}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",O.data),a=O.data,localStorage.setItem("userPermissions",JSON.stringify(a))}e.globalPermissionsList=a.global_permissions||[],e.objectPermissionsDict=a.object_permissions||{};const i=m.params.id;console.log("ID объекта:",i),e.canViewOrganization=e.globalPermissionsList.includes("core.view_organization")||e.objectPermissionsDict["core.view_organization"]&&e.objectPermissionsDict["core.view_organization"].includes(Number(i)),console.log("Права на просмотр организаций:",e.canViewOrganization),e.canEditOrganization=e.globalPermissionsList.includes("core.change_organization")||Array.isArray(e.objectPermissionsDict["core.change_organization"])&&e.objectPermissionsDict["core.change_organization"].includes(Number(i)),console.log("Права на редактирование организаций:",e.canEditOrganization),e.canDeleteOrganization=e.globalPermissionsList.includes("core.delete_organization")||Array.isArray(e.objectPermissionsDict["core.delete_organization"])&&e.objectPermissionsDict["core.delete_organization"].includes(Number(i)),console.log("Права на удаление организаций:",e.canDeleteOrganization),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(a){console.error("Ошибка при загрузке разрешений пользователя:",a)}},V=()=>{q(b)},I=L(()=>[{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),r=P(m.query.tab||localStorage.getItem(`activeOrganizationTab-${m.params.id}`)||"details");return console.log("Текущий таб:",r),B(r,t=>{localStorage.setItem(`activeOrganizationTab-${m.params.id}`,t),b.push({query:{tab:t}}),console.log("Загружен таб:",t)}),C(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await p(),await w(),await S(),h.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,o)=>{const a=M("router-link");return h.value?(n(),c("div",H,[e.canViewOrganization?(n(),c("div",K,[e.object.id?(n(),c("div",Q,[s("div",W,[s("div",X,[s("div",Y,[s("div",Z,[s("h1",null,l(e.object.legal_name||"Безымянная организация"),1)])]),s("div",ee,[s("div",oe,[o[1]||(o[1]=s("span",{class:"detail-card-text-label"},"ИНН:",-1)),u(" "+l(e.object.tin||"Нет ИНН"),1)])]),s("div",se,[e.canEditOrganization?(n(),N(a,{key:0,to:{name:"OrganizationEdit",params:{id:e.object.id}},class:"button"},{default:T(()=>[...o[2]||(o[2]=[u(" Изменить ",-1)])]),_:1},8,["to"])):d("",!0),e.canDeleteOrganization?(n(),c("button",{key:1,onClick:A,class:"button"}," Удалить ")):d("",!0),s("button",{type:"button",onClick:V,class:"button"},"Назад")]),j.value?(n(),c("div",te,[s("div",ae,[s("div",ie,[s("h2",ne,"Удаление "+l(e.object.legal_name||"Безымянная организация"),1)]),s("div",ce,[s("button",{onClick:o[0]||(o[0]=i=>D()),class:"minibutton"},"Подтвердить"),s("button",{onClick:k,class:"minibutton"},"Отменить")])])])):d("",!0)])]),s("div",le,[s("div",re,[(n(!0),c(x,null,E(I.value,i=>(n(),c("button",{key:i.name,class:F([{active:r.value===i.name},"tab-button"]),onClick:O=>r.value=i.name},l(i.label),11,de))),128))]),r.value?(n(),c("div",ue,[r.value==="details"?(n(),c("div",me,[s("div",be,[o[3]||(o[3]=s("span",{class:"detail-tab-label"},"Юридическое название:",-1)),u(" "+l(e.object.legal_name||"Нет юридического названия"),1)]),s("div",ge,[o[4]||(o[4]=s("span",{class:"detail-tab-label"},"ИНН:",-1)),u(" "+l(e.object.tin||"Нет ИНН"),1)]),s("div",_e,[o[5]||(o[5]=s("span",{class:"detail-tab-label"},"Создан:",-1)),u(" "+l(e.object.created?f(z)(e.object.created):"Нет данных о создании"),1)]),s("div",ve,[o[6]||(o[6]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),u(" "+l(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",pe,[o[7]||(o[7]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),u(" "+l(e.object.changed?f(z)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",je,[o[8]||(o[8]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),u(" "+l(e.object.editor?e.object.editor:"Нет редактора"),1)])])):d("",!0),r.value==="accountsGroupObjectPermissions"?(n(),c("div",Oe,[y(R,{state:e,fetchObject:p,contentTypeModel:"organization"},null,8,["state"])])):d("",!0),r.value==="accountObjectPermissions"?(n(),c("div",Pe,[y(U,{state:e,fetchObject:p,contentTypeModel:"organization"},null,8,["state"])])):d("",!0)])):d("",!0)])])):e.object.id?d("",!0):(n(),c("div",he,[...o[9]||(o[9]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(n(),c("div",ke,[...o[10]||(o[10]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),c("div",fe,[...o[11]||(o[11]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{we as default};
