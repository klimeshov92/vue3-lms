import{a as D,r as b,k as L,B as M,C as N,o as A,c as n,d as a,n as F,b as m,f as _,D as p,t as v,p as y,z as J,w as c,v as B,i as g,u as P,h as w,j as T,l as i}from"./index-CadGroRP.js";import{s as V}from"./custom-multiselect-7oKqqfDz.js";const G={key:0},H={class:"form-page"},K={class:"form-field"},Q={key:0,class:"error"},W={class:"form-field"},X={key:0,class:"form-field"},Y={key:0,class:"error"},Z={class:"form-field"},ee={key:0,class:"error"},se={class:"form-field"},te={class:"form-field"},oe={key:1,class:"loading"},ne={__name:"ControlElementCreate",setup(ae){const f=L(),r=P(),s=D({type_of_work:"",repeat:!1,task_template:null,name:"",categories:[],desc:""}),I=b(!1),C=[{label:"Итог задачи",value:"task_outcome"},{label:"Триггер",value:"trigger"}],d=b([]),S=async()=>{let o=localStorage.getItem("access_token");const e=g(o);if(o&&!e){r.push({name:"Login"});return}try{const t=await w.get(`${T}/task_templates/`,{headers:{Authorization:`Bearer ${o}`}});d.value=t.data.results||[],console.log("Шаблоны задач загружены:",d.value)}catch(t){console.error("Ошибка при загрузке шаблонов задач:",t.response?t.response.data:t.message)}},u=f.query.taskId||"",U=()=>{if(u){console.log("Task ID:",u);const o=d.value.find(e=>e.id===parseInt(u,10));o?(s.type_of_work=C.find(e=>e.value==="task_outcome"),s.task_template=o):console.error("Task не найден.")}else console.log("Task ID не найден.")},j=M(()=>{var o;return((o=s.type_of_work)==null?void 0:o.value)==="task_outcome"?d.value.filter(e=>e.task_outcome==!0):d.value}),k=b([]),O=async()=>{let o=localStorage.getItem("access_token");const e=g(o);if(o&&!e){r.push({name:"Login"});return}try{const t=await w.get(`${T}/categories/`,{headers:{Authorization:`Bearer ${o}`}});k.value=t.data.results||[],console.log("Категории загружены:",k.value)}catch(t){console.error("Ошибка при загрузке категорий:",t.response?t.response.data:t.message)}};N(()=>s.type_of_work,o=>{o.value!="task_outcome"&&(s.task_outcome=null)});const $=()=>{const o=f.query.taskId||"";o?r.push({name:"TaskTemplateDetail",params:{id:o}}):r.push({name:"ControlElementList"})},l=D({}),E=()=>(l.type_of_work=s.type_of_work.value?"":"Тип работы обязателен!",s.type_of_work.value=="task_outcome"&&(l.task_template=s.task_template?"":"Выбор шаблона задачи обязателен!"),Object.values(l).every(o=>!o)),R=async()=>{var o;if(!E()){console.error("Форма содержит ошибки:",l);return}try{console.log("Отправляем данные для создания объекта:",s);const e={type_of_work:s.type_of_work.value,repeat:s.repeat,task_template:(o=s.task_template)==null?void 0:o.id,name:s.name,categories:s.categories.map(z=>z.id),desc:s.desc};console.log("JSON данные перед отправкой:",e);let t=localStorage.getItem("access_token");const q=g(t);if(t&&!q){r.push({name:"Login"});return}const h=await w.post(`${T}/control_elements/`,e,{headers:{Authorization:`Bearer ${t}`}});console.log("Объект создан:",h.data),localStorage.removeItem("userPermissions");const x=f.query.taskId||"";x?r.push({name:"TaskTemplateDetail",params:{id:x}}):r.push({name:"ControlElementDetail",params:{id:h.data.id}})}catch(e){e.response&&e.response.data?(Object.assign(l,e.response.data),console.error("Ошибка при создании объекта:",e.response.data)):console.error("Ошибка при создании объекта:",e.message)}};return A(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await S(),await U(),await O(),I.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,e)=>I.value?(i(),n("div",G,[a("div",H,[e[17]||(e[17]=a("div",{class:"form-header"},[a("h1",null,"Создание управляющих элементов")],-1)),a("form",{onSubmit:F(R,["prevent"]),class:"form",id:"form"},[a("div",K,[e[6]||(e[6]=a("label",{class:"form-label"},"Тип работы:",-1)),_(p(V),{modelValue:s.type_of_work,"onUpdate:modelValue":e[0]||(e[0]=t=>s.type_of_work=t),options:C,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип работы",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!p(u)},null,8,["modelValue","disabled"]),l.type_of_work?(i(),n("span",Q,v(l.type_of_work),1)):m("",!0)]),a("div",W,[e[7]||(e[7]=a("label",{for:"repeat",class:"form-label"},"Многократное срабатывание:",-1)),y(a("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>s.repeat=t),id:"repeat",type:"checkbox",class:"form-input"},null,512),[[J,s.repeat]])]),s.type_of_work.value=="task_outcome"?(i(),n("div",X,[e[10]||(e[10]=a("label",{class:"form-label"},"Шаблон задачи:",-1)),_(p(V),{modelValue:s.task_template,"onUpdate:modelValue":e[2]||(e[2]=t=>s.task_template=t),options:j.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!p(u)},{noOptions:c(()=>[...e[8]||(e[8]=[a("span",null,"Список пуст",-1)])]),noResult:c(()=>[...e[9]||(e[9]=[a("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options","disabled"]),l.task_template?(i(),n("span",Y,v(l.task_template),1)):m("",!0)])):m("",!0),a("div",Z,[e[11]||(e[11]=a("label",{for:"name",class:"form-label"},"Название:",-1)),y(a("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>s.name=t),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[B,s.name]]),l.name?(i(),n("span",ee,v(l.name),1)):m("",!0)]),a("div",se,[e[14]||(e[14]=a("label",{class:"form-label"},"Категории:",-1)),_(p(V),{modelValue:s.categories,"onUpdate:modelValue":e[4]||(e[4]=t=>s.categories=t),options:k.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:c(()=>[...e[12]||(e[12]=[a("span",null,"Список пуст",-1)])]),noResult:c(()=>[...e[13]||(e[13]=[a("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),a("div",te,[e[15]||(e[15]=a("label",{for:"desc",class:"form-label"},"Описание:",-1)),y(a("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>s.desc=t),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[B,s.desc]])])],32),a("div",{class:"form-menu button-group"},[e[16]||(e[16]=a("button",{type:"submit",class:"button",form:"form"},"Сохранить",-1)),a("button",{type:"button",onClick:$,class:"button"},"Отмена")])])])):(i(),n("div",oe,[...e[18]||(e[18]=[a("div",null,"Загрузка данных...",-1)])]))}};export{ne as default};
