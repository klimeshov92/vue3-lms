import{r as p,a as $,o as E,c as r,d as t,b as k,t as y,f as C,w as _,C as F,p as j,v as x,n as L,i as w,u as R,h as f,j as v,k as z,l as i}from"./index-C8MToAQO.js";import{s as A}from"./custom-multiselect-DcF6BiF3.js";import{E as I}from"./EditorComponent-CNY1fJ-z.js";const M={key:0},q={key:0,class:"form-page"},J={class:"form-field"},P={key:0,class:"avatar-preview"},G=["href"],H={class:"form-field"},K={class:"form-field"},Q={key:0,class:"error"},W={lass:"form-field form-field-full_width"},X={key:0,class:"error"},Y={class:"form-field"},Z={key:1,class:"none-card"},ee={key:1,class:"loading"},le={__name:"NewEdit",setup(te){const h=z(),d=R(),c=p(null),a=$({name:"",content:"",desc:"",categories:[]}),V=p(!1),g=p([]),U=async()=>{let o=localStorage.getItem("access_token");const e=w(o);if(o&&!e){d.push({name:"Login"});return}try{const s=await f.get(`${v}/categories/`,{headers:{Authorization:`Bearer ${o}`}});g.value=s.data.results||[],console.log("Категории загружены:",g.value)}catch(s){console.error("Ошибка при загрузке категорий:",s.response?s.response.data:s.message)}},B=async()=>{var m;const o=h.params.id;let e=localStorage.getItem("access_token");const s=w(e);if(e&&!s){d.push({name:"Login"});return}try{const n=await f.get(`${v}/news/${o}/`,{headers:{Authorization:`Bearer ${e}`}});c.value=n.data,console.log("Объект успешно загружен:",c.value),Object.assign(a,c.value),u.value=c.value.avatar||""}catch(n){console.error("Ошибка загрузки объекта:",((m=n.response)==null?void 0:m.data)||n.message)}},b=p(null),u=p(null),O=o=>{const e=o.target.files[0];e&&(b.value=e,u.value=URL.createObjectURL(e))},l=$({}),D=()=>(l.name=a.name?"":"Название обязательно!",l.content=a.content.trim()?"":"Содержание обязательно!",Object.values(l).every(o=>!o)),N=async()=>{if(!D()){console.error("Форма содержит ошибки:",l);return}try{const o=h.params.id;let e=localStorage.getItem("access_token");const s=w(e);if(e&&!s){d.push({name:"Login"});return}const m={name:a.name,content:a.content||"",desc:a.desc,categories:a.categories.map(n=>n.id)};if(console.log("JSON данные перед отправкой:",m),await f.patch(`${v}/news/${o}/`,m,{headers:{Authorization:`Bearer ${e}`}}),console.log("Данные обновлены"),b.value){const n=new FormData;n.append("avatar",b.value);const T=`${v}/news/${o}/`;await f.patch(T,n,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}}),console.log("Аватар успешно обновлен")}console.log("Изменения сохранены"),d.push({name:"NewDetail",params:{id:o}})}catch(o){o.response&&o.response.data?(Object.assign(l,o.response.data),console.error("Ошибка при сохранении изменений:",o.response.data)):console.error("Ошибка при сохранении изменений:",o.message)}},S=()=>{d.back()};return E(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await U(),await B(),V.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,e)=>V.value?(i(),r("div",M,[c.value?(i(),r("div",q,[e[13]||(e[13]=t("div",{class:"form-header"},[t("h1",null,"Редактирование новости")],-1)),t("form",{onSubmit:L(N,["prevent"]),class:"form",id:"edit-form"},[t("div",J,[e[5]||(e[5]=t("label",{for:"avatar",class:"form-label"},"Аватар:",-1)),t("input",{type:"file",id:"avatar",onChange:O,class:"form-input"},null,32),u.value?(i(),r("div",P,[e[4]||(e[4]=t("span",{class:"avatar-preview-text"},"Текущий аватар:",-1)),t("a",{href:u.value,target:"_blank",class:"link"},y(u.value),9,G)])):k("",!0)]),t("div",H,[e[8]||(e[8]=t("label",{class:"form-label"},"Категории:",-1)),C(F(A),{modelValue:a.categories,"onUpdate:modelValue":e[0]||(e[0]=s=>a.categories=s),options:g.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:_(()=>[...e[6]||(e[6]=[t("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[7]||(e[7]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),t("div",K,[e[9]||(e[9]=t("label",{for:"name",class:"form-label"},"Название:",-1)),j(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>a.name=s),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[x,a.name]]),l.name?(i(),r("span",Q,y(l.name),1)):k("",!0)]),t("div",W,[e[10]||(e[10]=t("label",{for:"desc",class:"form-label"},"Содержание:",-1)),C(I,{modelValue:a.content,"onUpdate:modelValue":e[2]||(e[2]=s=>a.content=s)},null,8,["modelValue"]),l.content?(i(),r("span",X,y(l.content),1)):k("",!0)]),t("div",Y,[e[11]||(e[11]=t("label",{for:"desc",class:"form-label"},"Описание:",-1)),j(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=s=>a.desc=s),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[x,a.desc]])])],32),t("div",{class:"form-menu button-group"},[e[12]||(e[12]=t("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),t("button",{type:"button",onClick:S,class:"button"},"Отмена")])])):(i(),r("div",Z,[...e[14]||(e[14]=[t("div",null,"Объект не найден",-1)])]))])):(i(),r("div",ee,[...e[15]||(e[15]=[t("div",null,"Загрузка данных...",-1)])]))}};export{le as default};
