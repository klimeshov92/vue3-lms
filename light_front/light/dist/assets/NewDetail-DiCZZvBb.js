import{r as y,a as z,B as E,k as M,C as q,o as J,c as n,b as d,d as t,t as u,m,e as A,w as N,F,G as R,D as V,H as $,f as D,i as w,h as k,j as f,g as U,u as H,q as K,l as a,I as Q}from"./index-CzP8FZvf.js";import{_ as W,a as X}from"./AccountsGroupObjectPermissions-D9lR2uBj.js";import{_ as Y}from"./TopicMessages-ChEq3YyC.js";import"./EditorComponent-DxSf7Gmz.js";const Z={key:0},ee={key:0,class:"detail-page"},se={key:0},te={class:"detail-card"},oe={class:"detail-card-image-outer"},ae={key:0,class:"detail-card-image-inner"},ne=["src"],ie={key:1,class:"detail-card-image-none"},ce={class:"detail-card-info"},le={class:"detail-header"},re={class:"detail-header-title"},de={class:"detail-card-text"},ue={class:"detail-card-text-elem"},me={class:"detail-card-text-elem"},be={class:"detail-menu button-group"},_e={key:0,class:"modal-overlay"},ge={class:"modal"},pe={class:"modal-header"},ve={class:"modal-header-h2"},je={class:"minibutton-group modal-menu"},we={class:"detail-tabs"},ke={class:"tabs-header"},fe=["onClick"],Pe={key:0,class:"tabs-content"},he={key:0,class:"desc-tab"},ye={key:0},Ae={key:1},Ne={key:1,class:"detail-tab"},De={class:"detail-tab-elem"},Oe={class:"detail-tab-elem"},Se={class:"detail-tab-elem"},Ve={class:"detail-tab-elem"},$e={class:"detail-tab-elem"},Ie={class:"detail-tab-elem"},Te={key:2,class:"topic-tab"},Le={key:3,class:"table-tab"},Ce={key:4,class:"table-tab"},Ge={key:1,class:"none-container"},Be={key:1,class:"loading"},xe={key:1,class:"loading"},Re={__name:"NewDetail",setup(ze){const g=M(),p=H(),O=y(!1),e=z({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewNew:!1,canSelfAssignment:!1,canEditNew:!1,canDeleteNew:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),P=async()=>{const o=g.params.id;let s=localStorage.getItem("access_token");const l=w(s);s&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const i=await k.get(`${f}/news/${o}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные новости:",i.data),e.object=i.data}catch(i){console.error("Ошибка при получении данных новости:",i)}},h=y(!1),I=()=>{h.value=!0},S=()=>{h.value=!1},T=async()=>{let o=localStorage.getItem("access_token");const s=w(o);if(o&&!s){p.push({name:"Login"});return}const l=g.params.id;try{await k.delete(`${f}/news/${l}/`,{headers:{Authorization:`Bearer ${o}`}}),S(),p.push({name:"NewList"})}catch(i){console.error("Ошибка удаления новости:",i)}},L=async o=>{let s=localStorage.getItem("access_token");const l=w(s);if(s&&!l){p.push({name:"Login"});return}try{const i=await k.post(`${f}/self_assignment/${o}/`,{},{headers:{Authorization:`Bearer ${s}`}});console.log("Самоназначение:",i.data),p.push({name:"TaskDetail",params:{id:i.data.id}})}catch(i){console.error("Ошибка самоназначения:",i)}},C=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let s=localStorage.getItem("access_token");const l=w(s);if(!(!s||!l))try{(await k.get(`${f}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(i){console.error("Ошибка проверки версии прав:",i),localStorage.removeItem("userPermissions")}},G=async()=>{var l,i,v,j;let o=localStorage.getItem("access_token");const s=w(o);o&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{let c=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",c),Object.keys(c).length>0&&(console.log("ID пользователя в разрешениях из памяти:",c.user_id),!s&&c.user_id!==1||s&&s.user_id!==c.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),c={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(c).length===0){const r=await k.get(`${f}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",r.data),c=r.data,localStorage.setItem("userPermissions",JSON.stringify(c))}e.globalPermissionsList=c.global_permissions||[],e.objectPermissionsDict=c.object_permissions||{};const _=g.params.id;console.log("ID объекта:",_),e.canViewNew=e.globalPermissionsList.includes("news.view_new")||e.objectPermissionsDict["news.view_new"]&&e.objectPermissionsDict["news.view_new"].includes(Number(_)),console.log("Права на просмотр аккаунтов:",e.canViewNew),e.canSelfAssignment=e.canViewNew&&e.object.self_assignment_task_template&&e.object.self_assignment_task_template&&(!e.object.last_task||((i=(l=e.object.last_task)==null?void 0:l.result)==null?void 0:i.status)=="failed"||((j=(v=e.object.last_task)==null?void 0:v.result)==null?void 0:j.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditNew=e.globalPermissionsList.includes("news.change_new")||Array.isArray(e.objectPermissionsDict["news.change_new"])&&e.objectPermissionsDict["news.change_new"].includes(Number(_)),console.log("Права на редактирование аккаунтов:",e.canEditNew),e.canDeleteNew=e.globalPermissionsList.includes("news.delete_new")||Array.isArray(e.objectPermissionsDict["news.delete_new"])&&e.objectPermissionsDict["news.delete_new"].includes(Number(_)),console.log("Права на удаление аккаунтов:",e.canDeleteNew),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(c){console.error("Ошибка при загрузке разрешений пользователя:",c)}},B=()=>{K(p)},x=E(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=y(g.query.tab||localStorage.getItem(`activeNewTab-${g.params.id}`)||"details");return q(b,o=>{localStorage.setItem(`activeNewTab-${g.params.id}`,o),p.push({query:{tab:o}}),console.log("Загружен таб:",o)}),J(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await P(),await C(),await G(),O.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,s)=>{var i,v,j,c,_;const l=U("router-link");return O.value?(a(),n("div",Z,[e.canViewNew?(a(),n("div",ee,[e.object.id?(a(),n("div",se,[t("div",te,[t("div",oe,[e.object.avatar?(a(),n("div",ae,[t("img",{src:e.object.avatar||"/default-avatar.png",alt:"Аватар"},null,8,ne)])):(a(),n("div",ie,[...s[2]||(s[2]=[t("span",{class:"none-text"},"Нет аватара",-1)])]))]),t("div",ce,[t("div",le,[t("div",re,[t("h1",null,u(e.object.str||"Безымянная материал"),1)])]),t("div",de,[t("div",ue,[s[3]||(s[3]=t("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),m(" "+u((i=e.object.last_task)!=null&&i.result?(v=e.object.last_task)==null?void 0:v.result.status_display:"Не назначено"),1)]),t("div",me,[s[4]||(s[4]=t("span",{class:"detail-card-text-label"},"Категории:",-1)),m(" "+u(e.object.categories.length>0?e.object.categories.map(r=>r.name).join(", "):"Нет категорий"),1)])]),t("div",be,[e.object.last_task?(a(),A(l,{key:0,to:{name:"NewContent",params:{id:e.object.last_task.id}},class:"button"},{default:N(()=>[...s[5]||(s[5]=[m(" Ознакомиться ",-1)])]),_:1},8,["to"])):d("",!0),e.object.last_task?(a(),A(l,{key:1,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:N(()=>[...s[6]||(s[6]=[m(" Задача ",-1)])]),_:1},8,["to"])):d("",!0),e.canSelfAssignment?(a(),n("button",{key:2,onClick:s[0]||(s[0]=r=>L(e.object.self_assignment_task_template)),class:"button"}," Самоназначение ")):d("",!0),e.canEditNew?(a(),A(l,{key:3,to:{name:"NewEdit",params:{id:e.object.id}},class:"button"},{default:N(()=>[...s[7]||(s[7]=[m(" Изменить ",-1)])]),_:1},8,["to"])):d("",!0),e.canDeleteNew?(a(),n("button",{key:4,onClick:I,class:"button"}," Удалить ")):d("",!0),t("button",{type:"button",onClick:B,class:"button"},"Назад")]),h.value?(a(),n("div",_e,[t("div",ge,[t("div",pe,[t("h2",ve,"Удаление "+u(e.object.username||"Безымянная учетная запись"),1)]),t("div",je,[t("button",{onClick:s[1]||(s[1]=r=>T()),class:"minibutton"},"Подтвердить"),t("button",{onClick:S,class:"minibutton"},"Отменить")])])])):d("",!0)])]),t("div",we,[t("div",ke,[(a(!0),n(F,null,R(x.value,r=>(a(),n("button",{key:r.name,class:Q([{active:b.value===r.name},"tab-button"]),onClick:Ee=>b.value=r.name},u(r.label),11,fe))),128))]),b.value?(a(),n("div",Pe,[b.value==="desc"?(a(),n("div",he,[e.object.desc?(a(),n("div",ye,u(e.object.desc),1)):(a(),n("div",Ae,[...s[8]||(s[8]=[t("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):d("",!0),b.value==="details"?(a(),n("div",Ne,[t("div",De,[s[9]||(s[9]=t("span",{class:"detail-tab-label"},"Статус задачи:",-1)),m(" "+u((j=e.object.last_task)!=null&&j.result?(c=e.object.last_task)==null?void 0:c.result.status_display:"Не назначено"),1)]),t("div",Oe,[s[10]||(s[10]=t("span",{class:"detail-tab-label"},"Категории:",-1)),m(" "+u(e.object.categories.length>0?e.object.categories.map(r=>r.name).join(", "):"Нет категорий"),1)]),t("div",Se,[s[11]||(s[11]=t("span",{class:"detail-tab-label"},"Создан:",-1)),m(" "+u(e.object.created?V($)(e.object.created):"Нет данных о создании"),1)]),t("div",Ve,[s[12]||(s[12]=t("span",{class:"detail-tab-label"},"Создатель:",-1)),m(" "+u(e.object.creator?e.object.creator:"Нет создателя"),1)]),t("div",$e,[s[13]||(s[13]=t("span",{class:"detail-tab-label"},"Изменён:",-1)),m(" "+u(e.object.changed?V($)(e.object.changed):"Нет данных об изменениях"),1)]),t("div",Ie,[s[14]||(s[14]=t("span",{class:"detail-tab-label"},"Редактор:",-1)),m(" "+u(e.object.editor?e.object.editor:"Нет редактора"),1)])])):d("",!0),b.value==="messages"?(a(),n("div",Te,[D(Y,{topic_id:(_=e.object)==null?void 0:_.topic.id},null,8,["topic_id"])])):d("",!0),b.value==="accountsGroupObjectPermissions"?(a(),n("div",Le,[D(W,{state:e,fetchObject:P,contentTypeModel:"new"},null,8,["state"])])):d("",!0),b.value==="accountObjectPermissions"?(a(),n("div",Ce,[D(X,{state:e,fetchObject:P,contentTypeModel:"new"},null,8,["state"])])):d("",!0)])):d("",!0)])])):e.object.id?d("",!0):(a(),n("div",Ge,[...s[15]||(s[15]=[t("div",{class:"none-card"},[t("div",null,"Объект не найден.")],-1)])]))])):(a(),n("div",Be,[...s[16]||(s[16]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),n("div",xe,[...s[17]||(s[17]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{Re as default};
