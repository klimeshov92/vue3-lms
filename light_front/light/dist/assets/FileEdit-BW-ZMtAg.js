import{r as f,a as j,o as A,c as i,d as l,b as k,t as _,f as x,D as B,w as C,p as U,v as D,n as N,i as h,u as E,h as m,j as v,k as I,q as M,l as d}from"./index-CfAZEXlX.js";import{s as F}from"./custom-multiselect-CMYyZ4s-.js";const q={key:0},J={key:0,class:"form-page"},P={class:"form-field"},G={key:0,class:"upload_file-preview"},H=["href"],K={class:"form-field"},Q={key:0,class:"error"},W={class:"form-field"},X={class:"form-field"},Y={key:0,class:"error"},Z={class:"form-field"},ee={key:1,class:"none-card"},le={key:1,class:"loading"},te={__name:"FileEdit",setup(se){const w=I(),u=E(),n=f(null),a=j({file_type:"",name:"",desc:"",categories:[]}),V=f(!1),$=[{label:"Картинка",value:"image"},{label:"Видео",value:"video"},{label:"Аудио",value:"audio"},{label:"Документ",value:"document"}],g=f([]),O=async()=>{let s=localStorage.getItem("access_token");const e=h(s);if(s&&!e){u.push({name:"Login"});return}try{const o=await m.get(`${v}/categories/`,{headers:{Authorization:`Bearer ${s}`}});g.value=o.data.results||[],console.log("Категории загружены:",g.value)}catch(o){console.error("Ошибка при загрузке категорий:",o.response?o.response.data:o.message)}},S=async()=>{var p;const s=w.params.id;let e=localStorage.getItem("access_token");const o=h(e);if(e&&!o){u.push({name:"Login"});return}try{const r=await m.get(`${v}/files/${s}/`,{headers:{Authorization:`Bearer ${e}`}});n.value=r.data,console.log("Объект успешно загружен:",n.value),n.value.file_type=$.find(y=>y.value===n.value.file_type),console.log("Объект нормализован:",n.value),Object.assign(a,n.value),c.value=n.value.upload_file||""}catch(r){console.error("Ошибка загрузки объекта:",((p=r.response)==null?void 0:p.data)||r.message)}},b=f(null),c=f(null),T=s=>{const e=s.target.files[0];e&&(b.value=e,c.value=URL.createObjectURL(e))},t=j({}),L=()=>(t.file_type=a.file_type.value?"":"Тип файла обязателен!",t.name=a.name?"":"Название обязательно!",Object.values(t).every(s=>!s)),R=async()=>{if(!L()){console.error("Форма содержит ошибки:",t);return}try{const s=w.params.id;let e=localStorage.getItem("access_token");const o=h(e);if(e&&!o){u.push({name:"Login"});return}const p={file_type:a.file_type.value,name:a.name,desc:a.desc,categories:a.categories.map(r=>r.id)};if(console.log("JSON данные перед отправкой:",p),await m.patch(`${v}/files/${s}/`,p,{headers:{Authorization:`Bearer ${e}`}}),console.log("Данные обновлены"),b.value){const r=new FormData;r.append("upload_file",b.value);const y=`${v}/files/${s}/`;await m.patch(y,r,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}}),console.log("Файл успешно обновлен")}console.log("Изменения сохранены"),u.push({name:"FileDetail",params:{id:s}})}catch(s){s.response&&s.response.data?(Object.assign(t,s.response.data),console.error("Ошибка при сохранении изменений:",s.response.data)):console.error("Ошибка при сохранении изменений:",s.message)}},z=()=>{M(u)};return A(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await O(),await S(),V.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>V.value?(d(),i("div",q,[n.value?(d(),i("div",J,[e[13]||(e[13]=l("div",{class:"form-header"},[l("h1",null,"Редактирование файла")],-1)),l("form",{onSubmit:N(R,["prevent"]),class:"form",id:"edit-form"},[l("div",P,[e[5]||(e[5]=l("label",{for:"upload_file",class:"form-label"},"Загружаемый файл:",-1)),l("input",{type:"file",id:"upload_file",onChange:T,class:"form-input"},null,32),c.value?(d(),i("div",G,[e[4]||(e[4]=l("span",{class:"upload_file-preview-text"},"Текущий файл:",-1)),l("a",{href:c.value,target:"_blank",class:"link"},_(c.value),9,H)])):k("",!0)]),l("div",K,[e[6]||(e[6]=l("label",{class:"form-label"},"Тип файла:",-1)),x(B(F),{modelValue:a.file_type,"onUpdate:modelValue":e[0]||(e[0]=o=>a.file_type=o),options:$,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип файла",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),t.file_type?(d(),i("span",Q,_(t.file_type),1)):k("",!0)]),l("div",W,[e[9]||(e[9]=l("label",{class:"form-label"},"Категории:",-1)),x(B(F),{modelValue:a.categories,"onUpdate:modelValue":e[1]||(e[1]=o=>a.categories=o),options:g.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:C(()=>[...e[7]||(e[7]=[l("span",null,"Список пуст",-1)])]),noResult:C(()=>[...e[8]||(e[8]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),l("div",X,[e[10]||(e[10]=l("label",{for:"name",class:"form-label"},"Название:",-1)),U(l("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>a.name=o),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[D,a.name]]),t.name?(d(),i("span",Y,_(t.name),1)):k("",!0)]),l("div",Z,[e[11]||(e[11]=l("label",{for:"desc",class:"form-label"},"Описание:",-1)),U(l("textarea",{"onUpdate:modelValue":e[3]||(e[3]=o=>a.desc=o),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[D,a.desc]])])],32),l("div",{class:"form-menu button-group"},[e[12]||(e[12]=l("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),l("button",{type:"button",onClick:z,class:"button"},"Отмена")])])):(d(),i("div",ee,[...e[14]||(e[14]=[l("div",null,"Объект не найден",-1)])]))])):(d(),i("div",le,[...e[15]||(e[15]=[l("div",null,"Загрузка данных...",-1)])]))}};export{te as default};
