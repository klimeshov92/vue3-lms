import{r as p,a as I,B as j,X as S,o as w,c as a,b as P,d as l,k as R,i,u as F,h as u,j as d,l as c}from"./index-yfpLmCCm.js";const $={key:0},q={key:0,class:"detail-page"},C={key:0},U={class:"scorm-player"},B=["src"],O={key:1,class:"none-container"},z={key:1,class:"loading"},N={key:1,class:"loading"},D={__name:"ScormContent",setup(T){const m=R(),g=F(),_=p(!1),r=I({object:null,globalPermissionsList:[],objectPermissionsDict:{},canPerform:!1}),n=p(null),v=async()=>{const o=m.params.id;let e=localStorage.getItem("access_token");const s=i(e);if(e&&!s){g.push({name:"Login"});return}try{const t=await u.get(`${d}/scorm_content/${o}/`,{headers:{...e&&{Authorization:`Bearer ${e}`}}});console.log("Данные результата:",t.data),r.object=t.data}catch(t){console.error("Ошибка при получении данных результата:",t)}},k=j(()=>{if(!r.object)return"";const o=encodeURIComponent(r.object.task_id),e=encodeURIComponent(r.object.course_id),s=encodeURIComponent(r.object.user_id),t=encodeURIComponent(r.object.type);return`${S}/scorm_wrapper.html?task_id=${o}&course_id=${e}&user_id=${s}&type=${t}`}),b=()=>{if(!n.value){console.warn("Элемент iframe не найден");return}n.value.requestFullscreen?(console.log("Вызван requestFullscreen (стандартный)"),n.value.requestFullscreen()):n.value.mozRequestFullScreen?(console.log("Вызван mozRequestFullScreen (Firefox)"),n.value.mozRequestFullScreen()):n.value.webkitRequestFullscreen?(console.log("Вызван webkitRequestFullscreen (Chrome, Safari, Opera)"),n.value.webkitRequestFullscreen()):n.value.msRequestFullscreen?(console.log("Вызван msRequestFullscreen (IE/Edge)"),n.value.msRequestFullscreen()):console.warn("Полноэкранный режим не поддерживается этим браузером")},y=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let e=localStorage.getItem("access_token");const s=i(e);if(!(!e||!s))try{(await u.get(`${d}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(t){console.error("Ошибка проверки версии прав:",t),localStorage.removeItem("userPermissions")}},h=async()=>{let o=localStorage.getItem("access_token");const e=i(o);if(o&&!e){g.push({name:"Login"});return}try{let s=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",s),Object.keys(s).length>0&&(console.log("ID пользователя в разрешениях из памяти:",s.user_id),!e&&s.user_id!==1||e&&e.user_id!==s.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),s={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(s).length===0){const f=await u.get(`${d}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",f.data),s=f.data,localStorage.setItem("userPermissions",JSON.stringify(s))}r.globalPermissionsList=s.global_permissions||[],r.objectPermissionsDict=s.object_permissions||{};const t=m.params.id;console.log("ID объекта:",t),r.object.status!="failed"&&r.object.status!="canceled"&&(r.canPerform=r.object.user_id==e.user_id),console.log("Редактирование результата:",r.canPerform)}catch(s){console.error("Ошибка при загрузке разрешений пользователя:",s)}};return w(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await v(),await y(),await h(),_.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,e)=>_.value?(c(),a("div",$,[r.canPerform?(c(),a("div",q,[r.object.course_id?(c(),a("div",C,[l("button",{onClick:b,class:"fullscreen-btn"}," На весь экран "),l("div",U,[l("iframe",{ref_key:"scormIframe",ref:n,class:"scorm-player-iframe",src:k.value,allowfullscreen:"",webkitallowfullscreen:""},null,8,B)])])):r.object.id?P("",!0):(c(),a("div",O,[...e[0]||(e[0]=[l("div",{class:"none-card"},[l("div",null,"Объект не найден.")],-1)])]))])):(c(),a("div",z,[...e[1]||(e[1]=[l("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(c(),a("div",N,[...e[2]||(e[2]=[l("div",null,"Загрузка данных...",-1)])]))}};export{D as default};
