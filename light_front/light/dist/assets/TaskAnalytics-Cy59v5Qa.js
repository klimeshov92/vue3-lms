import{r as P,a as D,o as ee,c as r,d as t,b as c,f as y,C as I,t as u,w as f,p as A,v as U,m as b,F,E,i as k,u as te,h as V,j as x,k as se,g as le,l as i}from"./index-B3ZHU6wM.js";import{s as $}from"./custom-multiselect-DDQ9gWBN.js";const oe={key:0},ae={key:0,class:"analytic-page"},ne={class:"analytic-form",id:"analytic-form"},re={class:"form-field"},ie={key:0,class:"error"},de={key:0,class:"form-field"},ue={key:0,class:"error"},ce={key:1,class:"form-field"},pe={key:0,class:"error"},me={key:2,class:"form-field"},_e={key:0,class:"error"},be={key:3,class:"form-field"},ve={key:0,class:"error"},ge={key:4,class:"form-field"},fe={key:0,class:"error"},ye={key:5,class:"form-field"},ke={key:0,class:"error"},Ve={key:6,class:"form-field"},xe={key:0,class:"error"},we={key:7,class:"form-field"},Se={key:0,class:"error"},Ie={class:"analytic-menu button-group"},$e={class:"analytic-content"},Oe={key:0,class:"analytic-info"},Te={class:"test-section-tab-flex"},je={class:"test-section-tab-item"},Pe={class:"test-section-tab-item-detail"},Ae={class:"test-section-tab-item-detail-elem"},Ue={class:"test-section-tab-item-detail-elem"},he={class:"test-section-tab-item"},Be={class:"test-section-tab-item-detail"},Ne={class:"test-section-tab-item-detail-elem"},De={class:"test-section-tab-item-detail-elem"},Le={class:"test-section-tab-item-detail-elem"},ze={class:"test-section-tab-item-detail-elem"},Ce={class:"test-section-tab-item-detail-elem"},Re={class:"test-section-tab-item-detail-elem"},Je={class:"test-section-tab-item"},Fe={key:0,class:"test-section-tab-item-detail"},Ee={class:"test-section-tab-item-detail-label"},Me={key:1,class:"none-border-container"},qe={class:"test-section-tab-item"},Ge={class:"test-section-table_container"},He={key:0,class:"test-section-table-outer"},Ke={class:"test-section-table-inner"},Qe={class:"test-section-menu"},We={key:1},Xe={key:1,class:"none-card"},Ye={key:1,class:"loading"},Ze={key:1,class:"loading"},lt={__name:"TaskAnalytics",setup(et){se();const O=te(),T=P(!1),M=[{label:"По шаблону задачи",value:"task_template"}],q=[{label:"Все",value:"all"},{label:"Группа",value:"group"},{label:"Аккаунт",value:"account"}],s=D({report:"",task_template:null,executor_type:"",group:null,account:null,planned_start_gte:null,planned_start_lte:null,planned_end_gte:null,planned_end_lte:null}),a=D({results:[]}),h=P([]),G=async()=>{let n=localStorage.getItem("access_token");const e=k(n);if(n&&!e){O.push({name:"Login"});return}try{const l=await V.get(`${x}/task_templates/`,{headers:{Authorization:`Bearer ${n}`}});h.value=(l.data.results||[]).filter(p=>!p.is_child),console.log("Шаблоны задач загружены:",h.value)}catch(l){console.error("Ошибка при загрузке шаблонов задач:",l.response?l.response.data:l.message)}},B=P([]),H=async()=>{let n=localStorage.getItem("access_token");const e=k(n);if(n&&!e){O.push({name:"Login"});return}try{const l=await V.get(`${x}/accounts/`,{headers:{Authorization:`Bearer ${n}`}});B.value=l.data.results||[],console.log("Аккаунты загружены:",B.value)}catch(l){console.error("Ошибка при загрузке сотрудников:",l.response?l.response.data:l.message)}},N=P([]),K=async()=>{let n=localStorage.getItem("access_token");const e=k(n);if(n&&!e){O.push({name:"Login"});return}try{const l=await V.get(`${x}/account_groups/`,{headers:{Authorization:`Bearer ${n}`}});N.value=l.data.results||[],console.log("Группы загружены:",N.value)}catch(l){console.error("Ошибка при загрузке групп:",l.response?l.response.data:l.message)}},d=D({}),Q=()=>{var n,e,l,p,v;return d.report=(n=s.report)!=null&&n.value?"":"Выберите отчет",((e=s.report)==null?void 0:e.value)==="task_template"&&(d.task_template=s.task_template?"":"Выберите шаблон задачи"),d.executor_type=(l=s.executor_type)!=null&&l.value?"":"Выберите тип исполнителя",((p=s.executor_type)==null?void 0:p.value)==="group"&&(d.group=s.group?"":"Выберите группу"),((v=s.executor_type)==null?void 0:v.value)==="account"&&(d.account=s.account?"":"Выберите аккаунт"),Object.values(d).every(g=>!g)},W=async()=>{var n,e,l,p,v,g,w;if(!Q()){console.error("Форма содержит ошибки:",d);return}T.value=!1;try{console.log("Отправляем данные для создания объекта:",s);let _=localStorage.getItem("access_token");const j=k(_);if(_&&!j){O.push({name:"Login"});return}const m={report:(n=s.report)==null?void 0:n.value};if(((e=s.report)==null?void 0:e.value)==="task_template"){m.task_template=(l=s.task_template)==null?void 0:l.id,m.executor_type=s.executor_type.value,((p=s.executor_type)==null?void 0:p.value)==="group"&&(m.group=(v=s.group)==null?void 0:v.id),((g=s.executor_type)==null?void 0:g.value)==="account"&&(m.account=(w=s.account)==null?void 0:w.id),m.planned_start_gte=s.planned_start_gte,m.planned_start_lte=s.planned_start_lte,m.planned_end_gte=s.planned_end_gte,m.planned_end_lte=s.planned_end_lte,console.log("JSON данные перед отправкой:",m);const S=await V.post(`${x}/analytics_task_template/`,m,{headers:{Authorization:`Bearer ${_}`}});console.log("Данные отчеты:",S.data),a.results=S.data}T.value=!0}catch(_){_.response&&_.response.data?(Object.assign(d,_.response.data),console.error("Ошибка при создании объекта:",_.response.data)):console.error("Ошибка при создании объекта:",_.message)}},X=()=>{console.log("Сбрасываем фильтры"),s.report="",s.task_template=null,s.executor_type="",s.group=null,s.account=null,s.planned_start_gte="",s.planned_start_lte="",s.planned_end_gte="",s.planned_end_lte="",a.results=[]},Y=async()=>{console.log("Проверяем версию прав");const n=JSON.parse(localStorage.getItem("userPermissions"));if(!(n!=null&&n.permissions_version))return;console.log("Текущая версия прав:",n.permissions_version);let e=localStorage.getItem("access_token");const l=k(e);if(!(!e||!l))try{(await V.get(`${x}/user_permissions_version/${n.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(p){console.error("Ошибка проверки версии прав:",p),localStorage.removeItem("userPermissions")}},Z=async()=>{let n=localStorage.getItem("access_token");const e=k(n);n&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),n=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!e&&l.user_id!==1||e&&e.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const p=await V.get(`${x}/user_permissions/`,{headers:{...n&&{Authorization:`Bearer ${n}`}}});console.log("Разрешения пользователя загружены:",p.data),l=p.data,localStorage.setItem("userPermissions",JSON.stringify(l))}a.globalPermissionsList=l.global_permissions||[],a.objectPermissionsDict=l.object_permissions||{},a.canViewAnalytic=a.globalPermissionsList.includes("bpms.view_analytics")||!!a.objectPermissionsDict["core.view_category"],console.log("Права на просмотр аналитики:",a.canViewAnalytic)}catch(l){console.error("Ошибка при получении разрешений пользователя:",l)}};return ee(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await G(),await K(),await H(),await Y(),await Z(),T.value=!0}catch(n){console.error("Ошибка при загрузке данных:",n)}}),(n,e)=>{var p,v,g,w,_,j,m,S;const l=le("router-link");return T.value?(i(),r("div",oe,[a.canViewAnalytic?(i(),r("div",ae,[e[46]||(e[46]=t("div",{class:"analytic-header"},[t("h1",null,"Аналитика по задачам")],-1)),t("form",ne,[t("div",re,[e[10]||(e[10]=t("label",{class:"form-label"},"Отчет:",-1)),y(I($),{modelValue:s.report,"onUpdate:modelValue":e[0]||(e[0]=o=>s.report=o),options:M,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите отчет",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),d.report?(i(),r("span",ie,u(d.report),1)):c("",!0)]),((p=s.report)==null?void 0:p.value)=="task_template"?(i(),r("div",de,[e[13]||(e[13]=t("label",{class:"form-label"},"Шаблон задачи:",-1)),y(I($),{modelValue:s.task_template,"onUpdate:modelValue":e[1]||(e[1]=o=>s.task_template=o),options:h.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:f(()=>[...e[11]||(e[11]=[t("span",null,"Список пуст",-1)])]),noResult:f(()=>[...e[12]||(e[12]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),d.task_template?(i(),r("span",ue,u(d.task_template),1)):c("",!0)])):c("",!0),((v=s.report)==null?void 0:v.value)=="task_template"?(i(),r("div",ce,[e[14]||(e[14]=t("label",{class:"form-label"},"Исполнители:",-1)),y(I($),{modelValue:s.executor_type,"onUpdate:modelValue":e[2]||(e[2]=o=>s.executor_type=o),options:q,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип исполнителя",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),d.executor_type?(i(),r("span",pe,u(d.executor_type),1)):c("",!0)])):c("",!0),((g=s.executor_type)==null?void 0:g.value)=="group"?(i(),r("div",me,[e[17]||(e[17]=t("label",{class:"form-label"},"Группа:",-1)),y(I($),{modelValue:s.group,"onUpdate:modelValue":e[3]||(e[3]=o=>s.group=o),options:N.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите группу исполнителей",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:f(()=>[...e[15]||(e[15]=[t("span",null,"Список пуст",-1)])]),noResult:f(()=>[...e[16]||(e[16]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),d.group?(i(),r("span",_e,u(d.group),1)):c("",!0)])):c("",!0),((w=s.executor_type)==null?void 0:w.value)=="account"?(i(),r("div",be,[e[20]||(e[20]=t("label",{class:"form-label"},"Исполнитель:",-1)),y(I($),{modelValue:s.account,"onUpdate:modelValue":e[4]||(e[4]=o=>s.account=o),options:B.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите исполнителя",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:f(()=>[...e[18]||(e[18]=[t("span",null,"Список пуст",-1)])]),noResult:f(()=>[...e[19]||(e[19]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),d.account?(i(),r("span",ve,u(d.account),1)):c("",!0)])):c("",!0),((_=s.report)==null?void 0:_.value)=="task_template"?(i(),r("div",ge,[e[21]||(e[21]=t("label",{for:"planned_start_gte",class:"form-label"},"Планируемое начало не ранее:",-1)),A(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>s.planned_start_gte=o),id:"planned_start_gte",type:"datetime-local",class:"form-input"},null,512),[[U,s.planned_start_gte]]),d.planned_start_gte?(i(),r("span",fe,u(d.planned_start_gte),1)):c("",!0)])):c("",!0),((j=s.report)==null?void 0:j.value)=="task_template"?(i(),r("div",ye,[e[22]||(e[22]=t("label",{for:"planned_start_lte",class:"form-label"},"Планируемое начало не позднее:",-1)),A(t("input",{"onUpdate:modelValue":e[6]||(e[6]=o=>s.planned_start_lte=o),id:"planned_start_lte",type:"datetime-local",class:"form-input"},null,512),[[U,s.planned_start_lte]]),d.planned_start_lte?(i(),r("span",ke,u(d.planned_start_lte),1)):c("",!0)])):c("",!0),((m=s.report)==null?void 0:m.value)=="task_template"?(i(),r("div",Ve,[e[23]||(e[23]=t("label",{for:"planned_end_gte",class:"form-label"},"Планируемое завершение не ранее:",-1)),A(t("input",{"onUpdate:modelValue":e[7]||(e[7]=o=>s.planned_end_gte=o),id:"planned_end_gte",type:"datetime-local",class:"form-input"},null,512),[[U,s.planned_end_gte]]),d.planned_end_gte?(i(),r("span",xe,u(d.planned_end_gte),1)):c("",!0)])):c("",!0),((S=s.report)==null?void 0:S.value)=="task_template"?(i(),r("div",we,[e[24]||(e[24]=t("label",{for:"planned_end_lte",class:"form-label"},"Планируемое завершение не позднее:",-1)),A(t("input",{"onUpdate:modelValue":e[8]||(e[8]=o=>s.planned_end_lte=o),id:"planned_end_lte",type:"datetime-local",class:"form-input"},null,512),[[U,s.planned_end_lte]]),d.planned_end_lte?(i(),r("span",Se,u(d.planned_end_lte),1)):c("",!0)])):c("",!0)]),t("div",Ie,[t("button",{onClick:e[9]||(e[9]=o=>W()),class:"button"},"Сформировать отчет"),t("button",{onClick:X,class:"button"},"Сбросить отчет")]),t("div",$e,[a.results.length!==0?(i(),r("div",Oe,[t("div",Te,[t("div",je,[e[27]||(e[27]=t("div",{class:"test-section-tab-item-top"},[t("div",{class:"test-section-tab-item-title"},[t("h2",null," Общая ")])],-1)),t("div",Pe,[t("div",Ae,[e[25]||(e[25]=t("span",{class:"test-section-tab-item-detail-label"},"Всего:",-1)),b(" "+u(a.results?a.results.tasks_started:"Нет данных"),1)]),t("div",Ue,[e[26]||(e[26]=t("span",{class:"test-section-tab-item-detail-label"},"Завершено:",-1)),b(" "+u(a.results?a.results.tasks_finished:"Нет данных"),1)])]),e[28]||(e[28]=t("div",{class:"test-section-tab-item-menu-outer"},null,-1))]),t("div",he,[e[35]||(e[35]=t("div",{class:"test-section-tab-item-top"},[t("div",{class:"test-section-tab-item-title"},[t("h2",null," Статусы ")])],-1)),t("div",Be,[t("div",Ne,[e[29]||(e[29]=t("span",{class:"test-section-tab-item-detail-label"},"В ожидании:",-1)),b(" "+u(a.results.statuses?a.results.statuses.waiting:"Нет данных"),1)]),t("div",De,[e[30]||(e[30]=t("span",{class:"test-section-tab-item-detail-label"},"Назначено:",-1)),b(" "+u(a.results.statuses?a.results.statuses.assigned:"Нет данных"),1)]),t("div",Le,[e[31]||(e[31]=t("span",{class:"test-section-tab-item-detail-label"},"В процессе:",-1)),b(" "+u(a.results.statuses?a.results.statuses.in_progress:"Нет данных"),1)]),t("div",ze,[e[32]||(e[32]=t("span",{class:"test-section-tab-item-detail-label"},"Выполнено:",-1)),b(" "+u(a.results.statuses?a.results.statuses.completed:"Нет данных"),1)]),t("div",Ce,[e[33]||(e[33]=t("span",{class:"test-section-tab-item-detail-label"},"Провалено:",-1)),b(" "+u(a.results.statuses?a.results.statuses.failed:"Нет данных"),1)]),t("div",Re,[e[34]||(e[34]=t("span",{class:"test-section-tab-item-detail-label"},"Отменено:",-1)),b(" "+u(a.results.statuses?a.results.statuses.canceled:"Нет данных"),1)])]),e[36]||(e[36]=t("div",{class:"test-section-tab-item-menu-outer"},null,-1))]),t("div",Je,[e[38]||(e[38]=t("div",{class:"test-section-tab-item-top"},[t("div",{class:"test-section-tab-item-title"},[t("h2",null," Итоги ")])],-1)),a.results.outcomes&&a.results.outcomes.length>0?(i(),r("div",Fe,[(i(!0),r(F,null,E(a.results.outcomes,o=>(i(),r("div",{key:o.id,class:"test-section-tab-item-detail-elem"},[t("span",Ee,u(o.name?o.name:"Нет данных")+":",1),b(" "+u(o.count?o.count:"Нет данных"),1)]))),128))])):(i(),r("div",Me,[...e[37]||(e[37]=[t("div",{class:"none-border-mini"},"Нет итогов задач ",-1)])])),e[39]||(e[39]=t("div",{class:"test-section-tab-item-menu-outer"},null,-1))]),t("div",qe,[e[43]||(e[43]=t("div",{class:"test-section-tab-item-top"},[t("div",{class:"test-section-tab-item-title"},[t("h2",null," Список ")])],-1)),t("div",Ge,[a.results.tasks&&a.results.tasks.length>0?(i(),r("div",He,[t("div",Ke,[t("table",null,[e[41]||(e[41]=t("thead",null,[t("tr",null,[t("th",null,"Взаимодействие"),t("th",null,"Исполнитель"),t("th",null,"Статус"),t("th",null,"Итог"),t("th",null," Действия ")])],-1)),t("tbody",null,[(i(!0),r(F,null,E(a.results.tasks,o=>{var L,z,C,R,J;return i(),r("tr",{key:o.id},[t("td",null,u((L=o.interaction)!=null&&L.str?o.interaction.str:"-"),1),t("td",null,u((z=o.executor)!=null&&z.str?o.executor.str:"-"),1),t("td",null,u((C=o.result)!=null&&C.status_display?o.result.status_display:"-"),1),t("td",null,u((J=(R=o.result)==null?void 0:R.outcome)!=null&&J.str?o.result.outcome.str:"-"),1),t("td",null,[t("div",null,[t("div",Qe,[y(l,{to:{name:"TaskDetail",params:{id:o.id},query:{tab:"desc"}},class:"test-section-button"},{default:f(()=>[...e[40]||(e[40]=[b(" Подробнее ",-1)])]),_:1},8,["to"])])])])])}),128))])])])])):(i(),r("div",We,[...e[42]||(e[42]=[t("div",{class:"none-border-mini"},"Нет задач ",-1)])]))]),e[44]||(e[44]=t("div",{class:"test-section-tab-item-menu-outer"},null,-1))])])])):(i(),r("div",Xe,[...e[45]||(e[45]=[t("div",null,"Сформируйте отчет",-1)])]))])])):(i(),r("div",Ye,[...e[47]||(e[47]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),r("div",Ze,[...e[48]||(e[48]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{lt as default};
