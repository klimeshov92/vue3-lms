import{r as u,a as j,o as E,c as i,d as t,b as y,t as _,f as x,D as B,w as D,p as F,v as O,n as M,i as $,u as q,h as v,j as g,k as P,q as J,l as c}from"./index-yfpLmCCm.js";import{s as S}from"./custom-multiselect-BtCJ6pih.js";const Z={key:0},G={key:0,class:"form-page"},H={class:"form-field"},K={key:0,class:"avatar-preview"},Q=["href"],W={class:"form-field"},X={key:0,class:"upload_file-preview"},Y=["href"],ee={class:"form-field"},te={key:0,class:"error"},ae={class:"form-field"},se={class:"form-field"},oe={key:0,class:"error"},le={class:"form-field"},re={key:1,class:"none-card"},ne={key:1,class:"loading"},de={__name:"CourseEdit",setup(ie){const C=P(),d=q(),n=u(null),o=j({constructor_type:"",name:"",desc:"",categories:[]}),V=u(!1),U=[{label:"Ispring",value:"ispring"},{label:"Articulate",value:"articulate"},{label:"Scroll",value:"scroll"}],k=u([]),A=async()=>{let a=localStorage.getItem("access_token");const e=$(a);if(a&&!e){d.push({name:"Login"});return}try{const s=await v.get(`${g}/categories/`,{headers:{Authorization:`Bearer ${a}`}});k.value=s.data.results||[],console.log("Категории загружены:",k.value)}catch(s){console.error("Ошибка при загрузке категорий:",s.response?s.response.data:s.message)}},L=async()=>{var f;const a=C.params.id;let e=localStorage.getItem("access_token");const s=$(e);if(e&&!s){d.push({name:"Login"});return}try{const l=await v.get(`${g}/courses/${a}/`,{headers:{Authorization:`Bearer ${e}`}});n.value=l.data,console.log("Объект успешно загружен:",n.value),n.value.constructor_type=U.find(m=>m.value===n.value.constructor_type),console.log("Объект нормализован:",n.value),Object.assign(o,n.value),p.value=n.value.upload_file||""}catch(l){console.error("Ошибка загрузки объекта:",((f=l.response)==null?void 0:f.data)||l.message)}},h=u(null),p=u(null),R=a=>{const e=a.target.files[0];e&&(h.value=e,p.value=URL.createObjectURL(e))},w=u(null),b=u(null),T=a=>{const e=a.target.files[0];e&&(w.value=e,b.value=URL.createObjectURL(e))},r=j({}),z=()=>(r.constructor_type=o.constructor_type.value?"":"Тип курса обязателен!",r.name=o.name?"":"Название обязательно!",Object.values(r).every(a=>!a)),I=async()=>{if(!z()){console.error("Форма содержит ошибки:",r);return}try{const a=C.params.id;let e=localStorage.getItem("access_token");const s=$(e);if(e&&!s){d.push({name:"Login"});return}const f={constructor_type:o.constructor_type.value,name:o.name,desc:o.desc,categories:o.categories.map(l=>l.id)};if(console.log("JSON данные перед отправкой:",f),await v.patch(`${g}/courses/${a}/`,f,{headers:{Authorization:`Bearer ${e}`}}),console.log("Данные обновлены"),h.value){const l=new FormData;l.append("upload_file",h.value);const m=`${g}/courses/${a}/`;await v.patch(m,l,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}}),console.log("Файл успешно обновлен")}if(w.value){const l=new FormData;l.append("avatar",w.value);const m=`${g}/courses/${a}/`;await v.patch(m,l,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}}),console.log("Аватар успешно обновлен")}console.log("Изменения сохранены"),d.push({name:"CourseDetail",params:{id:a}})}catch(a){a.response&&a.response.data?(Object.assign(r,a.response.data),console.error("Ошибка при сохранении изменений:",a.response.data)):console.error("Ошибка при сохранении изменений:",a.message)}},N=()=>{J(d)};return E(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await A(),await L(),V.value=!0}catch(a){console.error("Ошибка при загрузке данных:",a)}}),(a,e)=>V.value?(c(),i("div",Z,[n.value?(c(),i("div",G,[e[15]||(e[15]=t("div",{class:"form-header"},[t("h1",null,"Редактирование курса")],-1)),t("form",{onSubmit:M(I,["prevent"]),class:"form",id:"edit-form"},[t("div",H,[e[5]||(e[5]=t("label",{for:"avatar",class:"form-label"},"Аватар:",-1)),t("input",{type:"file",id:"avatar",onChange:T,class:"form-input"},null,32),b.value?(c(),i("div",K,[e[4]||(e[4]=t("span",{class:"avatar-preview-text"},"Текущий аватар:",-1)),t("a",{href:b.value,target:"_blank",class:"link"},_(b.value),9,Q)])):y("",!0)]),t("div",W,[e[7]||(e[7]=t("label",{for:"upload_file",class:"form-label"},"Загружаемый курс:",-1)),t("input",{type:"file",id:"upload_file",onChange:R,class:"form-input"},null,32),p.value?(c(),i("div",X,[e[6]||(e[6]=t("span",{class:"upload_file-preview-text"},"Текущий курс:",-1)),t("a",{href:p.value,target:"_blank",class:"link"},_(p.value),9,Y)])):y("",!0)]),t("div",ee,[e[8]||(e[8]=t("label",{class:"form-label"},"Тип курса:",-1)),x(B(S),{modelValue:o.constructor_type,"onUpdate:modelValue":e[0]||(e[0]=s=>o.constructor_type=s),options:U,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип курса",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),r.constructor_type?(c(),i("span",te,_(r.constructor_type),1)):y("",!0)]),t("div",ae,[e[11]||(e[11]=t("label",{class:"form-label"},"Категории:",-1)),x(B(S),{modelValue:o.categories,"onUpdate:modelValue":e[1]||(e[1]=s=>o.categories=s),options:k.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:D(()=>[...e[9]||(e[9]=[t("span",null,"Список пуст",-1)])]),noResult:D(()=>[...e[10]||(e[10]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),t("div",se,[e[12]||(e[12]=t("label",{for:"name",class:"form-label"},"Название:",-1)),F(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>o.name=s),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[O,o.name]]),r.name?(c(),i("span",oe,_(r.name),1)):y("",!0)]),t("div",le,[e[13]||(e[13]=t("label",{for:"desc",class:"form-label"},"Описание:",-1)),F(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=s=>o.desc=s),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[O,o.desc]])])],32),t("div",{class:"form-menu button-group"},[e[14]||(e[14]=t("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),t("button",{type:"button",onClick:N,class:"button"},"Отмена")])])):(c(),i("div",re,[...e[16]||(e[16]=[t("div",null,"Объект не найден",-1)])]))])):(c(),i("div",ne,[...e[17]||(e[17]=[t("div",null,"Загрузка данных...",-1)])]))}};export{de as default};
