import{r as k,a as b,o as h,c as n,b as l,d as i,t as f,e as j,w as _,f as S,g as w,i as c,u as I,h as d,j as g,k as A,l as a,m as P}from"./index-BlU-7-2d.js";const V={key:0},L={key:0,class:"detail-page"},N={key:0},B={class:"detail-card"},E={class:"detail-card-info"},T={class:"detail-header"},$={class:"detail-header-title"},D={class:"material-content"},O=["innerHTML"],x={key:0,class:"detail-menu button-group"},C={key:1,class:"none-container"},z={key:0,class:"detail-menu button-group none-menu-padding"},J={key:1,class:"loading"},M={key:1,class:"loading"},U={__name:"PolicyPage",setup(H){A();const u=I(),m=k(!1),s=b({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewPolicyPage:!1,canEditPolicyPage:!1,canAddPolicyPage:!1}),y=async()=>{let t=localStorage.getItem("access_token");const e=c(t);if(t&&!e){u.push({name:"Login"});return}try{const o=await d.get(`${g}/policy_page_content/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные результата:",o.data),s.object=o.data}catch(o){console.error("Ошибка при получении данных страницы:",o)}},p=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let e=localStorage.getItem("access_token");const o=c(e);if(!(!e||!o))try{(await d.get(`${g}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(r){console.error("Ошибка проверки версии прав:",r),localStorage.removeItem("userPermissions")}},v=async()=>{let t=localStorage.getItem("access_token");const e=c(t);if(t&&!e){u.push({name:"Login"});return}try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!e&&o.user_id!==1||e&&e.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const r=await d.get(`${g}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",r.data),o=r.data,localStorage.setItem("userPermissions",JSON.stringify(o))}s.globalPermissionsList=o.global_permissions||[],s.objectPermissionsDict=o.object_permissions||{},s.canViewPolicyPage=!0,s.canAddPolicyPage=s.globalPermissionsList.includes("core.add_policy_page"),console.log("Права на добавление страницы:",s.canAddPolicyPage),s.canEditPolicyPage=s.globalPermissionsList.includes("core.change_policy_page")||Array.isArray(s.objectPermissionsDict["core.change_policy_page"])&&s.objectPermissionsDict["core.change_policy_page"].includes(Number(id)),console.log("Права на редактирование страницы:",s.canEditPolicyPage)}catch(o){console.error("Ошибка при загрузке разрешений пользователя:",o)}};return h(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await y(),await p(),await v(),m.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,e)=>{const o=w("router-link");return m.value?(a(),n("div",V,[s.canViewPolicyPage?(a(),n("div",L,[s.object.id?(a(),n("div",N,[i("div",B,[i("div",E,[i("div",T,[i("div",$,[i("h1",null,f(s.object.title||"Безымянный материал"),1)])]),i("div",D,[i("div",{innerHTML:s.object.content,class:"tiptap"},null,8,O)]),s.canEditPolicyPage?(a(),n("div",x,[s.canEditPolicyPage?(a(),j(o,{key:0,to:{name:"PolicyPageEdit",params:{id:s.object.id}},class:"button"},{default:_(()=>[...e[0]||(e[0]=[P(" Изменить ",-1)])]),_:1},8,["to"])):l("",!0)])):l("",!0),e[1]||(e[1]=i("div",null,null,-1))])])])):s.object.id?l("",!0):(a(),n("div",C,[e[3]||(e[3]=i("div",{class:"none-card"},[i("div",null,"Объект не найден.")],-1)),s.canAddPolicyPage?(a(),n("div",z,[S(o,{to:{name:"PolicyPageCreate"},class:"button"},{default:_(()=>[...e[2]||(e[2]=[P(" Создать ",-1)])]),_:1})])):l("",!0)]))])):(a(),n("div",J,[...e[4]||(e[4]=[i("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),n("div",M,[...e[5]||(e[5]=[i("div",null,"Загрузка данных...",-1)])]))}}};export{U as default};
