import{r as y,a as L,A as x,k as C,B,o as G,c,b as d,d as s,t as l,m as r,e as N,w as T,F as E,E as M,C as I,G as f,f as A,i as _,h as g,j as p,g as z,u as J,l as i,H as q}from"./index-C7lVKHoT.js";import{_ as F,a as R}from"./AccountsGroupObjectPermissions-Bs4p9YWR.js";import"./EditorComponent-vmM3im-r.js";const U={key:0},H={key:0,class:"detail-page"},K={key:0},Q={class:"detail-card"},W={class:"detail-card-info"},X={class:"detail-header"},Y={class:"detail-header-title"},Z={class:"detail-card-text"},ee={class:"detail-card-text-elem"},te={key:0,class:"detail-card-text-elem"},se={key:1,class:"detail-card-text-elem"},oe={class:"detail-card-text-elem"},ae={class:"detail-menu button-group"},ne={key:0,class:"modal-overlay"},ie={class:"modal"},ce={class:"modal-header"},le={class:"modal-header-h2"},re={class:"minibutton-group modal-menu"},de={class:"detail-tabs"},be={class:"tabs-header"},ue=["onClick"],me={key:0,class:"tabs-content"},_e={key:0,class:"detail-tab"},ge={class:"detail-tab-elem"},pe={key:0,class:"detail-tab-elem"},je={key:1,class:"detail-tab-elem"},ve={class:"detail-tab-elem"},ke={class:"detail-tab-elem"},ye={class:"detail-tab-elem"},Pe={class:"detail-tab-elem"},he={class:"detail-tab-elem"},Ie={class:"detail-tab-elem"},fe={key:1,class:"table-tab"},Ae={key:2,class:"table-tab"},Oe={key:1,class:"none-container"},we={key:1,class:"loading"},De={key:1,class:"loading"},xe={__name:"InteractionDetail",setup(Se){const u=C(),m=J(),P=y(!1),e=L({object:null,globalPermissionsList:[],objectPermissionsDict:{},canAddInteraction:!1,canViewInteraction:!1,canEditInteraction:!1}),j=async()=>{const a=u.params.id;let t=localStorage.getItem("access_token");const n=_(t);t&&!n&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const o=await g.get(`${p}/interactions/${a}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные задачи:",o.data),e.object=o.data}catch(o){console.error("Ошибка при получении данных задачи:",o)}},v=y(!1),O=()=>{v.value=!0},h=()=>{v.value=!1},w=async()=>{let a=localStorage.getItem("access_token");const t=_(a);if(a&&!t){m.push({name:"Login"});return}const n=u.params.id;try{await g.delete(`${p}/interactions/${n}/`,{headers:{Authorization:`Bearer ${a}`}}),h(),m.push({name:"InteractionList"})}catch(o){console.error("Ошибка удаления задачи:",o)}},D=async()=>{console.log("Проверяем версию прав");const a=JSON.parse(localStorage.getItem("userPermissions"));if(!(a!=null&&a.permissions_version))return;console.log("Текущая версия прав:",a.permissions_version);let t=localStorage.getItem("access_token");const n=_(t);if(!(!t||!n))try{(await g.get(`${p}/user_permissions_version/${a.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(o){console.error("Ошибка проверки версии прав:",o),localStorage.removeItem("userPermissions")}},S=async()=>{let a=localStorage.getItem("access_token");const t=_(a);a&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),a=null);try{let n=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",n),Object.keys(n).length>0&&(console.log("ID пользователя в разрешениях из памяти:",n.user_id),!t&&n.user_id!==1||t&&t.user_id!==n.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),n={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(n).length===0){const k=await g.get(`${p}/user_permissions/`,{headers:{...a&&{Authorization:`Bearer ${a}`}}});console.log("Разрешения пользователя загружены:",k.data),n=k.data,localStorage.setItem("userPermissions",JSON.stringify(n))}e.globalPermissionsList=n.global_permissions||[],e.objectPermissionsDict=n.object_permissions||{};const o=u.params.id;console.log("ID объекта:",o),e.canAddInteraction=e.globalPermissionsList.includes("bpms.add_interaction"),console.log("Права на добавление задач:",e.canAddInteraction),e.canViewInteraction=e.globalPermissionsList.includes("bpms.view_interaction")||e.objectPermissionsDict["bpms.view_interaction"]&&e.objectPermissionsDict["bpms.view_interaction"].includes(Number(o)),console.log("Права на просмотр задачи:",e.canViewInteraction),e.canEditInteraction=e.globalPermissionsList.includes("bpms.change_interaction")||Array.isArray(e.objectPermissionsDict["bpms.change_interaction"])&&e.objectPermissionsDict["bpms.change_interaction"].includes(Number(o)),console.log("Права на редактирование задачи:",e.canEditInteraction),e.canDeleteInteraction=e.globalPermissionsList.includes("bpms.delete_interaction")||Array.isArray(e.objectPermissionsDict["bpms.delete_interaction"])&&e.objectPermissionsDict["bpms.delete_interaction"].includes(Number(o)),console.log("Права на удаление задачи:",e.canDeleteInteraction),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(n){console.error("Ошибка при загрузке разрешений пользователя:",n)}},$=()=>{m.back()},V=x(()=>[{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=y(u.query.tab||localStorage.getItem(`activeInteractionTab-${u.params.id}`)||"details");return B(b,a=>{localStorage.setItem(`activeInteractionTab-${u.params.id}`,a),m.push({query:{tab:a}}),console.log("Загружен таб:",a)}),G(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await j(),await D(),await S(),P.value=!0}catch(a){console.error("Ошибка при загрузке данных:",a)}}),(a,t)=>{const n=z("router-link");return P.value?(i(),c("div",U,[e.canViewInteraction?(i(),c("div",H,[e.object.id?(i(),c("div",K,[s("div",Q,[s("div",W,[s("div",X,[s("div",Y,[s("h1",null,l(e.object.id||"Безымянное взаимодействие"),1)])]),s("div",Z,[s("div",ee,[t[1]||(t[1]=s("span",{class:"detail-card-text-label"},"Тип задачи:",-1)),r(" "+l(e.object.object_type_display||"Нет типа объекта"),1)]),e.object.object_type=="client"?(i(),c("div",te,[t[2]||(t[2]=s("span",{class:"detail-card-text-label"},"Клиент:",-1)),r(" "+l(e.object.client?e.object.client.str:"Нет итога"),1)])):d("",!0),e.object.object_type=="account"?(i(),c("div",se,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Клиент:",-1)),r(" "+l(e.object.account?e.object.account.str:"Нет итога"),1)])):d("",!0),s("div",oe,[t[4]||(t[4]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),r(" "+l(e.object.categories.length>0?e.object.categories.map(o=>o.name).join(", "):"Нет категорий"),1)])]),s("div",ae,[e.canEditInteraction?(i(),N(n,{key:0,to:{name:"InteractionEdit",params:{id:e.object.id}},class:"button"},{default:T(()=>[...t[5]||(t[5]=[r(" Изменить ",-1)])]),_:1},8,["to"])):d("",!0),e.canDeleteInteraction?(i(),c("button",{key:1,onClick:O,class:"button"}," Удалить ")):d("",!0),s("button",{type:"button",onClick:$,class:"button"},"Назад")]),v.value?(i(),c("div",ne,[s("div",ie,[s("div",ce,[s("h2",le,"Удаление "+l(e.object.name||"Безымянный задача"),1)]),s("div",re,[s("button",{onClick:t[0]||(t[0]=o=>w()),class:"minibutton"},"Подтвердить"),s("button",{onClick:h,class:"minibutton"},"Отменить")])])])):d("",!0)])]),s("div",de,[s("div",be,[(i(!0),c(E,null,M(V.value,o=>(i(),c("button",{key:o.name,class:q([{active:b.value===o.name},"tab-button"]),onClick:k=>b.value=o.name},l(o.label),11,ue))),128))]),b.value?(i(),c("div",me,[b.value==="details"?(i(),c("div",_e,[s("div",ge,[t[6]||(t[6]=s("span",{class:"detail-tab-label"},"Тип задачи:",-1)),r(" "+l(e.object.object_type_display||"Нет типа объекта"),1)]),e.object.object_type=="client"?(i(),c("div",pe,[t[7]||(t[7]=s("span",{class:"detail-tab-label"},"Клиент:",-1)),r(" "+l(e.object.client?e.object.client.str:"Нет итога"),1)])):d("",!0),e.object.object_type=="account"?(i(),c("div",je,[t[8]||(t[8]=s("span",{class:"detail-tab-label"},"Клиент:",-1)),r(" "+l(e.object.account?e.object.account.str:"Нет итога"),1)])):d("",!0),s("div",ve,[t[9]||(t[9]=s("span",{class:"detail-tab-label"},"Категории:",-1)),r(" "+l(e.object.categories.length>0?e.object.categories.map(o=>o.name).join(", "):"Нет категорий"),1)]),s("div",ke,[t[10]||(t[10]=s("span",{class:"detail-tab-label"},"Категории:",-1)),r(" "+l(e.object.categories.length>0?e.object.categories.map(o=>o.name).join(", "):"Нет категорий"),1)]),s("div",ye,[t[11]||(t[11]=s("span",{class:"detail-tab-label"},"Создан:",-1)),r(" "+l(e.object.created?I(f)(e.object.created):"Нет данных о создании"),1)]),s("div",Pe,[t[12]||(t[12]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),r(" "+l(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",he,[t[13]||(t[13]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),r(" "+l(e.object.changed?I(f)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Ie,[t[14]||(t[14]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),r(" "+l(e.object.editor?e.object.editor:"Нет редактора"),1)])])):d("",!0),b.value==="accountsGroupObjectPermissions"?(i(),c("div",fe,[A(F,{state:e,fetchObject:j,contentTypeModel:"interaction"},null,8,["state"])])):d("",!0),b.value==="accountObjectPermissions"?(i(),c("div",Ae,[A(R,{state:e,fetchObject:j,contentTypeModel:"interaction"},null,8,["state"])])):d("",!0)])):d("",!0)])])):e.object.id?d("",!0):(i(),c("div",Oe,[...t[15]||(t[15]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(i(),c("div",we,[...t[16]||(t[16]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),c("div",De,[...t[17]||(t[17]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{xe as default};
