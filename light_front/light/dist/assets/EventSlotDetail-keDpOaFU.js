import{r as O,a as X,B as Y,k as Z,C as ee,o as te,c as a,b,d as s,t as i,m as r,D as k,H as f,e as G,w as N,F as z,G as M,f as $,i as y,h,j as P,u as se,g as oe,q as ae,l as o,I as ne}from"./index-D8Gdgylc.js";import{_ as le,a as ie}from"./AccountsGroupObjectPermissions-CSIXTcn_.js";import{_ as ce}from"./TopicMessages-bfW0BDhU.js";import"./EditorComponent-CIG7yrXh.js";const re={key:0},de={key:0,class:"detail-page"},ue={key:0},be={class:"detail-card"},me={class:"detail-card-image-outer"},_e={key:0,class:"detail-card-image-inner"},ve=["src"],pe={key:1,class:"detail-card-image-none"},ge={class:"detail-card-info"},je={class:"detail-header"},ke={class:"detail-header-title"},fe={class:"detail-card-text"},ye={class:"detail-card-text-elem"},he={class:"detail-card-text-elem"},Pe={class:"detail-card-text-elem"},Se={class:"detail-card-text-elem"},Ae={class:"detail-card-text-elem"},we={key:0,class:"detail-card-text-elem"},De={class:"detail-menu button-group"},Oe=["href"],$e={key:0,class:"modal-overlay"},Ee={class:"modal"},Ve={class:"modal-header"},xe={class:"modal-header-h2"},Ie={class:"minibutton-group modal-menu"},Te={class:"detail-tabs"},Le={class:"tabs-header"},Ce=["onClick"],Be={key:0,class:"tabs-content"},Ge={key:0,class:"desc-tab"},Ne={key:0},ze={key:1},Me={key:1,class:"detail-tab"},qe={class:"detail-tab-elem"},Je={class:"detail-tab-elem"},Fe={class:"detail-tab-elem"},Re={class:"detail-tab-elem"},Ue={class:"detail-tab-elem"},He={class:"detail-tab-elem"},Ke={class:"detail-tab-elem"},Qe={key:0,class:"detail-tab-elem"},We={class:"detail-tab-elem"},Xe={class:"detail-tab-elem"},Ye={class:"detail-tab-elem"},Ze={class:"detail-tab-elem"},et={key:2,class:"table-tab"},tt={key:0},st={key:0,class:"table-tab-table-outer"},ot={class:"table-tab-table-inner"},at={key:0},nt={class:"table-tab-menu"},lt=["onClick"],it=["onClick"],ct={key:1},rt={key:1},dt={key:1},ut={key:3,class:"topic-tab"},bt={key:4,class:"table-tab"},mt={key:5,class:"table-tab"},_t={key:1,class:"none-container"},vt={key:1,class:"loading"},pt={key:1,class:"loading"},ht={__name:"EventSlotDetail",setup(gt){const S=Z(),p=se(),E=O(!1),e=X({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewEventSlot:!1,canAdmin:!1,canSelfAssignment:!1,canEditEventSlot:!1,canDeleteEventSlot:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),A=async()=>{const n=S.params.id;let t=localStorage.getItem("access_token");const c=y(t);t&&!c&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const l=await h.get(`${P}/event_slots/${n}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные мероприятия:",l.data),e.object=l.data}catch(l){console.error("Ошибка при получении данных мероприятия:",l)}},w=O(!1),q=()=>{w.value=!0},V=()=>{w.value=!1},J=async()=>{let n=localStorage.getItem("access_token");const t=y(n);if(n&&!t){p.push({name:"Login"});return}const c=S.params.id;try{await h.delete(`${P}/event_slots/${c}/`,{headers:{Authorization:`Bearer ${n}`}}),V(),p.push({name:"EventSlotList"})}catch(l){console.error("Ошибка удаления мероприятияа:",l)}},F=async n=>{let t=localStorage.getItem("access_token");const c=y(t);if(t&&!c){p.push({name:"Login"});return}try{const l=await h.post(`${P}/self_assignment/${n}/`,{},{headers:{Authorization:`Bearer ${t}`}});console.log("Самоназначение:",l.data),p.push({name:"TaskDetail",params:{id:l.data.id}})}catch(l){console.error("Ошибка самоназначения:",l)}},R=async()=>{let n=localStorage.getItem("access_token");const t=y(n);if(n&&!t){p.push({name:"Login"});return}const c=e.object.last_task.id;try{const l=await h.patch(`${P}/confirm_participation/${c}/`,{},{headers:{Authorization:`Bearer ${n}`}});console.log("Ответ об отметки об участии:",l.data),e.object.last_task.result.confirmed=l.data.confirmed;const _=e.object.tasks.find(m=>m.id===c);_.result.confirmed=l.data.confirmed}catch(l){console.error("При отметке об участии:",l)}},x=async(n,t)=>{let c=localStorage.getItem("access_token");const l=y(c);if(c&&!l){p.push({name:"Login"});return}try{const _=await h.patch(`${P}/mark_completion/${n}/${t}/`,{},{headers:{Authorization:`Bearer ${c}`}});console.log("Ответ об отметки об участии:",_.data);const m=e.object.tasks.find(d=>d.id===n);m&&m.result&&(m.result.status=t,m.result.status_display=t==="completed"?"Выполнена":t==="failed"?"Провалена":m.result.status_display)}catch(_){console.error("При отметке об участии:",_)}},U=async()=>{console.log("Проверяем версию прав");const n=JSON.parse(localStorage.getItem("userPermissions"));if(!(n!=null&&n.permissions_version))return;console.log("Текущая версия прав:",n.permissions_version);let t=localStorage.getItem("access_token");const c=y(t);if(!(!t||!c))try{(await h.get(`${P}/user_permissions_version/${n.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(l){console.error("Ошибка проверки версии прав:",l),localStorage.removeItem("userPermissions")}},H=async()=>{var c,l,_,m;let n=localStorage.getItem("access_token");const t=y(n);n&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),n=null);try{let d=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",d),Object.keys(d).length>0&&(console.log("ID пользователя в разрешениях из памяти:",d.user_id),!t&&d.user_id!==1||t&&t.user_id!==d.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),d={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(d).length===0){const j=await h.get(`${P}/user_permissions/`,{headers:{...n&&{Authorization:`Bearer ${n}`}}});console.log("Разрешения пользователя загружены:",j.data),d=j.data,localStorage.setItem("userPermissions",JSON.stringify(d))}e.globalPermissionsList=d.global_permissions||[],e.objectPermissionsDict=d.object_permissions||{};const g=S.params.id;console.log("ID объекта:",g),e.canViewEventSlot=e.globalPermissionsList.includes("events.view_event_slot")||e.objectPermissionsDict["events.view_event_slot"]&&e.objectPermissionsDict["events.view_event_slot"].includes(Number(g)),console.log("Права на просмотр аккаунтов:",e.canViewEventSlot),e.canAdmin=Array.isArray(e.object.event_template.admins)&&e.object.event_template.admins.some(j=>j.id===d.user_id),console.log("Права на администрирование:",e.canAdmin),e.canSelfAssignment=e.canViewEventSlot&&e.object.self_assignment_task_template&&(!e.object.last_task||((l=(c=e.object.last_task)==null?void 0:c.result)==null?void 0:l.status)=="failed"||((m=(_=e.object.last_task)==null?void 0:_.result)==null?void 0:m.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditEventSlot=e.globalPermissionsList.includes("events.change_event_slot")||Array.isArray(e.objectPermissionsDict["events.change_event_slot"])&&e.objectPermissionsDict["events.change_event_slot"].includes(Number(g)),console.log("Права на редактирование аккаунтов:",e.canEditEventSlot),e.canDeleteEventSlot=e.globalPermissionsList.includes("events.delete_event_slot")||Array.isArray(e.objectPermissionsDict["events.delete_event_slot"])&&e.objectPermissionsDict["events.delete_event_slot"].includes(Number(g)),console.log("Права на удаление аккаунтов:",e.canDeleteEventSlot),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(d){console.error("Ошибка при загрузке разрешений пользователя:",d)}},K=()=>{ae(p)},Q=Y(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},{name:"tasks",label:"Участники"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),v=O(S.query.tab||localStorage.getItem(`activeEventSlotTab-${S.params.id}`)||"details");return ee(v,n=>{localStorage.setItem(`activeEventSlotTab-${S.params.id}`,n),p.push({query:{tab:n}}),console.log("Загружен таб:",n)}),te(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await A(),await U(),await H(),E.value=!0}catch(n){console.error("Ошибка при загрузке данных:",n)}}),(n,t)=>{var l,_,m,d,g,j,I,T;const c=oe("router-link");return E.value?(o(),a("div",re,[e.canViewEventSlot?(o(),a("div",de,[e.object.id?(o(),a("div",ue,[s("div",be,[s("div",me,[e.object.event_template.avatar?(o(),a("div",_e,[s("img",{src:e.object.event_template.avatar||"/default-avatar.png",alt:"Аватар"},null,8,ve)])):(o(),a("div",pe,[...t[2]||(t[2]=[s("span",{class:"none-text"},"Нет аватара",-1)])]))]),s("div",ge,[s("div",je,[s("div",ke,[s("h1",null,i(e.object.str||"Безымянный мероприятия"),1)])]),s("div",fe,[s("div",ye,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Статус:",-1)),r(" "+i(e.object.status_display||"Нет статуса"),1)]),s("div",he,[t[4]||(t[4]=s("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),r(" "+i((l=e.object.last_task)!=null&&l.result?(_=e.object.last_task)==null?void 0:_.result.status_display:"Не назначено"),1)]),s("div",Pe,[t[5]||(t[5]=s("span",{class:"detail-card-text-label"},"Количество участников:",-1)),r(" "+i(e.object.number_of_participants||"Нет количества участников"),1)]),s("div",Se,[t[6]||(t[6]=s("span",{class:"detail-card-text-label"},"Регистрация открыта:",-1)),r(" "+i(e.object.registration?"Да":"Нет"),1)]),s("div",Ae,[t[7]||(t[7]=s("span",{class:"detail-card-text-label"},"Начало по плану:",-1)),r(" "+i(e.object.planned_start?k(f)(e.object.planned_start):"Нет данных о начале"),1)]),e.object.deadline?(o(),a("div",we,[t[8]||(t[8]=s("span",{class:"detail-card-text-label"},"Завершение по плану:",-1)),r(" "+i(e.object.planned_end?k(f)(e.object.planned_end):"Нет данных о завершении"),1)])):b("",!0)]),s("div",De,[e.object.last_task?(o(),a("a",{key:0,href:e.object.event_template.link,target:"_blank",rel:"noopener noreferrer",class:"button"}," Открыть слот ",8,Oe)):b("",!0),e.object.last_task?(o(),a("button",{key:1,onClick:R,class:"button"},i((g=(d=(m=e.object)==null?void 0:m.last_task)==null?void 0:d.result)!=null&&g.confirmed?"Отменить участие":"Подтвердить участие"),1)):b("",!0),e.object.last_task?(o(),G(c,{key:2,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:N(()=>[...t[9]||(t[9]=[r(" Задача ",-1)])]),_:1},8,["to"])):b("",!0),e.canSelfAssignment?(o(),a("button",{key:3,onClick:t[0]||(t[0]=u=>F(e.object.self_assignment_task_template)),class:"button"}," Самоназначение ")):b("",!0),e.canEditEventSlot?(o(),G(c,{key:4,to:{name:"EventSlotEdit",params:{id:e.object.id}},class:"button"},{default:N(()=>[...t[10]||(t[10]=[r(" Изменить ",-1)])]),_:1},8,["to"])):b("",!0),e.canDeleteEventSlot?(o(),a("button",{key:5,onClick:q,class:"button"}," Удалить ")):b("",!0),s("button",{type:"button",onClick:K,class:"button"},"Назад")]),w.value?(o(),a("div",$e,[s("div",Ee,[s("div",Ve,[s("h2",xe,"Удаление "+i(e.object.name||"Безымянного мероприятия"),1)]),s("div",Ie,[s("button",{onClick:t[1]||(t[1]=u=>J()),class:"minibutton"},"Подтвердить"),s("button",{onClick:V,class:"minibutton"},"Отменить")])])])):b("",!0)])]),s("div",Te,[s("div",Le,[(o(!0),a(z,null,M(Q.value,u=>(o(),a("button",{key:u.name,class:ne([{active:v.value===u.name},"tab-button"]),onClick:D=>v.value=u.name},i(u.label),11,Ce))),128))]),v.value?(o(),a("div",Be,[v.value==="desc"?(o(),a("div",Ge,[e.object.desc?(o(),a("div",Ne,i(e.object.desc),1)):(o(),a("div",ze,[...t[11]||(t[11]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):b("",!0),v.value==="details"?(o(),a("div",Me,[s("div",qe,[t[12]||(t[12]=s("span",{class:"detail-tab-label"},"Статус задачи:",-1)),r(" "+i((j=e.object.last_task)!=null&&j.result?(I=e.object.last_task)==null?void 0:I.result.status_display:"Не назначено"),1)]),s("div",Je,[t[13]||(t[13]=s("span",{class:"detail-tab-label"},"Статус:",-1)),r(" "+i(e.object.status_display||"Нет статуса"),1)]),s("div",Fe,[t[14]||(t[14]=s("span",{class:"detail-tab-label"},"Мероприятие:",-1)),r(" "+i(e.object.event_template.str||"Нет мероприятия"),1)]),s("div",Re,[t[15]||(t[15]=s("span",{class:"detail-tab-label"},"Количество участников:",-1)),r(" "+i(e.object.number_of_participants||"Нет количества участников"),1)]),s("div",Ue,[t[16]||(t[16]=s("span",{class:"detail-tab-label"},"Регистрация открыта:",-1)),r(" "+i(e.object.registration?"Да":"Нет"),1)]),s("div",He,[t[17]||(t[17]=s("span",{class:"detail-tab-label"},"Сроки:",-1)),r(" "+i(e.object.deadline?"Да":"Нет"),1)]),s("div",Ke,[t[18]||(t[18]=s("span",{class:"detail-tab-label"},"Начало по плану:",-1)),r(" "+i(e.object.planned_start?k(f)(e.object.planned_start):"Нет данных о начале"),1)]),e.object.deadline?(o(),a("div",Qe,[t[19]||(t[19]=s("span",{class:"detail-tab-label"},"Завершение по плану:",-1)),r(" "+i(e.object.planned_end?k(f)(e.object.planned_end):"Нет данных о завершении"),1)])):b("",!0),s("div",We,[t[20]||(t[20]=s("span",{class:"detail-tab-label"},"Создан:",-1)),r(" "+i(e.object.created?k(f)(e.object.created):"Нет данных о создании"),1)]),s("div",Xe,[t[21]||(t[21]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),r(" "+i(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",Ye,[t[22]||(t[22]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),r(" "+i(e.object.changed?k(f)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Ze,[t[23]||(t[23]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),r(" "+i(e.object.editor?e.object.editor:"Нет редактора"),1)])])):b("",!0),v.value==="tasks"?(o(),a("div",et,[e.canViewEventSlot?(o(),a("div",tt,[e.object.tasks&&e.object.tasks.length>0?(o(),a("div",st,[s("div",ot,[s("table",null,[t[24]||(t[24]=s("thead",null,[s("tr",null,[s("th",null,"Участник"),s("th",null,"Зарегистрирован"),s("th",null,"Подтверждение участия"),s("th",null,"Статус"),s("th",null," Действия ")])],-1)),s("tbody",null,[(o(!0),a(z,null,M(e.object.tasks,u=>{var D,L,C,B;return o(),a("tr",{key:u.id},[s("td",null,i(u.executor?u.executor:"Нет данных"),1),s("td",null,i(u.created?k(f)(u.created):"Нет данных"),1),s("td",null,i((D=u.result)!=null&&D.confirmed?"Да":"Нет"),1),s("td",null,i((L=u.result)!=null&&L.status_display?u.result.status_display:"Нет данных"),1),s("td",null,[e.canAdmin?(o(),a("div",at,[s("div",nt,[e.canAdmin&&((C=u.result)==null?void 0:C.status)!="completed"?(o(),a("button",{key:0,onClick:W=>x(u.id,"completed"),class:"table-tab-button"}," Выполнено ",8,lt)):b("",!0),e.canAdmin&&((B=u.result)==null?void 0:B.status)!="failed"?(o(),a("button",{key:1,onClick:W=>x(u.id,"failed"),class:"table-tab-button"}," Провалено ",8,it)):b("",!0)])])):(o(),a("div",ct," - "))])])}),128))])])])])):(o(),a("div",rt,[...t[25]||(t[25]=[s("div",{class:"none-border"},"Нет подзадач",-1)])]))])):(o(),a("div",dt,[...t[26]||(t[26]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])]))])):b("",!0),v.value==="messages"?(o(),a("div",ut,[$(ce,{topic_id:(T=e.object)==null?void 0:T.topic.id},null,8,["topic_id"])])):b("",!0),v.value==="accountsGroupObjectPermissions"?(o(),a("div",bt,[$(le,{state:e,fetchObject:A,contentTypeModel:"eventslot"},null,8,["state"])])):b("",!0),v.value==="accountObjectPermissions"?(o(),a("div",mt,[$(ie,{state:e,fetchObject:A,contentTypeModel:"eventslot"},null,8,["state"])])):b("",!0)])):b("",!0)])])):e.object.id?b("",!0):(o(),a("div",_t,[...t[27]||(t[27]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),a("div",vt,[...t[28]||(t[28]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),a("div",pt,[...t[29]||(t[29]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{ht as default};
