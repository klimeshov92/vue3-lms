import{r as u,a as j,o as E,c as i,d as t,b as y,t as _,f as x,C as F,w as B,p as D,v as O,n as M,i as C,u as P,h as v,j as g,k as q,l as c}from"./index-BlU-7-2d.js";import{s as A}from"./custom-multiselect-D-HMaYL6.js";const J={key:0},Z={key:0,class:"form-page"},G={class:"form-field"},H={key:0,class:"avatar-preview"},K=["href"],Q={class:"form-field"},W={key:0,class:"upload_file-preview"},X=["href"],Y={class:"form-field"},ee={key:0,class:"error"},te={class:"form-field"},se={class:"form-field"},ae={key:0,class:"error"},oe={class:"form-field"},le={key:1,class:"none-card"},re={key:1,class:"loading"},ue={__name:"CourseEdit",setup(ne){const $=q(),d=P(),n=u(null),o=j({constructor_type:"",name:"",desc:"",categories:[]}),V=u(!1),U=[{label:"Ispring",value:"ispring"},{label:"Articulate",value:"articulate"},{label:"Scroll",value:"scroll"}],k=u([]),L=async()=>{let s=localStorage.getItem("access_token");const e=C(s);if(s&&!e){d.push({name:"Login"});return}try{const a=await v.get(`${g}/categories/`,{headers:{Authorization:`Bearer ${s}`}});k.value=a.data.results||[],console.log("Категории загружены:",k.value)}catch(a){console.error("Ошибка при загрузке категорий:",a.response?a.response.data:a.message)}},R=async()=>{var f;const s=$.params.id;let e=localStorage.getItem("access_token");const a=C(e);if(e&&!a){d.push({name:"Login"});return}try{const l=await v.get(`${g}/courses/${s}/`,{headers:{Authorization:`Bearer ${e}`}});n.value=l.data,console.log("Объект успешно загружен:",n.value),n.value.constructor_type=U.find(m=>m.value===n.value.constructor_type),console.log("Объект нормализован:",n.value),Object.assign(o,n.value),p.value=n.value.upload_file||""}catch(l){console.error("Ошибка загрузки объекта:",((f=l.response)==null?void 0:f.data)||l.message)}},h=u(null),p=u(null),S=s=>{const e=s.target.files[0];e&&(h.value=e,p.value=URL.createObjectURL(e))},w=u(null),b=u(null),T=s=>{const e=s.target.files[0];e&&(w.value=e,b.value=URL.createObjectURL(e))},r=j({}),z=()=>(r.constructor_type=o.constructor_type.value?"":"Тип курса обязателен!",r.name=o.name?"":"Название обязательно!",Object.values(r).every(s=>!s)),I=async()=>{if(!z()){console.error("Форма содержит ошибки:",r);return}try{const s=$.params.id;let e=localStorage.getItem("access_token");const a=C(e);if(e&&!a){d.push({name:"Login"});return}const f={constructor_type:o.constructor_type.value,name:o.name,desc:o.desc,categories:o.categories.map(l=>l.id)};if(console.log("JSON данные перед отправкой:",f),await v.patch(`${g}/courses/${s}/`,f,{headers:{Authorization:`Bearer ${e}`}}),console.log("Данные обновлены"),h.value){const l=new FormData;l.append("upload_file",h.value);const m=`${g}/courses/${s}/`;await v.patch(m,l,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}}),console.log("Файл успешно обновлен")}if(w.value){const l=new FormData;l.append("avatar",w.value);const m=`${g}/courses/${s}/`;await v.patch(m,l,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}}),console.log("Аватар успешно обновлен")}console.log("Изменения сохранены"),d.push({name:"CourseDetail",params:{id:s}})}catch(s){s.response&&s.response.data?(Object.assign(r,s.response.data),console.error("Ошибка при сохранении изменений:",s.response.data)):console.error("Ошибка при сохранении изменений:",s.message)}},N=()=>{d.back()};return E(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await L(),await R(),V.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>V.value?(c(),i("div",J,[n.value?(c(),i("div",Z,[e[15]||(e[15]=t("div",{class:"form-header"},[t("h1",null,"Редактирование курса")],-1)),t("form",{onSubmit:M(I,["prevent"]),class:"form",id:"edit-form"},[t("div",G,[e[5]||(e[5]=t("label",{for:"avatar",class:"form-label"},"Аватар:",-1)),t("input",{type:"file",id:"avatar",onChange:T,class:"form-input"},null,32),b.value?(c(),i("div",H,[e[4]||(e[4]=t("span",{class:"avatar-preview-text"},"Текущий аватар:",-1)),t("a",{href:b.value,target:"_blank",class:"link"},_(b.value),9,K)])):y("",!0)]),t("div",Q,[e[7]||(e[7]=t("label",{for:"upload_file",class:"form-label"},"Загружаемый курс:",-1)),t("input",{type:"file",id:"upload_file",onChange:S,class:"form-input"},null,32),p.value?(c(),i("div",W,[e[6]||(e[6]=t("span",{class:"upload_file-preview-text"},"Текущий курс:",-1)),t("a",{href:p.value,target:"_blank",class:"link"},_(p.value),9,X)])):y("",!0)]),t("div",Y,[e[8]||(e[8]=t("label",{class:"form-label"},"Тип курса:",-1)),x(F(A),{modelValue:o.constructor_type,"onUpdate:modelValue":e[0]||(e[0]=a=>o.constructor_type=a),options:U,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип курса",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),r.constructor_type?(c(),i("span",ee,_(r.constructor_type),1)):y("",!0)]),t("div",te,[e[11]||(e[11]=t("label",{class:"form-label"},"Категории:",-1)),x(F(A),{modelValue:o.categories,"onUpdate:modelValue":e[1]||(e[1]=a=>o.categories=a),options:k.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:B(()=>[...e[9]||(e[9]=[t("span",null,"Список пуст",-1)])]),noResult:B(()=>[...e[10]||(e[10]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),t("div",se,[e[12]||(e[12]=t("label",{for:"name",class:"form-label"},"Название:",-1)),D(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>o.name=a),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[O,o.name]]),r.name?(c(),i("span",ae,_(r.name),1)):y("",!0)]),t("div",oe,[e[13]||(e[13]=t("label",{for:"desc",class:"form-label"},"Описание:",-1)),D(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>o.desc=a),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[O,o.desc]])])],32),t("div",{class:"form-menu button-group"},[e[14]||(e[14]=t("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),t("button",{type:"button",onClick:N,class:"button"},"Отмена")])])):(c(),i("div",le,[...e[16]||(e[16]=[t("div",null,"Объект не найден",-1)])]))])):(c(),i("div",re,[...e[17]||(e[17]=[t("div",null,"Загрузка данных...",-1)])]))}};export{ue as default};
