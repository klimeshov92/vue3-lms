import{a as O,r as m,k as z,o as J,c,d as o,b as V,p as U,v as M,f as C,w as p,C as j,n as R,F as E,E as G,t as f,e as H,i as _,h as k,j as y,u as K,g as Q,l as r,m as $}from"./index-Bpv6Iqa1.js";import{s as q}from"./custom-multiselect-rCMWLb_h.js";const W={key:0},X={key:0,class:"list-page"},Y={class:"filters-inner"},Z={class:"filters-field"},ee={class:"filters-field"},se={class:"filters-field"},oe={class:"filters-menu button-group"},te={key:1,class:"list-items"},le={class:"list-grid"},ie={class:"list-card-header"},ae={class:"list-card-header-title"},ne={class:"list-card-text"},re={class:"list-card-text-elem"},ce={class:"list-card-menu minibutton-group"},de={class:"list-pagination"},ue=["disabled"],ve=["disabled"],me={key:2,class:"none-card"},ge={key:3,class:"list-menu button-group"},be={key:1,class:"loading"},pe={key:1,class:"loading"},ye={__name:"PositionList",setup(fe){const d=z(),P=K(),i=O({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddPosition:!1,canViewPosition:!1}),F=m(!1),S=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"},{label:"Название подразделения: по возрастанию",value:"subdivision__name"},{label:"Название подразделения: по убыванию",value:"-subdivision__name"}],w=m([]),x=async()=>{let s=localStorage.getItem("access_token");const e=_(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const t=await k.get(`${y}/subdivisions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});w.value=t.data.results||[],console.log("Подразделения загружены:",w.value)}catch(t){console.error("Ошибка при загрузке подразделений:",t.response?t.response.data:t.message)}},n=O({name:d.query.name||"",subdivision:d.query.subdivision||"",order:S.find(s=>s.value===d.query.order||"name")}),A=()=>{const s=localStorage.getItem("positionFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(n,JSON.parse(s)))},a=m(Number(d.query.page)||1),h=m(1),L=()=>{const s=localStorage.getItem("positionPage");s&&(console.log("Загруженная странциа:",s),a.value=parseInt(s,10))},g=async(s,e)=>{var u;console.log("Загрузка должностей с фильтрами:",s,"для страницы:",e);let t=localStorage.getItem("access_token");const l=_(t);t&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null),P.push({name:"PositionList",query:{name:s.name||"",subdivision:s.subdivision||"",order:s.order.value,page:a.value}}),localStorage.setItem("positionFilters",JSON.stringify(s));try{const v=await k.get(`${y}/positions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}},params:{page:e,page_size:12,name:s.name,subdivision:(u=s.subdivision)==null?void 0:u.id,ordering:s.order.value}});console.log("Список организаций загружен:",v.data),i.items=v.data.results,h.value=Math.ceil(v.data.count/12)}catch(v){console.error("Ошибка при загрузке списка организаций:",v)}},N=s=>{console.log("Смена страницы на:",s),a.value=s,P.push({name:"PositionList",query:{...d.query,page:a.value}}),localStorage.setItem("positionPage",a.value),g(n,s)},b=m(!1),I=()=>{b.value=!b.value,console.log("Текущий статус показа фильтров:",b.value)},B=()=>{console.log("Сбрасываем фильтры"),n.name="",n.subdivision="",n.order=S.find(s=>s.value==="name"),localStorage.removeItem("positionFilters"),localStorage.removeItem("positionPage"),a.value=1,P.push({name:"PositionList",query:{name:"",subdivision:"",page:a.value}}),g(n,a.value)},D=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const t=_(e);if(!(!e||!t))try{(await k.get(`${y}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(l){console.error("Ошибка проверки версии прав:",l),localStorage.removeItem("userPermissions")}},T=async()=>{let s=localStorage.getItem("access_token");const e=_(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let t=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",t),Object.keys(t).length>0&&(console.log("ID пользователя в разрешениях из памяти:",t.user_id),!e&&t.user_id!==1||e&&e.user_id!==t.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),t={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(t).length===0){const l=await k.get(`${y}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",l.data),t=l.data,localStorage.setItem("userPermissions",JSON.stringify(t))}i.globalPermissionsList=t.global_permissions||[],i.objectPermissionsDict=t.object_permissions||{},i.canAddPosition=i.globalPermissionsList.includes("core.add_position"),console.log("Права на добавление подразделений:",i.canAddPosition),i.canViewPosition=i.globalPermissionsList.includes("core.view_position")||!!i.objectPermissionsDict["core.view_position"],console.log("Права на просмотр подразделений:",i.canViewPosition)}catch(t){console.error("Ошибка при получении разрешений пользователя:",t)}};return J(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await A(),await L(),await x(),await D(),await T(),await g(n,a.value),F.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const t=Q("router-link");return F.value?(r(),c("div",W,[i.canViewPosition?(r(),c("div",X,[e[16]||(e[16]=o("div",{class:"list-header"},[o("h1",null,"Должности")],-1)),o("div",{class:"list-settings"},[o("button",{onClick:I,class:"list-settings-button"}," Параметры ")]),b.value?(r(),c("div",{key:0,class:"filters-overlay",onClick:I},[o("div",{class:"filters-outer",onClick:e[4]||(e[4]=R(()=>{},["stop"]))},[o("div",{class:"filters-close_button-inner"},[o("button",{onClick:I,class:"filters-close_button"}," × ")]),o("div",Y,[o("div",Z,[e[7]||(e[7]=o("label",{class:"filters-label"},"Название:",-1)),U(o("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>n.name=l),class:"filters-input",placeholder:"Введите название"},null,512),[[M,n.name]])]),o("div",ee,[e[10]||(e[10]=o("label",{class:"filters-label"},"Подразделение:",-1)),C(j(q),{modelValue:n.subdivision,"onUpdate:modelValue":e[1]||(e[1]=l=>n.subdivision=l),options:w.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[8]||(e[8]=[o("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[9]||(e[9]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",se,[e[11]||(e[11]=o("label",{class:"filters-label"},"Сортировка:",-1)),C(j(q),{modelValue:n.order,"onUpdate:modelValue":e[2]||(e[2]=l=>n.order=l),options:S,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),o("div",oe,[o("button",{onClick:e[3]||(e[3]=l=>g(n,a.value.value)),class:"button"},"Применить"),o("button",{onClick:B,class:"button"},"Сбросить")])])])):V("",!0),i.items.length!==0?(r(),c("div",te,[o("div",le,[(r(!0),c(E,null,G(i.items,l=>{var u;return r(),c("div",{key:l.id,class:"list-card"},[o("div",ie,[o("div",ae,[o("h2",null,f(l.name||"Нет названия"),1)])]),o("div",ne,[o("div",re,[e[12]||(e[12]=o("span",{class:"list-card-text-label"},"Подразделение:",-1)),$(" "+f(((u=l.subdivision)==null?void 0:u.name)||"Нет родительского подразделения"),1)])]),o("div",ce,[C(t,{to:{name:"PositionDetail",params:{id:l.id},query:{tab:"details"}},class:"minibutton"},{default:p(()=>[...e[13]||(e[13]=[$(" Подробнее ",-1)])]),_:1},8,["to"])])])}),128))]),o("div",de,[o("button",{disabled:a.value===1,onClick:e[5]||(e[5]=l=>N(a.value-1)),class:"list-settings-button"}," Назад ",8,ue),o("span",null,"Страница "+f(a.value)+" из "+f(h.value),1),o("button",{disabled:a.value===h.value,onClick:e[6]||(e[6]=l=>N(a.value+1)),class:"list-settings-button"}," Вперед ",8,ve)])])):(r(),c("div",me,[...e[14]||(e[14]=[o("div",null,"Список пуст",-1)])])),i.canAddPosition?(r(),c("div",ge,[i.canAddPosition?(r(),H(t,{key:0,to:{name:"PositionCreate"},class:"button"},{default:p(()=>[...e[15]||(e[15]=[$(" Создать ",-1)])]),_:1})):V("",!0)])):V("",!0)])):(r(),c("div",be,[...e[17]||(e[17]=[o("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(r(),c("div",pe,[...e[18]||(e[18]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{ye as default};
