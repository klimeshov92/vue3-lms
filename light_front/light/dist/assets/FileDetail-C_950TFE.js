import{r as P,a as N,B as U,k as E,C as R,o as z,c as n,b as r,d as o,t as d,m as u,e as M,w as q,F as J,G as H,D,H as F,f as S,i as v,h as j,j as k,u as K,g as Q,q as W,l,I as X}from"./index-yfpLmCCm.js";import{_ as Y,a as Z}from"./AccountsGroupObjectPermissions-BCp0jPRO.js";import"./EditorComponent-sX0RyEc9.js";const ee={key:0},se={key:0,class:"detail-page"},oe={key:0},te={class:"detail-card"},ie={class:"detail-card-info"},le={class:"detail-header"},ae={class:"detail-header-title"},ne={class:"detail-card-text"},ce={class:"detail-card-text-elem"},re={class:"detail-card-text-elem"},de={class:"detail-menu button-group"},ue={key:0,class:"modal-overlay"},be={class:"modal"},me={class:"modal-header"},_e={class:"modal-header-h2"},ge={class:"minibutton-group modal-menu"},pe={class:"detail-tabs"},fe={class:"tabs-header"},ve=["onClick"],je={key:0,class:"tabs-content"},ke={key:0,class:"desc-tab"},he={key:0},ye={key:1},Pe={key:1,class:"detail-tab"},we={class:"detail-tab-elem"},Ae={class:"detail-tab-elem"},Oe={class:"detail-tab-elem"},De={class:"detail-tab-elem"},Fe={class:"detail-tab-elem"},Se={class:"detail-tab-elem"},$e={key:2,class:"table-tab"},Le={key:3,class:"table-tab"},Ie={key:1,class:"none-container"},Ve={key:1,class:"loading"},Ce={key:1,class:"loading"},Ne={__name:"FileDetail",setup(Be){const g=E(),f=K(),w=P(!1),e=N({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewFile:!1,canEditFile:!1,canDeleteFile:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),$=()=>{var t;(t=e.object)!=null&&t.upload_file?window.open(e.object.upload_file,"_blank"):console.warn("Файл не найден.")},L=async()=>{var s;const t=(s=e.object)==null?void 0:s.upload_file;if(!t){console.warn("Файл не найден.");return}try{await navigator.clipboard.writeText(t),console.log("Ссылка скопирована в буфер обмена!")}catch(i){console.error("Ошибка при копировании ссылки: ",i)}},I=async()=>{var a,m;const t=(a=e.object)==null?void 0:a.id,s=((m=e.object)==null?void 0:m.name)||"downloaded_file";if(!t){console.warn("ID файла не найден.");return}const i=localStorage.getItem("access_token");if(!i||!v(i)){console.warn("Токен невалиден, переход на логин"),f.push({name:"Login"});return}try{const _=`${k}/download_file/${t}/`;console.log(`Скачивание с URL: ${_}`);const c=await j.get(_,{responseType:"blob",headers:{Authorization:`Bearer ${i}`}});if(c.status===200){const O=new Blob([c.data],{type:c.headers["content-type"]}),p=document.createElement("a");p.href=window.URL.createObjectURL(O),p.setAttribute("download",s),document.body.appendChild(p),p.click(),p.remove(),window.URL.revokeObjectURL(p.href),console.log("Файл успешно скачан")}else console.error(`Ошибка при скачивании файла. Код: ${c.status}`)}catch(_){console.error("Ошибка при скачивании файла:",_)}},h=async()=>{const t=g.params.id;let s=localStorage.getItem("access_token");const i=v(s);s&&!i&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const a=await j.get(`${k}/files/${t}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные файла:",a.data),e.object=a.data}catch(a){console.error("Ошибка при получении данных файла:",a)}},y=P(!1),V=()=>{y.value=!0},A=()=>{y.value=!1},C=async()=>{let t=localStorage.getItem("access_token");const s=v(t);if(t&&!s){f.push({name:"Login"});return}const i=g.params.id;try{await j.delete(`${k}/files/${i}/`,{headers:{Authorization:`Bearer ${t}`}}),A(),f.push({name:"FileList"})}catch(a){console.error("Ошибка удаления файла:",a)}},B=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let s=localStorage.getItem("access_token");const i=v(s);if(!(!s||!i))try{(await j.get(`${k}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(a){console.error("Ошибка проверки версии прав:",a),localStorage.removeItem("userPermissions")}},G=async()=>{let t=localStorage.getItem("access_token");const s=v(t);t&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{let i=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",i),Object.keys(i).length>0&&(console.log("ID пользователя в разрешениях из памяти:",i.user_id),!s&&i.user_id!==1||s&&s.user_id!==i.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),i={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(i).length===0){const m=await j.get(`${k}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",m.data),i=m.data,localStorage.setItem("userPermissions",JSON.stringify(i))}e.globalPermissionsList=i.global_permissions||[],e.objectPermissionsDict=i.object_permissions||{};const a=g.params.id;console.log("ID объекта:",a),e.canViewFile=e.globalPermissionsList.includes("files.view_file")||e.objectPermissionsDict["files.view_file"]&&e.objectPermissionsDict["files.view_file"].includes(Number(a)),console.log("Права на просмотр файлов:",e.canViewFile),e.canEditFile=e.globalPermissionsList.includes("files.change_file")||Array.isArray(e.objectPermissionsDict["files.change_file"])&&e.objectPermissionsDict["files.change_file"].includes(Number(a)),console.log("Права на редактирование файлов:",e.canEditFile),e.canDeleteFile=e.globalPermissionsList.includes("files.delete_file")||Array.isArray(e.objectPermissionsDict["files.delete_file"])&&e.objectPermissionsDict["files.delete_file"].includes(Number(a)),console.log("Права на удаление файлов:",e.canDeleteFile),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(i){console.error("Ошибка при загрузке разрешений пользователя:",i)}},T=()=>{W(f)},x=U(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=P(g.query.tab||localStorage.getItem(`activeFileTab-${g.params.id}`)||"details");return R(b,t=>{localStorage.setItem(`activeFileTab-${g.params.id}`,t),f.push({query:{tab:t}}),console.log("Загружен таб:",t)}),z(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await h(),await B(),await G(),w.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,s)=>{var a,m,_;const i=Q("router-link");return w.value?(l(),n("div",ee,[e.canViewFile?(l(),n("div",se,[e.object.id?(l(),n("div",oe,[o("div",te,[o("div",ie,[o("div",le,[o("div",ae,[o("h1",null,d(e.object.name||"Безымянный файл"),1)])]),o("div",ne,[o("div",ce,[s[1]||(s[1]=o("span",{class:"detail-card-text-label"},"Тип файла:",-1)),u(" "+d(e.object.file_type_display||"Нет типа файла"),1)]),o("div",re,[s[2]||(s[2]=o("span",{class:"detail-card-text-label"},"Категории:",-1)),u(" "+d(e.object.categories.length>0?e.object.categories.map(c=>c.name).join(", "):"Нет категорий"),1)])]),o("div",de,[(a=e.object)!=null&&a.upload_file?(l(),n("button",{key:0,onClick:$,class:"button"}," Открыть ")):r("",!0),(m=e.object)!=null&&m.upload_file?(l(),n("button",{key:1,onClick:L,class:"button"}," Скопировать ссылку ")):r("",!0),(_=e.object)!=null&&_.upload_file?(l(),n("button",{key:2,onClick:I,class:"button"}," Скачать ")):r("",!0),e.canEditFile?(l(),M(i,{key:3,to:{name:"FileEdit",params:{id:e.object.id}},class:"button"},{default:q(()=>[...s[3]||(s[3]=[u(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canDeleteFile?(l(),n("button",{key:4,onClick:V,class:"button"}," Удалить ")):r("",!0),o("button",{type:"button",onClick:T,class:"button"},"Назад")]),y.value?(l(),n("div",ue,[o("div",be,[o("div",me,[o("h2",_e,"Удаление "+d(e.object.name||"Безымянный файл"),1)]),o("div",ge,[o("button",{onClick:s[0]||(s[0]=c=>C()),class:"minibutton"},"Подтвердить"),o("button",{onClick:A,class:"minibutton"},"Отменить")])])])):r("",!0)])]),o("div",pe,[o("div",fe,[(l(!0),n(J,null,H(x.value,c=>(l(),n("button",{key:c.name,class:X([{active:b.value===c.name},"tab-button"]),onClick:O=>b.value=c.name},d(c.label),11,ve))),128))])]),b.value?(l(),n("div",je,[b.value==="desc"?(l(),n("div",ke,[e.object.desc?(l(),n("div",he,d(e.object.desc),1)):(l(),n("div",ye,[...s[4]||(s[4]=[o("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):r("",!0),b.value==="details"?(l(),n("div",Pe,[o("div",we,[s[5]||(s[5]=o("span",{class:"detail-tab-label"},"Тип файла:",-1)),u(" "+d(e.object.file_type_display||"Нет типа файла"),1)]),o("div",Ae,[s[6]||(s[6]=o("span",{class:"detail-tab-label"},"Категории:",-1)),u(" "+d(e.object.categories.length>0?e.object.categories.map(c=>c.name).join(", "):"Нет категорий"),1)]),o("div",Oe,[s[7]||(s[7]=o("span",{class:"detail-tab-label"},"Создан:",-1)),u(" "+d(e.object.created?D(F)(e.object.created):"Нет данных о создании"),1)]),o("div",De,[s[8]||(s[8]=o("span",{class:"detail-tab-label"},"Создатель:",-1)),u(" "+d(e.object.creator?e.object.creator:"Нет создателя"),1)]),o("div",Fe,[s[9]||(s[9]=o("span",{class:"detail-tab-label"},"Изменён:",-1)),u(" "+d(e.object.changed?D(F)(e.object.changed):"Нет данных об изменениях"),1)]),o("div",Se,[s[10]||(s[10]=o("span",{class:"detail-tab-label"},"Редактор:",-1)),u(" "+d(e.object.editor?e.object.editor:"Нет редактора"),1)])])):r("",!0),b.value==="accountsGroupObjectPermissions"?(l(),n("div",$e,[S(Y,{state:e,fetchObject:h,contentTypeModel:"file"},null,8,["state"])])):r("",!0),b.value==="accountObjectPermissions"?(l(),n("div",Le,[S(Z,{state:e,fetchObject:h,contentTypeModel:"file"},null,8,["state"])])):r("",!0)])):r("",!0)])):e.object.id?r("",!0):(l(),n("div",Ie,[...s[11]||(s[11]=[o("div",{class:"none-card"},[o("div",null,"Объект не найден.")],-1)])]))])):(l(),n("div",Ve,[...s[12]||(s[12]=[o("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(l(),n("div",Ce,[...s[13]||(s[13]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{Ne as default};
