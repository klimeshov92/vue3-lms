import{a as x,r as g,k as z,o as J,c,d as t,b as h,p as U,v as M,f as V,w as k,D as j,n as R,F as E,G,t as u,e as H,i as b,h as _,j as f,u as K,g as Q,l as i,m as T}from"./index-CfAZEXlX.js";import{s as q}from"./custom-multiselect-CMYyZ4s-.js";const W={key:0},X={key:0,class:"list-page"},Y={class:"filters-inner"},Z={class:"filters-field"},ee={class:"filters-field"},se={class:"filters-field"},te={class:"filters-menu button-group"},le={key:1,class:"list-items"},ae={class:"list-grid"},oe={class:"list-card-header"},ne={class:"list-card-header-title"},re={class:"list-card-text"},ie={class:"list-card-text-elem"},ce={class:"list-card-text-elem"},de={class:"list-card-menu minibutton-group"},ue={class:"list-pagination"},me=["disabled"],ge=["disabled"],pe={key:2,class:"none-card"},ve={key:3,class:"list-menu button-group"},ke={key:1,class:"loading"},be={key:1,class:"loading"},ye={__name:"TaskTemplateList",setup(_e){const m=z(),y=K(),o=x({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddTaskTemplate:!1,canViewTaskTemplate:!1}),C=g(!1),S=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"},{label:"Название плана: по возрастанию",value:"plan__name"},{label:"Название плана: по убыванию",value:"-plan__name"}],P=g([]),F=async()=>{let s=localStorage.getItem("access_token");const e=b(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const l=await _.get(`${f}/categories/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});P.value=l.data.results||[],console.log("Категории загружены:",P.value)}catch(l){console.error("Ошибка при загрузке категорий:",l.response?l.response.data:l.message)}},r=x({name:m.query.name||"",categories:m.query.categories?m.query.categories.map(s=>({id:parseInt(s,10)})):[],order:S.find(s=>s.value===m.query.order||"plan__name")}),N=()=>{const s=localStorage.getItem("taskTemplateFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(r,JSON.parse(s)))},n=g(Number(m.query.page)||1),w=g(1),O=()=>{const s=localStorage.getItem("taskTemplatePage");s&&(console.log("Загруженная странциа:",s),n.value=parseInt(s,10))},p=async(s,e)=>{console.log("Загрузка шаблонов задач с фильтрами:",s,"для страницы:",e);let l=localStorage.getItem("access_token");const a=b(l);l&&!a&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),l=null),y.push({name:"TaskTemplateList",query:{name:s.name||"",categories:s.categories.map(d=>d.id)||[],order:s.order.value,page:n.value}}),localStorage.setItem("taskTemplateFilters",JSON.stringify(s));try{const d=await _.get(`${f}/task_templates/`,{headers:{...l&&{Authorization:`Bearer ${l}`}},params:{page:e,page_size:12,name:s.name,categories:s.categories.map(D=>D.id),ordering:s.order.value}});console.log("Список шаблонов задач загружен:",d.data),o.items=d.data.results,w.value=Math.ceil(d.data.count/12)}catch(d){console.error("Ошибка при загрузке списка шаблонов задач:",d)}},$=s=>{console.log("Смена страницы на:",s),n.value=s,y.push({name:"TaskTemplateList",query:{...m.query,page:n.value}}),localStorage.setItem("taskTemplatePage",n.value),p(r,s)},v=g(!1),I=()=>{v.value=!v.value,console.log("Текущий статус показа фильтров:",v.value)},A=()=>{console.log("Сбрасываем фильтры"),r.name="",r.categories=[],r.order=S.find(s=>s.value==="plan__name"),localStorage.removeItem("taskTemplateFilters"),localStorage.removeItem("taskTemplatePage"),n.value=1,y.push({name:"TaskTemplateList",query:{name:"",categories:[],page:n.value}}),p(r,n.value)},L=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const l=b(e);if(!(!e||!l))try{(await _.get(`${f}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(a){console.error("Ошибка проверки версии прав:",a),localStorage.removeItem("userPermissions")}},B=async()=>{let s=localStorage.getItem("access_token");const e=b(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!e&&l.user_id!==1||e&&e.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const a=await _.get(`${f}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",a.data),l=a.data,localStorage.setItem("userPermissions",JSON.stringify(l))}o.globalPermissionsList=l.global_permissions||[],o.objectPermissionsDict=l.object_permissions||{},o.canAddTaskTemplate=o.globalPermissionsList.includes("bpms.add_task_template"),console.log("Права на добавление шаблонов задач:",o.canAddTaskTemplate),o.canViewTaskTemplate=o.globalPermissionsList.includes("bpms.view_task_template")||!!o.objectPermissionsDict["bpms.view_task_template"],console.log("Права на просмотр шаблонов задач:",o.canViewTaskTemplate)}catch(l){console.error("Ошибка при получении разрешений пользователя:",l)}};return J(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await N(),await O(),await F(),await L(),await B(),await p(r,n.value),C.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const l=Q("router-link");return C.value?(i(),c("div",W,[o.canViewTaskTemplate?(i(),c("div",X,[e[17]||(e[17]=t("div",{class:"list-header"},[t("h1",null,"Шаблоны задач")],-1)),t("div",{class:"list-settings"},[t("button",{onClick:I,class:"list-settings-button"}," Параметры ")]),v.value?(i(),c("div",{key:0,class:"filters-overlay",onClick:I},[t("div",{class:"filters-outer",onClick:e[4]||(e[4]=R(()=>{},["stop"]))},[t("div",{class:"filters-close_button-inner"},[t("button",{onClick:I,class:"filters-close_button"}," × ")]),t("div",Y,[t("div",Z,[e[7]||(e[7]=t("label",{class:"filters-label"},"Название:",-1)),U(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>r.name=a),class:"filters-input",placeholder:"Введите название"},null,512),[[M,r.name]])]),t("div",ee,[e[10]||(e[10]=t("label",{class:"filters-label"},"Категории:",-1)),V(j(q),{modelValue:r.categories,"onUpdate:modelValue":e[1]||(e[1]=a=>r.categories=a),options:P.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:k(()=>[...e[8]||(e[8]=[t("span",null,"Список пуст",-1)])]),noResult:k(()=>[...e[9]||(e[9]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),t("div",se,[e[11]||(e[11]=t("label",{class:"filters-label"},"Сортировка:",-1)),V(j(q),{modelValue:r.order,"onUpdate:modelValue":e[2]||(e[2]=a=>r.order=a),options:S,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),t("div",te,[t("button",{onClick:e[3]||(e[3]=a=>p(r,n.value.value)),class:"button"},"Применить"),t("button",{onClick:A,class:"button"},"Сбросить")])])])):h("",!0),o.items.length!==0?(i(),c("div",le,[t("div",ae,[(i(!0),c(E,null,G(o.items,a=>(i(),c("div",{key:a.id,class:"list-card"},[t("div",oe,[t("div",ne,[t("h2",null,u(a.plan?a.plan.name+" - ":"")+u(a.item?a.item+" - ":"")+u(a.name||"Нет названия"),1)])]),t("div",re,[t("div",ie,[e[12]||(e[12]=t("span",{class:"list-card-text-label"},"Тип задачи:",-1)),T(" "+u(a.task_type_display||"Нет типа задачи"),1)]),t("div",ce,[e[13]||(e[13]=t("span",{class:"list-card-text-label"},"Категории:",-1)),T(" "+u(a.categories.length>0?a.categories.map(d=>d.name).join(", "):"Нет категорий"),1)])]),t("div",de,[V(l,{to:{name:"TaskTemplateDetail",params:{id:a.id},query:{tab:"desc"}},class:"minibutton"},{default:k(()=>[...e[14]||(e[14]=[T(" Подробнее ",-1)])]),_:1},8,["to"])])]))),128))]),t("div",ue,[t("button",{disabled:n.value===1,onClick:e[5]||(e[5]=a=>$(n.value-1)),class:"list-settings-button"}," Назад ",8,me),t("span",null,"Страница "+u(n.value)+" из "+u(w.value),1),t("button",{disabled:n.value===w.value,onClick:e[6]||(e[6]=a=>$(n.value+1)),class:"list-settings-button"}," Вперед ",8,ge)])])):(i(),c("div",pe,[...e[15]||(e[15]=[t("div",null,"Список пуст",-1)])])),o.canAddTaskTemplate?(i(),c("div",ve,[o.canAddTaskTemplate?(i(),H(l,{key:0,to:{name:"TaskTemplateCreate"},class:"button"},{default:k(()=>[...e[16]||(e[16]=[T(" Создать ",-1)])]),_:1})):h("",!0)])):h("",!0)])):(i(),c("div",ke,[...e[18]||(e[18]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),c("div",be,[...e[19]||(e[19]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{ye as default};
