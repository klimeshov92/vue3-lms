import{r as v,a as z,A as R,k as J,B as U,o as F,c as i,b as u,d as s,t as a,m as r,e as g,w as j,F as $,E as S,C as D,G as V,f as w,i as y,h as k,j as h,g as H,u as X,l as o,H as K,X as W}from"./index-B3ZHU6wM.js";import{_ as Y,a as Z}from"./AccountsGroupObjectPermissions-f5Gvl5vT.js";import"./EditorComponent-yVtovmJ6.js";const ee={key:0},te={key:0,class:"detail-page"},se={key:0},oe={class:"detail-card"},ie={class:"detail-card-image-outer"},ne={key:0,class:"detail-card-image-inner"},le=["src"],ae={key:1,class:"detail-card-image-none"},ce={class:"detail-card-info"},re={class:"detail-header"},de={class:"detail-header-title"},ue={class:"detail-card-text"},be={class:"detail-card-text-elem"},_e={class:"detail-card-text-elem"},me={class:"detail-card-text-elem"},pe={class:"detail-card-text-elem"},ve={class:"detail-menu button-group"},ge={key:0,class:"modal-overlay"},je={class:"modal"},ye={class:"modal-header"},ke={class:"modal-header-h2"},he={class:"minibutton-group modal-menu"},fe={class:"detail-tabs"},Pe={class:"tabs-header"},Ae=["onClick"],qe={key:0,class:"tabs-content"},De={key:0,class:"detail-tab"},Oe={class:"detail-tab-elem"},Qe={class:"detail-tab-elem"},xe={class:"detail-tab-elem"},Ie={class:"detail-tab-elem"},$e={class:"detail-tab-elem"},Se={class:"detail-tab-elem"},Ve={class:"detail-tab-elem"},we={class:"detail-tab-elem"},Ce={class:"detail-tab-elem"},Ee={class:"detail-tab-elem"},Le={key:1,class:"table-tab"},Ge={key:0},Be={key:0,class:"table-tab-table-outer"},Te={class:"table-tab-table-inner"},Ne={key:0},Me={key:1},ze={key:2},Re={key:3},Je={key:4},Ue=["href"],Fe={key:1},He={key:0},Xe={key:1},Ke={key:2},We={key:3},Ye={key:4},Ze={key:0},et={class:"table-tab-menu"},tt=["onClick"],st={key:2,class:"modal-overlay"},ot={class:"modal"},it={class:"modal-header"},nt={class:"modal-header-h2"},lt={class:"minibutton-group modal-menu"},at={key:1},ct={key:1},rt={key:1},dt={key:2,class:"tab-menu minibutton-group"},ut={key:2,class:"table-tab"},bt={key:3,class:"table-tab"},_t={key:1,class:"none-container"},mt={key:1,class:"loading"},pt={key:1,class:"loading"},kt={__name:"QuestionDetail",setup(vt){const _=J(),m=X(),O=v(!1),e=z({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewQuestion:!1,canEditQuestion:!1,canDeleteQuestion:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),f=async()=>{const l=_.params.id;let t=localStorage.getItem("access_token");const c=y(t);t&&!c&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const d=await k.get(`${h}/questions/${l}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные вопроса:",d.data),e.object=d.data}catch(d){console.error("Ошибка при получении данных вопроса:",d)}},P=v(!1),C=()=>{P.value=!0},Q=()=>{P.value=!1},E=async()=>{let l=localStorage.getItem("access_token");const t=y(l);if(l&&!t){m.push({name:"Login"});return}const c=_.params.id;try{await k.delete(`${h}/questions/${c}/`,{headers:{Authorization:`Bearer ${l}`}}),Q(),m.push({name:"QuestionList"})}catch(d){console.error("Ошибка удаления вопроса:",d)}},A=v(!1),q=v(null),L=l=>{q.value=l,A.value=!0},x=()=>{A.value=!1},G=async l=>{let t=localStorage.getItem("access_token");const c=y(t);if(t&&!c){m.push({name:"Login"});return}try{await k.delete(`${h}/answers/${l}/`,{headers:{Authorization:`Bearer ${t}`}}),await f(),x()}catch(d){console.error("Ошибка удаления аккаунта:",d)}},B=async()=>{console.log("Проверяем версию прав");const l=JSON.parse(localStorage.getItem("userPermissions"));if(!(l!=null&&l.permissions_version))return;console.log("Текущая версия прав:",l.permissions_version);let t=localStorage.getItem("access_token");const c=y(t);if(!(!t||!c))try{(await k.get(`${h}/user_permissions_version/${l.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(d){console.error("Ошибка проверки версии прав:",d),localStorage.removeItem("userPermissions")}},T=async()=>{let l=localStorage.getItem("access_token");const t=y(l);l&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),l=null);try{let c=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",c),Object.keys(c).length>0&&(console.log("ID пользователя в разрешениях из памяти:",c.user_id),!t&&c.user_id!==1||t&&t.user_id!==c.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),c={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(c).length===0){const p=await k.get(`${h}/user_permissions/`,{headers:{...l&&{Authorization:`Bearer ${l}`}}});console.log("Разрешения пользователя загружены:",p.data),c=p.data,localStorage.setItem("userPermissions",JSON.stringify(c))}e.globalPermissionsList=c.global_permissions||[],e.objectPermissionsDict=c.object_permissions||{};const d=_.params.id;console.log("ID объекта:",d),e.canViewQuestion=e.globalPermissionsList.includes("tests.view_question")||e.objectPermissionsDict["tests.view_question"]&&e.objectPermissionsDict["tests.view_question"].includes(Number(d)),console.log("Права на просмотр вопросов:",e.canViewQuestion),e.canEditQuestion=e.globalPermissionsList.includes("tests.change_question")||Array.isArray(e.objectPermissionsDict["tests.change_question"])&&e.objectPermissionsDict["tests.change_question"].includes(Number(d)),console.log("Права на редактирование вопросов:",e.canEditQuestion),e.canDeleteQuestion=e.globalPermissionsList.includes("tests.delete_question")||Array.isArray(e.objectPermissionsDict["tests.delete_question"])&&e.objectPermissionsDict["tests.delete_question"].includes(Number(d)),console.log("Права на удаление вопросов:",e.canDeleteQuestion),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(c){console.error("Ошибка при загрузке разрешений пользователя:",c)}},N=()=>{m.back()},M=R(()=>[{name:"details",label:"Детали"},e.canEditQuestion?{name:"answers",label:"Ответы"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=v(_.query.tab||localStorage.getItem(`activeQuestionTab-${_.params.id}`)||"details");return U(b,l=>{localStorage.setItem(`activeQuestionTab-${_.params.id}`,l),m.push({query:{tab:l}}),console.log("Загружен таб:",l)}),F(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await f(),await B(),await T(),O.value=!0}catch(l){console.error("Ошибка при загрузке данных:",l)}}),(l,t)=>{var d,p;const c=H("router-link");return O.value?(o(),i("div",ee,[e.canViewQuestion?(o(),i("div",te,[e.object.id?(o(),i("div",se,[s("div",oe,[s("div",ie,[e.object.picture?(o(),i("div",ne,[s("img",{src:e.object.picture||"/default-avatar.png",alt:"Картинка"},null,8,le)])):(o(),i("div",ae,[...t[2]||(t[2]=[s("span",{class:"none-text"},"Нет аватара",-1)])]))]),s("div",ce,[s("div",re,[s("div",de,[s("h1",null,a(e.object.text||"Вопрос без текста"),1)])]),s("div",ue,[s("div",be,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Тип вопроса:",-1)),r(" "+a(e.object.question_type_display||"Нет типа вопроса"),1)]),s("div",_e,[t[4]||(t[4]=s("span",{class:"detail-card-text-label"},"Инструкция:",-1)),r(" "+a(e.object.manual||"Нет инструкции"),1)]),s("div",me,[t[5]||(t[5]=s("span",{class:"detail-card-text-label"},"Балл:",-1)),r(" "+a(e.object.score!=null?e.object.score:"Нет баллов"),1)]),s("div",pe,[t[6]||(t[6]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),r(" "+a(((d=e.object.categories)==null?void 0:d.length)>0?e.object.categories.map(n=>n.name).join(", "):"Нет категорий"),1)])]),s("div",ve,[e.canEditQuestion?(o(),g(c,{key:0,to:{name:"QuestionEdit",params:{id:e.object.id}},class:"button"},{default:j(()=>[...t[7]||(t[7]=[r(" Изменить ",-1)])]),_:1},8,["to"])):u("",!0),e.canDeleteQuestion?(o(),i("button",{key:1,onClick:C,class:"button"}," Удалить ")):u("",!0),s("button",{type:"button",onClick:N,class:"button"},"Назад")]),P.value?(o(),i("div",ge,[s("div",je,[s("div",ye,[s("h2",ke,"Удаление "+a(e.object.username||"Безымянная учетная запись"),1)]),s("div",he,[s("button",{onClick:t[0]||(t[0]=n=>E()),class:"minibutton"},"Подтвердить"),s("button",{onClick:Q,class:"minibutton"},"Отменить")])])])):u("",!0)])]),s("div",fe,[s("div",Pe,[(o(!0),i($,null,S(M.value,n=>(o(),i("button",{key:n.name,class:K([{active:b.value===n.name},"tab-button"]),onClick:I=>b.value=n.name},a(n.label),11,Ae))),128))]),b.value?(o(),i("div",qe,[b.value==="details"?(o(),i("div",De,[s("div",Oe,[t[8]||(t[8]=s("span",{class:"detail-tab-label"},"Тип вопроса:",-1)),r(" "+a(e.object.question_type_display||"Нет типа вопроса"),1)]),s("div",Qe,[t[9]||(t[9]=s("span",{class:"detail-tab-label"},"Инструкция:",-1)),r(" "+a(e.object.manual||"Нет инструкции"),1)]),s("div",xe,[t[10]||(t[10]=s("span",{class:"detail-tab-label"},"Балл:",-1)),r(" "+a(e.object.score!=null?e.object.score:"Нет баллов"),1)]),s("div",Ie,[t[11]||(t[11]=s("span",{class:"detail-tab-label"},"Обратная связь при правильном ответе:",-1)),r(" "+a(e.object.feedback_for_correct||"Нет обратной связи при правильном ответе"),1)]),s("div",$e,[t[12]||(t[12]=s("span",{class:"detail-tab-label"},"Обратная связь при неправильном ответе:",-1)),r(" "+a(e.object.feedback_for_incorrect||"Нет обратной связи при правильном ответе"),1)]),s("div",Se,[t[13]||(t[13]=s("span",{class:"detail-tab-label"},"Категории:",-1)),r(" "+a(((p=e.object.categories)==null?void 0:p.length)>0?e.object.categories.map(n=>n.name).join(", "):"Нет категорий"),1)]),s("div",Ve,[t[14]||(t[14]=s("span",{class:"detail-tab-label"},"Создан:",-1)),r(" "+a(e.object.created?D(V)(e.object.created):"Нет данных о создании"),1)]),s("div",we,[t[15]||(t[15]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),r(" "+a(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",Ce,[t[16]||(t[16]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),r(" "+a(e.object.changed?D(V)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Ee,[t[17]||(t[17]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),r(" "+a(e.object.editor?e.object.editor:"Нет редактора"),1)])])):u("",!0),b.value==="answers"?(o(),i("div",Le,[e.canEditQuestion?(o(),i("div",Ge,[e.object.answers&&e.object.answers.length>0?(o(),i("div",Be,[s("div",Te,[s("table",null,[s("thead",null,[s("tr",null,[t[18]||(t[18]=s("th",null,"Порядок",-1)),t[19]||(t[19]=s("th",null,"Текст",-1)),t[20]||(t[20]=s("th",null,"Картинка",-1)),e.object.question_type=="single_selection"||e.object.question_type=="multiple_choice"?(o(),i("th",Ne," Правильный ответ ")):e.object.question_type=="sorting"?(o(),i("th",Me," Правильный порядок ")):e.object.question_type=="text_input"?(o(),i("th",ze," Правильный текст ")):e.object.question_type=="numeric_input"?(o(),i("th",Re," Правильное число ")):e.object.question_type=="compliance"?(o(),i("th",Je," Соотвествующий пункт ")):u("",!0),t[21]||(t[21]=s("th",null,"Балл",-1)),t[22]||(t[22]=s("th",null,"Обратная связь при правильном ответе",-1)),t[23]||(t[23]=s("th",null,"Обратная связь при неправильном ответе",-1)),t[24]||(t[24]=s("th",null," Действия ",-1))])]),s("tbody",null,[(o(!0),i($,null,S(e.object.answers,n=>(o(),i("tr",{key:n.id},[s("td",null,a(n.item?n.item:"Нет данных"),1),s("td",null,a(n.text?n.text:"Нет данных"),1),s("td",null,[n.picture?(o(),i("a",{key:0,class:"table-tab-button",href:D(W)+n.picture,target:"_blank",rel:"noopener noreferrer"}," Открыть ",8,Ue)):(o(),i("span",Fe,"Нет"))]),e.object.question_type=="single_selection"||e.object.question_type=="multiple_choice"?(o(),i("td",He,a(n.correct_answer?"Да":"Нет"),1)):e.object.question_type=="sorting"?(o(),i("td",Xe,a(n.correct_item?n.correct_item:"Нет данных"),1)):e.object.question_type=="text_input"?(o(),i("td",Ke,a(n.correct_text_input?n.correct_text_input:"Нет данных"),1)):e.object.question_type=="numeric_input"?(o(),i("td",We,a(n.correct_numeric_input?n.correct_numeric_input:"Нет данных"),1)):e.object.question_type=="compliance"?(o(),i("td",Ye,[r(a(n.relevant_point.text?n.relevant_point.text:"")+" ",1),e.canDeleteQuestion&&!n.relevant_point.text?(o(),g(c,{key:0,to:{name:"RelevantPointCreate",query:{answerId:n.id,questionId:e.object.id}},class:"table-tab-button table-tab-button-margin-left"},{default:j(()=>[...t[25]||(t[25]=[r(" Создать ",-1)])]),_:1},8,["to"])):u("",!0),e.canDeleteQuestion&&n.relevant_point.text?(o(),g(c,{key:1,to:{name:"RelevantPointEdit",params:{id:n.relevant_point.id},query:{answerId:n.id,questionId:e.object.id}},class:"table-tab-button table-tab-button-margin-left"},{default:j(()=>[...t[26]||(t[26]=[r(" Изменить ",-1)])]),_:1},8,["to"])):u("",!0)])):u("",!0),s("td",null,a(n.score!=null?n.score:"Нет данных"),1),s("td",null,a(n.feedback_for_correct?n.feedback_for_correct:"Нет данных"),1),s("td",null,a(n.feedback_for_incorrect?n.feedback_for_incorrect:"Нет данных"),1),s("td",null,[e.canEditQuestion||e.canDeleteQuestion?(o(),i("div",Ze,[s("div",et,[e.canEditQuestion?(o(),g(c,{key:0,to:{name:"AnswerEdit",params:{id:n.id},query:{questionId:e.object.id}},class:"table-tab-button"},{default:j(()=>[...t[27]||(t[27]=[r(" Изменить ",-1)])]),_:1},8,["to"])):u("",!0),e.canDeleteQuestion?(o(),i("button",{key:1,onClick:I=>L(n),class:"table-tab-button"}," Удалить ",8,tt)):u("",!0),A.value?(o(),i("div",st,[s("div",ot,[s("div",it,[s("h2",nt,"Удаление "+a(q.value.text||"Пустой вопрос"),1)]),s("div",lt,[s("button",{onClick:t[1]||(t[1]=I=>G(q.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:x,class:"minibutton"},"Отменить")])])])):u("",!0)])])):(o(),i("div",at," - "))])]))),128))])])])])):(o(),i("div",ct,[...t[28]||(t[28]=[s("div",{class:"none-border"},"Нет ответов",-1)])]))])):(o(),i("div",rt,[...t[29]||(t[29]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])])),e.canEditQuestion?(o(),i("div",dt,[e.canEditQuestion?(o(),g(c,{key:0,to:{name:"AnswerCreate",query:{questionId:e.object.id}},class:"minibutton"},{default:j(()=>[...t[30]||(t[30]=[r(" Создать ",-1)])]),_:1},8,["to"])):u("",!0)])):u("",!0)])):u("",!0),b.value==="accountsGroupObjectPermissions"?(o(),i("div",ut,[w(Y,{state:e,fetchObject:f,contentTypeModel:"question"},null,8,["state"])])):u("",!0),b.value==="accountObjectPermissions"?(o(),i("div",bt,[w(Z,{state:e,fetchObject:f,contentTypeModel:"question"},null,8,["state"])])):u("",!0)])):u("",!0)])])):e.object.id?u("",!0):(o(),i("div",_t,[...t[31]||(t[31]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),i("div",mt,[...t[32]||(t[32]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),i("div",pt,[...t[33]||(t[33]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{kt as default};
