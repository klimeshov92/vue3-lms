import{r as g,a as Y,B as Z,k as ee,C as te,o as se,c as a,b as r,d as s,t as l,m as c,e as k,w as j,F as V,G as C,D as M,H as N,f as x,i as y,h,j as f,g as oe,u as ae,q as ie,l as o,I as ne}from"./index-CzP8FZvf.js";import{_ as le,a as ce}from"./AccountsGroupObjectPermissions-D9lR2uBj.js";import{_ as de}from"./TopicMessages-ChEq3YyC.js";import"./EditorComponent-DxSf7Gmz.js";const re={key:0},ue={key:0,class:"detail-page"},me={key:0},be={class:"detail-card"},_e={class:"detail-card-image-outer"},ve={key:0,class:"detail-card-image-inner"},pe=["src"],ge={key:1,class:"detail-card-image-none"},ke={class:"detail-card-info"},je={class:"detail-header"},ye={class:"detail-header-title"},he={class:"detail-card-text"},fe={class:"detail-card-text-elem"},Te={class:"detail-card-text-elem"},Pe={class:"detail-card-text-elem"},we={class:"detail-card-text-elem"},Se={class:"detail-card-text-elem"},Ae={class:"detail-menu button-group"},De={key:0,class:"modal-overlay"},Oe={class:"modal"},$e={class:"modal-header"},Ie={class:"modal-header-h2"},Ve={class:"minibutton-group modal-menu"},Ce={class:"detail-tabs"},xe={class:"tabs-header"},Le=["onClick"],Ee={key:0,class:"tabs-content"},Be={key:0,class:"desc-tab"},Ge={key:0},Me={key:1},Ne={key:1,class:"detail-tab"},ze={class:"detail-tab-elem"},qe={class:"detail-tab-elem"},Qe={class:"detail-tab-elem"},Je={class:"detail-tab-elem"},Fe={class:"detail-tab-elem"},Re={class:"detail-tab-elem"},Ue={class:"detail-tab-elem"},He={class:"detail-tab-elem"},Ke={class:"detail-tab-elem"},We={class:"detail-tab-elem"},Xe={class:"detail-tab-elem"},Ye={class:"detail-tab-elem"},Ze={class:"detail-tab-elem"},et={key:2,class:"test-section-tab"},tt={key:0},st={key:0,class:"test-section-tab-flex"},ot={class:"test-section-tab-item-top"},at={class:"test-section-tab-item-title"},it={class:"test-section-tab-item-detail"},nt={class:"test-section-tab-item-detail-elem"},lt={key:0,class:"test-section-table_container"},ct={key:0,class:"test-section-table-outer"},dt={class:"test-section-table-inner"},rt={key:0},ut={class:"test-section-menu"},mt=["onClick"],bt={key:1},_t={key:1},vt={key:1,class:"test-section-tab-item-menu-outer"},pt={class:"test-section-tab-item-menu-inner"},gt=["onClick"],kt={key:2},jt={key:0,class:"modal-overlay"},yt={class:"modal"},ht={class:"modal-header"},ft={class:"modal-header-h2"},Tt={class:"minibutton-group modal-menu"},Pt={key:1,class:"modal-overlay"},wt={class:"modal"},St={class:"modal-header"},At={class:"modal-header-h2"},Dt={class:"minibutton-group modal-menu"},Ot={key:1},$t={key:1},It={key:2,class:"tab-menu minibutton-group"},Vt={key:3,class:"topic-tab"},Ct={key:4,class:"table-tab"},xt={key:5,class:"table-tab"},Lt={key:1,class:"none-container"},Et={key:1,class:"loading"},Bt={key:1,class:"loading"},Jt={__name:"TestDetail",setup(Gt){const T=ee(),v=ae(),L=g(!1),e=Y({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewTest:!1,canSelfAssignment:!1,canEditTest:!1,canDeleteTest:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),P=async()=>{const i=T.params.id;let t=localStorage.getItem("access_token");const u=y(t);t&&!u&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const d=await h.get(`${f}/tests/${i}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные теста:",d.data),e.object=d.data}catch(d){console.error("Ошибка при получении данных теста:",d)}},A=g(!1),z=()=>{A.value=!0},E=()=>{A.value=!1},q=async()=>{let i=localStorage.getItem("access_token");const t=y(i);if(i&&!t){v.push({name:"Login"});return}const u=T.params.id;try{await h.delete(`${f}/tests/${u}/`,{headers:{Authorization:`Bearer ${i}`}}),E(),v.push({name:"TestList"})}catch(d){console.error("Ошибка удаления теста:",d)}},D=g(!1),O=g(null),Q=i=>{O.value=i,D.value=!0},B=()=>{D.value=!1},J=async i=>{let t=localStorage.getItem("access_token");const u=y(t);if(t&&!u){v.push({name:"Login"});return}try{await h.delete(`${f}/test_sections/${i}/`,{headers:{Authorization:`Bearer ${t}`}}),await P(),B()}catch(d){console.error("Ошибка удаления раздела теста:",d)}},$=g(!1),I=g(null),F=i=>{I.value=i,$.value=!0},G=()=>{$.value=!1},R=async i=>{let t=localStorage.getItem("access_token");const u=y(t);if(t&&!u){v.push({name:"Login"});return}try{await h.delete(`${f}/test_section_questions/${i}/`,{headers:{Authorization:`Bearer ${t}`}}),await P(),G()}catch(d){console.error("Ошибка удаления вопроса раздела теста:",d)}},U=async i=>{let t=localStorage.getItem("access_token");const u=y(t);if(t&&!u){v.push({name:"Login"});return}try{const d=await h.post(`${f}/self_assignment/${i}/`,{},{headers:{Authorization:`Bearer ${t}`}});console.log("Самоназначение:",d.data),v.push({name:"TaskDetail",params:{id:d.data.id}})}catch(d){console.error("Ошибка самоназначения:",d)}},H=async()=>{console.log("Проверяем версию прав");const i=JSON.parse(localStorage.getItem("userPermissions"));if(!(i!=null&&i.permissions_version))return;console.log("Текущая версия прав:",i.permissions_version);let t=localStorage.getItem("access_token");const u=y(t);if(!(!t||!u))try{(await h.get(`${f}/user_permissions_version/${i.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(d){console.error("Ошибка проверки версии прав:",d),localStorage.removeItem("userPermissions")}},K=async()=>{var u,d,w,S;let i=localStorage.getItem("access_token");const t=y(i);i&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),i=null);try{let m=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",m),Object.keys(m).length>0&&(console.log("ID пользователя в разрешениях из памяти:",m.user_id),!t&&m.user_id!==1||t&&t.user_id!==m.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),m={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(m).length===0){const n=await h.get(`${f}/user_permissions/`,{headers:{...i&&{Authorization:`Bearer ${i}`}}});console.log("Разрешения пользователя загружены:",n.data),m=n.data,localStorage.setItem("userPermissions",JSON.stringify(m))}e.globalPermissionsList=m.global_permissions||[],e.objectPermissionsDict=m.object_permissions||{};const p=T.params.id;console.log("ID объекта:",p),e.canViewTest=e.globalPermissionsList.includes("tests.view_test")||e.objectPermissionsDict["tests.view_test"]&&e.objectPermissionsDict["tests.view_test"].includes(Number(p)),console.log("Права на просмотр аккаунтов:",e.canViewTest),e.canSelfAssignment=e.canViewTest&&e.object.self_assignment_task_template&&e.object.self_assignment_task_template&&(!e.object.last_task||((d=(u=e.object.last_task)==null?void 0:u.result)==null?void 0:d.status)=="failed"||((S=(w=e.object.last_task)==null?void 0:w.result)==null?void 0:S.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditTest=e.globalPermissionsList.includes("tests.change_test")||Array.isArray(e.objectPermissionsDict["tests.change_test"])&&e.objectPermissionsDict["tests.change_test"].includes(Number(p)),console.log("Права на редактирование аккаунтов:",e.canEditTest),e.canDeleteTest=e.globalPermissionsList.includes("tests.delete_test")||Array.isArray(e.objectPermissionsDict["tests.delete_test"])&&e.objectPermissionsDict["tests.delete_test"].includes(Number(p)),console.log("Права на удаление аккаунтов:",e.canDeleteTest),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(m){console.error("Ошибка при загрузке разрешений пользователя:",m)}},W=()=>{ie(v)},X=Z(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canEditTest?{name:"test_sections",label:"Раздел теста"}:null,e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=g(T.query.tab||localStorage.getItem(`activeTestTab-${T.params.id}`)||"details");return te(b,i=>{localStorage.setItem(`activeTestTab-${T.params.id}`,i),v.push({query:{tab:i}}),console.log("Загружен таб:",i)}),se(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await P(),await H(),await K(),L.value=!0}catch(i){console.error("Ошибка при загрузке данных:",i)}}),(i,t)=>{var d,w,S,m,p;const u=oe("router-link");return L.value?(o(),a("div",re,[e.canViewTest?(o(),a("div",ue,[e.object.id?(o(),a("div",me,[s("div",be,[s("div",_e,[e.object.avatar?(o(),a("div",ve,[s("img",{src:e.object.avatar||"/default-avatar.png",alt:"Аватар"},null,8,pe)])):(o(),a("div",ge,[...t[4]||(t[4]=[s("span",{class:"none-text"},"Нет аватара",-1)])]))]),s("div",ke,[s("div",je,[s("div",ye,[s("h1",null,l(e.object.name||"Безымянный тест"),1)])]),s("div",he,[s("div",fe,[t[5]||(t[5]=s("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),c(" "+l((d=e.object.last_task)!=null&&d.result?(w=e.object.last_task)==null?void 0:w.result.status_display:"Не назначено"),1)]),s("div",Te,[t[6]||(t[6]=s("span",{class:"detail-card-text-label"},"Проходной балл:",-1)),c(" "+l(e.object.passing_score||"Нет проходного балла"),1)]),s("div",Pe,[t[7]||(t[7]=s("span",{class:"detail-card-text-label"},"Время на выполнение (минут):",-1)),c(" "+l(e.object.time_to_complete||"Нет времени на выполнение"),1)]),s("div",we,[t[8]||(t[8]=s("span",{class:"detail-card-text-label"},"Попытки:",-1)),c(" "+l(e.object.attempts||"Нет попыток"),1)]),s("div",Se,[t[9]||(t[9]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),c(" "+l(e.object.categories.length>0?e.object.categories.map(n=>n.name).join(", "):"Нет категорий"),1)])]),s("div",Ae,[e.object.last_task?(o(),k(u,{key:0,to:{name:"TestAttempt",params:{id:e.object.last_task.id}},class:"button"},{default:j(()=>[...t[10]||(t[10]=[c(" Пройти ",-1)])]),_:1},8,["to"])):r("",!0),e.object.last_task?(o(),k(u,{key:1,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:j(()=>[...t[11]||(t[11]=[c(" Задача ",-1)])]),_:1},8,["to"])):r("",!0),e.canSelfAssignment?(o(),a("button",{key:2,onClick:t[0]||(t[0]=n=>U(e.object.self_assignment_task_template)),class:"button"}," Самоназначение ")):r("",!0),e.canEditTest?(o(),k(u,{key:3,to:{name:"TestEdit",params:{id:e.object.id}},class:"button"},{default:j(()=>[...t[12]||(t[12]=[c(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canDeleteTest?(o(),a("button",{key:4,onClick:z,class:"button"}," Удалить ")):r("",!0),s("button",{type:"button",onClick:W,class:"button"},"Назад")]),A.value?(o(),a("div",De,[s("div",Oe,[s("div",$e,[s("h2",Ie,"Удаление "+l(e.object.username||"Безымянная учетная запись"),1)]),s("div",Ve,[s("button",{onClick:t[1]||(t[1]=n=>q()),class:"minibutton"},"Подтвердить"),s("button",{onClick:E,class:"minibutton"},"Отменить")])])])):r("",!0)])]),s("div",Ce,[s("div",xe,[(o(!0),a(V,null,C(X.value,n=>(o(),a("button",{key:n.name,class:ne([{active:b.value===n.name},"tab-button"]),onClick:_=>b.value=n.name},l(n.label),11,Le))),128))]),b.value?(o(),a("div",Ee,[b.value==="desc"?(o(),a("div",Be,[e.object.desc?(o(),a("div",Ge,l(e.object.desc),1)):(o(),a("div",Me,[...t[13]||(t[13]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):r("",!0),b.value==="details"?(o(),a("div",Ne,[s("div",ze,[t[14]||(t[14]=s("span",{class:"detail-tab-label"},"Статус задачи:",-1)),c(" "+l((S=e.object.last_task)!=null&&S.result?(m=e.object.last_task)==null?void 0:m.result.status_display:"Не назначено"),1)]),s("div",qe,[t[15]||(t[15]=s("span",{class:"detail-tab-label"},"Категории:",-1)),c(" "+l(e.object.categories.length>0?e.object.categories.map(n=>n.name).join(", "):"Нет категорий"),1)]),s("div",Qe,[t[16]||(t[16]=s("span",{class:"detail-tab-label"},"Проходной балл:",-1)),c(" "+l(e.object.passing_score||"Нет проходного балла"),1)]),s("div",Je,[t[17]||(t[17]=s("span",{class:"detail-tab-label"},"Время на выполнение (минут):",-1)),c(" "+l(e.object.time_to_complete||"Нет времени на выполнение"),1)]),s("div",Fe,[t[18]||(t[18]=s("span",{class:"detail-tab-label"},"Попытки:",-1)),c(" "+l(e.object.attempts||"Нет попыток"),1)]),s("div",Re,[t[19]||(t[19]=s("span",{class:"detail-tab-label"},"Случайный порядок вопросов:",-1)),c(" "+l(e.object.random_questions?"Да":"Нет"),1)]),s("div",Ue,[t[20]||(t[20]=s("span",{class:"detail-tab-label"},"Случайный порядок ответов:",-1)),c(" "+l(e.object.random_answers?"Да":"Нет"),1)]),s("div",He,[t[21]||(t[21]=s("span",{class:"detail-tab-label"},"Показывать результаты вопросов:",-1)),c(" "+l(e.object.show_questions_results?"Да":"Нет"),1)]),s("div",Ke,[t[22]||(t[22]=s("span",{class:"detail-tab-label"},"Показывать результаты ответов:",-1)),c(" "+l(e.object.show_answers_results?"Да":"Нет"),1)]),s("div",We,[t[23]||(t[23]=s("span",{class:"detail-tab-label"},"Создан:",-1)),c(" "+l(e.object.created?M(N)(e.object.created):"Нет данных о создании"),1)]),s("div",Xe,[t[24]||(t[24]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),c(" "+l(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",Ye,[t[25]||(t[25]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),c(" "+l(e.object.changed?M(N)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Ze,[t[26]||(t[26]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),c(" "+l(e.object.editor?e.object.editor:"Нет редактора"),1)])])):r("",!0),b.value==="test_sections"?(o(),a("div",et,[e.canEditTest?(o(),a("div",tt,[e.object.test_sections&&e.object.test_sections.length>0?(o(),a("div",st,[(o(!0),a(V,null,C(e.object.test_sections,n=>(o(),a("div",{key:n.id,class:"test-section-tab-item"},[s("div",ot,[s("div",at,[s("h2",null,l(n.item?n.item:"Нет данных")+" - "+l(n.name?n.name:"Нет имени"),1)])]),s("div",it,[s("div",nt,[t[27]||(t[27]=s("span",{class:"test-section-tab-item-detail-label"},"Размер выборки:",-1)),c(" "+l(n.sample_size?n.sample_size:"Нет данных"),1)])]),e.canViewTest?(o(),a("div",lt,[n.test_section_questions&&n.test_section_questions.length>0?(o(),a("div",ct,[s("div",dt,[s("table",null,[t[29]||(t[29]=s("thead",null,[s("tr",null,[s("th",null,"Порядок"),s("th",null,"Вопрос"),s("th",null," Действия ")])],-1)),s("tbody",null,[(o(!0),a(V,null,C(n.test_section_questions,_=>(o(),a("tr",{key:_.id},[s("td",null,l(_.item?_.item:"-"),1),s("td",null,l(_.question.text?_.question.text:"-"),1),s("td",null,[e.canViewTest?(o(),a("div",rt,[s("div",ut,[e.canEditTest?(o(),k(u,{key:0,to:{name:"TestSectionQuestionEdit",params:{id:_.id},query:{testSectionId:n.id,testId:e.object.id}},class:"test-section-button"},{default:j(()=>[...t[28]||(t[28]=[c(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canEditTest?(o(),a("button",{key:1,onClick:Mt=>F(_),class:"test-section-button"}," Удалить ",8,mt)):r("",!0)])])):(o(),a("div",bt," - "))])]))),128))])])])])):(o(),a("div",_t,[...t[30]||(t[30]=[s("div",{class:"none-border-mini"},"Нет вопросов теста",-1)])]))])):r("",!0),e.canViewTest?(o(),a("div",vt,[s("div",pt,[e.canEditTest?(o(),k(u,{key:0,to:{name:"TestSectionQuestionCreate",query:{testSectionId:n.id,testId:e.object.id}},class:"test-section-button"},{default:j(()=>[...t[31]||(t[31]=[c(" Создать ",-1)])]),_:1},8,["to"])):r("",!0),e.canEditTest?(o(),k(u,{key:1,to:{name:"TestSectionEdit",params:{id:n.id},query:{testId:e.object.id}},class:"test-section-button"},{default:j(()=>[...t[32]||(t[32]=[c(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canEditTest?(o(),a("button",{key:2,onClick:_=>Q(n),class:"test-section-button"}," Удалить ",8,gt)):r("",!0)])])):(o(),a("div",kt," - "))]))),128)),D.value?(o(),a("div",jt,[s("div",yt,[s("div",ht,[s("h2",ft,"Удаление "+l(O.value.str||"Безымянная подзадача"),1)]),s("div",Tt,[s("button",{onClick:t[2]||(t[2]=n=>J(O.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:B,class:"minibutton"},"Отменить")])])])):r("",!0),$.value?(o(),a("div",Pt,[s("div",wt,[s("div",St,[s("h2",At,"Удаление "+l(I.value.str||"Безымянная подзадача"),1)]),s("div",Dt,[s("button",{onClick:t[3]||(t[3]=n=>R(I.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:G,class:"minibutton"},"Отменить")])])])):r("",!0)])):(o(),a("div",Ot,[...t[33]||(t[33]=[s("div",{class:"none-border"},"Нет разделов теста",-1)])]))])):(o(),a("div",$t,[...t[34]||(t[34]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])])),e.canEditTest?(o(),a("div",It,[e.canEditTest?(o(),k(u,{key:0,to:{name:"TestSectionCreate",query:{testId:e.object.id}},class:"minibutton"},{default:j(()=>[...t[35]||(t[35]=[c(" Создать ",-1)])]),_:1},8,["to"])):r("",!0)])):r("",!0)])):r("",!0),b.value==="messages"?(o(),a("div",Vt,[x(de,{topic_id:(p=e.object)==null?void 0:p.topic.id},null,8,["topic_id"])])):r("",!0),b.value==="accountsGroupObjectPermissions"?(o(),a("div",Ct,[x(le,{state:e,fetchObject:P,contentTypeModel:"test"},null,8,["state"])])):r("",!0),b.value==="accountObjectPermissions"?(o(),a("div",xt,[x(ce,{state:e,fetchObject:P,contentTypeModel:"test"},null,8,["state"])])):r("",!0)])):r("",!0)])])):e.object.id?r("",!0):(o(),a("div",Lt,[...t[36]||(t[36]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),a("div",Et,[...t[37]||(t[37]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),a("div",Bt,[...t[38]||(t[38]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Jt as default};
