import{_ as L,r as y,a as j,k as N,C as M,o as q,c as r,b as n,d as o,n as F,f as g,w as _,D as m,t as v,p as J,v as G,i as h,u as H,h as V,j as $,q as K,l as i}from"./index-CfAZEXlX.js";import{s as b}from"./custom-multiselect-CMYyZ4s-.js";const P={key:0},Q={class:"form-page"},W={class:"form-field"},X={key:0,class:"error"},Y={class:"form-field"},Z={key:0,class:"error"},ee={key:0,class:"form-field"},te={key:0,class:"error"},le={key:1,class:"form-field"},se={key:0,class:"error"},ae={key:2,class:"form-field"},oe={key:0,class:"error"},re={key:3,class:"form-field"},ne={key:0,class:"error"},ie={__name:"ControlElementEventEdit",setup(de){const C=N(),p=H(),I=y(!1),B=[{label:"Аккаунт создан",value:"account_created"},{label:"Изменился статус дочерней задачи",value:"child_task_status_changed"},{label:"Истек срок задачи",value:"task_deadline"},{label:"Изменился статус задачи",value:"task_status_changed"},{label:"Изменился итог задачи",value:"task_outcome_changed"},{label:"Сработал триггер",value:"trigger_fired"},{label:"Периодическое событие",value:"periodic_event"}],O=[{label:"Ежедневно",value:"daily"},{label:"Еженедельно",value:"weekly"},{label:"Ежемесячно",value:"monthly"}],d=y(null),t=j({control_element:null,event_type:"",task_template:null,fired_trigger:null,period:"",start_time:null}),a=j({}),k=y([]),U=async()=>{let s=localStorage.getItem("access_token");const e=h(s);if(s&&!e){p.push({name:"Login"});return}try{const l=await V.get(`${$}/control_elements/`,{headers:{Authorization:`Bearer ${s}`}});k.value=l.data.results||[],console.log("Управлябщие элементы загружены:",k.value)}catch(l){console.error("Ошибка при загрузке управлябщих элементов:",l.response?l.response.data:l.message)}},S=C.query.control_elementId||"";console.log("control_elementId:",S);const E=y([]),w=async()=>{let s=localStorage.getItem("access_token");const e=h(s);if(s&&!e){p.push({name:"Login"});return}try{const l=await V.get(`${$}/task_templates/`,{headers:{Authorization:`Bearer ${s}`}});E.value=l.data.results||[],console.log("Шаблоны задач загружены:",E.value)}catch(l){console.error("Ошибка при загрузке шаблонов задач:",l.response?l.response.data:l.message)}},x=async()=>{var u;const s=C.params.id;let e=localStorage.getItem("access_token");const l=h(e);if(e&&!l){p.push({name:"Login"});return}console.log(`Начало загрузки объекта с ID: ${s}`);try{const c=await V.get(`${$}/control_element_events/${s}/`,{headers:{Authorization:`Bearer ${e}`}});console.log("Объект успешно загружен:",c.data),d.value=c.data,d.value.event_type=B.find(f=>f.value===d.value.event_type),d.value.period=O.find(f=>f.value===d.value.period),d.value.start_time&&(d.value.start_time=d.value.start_time.slice(0,16)),console.log("Объект нормализован:",d.value),Object.assign(t,d.value)}catch(c){console.error("Ошибка загрузки объекта:",((u=c.response)==null?void 0:u.data)||c.message)}};M(()=>t.event_type,s=>{s.value!="task_created"&&s.value!="child_task_status_changed"&&s.value!="task_deadline"&&s.value!="task_status_changed"&&s.value!="task_outcome_changed"&&s.value!="periodic_event"&&(t.task_template=null),s.value!="trigger_fired"&&(t.fired_trigger=null),s.value!="periodic_event"&&(t.period="",t.start_time=null)});const D=()=>(a.control_element=t.control_element?"":"Управляющий элемент обязателен",a.event_type=t.event_type.value?"":"Cобытие обязательно!",(t.event_type=="task_created"||t.event_type=="child_task_status_changed"||t.event_type=="task_deadline"||t.event_type=="task_status_changed"||t.event_type=="task_outcome_changed"||t.event_type=="periodic_event")&&(a.task_template=t.task_template?"":"Шаблон задачи обязателен!"),t.event_type=="trigger_fired"&&(a.fired_trigger=t.fired_trigger?"":"Управляющий элемент обязателен!"),t.event_type=="periodic_event"&&(a.period=t.period.value?"":"Период обязателен!",a.start_time=t.start_time?"":"Выбор начала обязателен"),Object.values(a).every(s=>!s)),R=async()=>{var s,e,l;if(!D()){console.error("Форма содержит ошибки:",a);return}try{const u=C.params.id;let c=localStorage.getItem("access_token");const f=h(c);if(c&&!f){p.push({name:"Login"});return}const T={control_element:t.control_element.id,event_type:t.event_type.value,task_template:((s=t.task_template)==null?void 0:s.id)||null,fired_trigger:((e=t.fired_trigger)==null?void 0:e.id)||null,period:((l=t.period)==null?void 0:l.value)||"",start_time:t.start_time},A=t.control_element.id;console.log("JSON данные перед отправкой:",T),await V.patch(`${$}/control_element_events/${u}/`,T,{headers:{Authorization:`Bearer ${c}`}}),console.log("Данные обновлены"),p.push({name:"ControlElementDetail",params:{id:A}})}catch(u){u.response&&u.response.data?(Object.assign(a,u.response.data),console.error("Ошибка при сохранении изменений:",u.response.data)):console.error("Ошибка при сохранении изменений:",u.message)}},z=()=>{K(p)};return q(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await U(),await w(),await x(),I.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>I.value?(i(),r("div",P,[o("div",Q,[e[19]||(e[19]=o("div",{class:"form-header"},[o("h1",null,"Редактирование события")],-1)),d.value?(i(),r("form",{key:0,onSubmit:F(R,["prevent"]),class:"form",id:"edit-form"},[o("div",W,[e[8]||(e[8]=o("label",{class:"form-label"},"Управляющий элемент:",-1)),g(m(b),{modelValue:t.control_element,"onUpdate:modelValue":e[0]||(e[0]=l=>t.control_element=l),options:k.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите управляющий элемент",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!m(S)},{noOptions:_(()=>[...e[6]||(e[6]=[o("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[7]||(e[7]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options","disabled"]),a.control_element?(i(),r("span",X,v(a.control_element),1)):n("",!0)]),o("div",Y,[e[9]||(e[9]=o("label",{class:"form-label"},"Событие:",-1)),g(m(b),{modelValue:t.event_type,"onUpdate:modelValue":e[1]||(e[1]=l=>t.event_type=l),options:B,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип задачи",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),a.event_type?(i(),r("span",Z,v(a.event_type),1)):n("",!0)]),t.event_type.value=="task_created"||t.event_type.value=="child_task_status_changed"||t.event_type.value=="task_deadline"||t.event_type.value=="task_status_changed"||t.event_type.value=="task_outcome_changed"||t.event_type.value=="periodic_event"?(i(),r("div",ee,[e[12]||(e[12]=o("label",{class:"form-label"},"Шаблон задачи:",-1)),g(m(b),{modelValue:t.task_template,"onUpdate:modelValue":e[2]||(e[2]=l=>t.task_template=l),options:E.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:_(()=>[...e[10]||(e[10]=[o("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[11]||(e[11]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.task_template?(i(),r("span",te,v(a.task_template),1)):n("",!0)])):n("",!0),t.event_type.value=="trigger_fired"?(i(),r("div",le,[e[15]||(e[15]=o("label",{class:"form-label"},"Сработавший триггер:",-1)),g(m(b),{modelValue:t.fired_trigger,"onUpdate:modelValue":e[3]||(e[3]=l=>t.fired_trigger=l),options:k.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите управляющий элемент",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:_(()=>[...e[13]||(e[13]=[o("span",null,"Список пуст",-1)])]),noResult:_(()=>[...e[14]||(e[14]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.fired_trigger?(i(),r("span",se,v(a.fired_trigger),1)):n("",!0)])):n("",!0),t.event_type.value=="periodic_event"?(i(),r("div",ae,[e[16]||(e[16]=o("label",{class:"form-label"},"Период:",-1)),g(m(b),{modelValue:t.period,"onUpdate:modelValue":e[4]||(e[4]=l=>t.period=l),options:O,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите период",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!0},null,8,["modelValue"]),a.period?(i(),r("span",oe,v(a.period),1)):n("",!0)])):n("",!0),t.event_type.value=="periodic_event"?(i(),r("div",re,[e[17]||(e[17]=o("label",{for:"start_time",class:"form-label"},"Начало по плану:",-1)),J(o("input",{"onUpdate:modelValue":e[5]||(e[5]=l=>t.start_time=l),id:"start_time",type:"datetime-local",class:"form-input",disabled:!0},null,512),[[G,t.start_time]]),a.start_time?(i(),r("span",ne,v(a.start_time),1)):n("",!0)])):n("",!0)],32)):n("",!0),o("div",{class:"form-menu button-group"},[e[18]||(e[18]=o("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),o("button",{type:"button",onClick:z,class:"button"},"Отмена")])])])):n("",!0)}},pe=L(ie,[["__scopeId","data-v-e91891b9"]]);export{pe as default};
