import{r as p,a as y,A as R,o as T,c,d as t,b,f as w,C as h,t as V,w as j,n as U,k as A,i as x,u as D,h as q,j as B,l as d}from"./index-C8MToAQO.js";import{s as O}from"./custom-multiselect-DcF6BiF3.js";const z={key:0},E={key:0,class:"form-page"},I={class:"form-field"},L={key:0,class:"error"},M={key:0,class:"form-field"},F={key:0,class:"error"},J={key:1,class:"none-card"},P={key:1,class:"loading"},Q={__name:"PlanResultUpdate",setup(G){const k=A(),m=D(),l=p(null),u=y({task:null,status:"",outcome:null}),g=p(!1),f=p([]),a=p(),$=async()=>{var i;const r=k.params.id;let e=localStorage.getItem("access_token");const s=x(e);if(e&&!s){m.push({name:"Login"});return}try{const o=await q.get(`${B}/plan_result_update/${r}/`,{headers:{Authorization:`Bearer ${e}`}});l.value=o.data,console.log("Объект успешно загружен:",l.value),f.value=l.value.outcomes,console.log("Итоги задачи:",f.value),l.value.task.controllers.some(v=>v==s.user_id)?a.value="controller":(l.value.task.executor==s.user_id||l.value.task.co_executors.some(v=>v.id==s.user_id))&&(a.value="executor"),console.log("Роль:",a.value),l.value.status=_.value.find(v=>v.value===l.value.status),console.log("Объект нормализован:",l.value),Object.assign(u,l.value)}catch(o){console.error("Ошибка загрузки объекта:",((i=o.response)==null?void 0:i.data)||o.message)}},_=R(()=>[!l.value.task.require_review||a.value=="controller"?{label:"В ожидании",value:"waiting"}:null,!l.value.task.require_review||a.value=="controller"?{label:"Назначено",value:"assigned"}:null,{label:"В процессе",value:"in_progress"},{label:"На проверке",value:"under_review"},!l.value.task.require_review||a.value=="controller"?{label:"Выполнено",value:"completed"}:null,!l.value.task.require_review||a.value=="controller"?{label:"Провалено",value:"failed"}:null,!l.value.task.require_review||a.value=="controller"?{label:"Отменено",value:"canceled"}:null,!l.value.task.require_review||a.value=="controller"?{name:"desc",label:"Описание"}:null].filter(Boolean)),n=y({}),C=()=>(n.status=u.status.value?"":"Статус задачи обязателен!",Object.values(n).every(r=>!r)),S=async()=>{var e;const r=k.params.id;if(!C()){console.error("Форма содержит ошибки:",n);return}try{let s=localStorage.getItem("access_token");const i=x(s);if(s&&!i){m.push({name:"Login"});return}const o={status:u.status.value,outcome:((e=u.outcome)==null?void 0:e.id)||null};console.log("JSON данные перед отправкой:",o),await q.patch(`${B}/plan_result_update/${r}/`,o,{headers:{Authorization:`Bearer ${s}`}}),console.log("Данные обновлены"),m.push({name:"TaskDetail",params:{id:r}})}catch(s){s.response&&s.response.data?(Object.assign(n,s.response.data),console.error("Ошибка при сохранении изменений:",s.response.data)):console.error("Ошибка при сохранении изменений:",s.message)}},N=()=>{m.back()};return T(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await $(),g.value=!0}catch(r){console.error("Ошибка при загрузке данных:",r)}}),(r,e)=>{var s,i;return g.value?(d(),c("div",z,[l.value?(d(),c("div",E,[e[7]||(e[7]=t("div",{class:"form-header"},[t("h1",null,"Результат плана")],-1)),t("form",{onSubmit:U(S,["prevent"]),class:"modal-form",id:"edit-form"},[t("div",I,[e[2]||(e[2]=t("label",{class:"form-label"},"Статус:",-1)),w(h(O),{modelValue:u.status,"onUpdate:modelValue":e[0]||(e[0]=o=>u.status=o),options:_.value,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите статус",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue","options"]),n.status?(d(),c("span",L,V(n.status),1)):b("",!0)]),(i=(s=l.value)==null?void 0:s.task)!=null&&i.task_outcome?(d(),c("div",M,[e[5]||(e[5]=t("label",{class:"form-label"},"Итог задачи:",-1)),w(h(O),{modelValue:u.outcome,"onUpdate:modelValue":e[1]||(e[1]=o=>u.outcome=o),options:f.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите итог задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:j(()=>[...e[3]||(e[3]=[t("span",null,"Список пуст",-1)])]),noResult:j(()=>[...e[4]||(e[4]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),n.outcome?(d(),c("span",F,V(n.outcome),1)):b("",!0)])):b("",!0)],32),t("div",{class:"button-group modal-menu"},[e[6]||(e[6]=t("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),t("button",{type:"button",onClick:N,class:"button"},"Отмена")])])):(d(),c("div",J,[...e[8]||(e[8]=[t("div",null,"Объект не найден",-1)])]))])):(d(),c("div",P,[...e[9]||(e[9]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{Q as default};
