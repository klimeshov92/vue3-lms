import{a as N,r as c,k as M,o as R,c as d,d as o,b as O,p as E,v as G,f as w,w as v,D as x,n as H,F as K,G as Q,t as p,e as W,i as _,h as f,j as k,u as X,g as Y,l as r,m as I}from"./index-CfAZEXlX.js";import{s as q}from"./custom-multiselect-CMYyZ4s-.js";const Z={key:0},ee={key:0,class:"list-page"},se={class:"filters-inner"},oe={class:"filters-field"},le={class:"filters-field"},te={class:"filters-field"},ae={class:"filters-field"},ie={class:"filters-menu button-group"},ne={key:1,class:"list-items"},re={class:"list-grid"},de={class:"list-card-header"},ue={class:"list-card-header-title"},ce={class:"list-card-text"},ve={class:"list-card-text-elem"},ge={class:"list-card-text-elem"},me={class:"list-card-menu minibutton-group"},be={class:"list-pagination"},pe=["disabled"],_e=["disabled"],fe={key:2,class:"none-card"},ke={key:3,class:"list-menu button-group"},Se={key:1,class:"loading"},ye={key:1,class:"loading"},ze={__name:"SubdivisionList",setup(we){const u=M(),P=X(),i=N({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddSubdivision:!1,canViewSubdivision:!1}),A=c(!1),z=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"},{label:"Юридическое назнание организации: по возрастанию",value:"organization__legal_name"},{label:"Юридическое назнание организации: по убыванию",value:"-organization__legal_name"},{label:"Название родительского подразделения: по возрастанию",value:"parent_subdivision__name"},{label:"Название родительского подразделения: по убыванию",value:"-parent_subdivision__name"}],V=c([]),j=async()=>{let s=localStorage.getItem("access_token");const e=_(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const l=await f.get(`${k}/organizations/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});V.value=l.data.results||[],console.log("Организации загружены:",V.value)}catch(l){console.error("Ошибка при загрузке организаций:",l.response?l.response.data:l.message)}},h=c([]),B=async()=>{let s=localStorage.getItem("access_token");const e=_(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const l=await f.get(`${k}/subdivisions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});h.value=l.data.results||[],console.log("Подразделения загружены:",h.value)}catch(l){console.error("Ошибка при загрузке подразделений:",l.response?l.response.data:l.message)}},a=N({name:u.query.name||"",organization:u.query.organization||"",parent_subdivision:u.query.parent_subdivision||"",order:z.find(s=>s.value===u.query.order||"name")}),L=()=>{const s=localStorage.getItem("subdivisionFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(a,JSON.parse(s)))},n=c(Number(u.query.page)||1),$=c(1),D=()=>{const s=localStorage.getItem("subdivisionPage");s&&(console.log("Загруженная странциа:",s),n.value=parseInt(s,10))},S=async(s,e)=>{var g,m;console.log("Загрузка подразделений с фильтрами:",s,"для страницы:",e);let l=localStorage.getItem("access_token");const t=_(l);l&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),l=null),P.push({name:"SubdivisionList",query:{name:s.name||"",organization:s.organization||"",parent_subdivision:s.parent_subdivision||"",order:s.order.value,page:n.value}}),localStorage.setItem("subdivisionFilters",JSON.stringify(s));try{const b=await f.get(`${k}/subdivisions/`,{headers:{...l&&{Authorization:`Bearer ${l}`}},params:{page:e,page_size:12,name:s.name,organization:(g=s.organization)==null?void 0:g.id,parent_subdivision:(m=s.parent_subdivision)==null?void 0:m.id,ordering:s.order.value}});console.log("Список организаций загружен:",b.data),i.items=b.data.results,$.value=Math.ceil(b.data.count/12)}catch(b){console.error("Ошибка при загрузке списка организаций:",b)}},F=s=>{console.log("Смена страницы на:",s),n.value=s,P.push({name:"SubdivisionList",query:{...u.query,page:n.value}}),localStorage.setItem("subdivisionPage",n.value),S(a,s)},y=c(!1),C=()=>{y.value=!y.value,console.log("Текущий статус показа фильтров:",y.value)},T=()=>{console.log("Сбрасываем фильтры"),a.name="",a.organization="",a.parent_subdivision="",a.order=z.find(s=>s.value==="name"),localStorage.removeItem("subdivisionFilters"),localStorage.removeItem("subdivisionPage"),n.value=1,P.push({name:"SubdivisionList",query:{name:"",organization:"",parent_subdivision:"",page:n.value}}),S(a,n.value)},U=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const l=_(e);if(!(!e||!l))try{(await f.get(`${k}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(t){console.error("Ошибка проверки версии прав:",t),localStorage.removeItem("userPermissions")}},J=async()=>{let s=localStorage.getItem("access_token");const e=_(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!e&&l.user_id!==1||e&&e.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const t=await f.get(`${k}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",t.data),l=t.data,localStorage.setItem("userPermissions",JSON.stringify(l))}i.globalPermissionsList=l.global_permissions||[],i.objectPermissionsDict=l.object_permissions||{},i.canAddSubdivision=i.globalPermissionsList.includes("core.add_subdivision"),console.log("Права на добавление подразделений:",i.canAddSubdivision),i.canViewSubdivision=i.globalPermissionsList.includes("core.view_subdivision")||!!i.objectPermissionsDict["core.view_subdivision"],console.log("Права на просмотр подразделений:",i.canViewSubdivision)}catch(l){console.error("Ошибка при получении разрешений пользователя:",l)}};return R(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await L(),await D(),await j(),await B(),await U(),await J(),await S(a,n.value),A.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const l=Y("router-link");return A.value?(r(),d("div",Z,[i.canViewSubdivision?(r(),d("div",ee,[e[21]||(e[21]=o("div",{class:"list-header"},[o("h1",null,"Подразделения")],-1)),o("div",{class:"list-settings"},[o("button",{onClick:C,class:"list-settings-button"}," Параметры ")]),y.value?(r(),d("div",{key:0,class:"filters-overlay",onClick:C},[o("div",{class:"filters-outer",onClick:e[5]||(e[5]=H(()=>{},["stop"]))},[o("div",{class:"filters-close_button-inner"},[o("button",{onClick:C,class:"filters-close_button"}," × ")]),o("div",se,[o("div",oe,[e[8]||(e[8]=o("label",{class:"filters-label"},"Название:",-1)),E(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.name=t),class:"filters-input",placeholder:"Введите название"},null,512),[[G,a.name]])]),o("div",le,[e[11]||(e[11]=o("label",{class:"filters-label"},"Организация:",-1)),w(x(q),{modelValue:a.organization,"onUpdate:modelValue":e[1]||(e[1]=t=>a.organization=t),options:V.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"legal_name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:v(()=>[...e[9]||(e[9]=[o("span",null,"Список пуст",-1)])]),noResult:v(()=>[...e[10]||(e[10]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",te,[e[14]||(e[14]=o("label",{class:"filters-label"},"Родительское подразделение:",-1)),w(x(q),{modelValue:a.parent_subdivision,"onUpdate:modelValue":e[2]||(e[2]=t=>a.parent_subdivision=t),options:h.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:v(()=>[...e[12]||(e[12]=[o("span",null,"Список пуст",-1)])]),noResult:v(()=>[...e[13]||(e[13]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",ae,[e[15]||(e[15]=o("label",{class:"filters-label"},"Сортировка:",-1)),w(x(q),{modelValue:a.order,"onUpdate:modelValue":e[3]||(e[3]=t=>a.order=t),options:z,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),o("div",ie,[o("button",{onClick:e[4]||(e[4]=t=>S(a,n.value.value)),class:"button"},"Применить"),o("button",{onClick:T,class:"button"},"Сбросить")])])])):O("",!0),i.items.length!==0?(r(),d("div",ne,[o("div",re,[(r(!0),d(K,null,Q(i.items,t=>{var g,m;return r(),d("div",{key:t.id,class:"list-card"},[o("div",de,[o("div",ue,[o("h2",null,p(t.name||"Нет названия"),1)])]),o("div",ce,[o("div",ve,[e[16]||(e[16]=o("span",{class:"list-card-text-label"},"Организация:",-1)),I(" "+p(((g=t.organization)==null?void 0:g.legal_name)||"Нет организации"),1)]),o("div",ge,[e[17]||(e[17]=o("span",{class:"list-card-text-label"},"Родительское подразделение:",-1)),I(" "+p(((m=t.parent_subdivision)==null?void 0:m.name)||"Нет родительского подразделения"),1)])]),o("div",me,[w(l,{to:{name:"SubdivisionDetail",params:{id:t.id},query:{tab:"details"}},class:"minibutton"},{default:v(()=>[...e[18]||(e[18]=[I(" Подробнее ",-1)])]),_:1},8,["to"])])])}),128))]),o("div",be,[o("button",{disabled:n.value===1,onClick:e[6]||(e[6]=t=>F(n.value-1)),class:"list-settings-button"}," Назад ",8,pe),o("span",null,"Страница "+p(n.value)+" из "+p($.value),1),o("button",{disabled:n.value===$.value,onClick:e[7]||(e[7]=t=>F(n.value+1)),class:"list-settings-button"}," Вперед ",8,_e)])])):(r(),d("div",fe,[...e[19]||(e[19]=[o("div",null,"Список пуст",-1)])])),i.canAddSubdivision?(r(),d("div",ke,[i.canAddSubdivision?(r(),W(l,{key:0,to:{name:"SubdivisionCreate"},class:"button"},{default:v(()=>[...e[20]||(e[20]=[I(" Создать ",-1)])]),_:1})):O("",!0)])):O("",!0)])):(r(),d("div",Se,[...e[22]||(e[22]=[o("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(r(),d("div",ye,[...e[23]||(e[23]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{ze as default};
