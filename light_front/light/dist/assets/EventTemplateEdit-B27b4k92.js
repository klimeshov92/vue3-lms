import{r as v,a as D,C as A,o as M,c as i,d as l,b as m,t as b,f as B,D as C,w,p as h,v as _,n as q,i as x,u as J,h as k,j as y,k as P,q as G,l as d}from"./index-CadGroRP.js";import{s as T}from"./custom-multiselect-7oKqqfDz.js";import"./EditorComponent-Cj7qhH0h.js";const H={key:0},K={key:0,class:"form-page"},Q={class:"form-field"},W={key:0,class:"avatar-preview"},X=["href"],Y={class:"form-field"},Z={key:0,class:"error"},ee={class:"form-field"},ae={class:"form-field"},oe={key:0,class:"error"},le={key:0,class:"form-field"},te={key:0,class:"error"},se={key:1,class:"form-field"},re={key:0,class:"error"},ne={class:"form-field"},ie={key:0,class:"error"},de={class:"form-field"},ue={key:1,class:"none-card"},ce={key:1,class:"loading"},be={__name:"EventTemplateEdit",setup(me){const j=P(),f=J(),u=v(null),a=D({format:"",categories:[],name:"",link:"",location:"",admins:[],desc:""}),O=v(!1),S=[{label:"Очное мероприятие",value:"face_to_face"},{label:"Вебинар",value:"webinar"},{label:"Смешанный формат",value:"mixed"}],V=v([]),L=async()=>{let o=localStorage.getItem("access_token");const e=x(o);if(o&&!e){f.push({name:"Login"});return}try{const s=await k.get(`${y}/categories/`,{headers:{Authorization:`Bearer ${o}`}});V.value=s.data.results||[],console.log("Категории загружены:",V.value)}catch(s){console.error("Ошибка при загрузке категорий:",s.response?s.response.data:s.message)}},$=v([]),R=async()=>{let o=localStorage.getItem("access_token");const e=x(o);if(o&&!e){f.push({name:"Login"});return}try{const s=await k.get(`${y}/accounts/`,{headers:{Authorization:`Bearer ${o}`}});$.value=s.data.results||[],console.log("Аккаунты загружены:",$.value)}catch(s){console.error("Ошибка при загрузке сотрудников:",s.response?s.response.data:s.message)}},z=async()=>{var c;const o=j.params.id;let e=localStorage.getItem("access_token");const s=x(e);if(e&&!s){f.push({name:"Login"});return}try{const r=await k.get(`${y}/event_templates/${o}/`,{headers:{Authorization:`Bearer ${e}`}});u.value=r.data,console.log("Объект успешно загружен:",u.value),u.value.format=S.find(p=>p.value===u.value.format),console.log("Объект нормализован:",u.value),Object.assign(a,u.value),g.value=u.value.avatar||""}catch(r){console.error("Ошибка загрузки объекта:",((c=r.response)==null?void 0:c.data)||r.message)}},U=v(null),g=v(null),E=o=>{const e=o.target.files[0];e&&(U.value=e,g.value=URL.createObjectURL(e))};A(()=>a.term_type,o=>{o.value=="none"&&(a.term_value=null)}),A(()=>a.format,o=>{o.value!="face_to_face"&&o.value!="mixed"&&(a.location=null),o.value!="webinar"&&o.value!="mixed"&&(a.link=null)});const t=D({}),F=()=>(t.format=a.format.value?"":"Формат обязателен!",a.format.value=="face_to_face"&&(t.location=a.location?"":"Локация обязательна!"),a.format.value=="webinar"&&(t.link=a.link?"":"Ссылка обязательна!"),a.format.value=="mixed"&&(t.link=a.link?"":"Ссылка обязательна!",t.location=a.location?"":"Локация обязательна!"),t.name=a.name?"":"Название обязательно!",t.admins=a.admins&&a.admins.length>0?"":"Ведущие обязательны!",Object.values(t).every(o=>!o)),I=async()=>{if(!F()){console.error("Форма содержит ошибки:",t);return}try{const o=j.params.id;let e=localStorage.getItem("access_token");const s=x(e);if(e&&!s){f.push({name:"Login"});return}const c={format:a.format.value,categories:a.categories.map(r=>r.id),name:a.name,link:a.link,location:a.location,admins:a.admins.map(r=>r.id),desc:a.desc};if(console.log("JSON данные перед отправкой:",c),await k.patch(`${y}/event_templates/${o}/`,c,{headers:{Authorization:`Bearer ${e}`}}),console.log("Данные обновлены"),U.value){const r=new FormData;r.append("avatar",U.value);const p=`${y}/event_templates/${o}/`;await k.patch(p,r,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}}),console.log("Аватар успешно обновлен")}console.log("Изменения сохранены"),f.push({name:"EventTemplateDetail",params:{id:o}})}catch(o){o.response&&o.response.data?(Object.assign(t,o.response.data),console.error("Ошибка при сохранении изменений:",o.response.data)):console.error("Ошибка при сохранении изменений:",o.message)}},N=()=>{G(f)};return M(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await L(),await R(),await z(),O.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,e)=>{var s,c,r,p;return O.value?(d(),i("div",H,[u.value?(d(),i("div",K,[e[21]||(e[21]=l("div",{class:"form-header"},[l("h1",null,"Редактирование мероприятия")],-1)),l("form",{onSubmit:q(I,["prevent"]),class:"form",id:"edit-form"},[l("div",Q,[e[8]||(e[8]=l("label",{for:"avatar",class:"form-label"},"Аватар:",-1)),l("input",{type:"file",id:"avatar",onChange:E,class:"form-input"},null,32),g.value?(d(),i("div",W,[e[7]||(e[7]=l("span",{class:"avatar-preview-text"},"Текущий аватар:",-1)),l("a",{href:g.value,target:"_blank",class:"link"},b(g.value),9,X)])):m("",!0)]),l("div",Y,[e[9]||(e[9]=l("label",{class:"form-label"},"Формат:",-1)),B(C(T),{modelValue:a.format,"onUpdate:modelValue":e[0]||(e[0]=n=>a.format=n),options:S,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите формат",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),t.format?(d(),i("span",Z,b(t.format),1)):m("",!0)]),l("div",ee,[e[12]||(e[12]=l("label",{class:"form-label"},"Категории:",-1)),B(C(T),{modelValue:a.categories,"onUpdate:modelValue":e[1]||(e[1]=n=>a.categories=n),options:V.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:w(()=>[...e[10]||(e[10]=[l("span",null,"Список пуст",-1)])]),noResult:w(()=>[...e[11]||(e[11]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),l("div",ae,[e[13]||(e[13]=l("label",{for:"name",class:"form-label"},"Название:",-1)),h(l("input",{"onUpdate:modelValue":e[2]||(e[2]=n=>a.name=n),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[_,a.name]]),t.name?(d(),i("span",oe,b(t.name),1)):m("",!0)]),((s=a.format)==null?void 0:s.value)=="face_to_face"||((c=a.format)==null?void 0:c.value)=="mixed"?(d(),i("div",le,[e[14]||(e[14]=l("label",{for:"location",class:"form-label"},"Локация:",-1)),h(l("textarea",{"onUpdate:modelValue":e[3]||(e[3]=n=>a.location=n),id:"location",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[_,a.location]]),t.location?(d(),i("span",te,b(t.location),1)):m("",!0)])):m("",!0),((r=a.format)==null?void 0:r.value)=="webinar"||((p=a.format)==null?void 0:p.value)=="mixed"?(d(),i("div",se,[e[15]||(e[15]=l("label",{for:"link",class:"form-label"},"Ссылка:",-1)),h(l("textarea",{"onUpdate:modelValue":e[4]||(e[4]=n=>a.link=n),id:"link",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[_,a.link]]),t.link?(d(),i("span",re,b(t.link),1)):m("",!0)])):m("",!0),l("div",ne,[e[18]||(e[18]=l("label",{class:"form-label"},"Ведущие:",-1)),B(C(T),{modelValue:a.admins,"onUpdate:modelValue":e[5]||(e[5]=n=>a.admins=n),options:$.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите админов",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:w(()=>[...e[16]||(e[16]=[l("span",null,"Список пуст",-1)])]),noResult:w(()=>[...e[17]||(e[17]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),t.admins?(d(),i("span",ie,b(t.admins),1)):m("",!0)]),l("div",de,[e[19]||(e[19]=l("label",{for:"desc",class:"form-label"},"Описание:",-1)),h(l("textarea",{"onUpdate:modelValue":e[6]||(e[6]=n=>a.desc=n),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[_,a.desc]])])],32),l("div",{class:"form-menu button-group"},[e[20]||(e[20]=l("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),l("button",{type:"button",onClick:N,class:"button"},"Отмена")])])):(d(),i("div",ue,[...e[22]||(e[22]=[l("div",null,"Объект не найден",-1)])]))])):(d(),i("div",ce,[...e[23]||(e[23]=[l("div",null,"Загрузка данных...",-1)])]))}}};export{be as default};
