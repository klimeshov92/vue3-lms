import{r as p,a as B,o as I,c as u,d as o,f as k,D as V,p as S,b as E,v as j,t as L,w as m,n as N,i as v,u as R,h as f,j as b,k as _,q as M,l as c}from"./index-Czc3v3Gw.js";import{s as w}from"./custom-multiselect-B58g3l4X.js";const q={key:0},G={key:0,class:"form-page"},P={class:"form-field"},F={class:"form-field"},J={key:0,class:"error"},H={class:"form-field"},K={class:"form-field"},Q={class:"form-field"},W={key:1,class:"none-card"},X={key:1,class:"loading"},se={__name:"AccountGroupEdit",setup(Y){const h=_(),n=R(),r=p(null),a=B({name:"",type:"",categories:[],permissions:[],desc:""}),$=p(!1),x=[{label:"Пользовательская",value:"custom"},{label:"Системная",value:"system"},{label:"Организация",value:"organization"},{label:"Подразделение",value:"subdivision"},{label:"Должность",value:"position"},{label:"Назначение",value:"assignment"},{label:"Импорт из Excel",value:"excel_import"},{label:"Импорт по API",value:"api_import"},{label:"Участники мероприятия",value:"event_participants"},{label:"Ответственные мероприятия",value:"event_responsible"}],g=p([]),A=async()=>{let l=localStorage.getItem("access_token");const e=v(l);if(l&&!e){n.push({name:"Login"});return}try{const s=await f.get(`${b}/categories/`,{headers:{Authorization:`Bearer ${l}`}});g.value=s.data.results||[],console.log("Категории загружены:",g.value)}catch(s){console.error("Ошибка при загрузке категорий:",s.response?s.response.data:s.message)}},y=p([]),O=async()=>{let l=localStorage.getItem("access_token");const e=v(l);if(l&&!e){n.push({name:"Login"});return}try{const s=await f.get(`${b}/permissions/`,{headers:{Authorization:`Bearer ${l}`}});y.value=s.data.results||[],console.log("Разрешения загружены:",y.value)}catch(s){console.error("Ошибка при загрузке разрешений:",s.response?s.response.data:s.message)}},T=async()=>{var d;const l=h.params.id;let e=localStorage.getItem("access_token");const s=v(e);if(e&&!s){n.push({name:"Login"});return}try{const t=await f.get(`${b}/account_groups/${l}/`,{headers:{Authorization:`Bearer ${e}`}});r.value=t.data,console.log("Объект успешно загружен:",r.value),r.value.type=x.find(D=>D.value===r.value.type),console.log("Объект нормализован:",r.value),Object.assign(a,r.value)}catch(t){console.error("Ошибка загрузки объекта:",((d=t.response)==null?void 0:d.data)||t.message)}},i=B({}),U=()=>(i.name=a.name?"":"Название обязательно!",Object.values(i).every(l=>!l)),z=async()=>{if(!U()){console.error("Форма содержит ошибки:",i);return}try{const l=h.params.id;let e=localStorage.getItem("access_token");const s=v(e);if(e&&!s){n.push({name:"Login"});return}const d={name:a.name,type:a.type.value,categories:a.categories.map(t=>t.id),permissions:a.permissions.map(t=>t.id),desc:a.desc};console.log("JSON данные перед отправкой:",d),await f.patch(`${b}/account_groups/${l}/`,d,{headers:{Authorization:`Bearer ${e}`}}),console.log("Данные обновлены"),console.log("Изменения сохранены"),n.push({name:"AccountGroupDetail",params:{id:l}})}catch(l){l.response&&l.response.data?(Object.assign(i,l.response.data),console.error("Ошибка при сохранении изменений:",l.response.data)):console.error("Ошибка при сохранении изменений:",l.message)}},C=()=>{M(n)};return I(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await A(),await O(),await T(),$.value=!0}catch(l){console.error("Ошибка при загрузке данных:",l)}}),(l,e)=>$.value?(c(),u("div",q,[r.value?(c(),u("div",G,[e[15]||(e[15]=o("div",{class:"form-header"},[o("h1",null,"Редактирование группы")],-1)),o("form",{onSubmit:N(z,["prevent"]),class:"form",id:"edit-form"},[o("div",P,[e[5]||(e[5]=o("label",{class:"form-label"},"Тип:",-1)),k(V(w),{modelValue:a.type,"onUpdate:modelValue":e[0]||(e[0]=s=>a.type=s),options:x,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!a.type},null,8,["modelValue","disabled"])]),o("div",F,[e[6]||(e[6]=o("label",{for:"name",class:"form-label"},"Название:",-1)),S(o("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>a.name=s),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[j,a.name]]),i.name?(c(),u("span",J,L(i.name),1)):E("",!0)]),o("div",H,[e[9]||(e[9]=o("label",{class:"form-label"},"Категории:",-1)),k(V(w),{modelValue:a.categories,"onUpdate:modelValue":e[2]||(e[2]=s=>a.categories=s),options:g.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:m(()=>[...e[7]||(e[7]=[o("span",null,"Список пуст",-1)])]),noResult:m(()=>[...e[8]||(e[8]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",K,[e[12]||(e[12]=o("label",{class:"form-label"},"Права:",-1)),k(V(w),{modelValue:a.permissions,"onUpdate:modelValue":e[3]||(e[3]=s=>a.permissions=s),options:y.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите права",label:"codename","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:m(()=>[...e[10]||(e[10]=[o("span",null,"Список пуст",-1)])]),noResult:m(()=>[...e[11]||(e[11]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",Q,[e[13]||(e[13]=o("label",{for:"desc",class:"form-label"},"Описание:",-1)),S(o("textarea",{"onUpdate:modelValue":e[4]||(e[4]=s=>a.desc=s),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[j,a.desc]])])],32),o("div",{class:"form-menu button-group"},[e[14]||(e[14]=o("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),o("button",{type:"button",onClick:C,class:"button"},"Отмена")])])):(c(),u("div",W,[...e[16]||(e[16]=[o("div",null,"Объект не найден",-1)])]))])):(c(),u("div",X,[...e[17]||(e[17]=[o("div",null,"Загрузка данных...",-1)])]))}};export{se as default};
