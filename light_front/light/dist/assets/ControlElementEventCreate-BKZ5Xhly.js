import{_ as z,r as y,a as I,k as A,B as L,o as M,c as r,b as n,d as o,n as q,f as v,w as c,C as u,t as p,p as F,v as J,i as h,u as G,h as C,j as E,l as i}from"./index-_TMNgkFu.js";import{s as f}from"./custom-multiselect-M3BzxD5H.js";const H={key:0},K={class:"form-page"},P={class:"form-field"},Q={key:0,class:"error"},W={class:"form-field"},X={key:0,class:"error"},Y={key:0,class:"form-field"},Z={key:0,class:"error"},ee={key:1,class:"form-field"},te={key:0,class:"error"},le={key:2,class:"form-field"},se={key:0,class:"error"},oe={key:3,class:"form-field"},ae={key:0,class:"error"},re={__name:"ControlElementEventCreate",setup(ne){const _=G(),B=A(),V=y(!1),D=[{label:"Аккаунт создан",value:"account_created"},{label:"Изменился статус дочерней задачи",value:"child_task_status_changed"},{label:"Истек срок задачи",value:"task_deadline"},{label:"Изменился статус задачи",value:"task_status_changed"},{label:"Изменился итог задачи",value:"task_outcome_changed"},{label:"Сработал триггер",value:"trigger_fired"},{label:"Периодическое событие",value:"periodic_event"}],O=[{label:"Ежедневно",value:"daily"},{label:"Еженедельно",value:"weekly"},{label:"Ежемесячно",value:"monthly"}],e=I({control_element:null,event_type:"",task_template:null,fired_trigger:null,period:"",start_time:null}),a=I({}),m=y([]),T=async()=>{let l=localStorage.getItem("access_token");const t=h(l);if(l&&!t){_.push({name:"Login"});return}try{const s=await C.get(`${E}/control_elements/`,{headers:{Authorization:`Bearer ${l}`}});m.value=s.data.results||[],console.log("Управлябщие элементы загружены:",m.value)}catch(s){console.error("Ошибка при загрузке управлябщих элементов:",s.response?s.response.data:s.message)}},g=B.query.control_elementId||"",U=()=>{if(g){console.log("ControlElement ID:",g);const l=m.value.find(t=>t.id===parseInt(g,10));l?e.control_element=l:console.error("ControlElement не найден.")}else console.log("ControlElement ID не найден.")},b=y([]),j=async()=>{let l=localStorage.getItem("access_token");const t=h(l);if(l&&!t){_.push({name:"Login"});return}try{const s=await C.get(`${E}/task_templates/`,{headers:{Authorization:`Bearer ${l}`}});b.value=s.data.results||[],console.log("Шаблоны задач загружены:",b.value)}catch(s){console.error("Ошибка при загрузке шаблонов задач:",s.response?s.response.data:s.message)}};L(()=>e.event_type,l=>{l.value!="task_created"&&l.value!="child_task_status_changed"&&l.value!="task_deadline"&&l.value!="task_status_changed"&&l.value!="task_outcome_changed"&&l.value!="periodic_event"&&(e.task_template=null),l.value!="trigger_fired"&&(e.fired_trigger=null),l.value!="periodic_event"&&(e.period="",e.start_time=null)});const x=()=>(a.control_element=e.control_element?"":"Управляющий элемент обязателен",a.event_type=e.event_type.value?"":"Cобытие обязательно!",(e.event_type=="task_created"||e.event_type=="child_task_status_changed"||e.event_type=="task_deadline"||e.event_type=="task_status_changed"||e.event_type=="task_outcome_changed"||e.event_type=="periodic_event")&&(a.task_template=e.task_template?"":"Шаблон задачи обязателен!"),e.event_type=="trigger_fired"&&(a.fired_trigger=e.fired_trigger?"":"Управляющий элемент обязателен!"),e.event_type=="periodic_event"&&(a.period=e.period.value?"":"Период обязателен!",a.start_time=e.start_time?"":"Выбор начала обязателен"),Object.values(a).every(l=>!l)),R=async()=>{var l,t,s;if(!x()){console.error("Форма содержит ошибки:",a);return}try{console.log("Отправляем данные для создания объекта:",e);const d={control_element:e.control_element.id,event_type:e.event_type.value,task_template:((l=e.task_template)==null?void 0:l.id)||null,fired_trigger:((t=e.fired_trigger)==null?void 0:t.id)||null,period:((s=e.period)==null?void 0:s.value)||"",start_time:e.start_time},$=e.control_element.id;console.log("JSON данные перед отправкой:",d);let k=localStorage.getItem("access_token");const w=h(k);if(k&&!w){_.push({name:"Login"});return}const N=await C.post(`${E}/control_element_events/`,d,{headers:{Authorization:`Bearer ${k}`}});console.log("Объект создан:",N.data),_.push({name:"ControlElementDetail",params:{id:$}})}catch(d){d.response&&d.response.data?(Object.assign(a,d.response.data),console.error("Ошибка при создании объекта:",d.response.data)):console.error("Ошибка при создании объекта:",d.message)}},S=()=>{const l=e.control_element.id;_.push({name:"ControlElementDetail",params:{id:l}})};return M(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await T(),await U(),await j(),V.value=!0}catch(l){console.error("Ошибка при загрузке данных:",l)}}),(l,t)=>V.value?(i(),r("div",H,[o("div",K,[t[19]||(t[19]=o("div",{class:"form-header"},[o("h1",null,"Создание события")],-1)),o("form",{onSubmit:q(R,["prevent"]),class:"form",id:"form"},[o("div",P,[t[8]||(t[8]=o("label",{class:"form-label"},"Управляющий элемент:",-1)),v(u(f),{modelValue:e.control_element,"onUpdate:modelValue":t[0]||(t[0]=s=>e.control_element=s),options:m.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите управляющий элемент",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:!!u(g)},{noOptions:c(()=>[...t[6]||(t[6]=[o("span",null,"Список пуст",-1)])]),noResult:c(()=>[...t[7]||(t[7]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options","disabled"]),a.control_element?(i(),r("span",Q,p(a.control_element),1)):n("",!0)]),o("div",W,[t[9]||(t[9]=o("label",{class:"form-label"},"Событие:",-1)),v(u(f),{modelValue:e.event_type,"onUpdate:modelValue":t[1]||(t[1]=s=>e.event_type=s),options:D,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип задачи",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),a.event_type?(i(),r("span",X,p(a.event_type),1)):n("",!0)]),e.event_type.value=="task_created"||e.event_type.value=="child_task_status_changed"||e.event_type.value=="task_deadline"||e.event_type.value=="task_status_changed"||e.event_type.value=="task_outcome_changed"||e.event_type.value=="periodic_event"?(i(),r("div",Y,[t[12]||(t[12]=o("label",{class:"form-label"},"Шаблон задачи:",-1)),v(u(f),{modelValue:e.task_template,"onUpdate:modelValue":t[2]||(t[2]=s=>e.task_template=s),options:b.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:c(()=>[...t[10]||(t[10]=[o("span",null,"Список пуст",-1)])]),noResult:c(()=>[...t[11]||(t[11]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.task_template?(i(),r("span",Z,p(a.task_template),1)):n("",!0)])):n("",!0),e.event_type.value=="trigger_fired"?(i(),r("div",ee,[t[15]||(t[15]=o("label",{class:"form-label"},"Сработавший триггер:",-1)),v(u(f),{modelValue:e.fired_trigger,"onUpdate:modelValue":t[3]||(t[3]=s=>e.fired_trigger=s),options:m.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите управляющий элемент",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:c(()=>[...t[13]||(t[13]=[o("span",null,"Список пуст",-1)])]),noResult:c(()=>[...t[14]||(t[14]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.fired_trigger?(i(),r("span",te,p(a.fired_trigger),1)):n("",!0)])):n("",!0),e.event_type.value=="periodic_event"?(i(),r("div",le,[t[16]||(t[16]=o("label",{class:"form-label"},"Период:",-1)),v(u(f),{modelValue:e.period,"onUpdate:modelValue":t[4]||(t[4]=s=>e.period=s),options:O,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите период",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),a.period?(i(),r("span",se,p(a.period),1)):n("",!0)])):n("",!0),e.event_type.value=="periodic_event"?(i(),r("div",oe,[t[17]||(t[17]=o("label",{for:"start_time",class:"form-label"},"Начало по плану:",-1)),F(o("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>e.start_time=s),id:"start_time",type:"datetime-local",class:"form-input"},null,512),[[J,e.start_time]]),a.start_time?(i(),r("span",ae,p(a.start_time),1)):n("",!0)])):n("",!0)],32),o("div",{class:"form-menu button-group"},[t[18]||(t[18]=o("button",{type:"submit",class:"button",form:"form"},"Сохранить",-1)),o("button",{type:"button",onClick:S,class:"button"},"Отмена")])])])):n("",!0)}},ce=z(re,[["__scopeId","data-v-dd2d95da"]]);export{ce as default};
