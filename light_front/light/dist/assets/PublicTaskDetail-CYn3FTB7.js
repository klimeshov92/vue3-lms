import{r as A,a as E,A as z,k as M,B as J,o as q,c as i,b as u,d as t,t as n,m as b,e as D,w as S,F,E as R,C as V,G as $,f as T,i as j,h as P,j as f,g as U,u as H,l as a,H as K}from"./index-dWaDSvEZ.js";import{_ as Q,a as W}from"./AccountsGroupObjectPermissions-znzMgBhx.js";import{_ as X}from"./TopicMessages-DIWwjUUy.js";import"./EditorComponent-Dgh5e3c2.js";const Y={key:0},Z={key:0,class:"detail-page"},ee={key:0},se={class:"detail-card"},te={class:"detail-card-image-outer"},oe={key:0,class:"detail-card-image-inner"},ae=["src"],ie={key:1,class:"detail-card-image-none"},ce={class:"detail-card-info"},le={class:"detail-header"},ne={class:"detail-header-title"},re={class:"detail-card-text"},de={class:"detail-card-text-elem"},ue={class:"detail-card-text-elem"},be={class:"detail-card-text-elem"},me={class:"detail-menu button-group"},_e={key:0,class:"modal-overlay"},pe={class:"modal"},ge={class:"modal-header"},ke={class:"modal-header-h2"},ve={class:"minibutton-group modal-menu"},je={class:"detail-tabs"},Pe={class:"tabs-header"},fe=["onClick"],he={key:0,class:"tabs-content"},ye={key:0,class:"desc-tab"},Ae={key:0},Te={key:1},we={key:1,class:"detail-tab"},Oe={class:"detail-tab-elem"},De={class:"detail-tab-elem"},Se={class:"detail-tab-elem"},Ve={class:"detail-tab-elem"},$e={class:"detail-tab-elem"},Ie={class:"detail-tab-elem"},Le={class:"detail-tab-elem"},xe={key:2,class:"topic-tab"},Ge={key:3,class:"table-tab"},Ce={key:4,class:"table-tab"},Be={key:1,class:"none-container"},Ne={key:1,class:"loading"},Ee={key:1,class:"loading"},Ue={__name:"PublicTaskDetail",setup(ze){const p=M(),g=H(),w=A(!1),e=E({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewPublicTask:!1,canSelfAssignment:!1,canEditPublicTask:!1,canDeletePublicTask:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),h=async()=>{const o=p.params.id;let s=localStorage.getItem("access_token");const r=j(s);s&&!r&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const c=await P.get(`${f}/public_tasks/${o}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные плана:",c.data),e.object=c.data}catch(c){console.error("Ошибка при получении данных плана:",c)}},y=A(!1),I=()=>{y.value=!0},O=()=>{y.value=!1},L=async()=>{let o=localStorage.getItem("access_token");const s=j(o);if(o&&!s){g.push({name:"Login"});return}const r=p.params.id;try{await P.delete(`${f}/public_tasks/${r}/`,{headers:{Authorization:`Bearer ${o}`}}),O(),g.push({name:"PublicTaskList"})}catch(c){console.error("Ошибка удаления плана:",c)}},x=async o=>{let s=localStorage.getItem("access_token");const r=j(s);if(s&&!r){g.push({name:"Login"});return}try{const c=await P.post(`${f}/self_assignment/${o}/public_task/${e.object.id}/`,{},{headers:{Authorization:`Bearer ${s}`}});console.log("Самоназначение:",c.data),g.push({name:"TaskDetail",params:{id:c.data.id}})}catch(c){console.error("Ошибка самоназначения:",c)}},G=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let s=localStorage.getItem("access_token");const r=j(s);if(!(!s||!r))try{(await P.get(`${f}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(c){console.error("Ошибка проверки версии прав:",c),localStorage.removeItem("userPermissions")}},C=async()=>{var r,c,k,v;let o=localStorage.getItem("access_token");const s=j(o);o&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!s&&l.user_id!==1||s&&s.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const d=await P.get(`${f}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",d.data),l=d.data,localStorage.setItem("userPermissions",JSON.stringify(l))}e.globalPermissionsList=l.global_permissions||[],e.objectPermissionsDict=l.object_permissions||{};const _=p.params.id;console.log("ID объекта:",_),e.canViewPublicTask=e.globalPermissionsList.includes("bpms.view_public_task")||e.objectPermissionsDict["bpms.view_public_task"]&&e.objectPermissionsDict["bpms.view_public_task"].includes(Number(_)),console.log("Права на просмотр аккаунтов:",e.canViewPublicTask),e.canSelfAssignment=e.canViewPublicTask&&e.object.self_assignment_task_template&&e.object.self_assignment_task_template&&(!e.object.last_task||((c=(r=e.object.last_task)==null?void 0:r.result)==null?void 0:c.status)=="failed"||((v=(k=e.object.last_task)==null?void 0:k.result)==null?void 0:v.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditPublicTask=e.globalPermissionsList.includes("bpms.change_public_task")||Array.isArray(e.objectPermissionsDict["bpms.change_public_task"])&&e.objectPermissionsDict["bpms.change_public_task"].includes(Number(_)),console.log("Права на редактирование аккаунтов:",e.canEditPublicTask),e.canDeletePublicTask=e.globalPermissionsList.includes("bpms.delete_public_task")||Array.isArray(e.objectPermissionsDict["bpms.delete_public_task"])&&e.objectPermissionsDict["bpms.delete_public_task"].includes(Number(_)),console.log("Права на удаление аккаунтов:",e.canDeletePublicTask),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(l){console.error("Ошибка при загрузке разрешений пользователя:",l)}},B=()=>{g.back()},N=z(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),m=A(p.query.tab||localStorage.getItem(`activePublicTaskTab-${p.params.id}`)||"details");return J(m,o=>{localStorage.setItem(`activePublicTaskTab-${p.params.id}`,o),g.push({query:{tab:o}}),console.log("Загружен таб:",o)}),q(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await h(),await G(),await C(),w.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,s)=>{var c,k,v,l,_;const r=U("router-link");return w.value?(a(),i("div",Y,[e.canViewPublicTask?(a(),i("div",Z,[e.object.id?(a(),i("div",ee,[t("div",se,[t("div",te,[e.object.avatar?(a(),i("div",oe,[t("img",{src:e.object.avatar||"/default-avatar.png",alt:"Аватар"},null,8,ae)])):(a(),i("div",ie,[...s[2]||(s[2]=[t("span",{class:"none-text"},"Нет аватара",-1)])]))]),t("div",ce,[t("div",le,[t("div",ne,[t("h1",null,n(e.object.name||"Безымянный план"),1)])]),t("div",re,[t("div",de,[s[3]||(s[3]=t("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),b(" "+n((c=e.object.last_task)!=null&&c.result?(k=e.object.last_task)==null?void 0:k.result.status_display:"Не назначено"),1)]),t("div",ue,[s[4]||(s[4]=t("span",{class:"detail-card-text-label"},"Шаблон задачи:",-1)),b(" "+n(e.object.task_template?e.object.task_template.str:"Нет плана"),1)]),t("div",be,[s[5]||(s[5]=t("span",{class:"detail-card-text-label"},"Категории:",-1)),b(" "+n(e.object.categories.length>0?e.object.categories.map(d=>d.name).join(", "):"Нет категорий"),1)])]),t("div",me,[e.object.last_task?(a(),D(r,{key:0,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:S(()=>[...s[6]||(s[6]=[b(" Задача ",-1)])]),_:1},8,["to"])):u("",!0),e.canSelfAssignment?(a(),i("button",{key:1,onClick:s[0]||(s[0]=d=>x(e.object.task_template.id)),class:"button"}," Самоназначение ")):u("",!0),e.canEditPublicTask?(a(),D(r,{key:2,to:{name:"PublicTaskEdit",params:{id:e.object.id}},class:"button"},{default:S(()=>[...s[7]||(s[7]=[b(" Изменить ",-1)])]),_:1},8,["to"])):u("",!0),e.canDeletePublicTask?(a(),i("button",{key:3,onClick:I,class:"button"}," Удалить ")):u("",!0),t("button",{type:"button",onClick:B,class:"button"},"Назад")]),y.value?(a(),i("div",_e,[t("div",pe,[t("div",ge,[t("h2",ke,"Удаление "+n(e.object.username||"Безымянная учетная запись"),1)]),t("div",ve,[t("button",{onClick:s[1]||(s[1]=d=>L()),class:"minibutton"},"Подтвердить"),t("button",{onClick:O,class:"minibutton"},"Отменить")])])])):u("",!0)])]),t("div",je,[t("div",Pe,[(a(!0),i(F,null,R(N.value,d=>(a(),i("button",{key:d.name,class:K([{active:m.value===d.name},"tab-button"]),onClick:Me=>m.value=d.name},n(d.label),11,fe))),128))]),m.value?(a(),i("div",he,[m.value==="desc"?(a(),i("div",ye,[e.object.desc?(a(),i("div",Ae,n(e.object.desc),1)):(a(),i("div",Te,[...s[8]||(s[8]=[t("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):u("",!0),m.value==="details"?(a(),i("div",we,[t("div",Oe,[s[9]||(s[9]=t("span",{class:"detail-tab-label"},"Статус задачи:",-1)),b(" "+n((v=e.object.last_task)!=null&&v.result?(l=e.object.last_task)==null?void 0:l.result.status_display:"Не назначено"),1)]),t("div",De,[s[10]||(s[10]=t("span",{class:"detail-tab-label"},"Шаблон задачи:",-1)),b(" "+n(e.object.task_template?e.object.task_template.str:"Нет плана"),1)]),t("div",Se,[s[11]||(s[11]=t("span",{class:"detail-tab-label"},"Категории:",-1)),b(" "+n(e.object.categories.length>0?e.object.categories.map(d=>d.name).join(", "):"Нет категорий"),1)]),t("div",Ve,[s[12]||(s[12]=t("span",{class:"detail-tab-label"},"Создан:",-1)),b(" "+n(e.object.created?V($)(e.object.created):"Нет данных о создании"),1)]),t("div",$e,[s[13]||(s[13]=t("span",{class:"detail-tab-label"},"Создатель:",-1)),b(" "+n(e.object.creator?e.object.creator:"Нет создателя"),1)]),t("div",Ie,[s[14]||(s[14]=t("span",{class:"detail-tab-label"},"Изменён:",-1)),b(" "+n(e.object.changed?V($)(e.object.changed):"Нет данных об изменениях"),1)]),t("div",Le,[s[15]||(s[15]=t("span",{class:"detail-tab-label"},"Редактор:",-1)),b(" "+n(e.object.editor?e.object.editor:"Нет редактора"),1)])])):u("",!0),m.value==="messages"?(a(),i("div",xe,[T(X,{topic_id:(_=e.object)==null?void 0:_.topic.id},null,8,["topic_id"])])):u("",!0),m.value==="accountsGroupObjectPermissions"?(a(),i("div",Ge,[T(Q,{state:e,fetchObject:h,contentTypeModel:"public_task"},null,8,["state"])])):u("",!0),m.value==="accountObjectPermissions"?(a(),i("div",Ce,[T(W,{state:e,fetchObject:h,contentTypeModel:"public_task"},null,8,["state"])])):u("",!0)])):u("",!0)])])):e.object.id?u("",!0):(a(),i("div",Be,[...s[16]||(s[16]=[t("div",{class:"none-card"},[t("div",null,"Объект не найден.")],-1)])]))])):(a(),i("div",Ne,[...s[17]||(s[17]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),i("div",Ee,[...s[18]||(s[18]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{Ue as default};
