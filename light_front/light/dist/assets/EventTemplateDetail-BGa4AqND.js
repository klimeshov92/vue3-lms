import{r as A,a as N,A as z,k as M,B as J,o as q,c as l,b as m,d as s,t as n,m as r,e as D,w as E,F,E as R,C as x,G as S,f as T,i as k,h as f,j as y,g as U,u as H,l as o,H as K}from"./index-BlU-7-2d.js";import{_ as Q,a as W}from"./AccountsGroupObjectPermissions-BO8QtGg4.js";import{_ as X}from"./TopicMessages-C_Qr-qWY.js";import"./EditorComponent-Q0CXIZSB.js";const Y={key:0},Z={key:0,class:"detail-page"},ee={key:0},te={class:"detail-card"},se={class:"detail-card-image-outer"},oe={key:0,class:"detail-card-image-inner"},ae=["src"],le={key:1,class:"detail-card-image-none"},ne={class:"detail-card-info"},ie={class:"detail-header"},ce={class:"detail-header-title"},re={class:"detail-card-text"},de={class:"detail-card-text-elem"},me={class:"detail-card-text-elem"},be={class:"detail-card-text-elem"},ue={key:0,class:"detail-card-text-elem"},_e={key:1,class:"detail-card-text-elem"},pe={class:"detail-card-text-elem"},ve={class:"detail-card-text-elem"},ge={class:"detail-menu button-group"},je={key:0,class:"modal-overlay"},ke={class:"modal"},fe={class:"modal-header"},ye={class:"modal-header-h2"},Pe={class:"minibutton-group modal-menu"},he={class:"detail-tabs"},Ae={class:"tabs-header"},Te=["onClick"],we={key:0,class:"tabs-content"},Oe={key:0,class:"desc-tab"},De={key:0},Ee={key:1},xe={key:1,class:"detail-tab"},Se={class:"detail-tab-elem"},Ve={class:"detail-tab-elem"},$e={key:0,class:"detail-tab-elem"},Ie={key:1,class:"detail-tab-elem"},Le={class:"detail-tab-elem"},Ge={class:"detail-tab-elem"},Ce={class:"detail-tab-elem"},Be={class:"detail-tab-elem"},Ne={class:"detail-tab-elem"},ze={class:"detail-tab-elem"},Me={key:2,class:"topic-tab"},Je={key:3,class:"table-tab"},qe={key:4,class:"table-tab"},Fe={key:1,class:"none-container"},Re={key:1,class:"loading"},Ue={key:1,class:"loading"},Ze={__name:"EventTemplateDetail",setup(He){const p=M(),v=H(),w=A(!1),e=N({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewEventTemplate:!1,canEditEventTemplate:!1,canDeleteEventTemplate:!1,canSelfAssignment:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),P=async()=>{const a=p.params.id;let t=localStorage.getItem("access_token");const b=k(t);t&&!b&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const i=await f.get(`${y}/event_templates/${a}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные мероприятия:",i.data),e.object=i.data}catch(i){console.error("Ошибка при получении данных мероприятия:",i)}},h=A(!1),V=()=>{h.value=!0},O=()=>{h.value=!1},$=async()=>{let a=localStorage.getItem("access_token");const t=k(a);if(a&&!t){v.push({name:"Login"});return}const b=p.params.id;try{await f.delete(`${y}/event_templates/${b}/`,{headers:{Authorization:`Bearer ${a}`}}),O(),v.push({name:"EventTemplateList"})}catch(i){console.error("Ошибка удаления мероприятияа:",i)}},I=async a=>{let t=localStorage.getItem("access_token");const b=k(t);if(t&&!b){v.push({name:"Login"});return}try{const i=await f.post(`${y}/self_assignment/${a}/`,{},{headers:{Authorization:`Bearer ${t}`}});console.log("Самоназначение:",i.data),v.push({name:"TaskDetail",params:{id:i.data.id}})}catch(i){console.error("Ошибка самоназначения:",i)}},L=async()=>{console.log("Проверяем версию прав");const a=JSON.parse(localStorage.getItem("userPermissions"));if(!(a!=null&&a.permissions_version))return;console.log("Текущая версия прав:",a.permissions_version);let t=localStorage.getItem("access_token");const b=k(t);if(!(!t||!b))try{(await f.get(`${y}/user_permissions_version/${a.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(i){console.error("Ошибка проверки версии прав:",i),localStorage.removeItem("userPermissions")}},G=async()=>{var b,i,g,j;let a=localStorage.getItem("access_token");const t=k(a);a&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),a=null);try{let d=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",d),Object.keys(d).length>0&&(console.log("ID пользователя в разрешениях из памяти:",d.user_id),!t&&d.user_id!==1||t&&t.user_id!==d.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),d={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(d).length===0){const c=await f.get(`${y}/user_permissions/`,{headers:{...a&&{Authorization:`Bearer ${a}`}}});console.log("Разрешения пользователя загружены:",c.data),d=c.data,localStorage.setItem("userPermissions",JSON.stringify(d))}e.globalPermissionsList=d.global_permissions||[],e.objectPermissionsDict=d.object_permissions||{};const _=p.params.id;console.log("ID объекта:",_),e.canViewEventTemplate=e.globalPermissionsList.includes("events.view_event_template")||e.objectPermissionsDict["events.view_event_template"]&&e.objectPermissionsDict["events.view_event_template"].includes(Number(_)),console.log("Права на просмотр аккаунтов:",e.canViewEventTemplate),e.canSelfAssignment=e.canViewEventTemplate&&e.object.self_assignment_task_template&&e.object.self_assignment_task_template&&(!e.object.last_task||((i=(b=e.object.last_task)==null?void 0:b.result)==null?void 0:i.status)=="failed"||((j=(g=e.object.last_task)==null?void 0:g.result)==null?void 0:j.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditEventTemplate=e.globalPermissionsList.includes("events.change_event_template")||Array.isArray(e.objectPermissionsDict["events.change_event_template"])&&e.objectPermissionsDict["events.change_event_template"].includes(Number(_)),console.log("Права на редактирование аккаунтов:",e.canEditEventTemplate),e.canDeleteEventTemplate=e.globalPermissionsList.includes("events.delete_event_template")||Array.isArray(e.objectPermissionsDict["events.delete_event_template"])&&e.objectPermissionsDict["events.delete_event_template"].includes(Number(_)),console.log("Права на удаление аккаунтов:",e.canDeleteEventTemplate),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(d){console.error("Ошибка при загрузке разрешений пользователя:",d)}},C=()=>{v.back()},B=z(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),u=A(p.query.tab||localStorage.getItem(`activeEventTemplateTab-${p.params.id}`)||"details");return J(u,a=>{localStorage.setItem(`activeEventTemplateTab-${p.params.id}`,a),v.push({query:{tab:a}}),console.log("Загружен таб:",a)}),q(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await P(),await L(),await G(),w.value=!0}catch(a){console.error("Ошибка при загрузке данных:",a)}}),(a,t)=>{var i,g,j,d,_;const b=U("router-link");return w.value?(o(),l("div",Y,[e.canViewEventTemplate?(o(),l("div",Z,[e.object.id?(o(),l("div",ee,[s("div",te,[s("div",se,[e.object.avatar?(o(),l("div",oe,[s("img",{src:e.object.avatar||"/default-avatar.png",alt:"Аватар"},null,8,ae)])):(o(),l("div",le,[...t[2]||(t[2]=[s("span",{class:"none-text"},"Нет аватара",-1)])]))]),s("div",ne,[s("div",ie,[s("div",ce,[s("h1",null,n(e.object.name||"Безымянный мероприятия"),1)])]),s("div",re,[s("div",de,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),r(" "+n((i=e.object.last_task)!=null&&i.result?(g=e.object.last_task)==null?void 0:g.result.status_display:"Не назначено"),1)]),s("div",me,[t[4]||(t[4]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),r(" "+n(e.object.categories.length>0?e.object.categories.map(c=>c.name).join(", "):"Нет категорий"),1)]),s("div",be,[t[5]||(t[5]=s("span",{class:"detail-card-text-label"},"Форомат:",-1)),r(" "+n(e.object.format_display||"Нет формата"),1)]),e.object.format=="face_to_face"||e.object.format=="mixed"?(o(),l("div",ue,[t[6]||(t[6]=s("span",{class:"detail-card-text-label"},"Локация:",-1)),r(" "+n(e.object.location||"Нет локации"),1)])):m("",!0),e.object.format=="webinar"||e.object.format=="mixed"?(o(),l("div",_e,[t[7]||(t[7]=s("span",{class:"detail-card-text-label"},"Ссылка:",-1)),r(" "+n(e.object.link||"Нет ссылки"),1)])):m("",!0),s("div",pe,[t[8]||(t[8]=s("span",{class:"detail-card-text-label"},"Ведущие:",-1)),r(" "+n(e.object.admins.length>0?e.object.admins.map(c=>c.str).join(", "):"Нет ведущих"),1)]),s("div",ve,[t[9]||(t[9]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),r(" "+n(e.object.categories.length>0?e.object.categories.map(c=>c.name).join(", "):"Нет категорий"),1)])]),s("div",ge,[e.object.last_task?(o(),D(b,{key:0,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:E(()=>[...t[10]||(t[10]=[r(" Задача ",-1)])]),_:1},8,["to"])):m("",!0),e.canSelfAssignment?(o(),l("button",{key:1,onClick:t[0]||(t[0]=c=>I(e.object.self_assignment_task_template)),class:"button"}," Самоназначение ")):m("",!0),e.canEditEventTemplate&&!e.object.last_task?(o(),D(b,{key:2,to:{name:"EventTemplateEdit",params:{id:e.object.id}},class:"button"},{default:E(()=>[...t[11]||(t[11]=[r(" Изменить ",-1)])]),_:1},8,["to"])):m("",!0),e.canDeleteEventTemplate?(o(),l("button",{key:3,onClick:V,class:"button"}," Удалить ")):m("",!0),s("button",{type:"button",onClick:C,class:"button"},"Назад")]),h.value?(o(),l("div",je,[s("div",ke,[s("div",fe,[s("h2",ye,"Удаление "+n(e.object.name||"Безымянного мероприятия"),1)]),s("div",Pe,[s("button",{onClick:t[1]||(t[1]=c=>$()),class:"minibutton"},"Подтвердить"),s("button",{onClick:O,class:"minibutton"},"Отменить")])])])):m("",!0)])]),s("div",he,[s("div",Ae,[(o(!0),l(F,null,R(B.value,c=>(o(),l("button",{key:c.name,class:K([{active:u.value===c.name},"tab-button"]),onClick:Ke=>u.value=c.name},n(c.label),11,Te))),128))]),u.value?(o(),l("div",we,[u.value==="desc"?(o(),l("div",Oe,[e.object.desc?(o(),l("div",De,n(e.object.desc),1)):(o(),l("div",Ee,[...t[12]||(t[12]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):m("",!0),u.value==="details"?(o(),l("div",xe,[s("div",Se,[t[13]||(t[13]=s("span",{class:"detail-tab-label"},"Статус задачи:",-1)),r(" "+n((j=e.object.last_task)!=null&&j.result?(d=e.object.last_task)==null?void 0:d.result.status_display:"Не назначено"),1)]),s("div",Ve,[t[14]||(t[14]=s("span",{class:"detail-tab-label"},"Форомат:",-1)),r(" "+n(e.object.format_display||"Нет формата"),1)]),e.object.format=="face_to_face"||e.object.format=="mixed"?(o(),l("div",$e,[t[15]||(t[15]=s("span",{class:"detail-tab-label"},"Локация:",-1)),r(" "+n(e.object.location||"Нет локации"),1)])):m("",!0),e.object.format=="webinar"||e.object.format=="mixed"?(o(),l("div",Ie,[t[16]||(t[16]=s("span",{class:"detail-tab-label"},"Ссылка:",-1)),r(" "+n(e.object.link||"Нет ссылки"),1)])):m("",!0),s("div",Le,[t[17]||(t[17]=s("span",{class:"detail-tab-label"},"Ведущие:",-1)),r(" "+n(e.object.admins.length>0?e.object.admins.map(c=>c.str).join(", "):"Нет ведущих"),1)]),s("div",Ge,[t[18]||(t[18]=s("span",{class:"detail-tab-label"},"Категории:",-1)),r(" "+n(e.object.categories.length>0?e.object.categories.map(c=>c.name).join(", "):"Нет категорий"),1)]),s("div",Ce,[t[19]||(t[19]=s("span",{class:"detail-tab-label"},"Создан:",-1)),r(" "+n(e.object.created?x(S)(e.object.created):"Нет данных о создании"),1)]),s("div",Be,[t[20]||(t[20]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),r(" "+n(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",Ne,[t[21]||(t[21]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),r(" "+n(e.object.changed?x(S)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",ze,[t[22]||(t[22]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),r(" "+n(e.object.editor?e.object.editor:"Нет редактора"),1)])])):m("",!0),u.value==="messages"?(o(),l("div",Me,[T(X,{topic_id:(_=e.object)==null?void 0:_.topic.id},null,8,["topic_id"])])):m("",!0),u.value==="accountsGroupObjectPermissions"?(o(),l("div",Je,[T(Q,{state:e,fetchObject:P,contentTypeModel:"eventtemplate"},null,8,["state"])])):m("",!0),u.value==="accountObjectPermissions"?(o(),l("div",qe,[T(W,{state:e,fetchObject:P,contentTypeModel:"eventtemplate"},null,8,["state"])])):m("",!0)])):m("",!0)])])):e.object.id?m("",!0):(o(),l("div",Fe,[...t[23]||(t[23]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),l("div",Re,[...t[24]||(t[24]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),l("div",Ue,[...t[25]||(t[25]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Ze as default};
