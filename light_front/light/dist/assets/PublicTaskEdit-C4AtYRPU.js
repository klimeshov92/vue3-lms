import{r as d,a as B,o as N,c as n,d as s,b as w,t as $,f as j,w as g,D as x,p as C,v as O,n as E,i as b,u as M,h as p,j as f,k as P,q,l as i}from"./index-yfpLmCCm.js";import{s as S}from"./custom-multiselect-BtCJ6pih.js";import"./EditorComponent-sX0RyEc9.js";const J={key:0},G={key:0,class:"form-page"},H={class:"form-field"},K={key:0,class:"avatar-preview"},Q=["href"],W={class:"form-field"},X={class:"form-field"},Y={key:0,class:"error"},Z={class:"form-field"},ee={key:0,class:"error"},se={class:"form-field"},ae={key:1,class:"none-card"},te={key:1,class:"loading"},ie={__name:"PublicTaskEdit",setup(oe){const V=P(),c=M(),u=d(null),o=B({task_template:null,name:"",desc:"",categories:[]}),T=d(!1),y=d([]),U=async()=>{let t=localStorage.getItem("access_token");const e=b(t);if(t&&!e){c.push({name:"Login"});return}try{const a=await p.get(`${f}/categories/`,{headers:{Authorization:`Bearer ${t}`}});y.value=a.data.results||[],console.log("Категории загружены:",y.value)}catch(a){console.error("Ошибка при загрузке категорий:",a.response?a.response.data:a.message)}},_=d([]),D=async()=>{let t=localStorage.getItem("access_token");const e=b(t);if(t&&!e){c.push({name:"Login"});return}try{const a=await p.get(`${f}/task_templates/`,{headers:{Authorization:`Bearer ${t}`},params:{task_type:"common_task"}});_.value=a.data.results||[],console.log("Шаблоны задач загружены:",_.value)}catch(a){console.error("Ошибка при загрузке шаблонов задач:",a.response?a.response.data:a.message)}},L=async()=>{var v;const t=V.params.id;let e=localStorage.getItem("access_token");const a=b(e);if(e&&!a){c.push({name:"Login"});return}try{const r=await p.get(`${f}/public_tasks/${t}/`,{headers:{Authorization:`Bearer ${e}`}});u.value=r.data,console.log("Объект успешно загружен:",u.value),Object.assign(o,u.value),m.value=u.value.avatar||""}catch(r){console.error("Ошибка загрузки объекта:",((v=r.response)==null?void 0:v.data)||r.message)}},h=d(null),m=d(null),R=t=>{const e=t.target.files[0];e&&(h.value=e,m.value=URL.createObjectURL(e))},l=B({}),z=()=>(l.task_template=o.task_template?"":"Выбор шаблона задачи обязателен!",l.name=o.name?"":"Название обязательно!",Object.values(l).every(t=>!t)),A=async()=>{var t;if(!z()){console.error("Форма содержит ошибки:",l);return}try{const e=V.params.id;let a=localStorage.getItem("access_token");const v=b(a);if(a&&!v){c.push({name:"Login"});return}const r={task_template:(t=o.task_template)==null?void 0:t.id,name:o.name,desc:o.desc,categories:o.categories.map(k=>k.id)};if(console.log("JSON данные перед отправкой:",r),await p.patch(`${f}/public_tasks/${e}/`,r,{headers:{Authorization:`Bearer ${a}`},params:{task_type:"common_task"}}),console.log("Данные обновлены"),h.value){const k=new FormData;k.append("avatar",h.value);const I=`${f}/public_tasks/${e}/`;await p.patch(I,k,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"multipart/form-data"}}),console.log("Аватар успешно обновлен")}console.log("Изменения сохранены"),c.push({name:"PublicTaskDetail",params:{id:e}})}catch(e){e.response&&e.response.data?(Object.assign(l,e.response.data),console.error("Ошибка при сохранении изменений:",e.response.data)):console.error("Ошибка при сохранении изменений:",e.message)}},F=()=>{q(c)};return N(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await U(),await D(),await L(),T.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,e)=>T.value?(i(),n("div",J,[u.value?(i(),n("div",G,[e[15]||(e[15]=s("div",{class:"form-header"},[s("h1",null,"Редактирование плана")],-1)),s("form",{onSubmit:E(A,["prevent"]),class:"form",id:"edit-form"},[s("div",H,[e[5]||(e[5]=s("label",{for:"avatar",class:"form-label"},"Аватар:",-1)),s("input",{type:"file",id:"avatar",onChange:R,class:"form-input"},null,32),m.value?(i(),n("div",K,[e[4]||(e[4]=s("span",{class:"avatar-preview-text"},"Текущий аватар:",-1)),s("a",{href:m.value,target:"_blank",class:"link"},$(m.value),9,Q)])):w("",!0)]),s("div",W,[e[8]||(e[8]=s("label",{class:"form-label"},"Категории:",-1)),j(x(S),{modelValue:o.categories,"onUpdate:modelValue":e[0]||(e[0]=a=>o.categories=a),options:y.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:g(()=>[...e[6]||(e[6]=[s("span",null,"Список пуст",-1)])]),noResult:g(()=>[...e[7]||(e[7]=[s("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),s("div",X,[e[11]||(e[11]=s("label",{class:"form-label"},"Шаблон задачи:",-1)),j(x(S),{modelValue:o.task_template,"onUpdate:modelValue":e[1]||(e[1]=a=>o.task_template=a),options:_.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите шаблон задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:g(()=>[...e[9]||(e[9]=[s("span",null,"Список пуст",-1)])]),noResult:g(()=>[...e[10]||(e[10]=[s("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),l.task_template?(i(),n("span",Y,$(l.task_template),1)):w("",!0)]),s("div",Z,[e[12]||(e[12]=s("label",{for:"name",class:"form-label"},"Название:",-1)),C(s("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>o.name=a),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[O,o.name]]),l.name?(i(),n("span",ee,$(l.name),1)):w("",!0)]),s("div",se,[e[13]||(e[13]=s("label",{for:"desc",class:"form-label"},"Описание:",-1)),C(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>o.desc=a),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[O,o.desc]])])],32),s("div",{class:"form-menu button-group"},[e[14]||(e[14]=s("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),s("button",{type:"button",onClick:F,class:"button"},"Отмена")])])):(i(),n("div",ae,[...e[16]||(e[16]=[s("div",null,"Объект не найден",-1)])]))])):(i(),n("div",te,[...e[17]||(e[17]=[s("div",null,"Загрузка данных...",-1)])]))}};export{ie as default};
