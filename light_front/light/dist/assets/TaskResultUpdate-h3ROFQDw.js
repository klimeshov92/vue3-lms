import{r as p,a as w,B as U,o as C,c,d as o,b as f,p as N,v as R,t as k,f as h,D as V,w as x,n as M,k as z,i as B,u as A,h as j,j as q,q as E,l as i}from"./index-CAPuKB9Y.js";import{s as O}from"./custom-multiselect-BiCJycwk.js";const I={key:0},L={key:0,class:"form-page"},F={class:"form-field"},J={key:0,class:"error"},G={class:"form-field"},H={key:0,class:"error"},K={key:0,class:"form-field"},P={key:0,class:"error"},Q={key:1,class:"none-card"},W={key:1,class:"loading"},ee={__name:"TaskResultUpdate",setup(X){const _=z(),m=A(),s=p(null),t=w({task:null,score_scaled:null,status:"",outcome:null}),g=p(!1),b=p([]),n=p(),S=async()=>{var d;const u=_.params.id;let e=localStorage.getItem("access_token");const l=B(e);if(e&&!l){m.push({name:"Login"});return}try{const a=await j.get(`${q}/task_result_update/${u}/`,{headers:{Authorization:`Bearer ${e}`}});s.value=a.data,console.log("Объект успешно загружен:",s.value),b.value=s.value.outcomes,console.log("Итоги задачи:",b.value),s.value.task.controllers.some(v=>v==l.user_id)?n.value="controller":(s.value.task.executor==l.user_id||s.value.task.co_executors.some(v=>v.id==l.user_id))&&(n.value="executor"),console.log("Роль:",n.value),s.value.status=y.value.find(v=>v.value===s.value.status),console.log("Объект нормализован:",s.value),Object.assign(t,s.value)}catch(a){console.error("Ошибка загрузки объекта:",((d=a.response)==null?void 0:d.data)||a.message)}},y=U(()=>[!s.value.task.require_review||n.value=="controller"?{label:"В ожидании",value:"waiting"}:null,!s.value.task.require_review||n.value=="controller"?{label:"Назначено",value:"assigned"}:null,{label:"В процессе",value:"in_progress"},{label:"На проверке",value:"under_review"},!s.value.task.require_review||n.value=="controller"?{label:"Выполнено",value:"completed"}:null,!s.value.task.require_review||n.value=="controller"?{label:"Провалено",value:"failed"}:null,!s.value.task.require_review||n.value=="controller"?{label:"Отменено",value:"canceled"}:null].filter(Boolean)),r=w({}),T=()=>(r.status=t.status.value?"":"Статус задачи обязателен!",r.score_scaled=t.score_scaled!=null?"":"Выбор процента выполнения обязателен!",Object.values(r).every(u=>!u)),$=async()=>{var e;const u=_.params.id;if(!T()){console.error("Форма содержит ошибки:",r);return}try{let l=localStorage.getItem("access_token");const d=B(l);if(l&&!d){m.push({name:"Login"});return}const a={score_scaled:t.score_scaled,status:t.status.value,outcome:((e=t.outcome)==null?void 0:e.id)||null};console.log("JSON данные перед отправкой:",a),await j.patch(`${q}/task_result_update/${u}/`,a,{headers:{Authorization:`Bearer ${l}`}}),console.log("Данные обновлены"),m.push({name:"TaskDetail",params:{id:u}})}catch(l){l.response&&l.response.data?(Object.assign(r,l.response.data),console.error("Ошибка при сохранении изменений:",l.response.data)):console.error("Ошибка при сохранении изменений:",l.message)}},D=()=>{E(m)};return C(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await S(),g.value=!0}catch(u){console.error("Ошибка при загрузке данных:",u)}}),(u,e)=>{var l,d;return g.value?(i(),c("div",I,[s.value?(i(),c("div",L,[e[9]||(e[9]=o("div",{class:"form-header"},[o("h1",null,"Результат задачи")],-1)),o("form",{onSubmit:M($,["prevent"]),class:"modal-form",id:"edit-form"},[o("div",F,[e[3]||(e[3]=o("label",{for:"score_scaled",class:"form-label"},"Процент выполнения:",-1)),N(o("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>t.score_scaled=a),id:"score_scaled",type:"number",class:"form-input",placeholder:"Введите пункт"},null,512),[[R,t.score_scaled]]),r.score_scaled?(i(),c("span",J,k(r.score_scaled),1)):f("",!0)]),o("div",G,[e[4]||(e[4]=o("label",{class:"form-label"},"Статус:",-1)),h(V(O),{modelValue:t.status,"onUpdate:modelValue":e[1]||(e[1]=a=>t.status=a),options:y.value,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!1,placeholder:"Выберите статус",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue","options"]),r.status?(i(),c("span",H,k(r.status),1)):f("",!0)]),(d=(l=s.value)==null?void 0:l.task)!=null&&d.task_outcome?(i(),c("div",K,[e[7]||(e[7]=o("label",{class:"form-label"},"Итог задачи:",-1)),h(V(O),{modelValue:t.outcome,"onUpdate:modelValue":e[2]||(e[2]=a=>t.outcome=a),options:b.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите итог задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:x(()=>[...e[5]||(e[5]=[o("span",null,"Список пуст",-1)])]),noResult:x(()=>[...e[6]||(e[6]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),r.outcome?(i(),c("span",P,k(r.outcome),1)):f("",!0)])):f("",!0)],32),o("div",{class:"button-group modal-menu"},[e[8]||(e[8]=o("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),o("button",{type:"button",onClick:D,class:"button"},"Отмена")])])):(i(),c("div",Q,[...e[10]||(e[10]=[o("div",null,"Объект не найден",-1)])]))])):(i(),c("div",W,[...e[11]||(e[11]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{ee as default};
