import{a as N,r as m,k as z,o as J,c,d as t,b as I,p as U,v as M,f as V,w as y,D as O,n as R,F as E,G,t as b,e as H,i as _,h as f,j as k,u as K,g as Q,l as i,m as $}from"./index-CadGroRP.js";import{s as j}from"./custom-multiselect-7oKqqfDz.js";const W={key:0},X={key:0,class:"list-page"},Y={class:"filters-inner"},Z={class:"filters-field"},ee={class:"filters-field"},se={class:"filters-field"},te={class:"filters-menu button-group"},oe={key:1,class:"list-items"},le={class:"list-grid"},ae={class:"list-card-header"},re={class:"list-card-header-title"},ne={class:"list-card-text"},ie={class:"list-card-text-elem"},ce={class:"list-card-menu minibutton-group"},de={class:"list-pagination"},ue=["disabled"],ge=["disabled"],me={key:2,class:"none-card"},ve={key:3,class:"list-menu button-group"},pe={key:1,class:"loading"},ye={key:1,class:"loading"},ke={__name:"CategoryList",setup(be){const d=z(),C=K(),a=N({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddCategory:!1,canViewCategory:!1}),A=m(!1),S=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"},{label:"Название родительской категории: по возрастанию",value:"parent_category__name"},{label:"Название родительской категории: по убыванию",value:"-parent_category__name"}],P=m([]),q=async()=>{let s=localStorage.getItem("access_token");const e=_(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const o=await f.get(`${k}/categories/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});P.value=o.data.results||[],console.log("Категории загружены:",P.value)}catch(o){console.error("Ошибка при загрузке категорий:",o.response?o.response.data:o.message)}},r=N({name:d.query.name||"",parent_category:d.query.parent_category||"",order:S.find(s=>s.value===d.query.order||"name")}),x=()=>{const s=localStorage.getItem("categoryFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(r,JSON.parse(s)))},n=m(Number(d.query.page)||1),w=m(1),L=()=>{const s=localStorage.getItem("categoryPage");s&&(console.log("Загруженная странциа:",s),n.value=parseInt(s,10))},v=async(s,e)=>{var u;console.log("Загрузка категорий с фильтрами:",s,"для страницы:",e);let o=localStorage.getItem("access_token");const l=_(o);o&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null),C.push({name:"CategoryList",query:{name:s.name||"",parent_category:s.parent_category||"",order:s.order.value,page:n.value}}),localStorage.setItem("categoryFilters",JSON.stringify(s));try{const g=await f.get(`${k}/categories/`,{headers:{...o&&{Authorization:`Bearer ${o}`}},params:{page:e,page_size:12,name:s.name,parent_category:(u=s.parent_category)==null?void 0:u.id,ordering:s.order.value}});console.log("Список категорий загружен:",g.data),a.items=g.data.results,w.value=Math.ceil(g.data.count/12)}catch(g){console.error("Ошибка при загрузке списка категорий:",g)}},F=s=>{console.log("Смена страницы на:",s),n.value=s,C.push({name:"CategoryList",query:{...d.query,page:n.value}}),localStorage.setItem("categoryPage",n.value),v(r,s)},p=m(!1),h=()=>{p.value=!p.value,console.log("Текущий статус показа фильтров:",p.value)},B=()=>{console.log("Сбрасываем фильтры"),r.name="",r.parent_category=null,r.order=S.find(s=>s.value==="name"),localStorage.removeItem("categoryFilters"),localStorage.removeItem("categoryPage"),n.value=1,C.push({name:"AccountList",query:{name:"",parent_category:null,order:r.order.value,page:n.value}}),v(r,n.value)},D=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const o=_(e);if(!(!e||!o))try{(await f.get(`${k}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(l){console.error("Ошибка проверки версии прав:",l),localStorage.removeItem("userPermissions")}},T=async()=>{let s=localStorage.getItem("access_token");const e=_(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!e&&o.user_id!==1||e&&e.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const l=await f.get(`${k}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",l.data),o=l.data,localStorage.setItem("userPermissions",JSON.stringify(o))}a.globalPermissionsList=o.global_permissions||[],a.objectPermissionsDict=o.object_permissions||{},a.canAddCategory=a.globalPermissionsList.includes("core.add_category"),console.log("Права на добавление аккаунтов:",a.canAddCategory),a.canViewCategory=a.globalPermissionsList.includes("core.view_category")||!!a.objectPermissionsDict["core.view_category"],console.log("Права на просмотр аккаунтов:",a.canViewCategory)}catch(o){console.error("Ошибка при получении разрешений пользователя:",o)}};return J(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await x(),await L(),await q(),await D(),await T(),await v(r,n.value),A.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const o=Q("router-link");return A.value?(i(),c("div",W,[a.canViewCategory?(i(),c("div",X,[e[16]||(e[16]=t("div",{class:"list-header"},[t("h1",null,"Категории")],-1)),t("div",{class:"list-settings"},[t("button",{onClick:h,class:"list-settings-button"}," Параметры ")]),p.value?(i(),c("div",{key:0,class:"filters-overlay",onClick:h},[t("div",{class:"filters-outer",onClick:e[4]||(e[4]=R(()=>{},["stop"]))},[t("div",{class:"filters-close_button-inner"},[t("button",{onClick:h,class:"filters-close_button"}," × ")]),t("div",Y,[t("div",Z,[e[7]||(e[7]=t("label",{class:"filters-label"},"Название:",-1)),U(t("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>r.name=l),class:"filters-input",placeholder:"Введите название"},null,512),[[M,r.name]])]),t("div",ee,[e[10]||(e[10]=t("label",{class:"filters-label"},"Родительская категория:",-1)),V(O(j),{modelValue:r.parent_category,"onUpdate:modelValue":e[1]||(e[1]=l=>r.parent_category=l),options:P.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:y(()=>[...e[8]||(e[8]=[t("span",null,"Список пуст",-1)])]),noResult:y(()=>[...e[9]||(e[9]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),t("div",se,[e[11]||(e[11]=t("label",{class:"filters-label"},"Сортировка:",-1)),V(O(j),{modelValue:r.order,"onUpdate:modelValue":e[2]||(e[2]=l=>r.order=l),options:S,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),t("div",te,[t("button",{onClick:e[3]||(e[3]=l=>v(r,n.value.value)),class:"button"},"Применить"),t("button",{onClick:B,class:"button"},"Сбросить")])])])):I("",!0),a.items.length!==0?(i(),c("div",oe,[t("div",le,[(i(!0),c(E,null,G(a.items,l=>{var u;return i(),c("div",{key:l.id,class:"list-card"},[t("div",ae,[t("div",re,[t("h2",null,b(l.name||"Нет имени пользователя"),1)])]),t("div",ne,[t("div",ie,[e[12]||(e[12]=t("span",{class:"list-card-text-label"},"Родительская категория:",-1)),$(" "+b(((u=l.parent_category)==null?void 0:u.name)||"Нет родительской категории"),1)])]),t("div",ce,[V(o,{to:{name:"CategoryDetail",params:{id:l.id},query:{tab:"desc"}},class:"minibutton"},{default:y(()=>[...e[13]||(e[13]=[$(" Подробнее ",-1)])]),_:1},8,["to"])])])}),128))]),t("div",de,[t("button",{disabled:n.value===1,onClick:e[5]||(e[5]=l=>F(n.value-1)),class:"list-settings-button"}," Назад ",8,ue),t("span",null,"Страница "+b(n.value)+" из "+b(w.value),1),t("button",{disabled:n.value===w.value,onClick:e[6]||(e[6]=l=>F(n.value+1)),class:"list-settings-button"}," Вперед ",8,ge)])])):(i(),c("div",me,[...e[14]||(e[14]=[t("div",null,"Список пуст",-1)])])),a.canAddCategory?(i(),c("div",ve,[a.canAddCategory?(i(),H(o,{key:0,to:{name:"CategoryCreate"},class:"button"},{default:y(()=>[...e[15]||(e[15]=[$(" Создать ",-1)])]),_:1})):I("",!0)])):I("",!0)])):(i(),c("div",pe,[...e[17]||(e[17]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),c("div",ye,[...e[18]||(e[18]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{ke as default};
