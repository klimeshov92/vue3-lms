import{r as k,a as V,A as L,k as x,B,o as G,c,b as r,d as t,t as l,m as d,e as N,w as T,F as E,E as M,C,G as f,f as A,i as _,h as g,j as v,g as z,u as J,l as a,H as q}from"./index-B-w4kYl_.js";import{_ as F,a as R}from"./AccountsGroupObjectPermissions-DDdtONPx.js";import"./EditorComponent-DnRpnzAn.js";const U={key:0},H={key:0,class:"detail-page"},K={key:0},Q={class:"detail-card"},W={class:"detail-card-info"},X={class:"detail-header"},Y={class:"detail-header-title"},Z={class:"detail-card-text"},ee={key:0,class:"detail-card-text-elem"},se={class:"detail-card-text-elem"},te={class:"detail-menu button-group"},oe={key:0,class:"modal-overlay"},ie={class:"modal"},ne={class:"modal-header"},ae={class:"modal-header-h2"},ce={class:"minibutton-group modal-menu"},le={class:"detail-tabs"},re={class:"tabs-header"},de=["onClick"],ue={key:0,class:"tabs-content"},me={key:0,class:"detail-tab"},be={key:0,class:"detail-tab-elem"},_e={class:"detail-tab-elem"},ge={class:"detail-tab-elem"},ve={class:"detail-tab-elem"},pe={class:"detail-tab-elem"},je={class:"detail-tab-elem"},he={key:1,class:"table-tab"},ke={key:2,class:"table-tab"},Pe={key:1,class:"none-container"},ye={key:1,class:"loading"},Ce={key:1,class:"loading"},De={__name:"ClientDetail",setup(fe){const m=x(),b=J(),P=k(!1),e=V({object:null,globalPermissionsList:[],objectPermissionsDict:{},canAddClient:!1,canViewClient:!1,canEditClient:!1}),p=async()=>{const o=m.params.id;let s=localStorage.getItem("access_token");const n=_(s);s&&!n&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const i=await g.get(`${v}/clients/${o}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные клиента:",i.data),e.object=i.data}catch(i){console.error("Ошибка при получении данных клиента:",i)}},j=k(!1),O=()=>{j.value=!0},y=()=>{j.value=!1},w=async()=>{let o=localStorage.getItem("access_token");const s=_(o);if(o&&!s){b.push({name:"Login"});return}const n=m.params.id;try{await g.delete(`${v}/clients/${n}/`,{headers:{Authorization:`Bearer ${o}`}}),y(),b.push({name:"ClientList"})}catch(i){console.error("Ошибка удаления клиента:",i)}},D=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let s=localStorage.getItem("access_token");const n=_(s);if(!(!s||!n))try{(await g.get(`${v}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(i){console.error("Ошибка проверки версии прав:",i),localStorage.removeItem("userPermissions")}},S=async()=>{let o=localStorage.getItem("access_token");const s=_(o);o&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{let n=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",n),Object.keys(n).length>0&&(console.log("ID пользователя в разрешениях из памяти:",n.user_id),!s&&n.user_id!==1||s&&s.user_id!==n.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),n={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(n).length===0){const h=await g.get(`${v}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",h.data),n=h.data,localStorage.setItem("userPermissions",JSON.stringify(n))}e.globalPermissionsList=n.global_permissions||[],e.objectPermissionsDict=n.object_permissions||{};const i=m.params.id;console.log("ID объекта:",i),e.canAddClient=e.globalPermissionsList.includes("core.add_client"),console.log("Права на добавление клиент:",e.canAddClient),e.canViewClient=e.globalPermissionsList.includes("core.view_client")||e.objectPermissionsDict["core.view_client"]&&e.objectPermissionsDict["core.view_client"].includes(Number(i)),console.log("Права на просмотр клиента:",e.canViewClient),e.canEditClient=e.globalPermissionsList.includes("core.change_client")||Array.isArray(e.objectPermissionsDict["core.change_client"])&&e.objectPermissionsDict["core.change_client"].includes(Number(i)),console.log("Права на редактирование клиента:",e.canEditClient),e.canDeleteClient=e.globalPermissionsList.includes("core.delete_client")||Array.isArray(e.objectPermissionsDict["core.delete_client"])&&e.objectPermissionsDict["core.delete_client"].includes(Number(i)),console.log("Права на удаление клиента:",e.canDeleteClient),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(n){console.error("Ошибка при загрузке разрешений пользователя:",n)}},$=()=>{b.back()},I=L(()=>[{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),u=k(m.query.tab||localStorage.getItem(`activeClientTab-${m.params.id}`)||"details");return B(u,o=>{localStorage.setItem(`activeClientTab-${m.params.id}`,o),b.push({query:{tab:o}}),console.log("Загружен таб:",o)}),G(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await p(),await D(),await S(),P.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,s)=>{const n=z("router-link");return P.value?(a(),c("div",U,[e.canViewClient?(a(),c("div",H,[e.object.id?(a(),c("div",K,[t("div",Q,[t("div",W,[t("div",X,[t("div",Y,[t("h1",null,l(e.object.id||"Безымянное взаимодействие"),1)])]),t("div",Z,[e.object.object_type=="account"?(a(),c("div",ee,[s[1]||(s[1]=t("span",{class:"detail-card-text-label"},"Аккаунт:",-1)),d(" "+l(e.object.account?e.object.account.str:"Нет итога"),1)])):r("",!0),t("div",se,[s[2]||(s[2]=t("span",{class:"detail-card-text-label"},"Категории:",-1)),d(" "+l(e.object.categories.length>0?e.object.categories.map(i=>i.name).join(", "):"Нет категорий"),1)])]),t("div",te,[e.canEditClient?(a(),N(n,{key:0,to:{name:"ClientEdit",params:{id:e.object.id}},class:"button"},{default:T(()=>[...s[3]||(s[3]=[d(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canDeleteClient?(a(),c("button",{key:1,onClick:O,class:"button"}," Удалить ")):r("",!0),t("button",{type:"button",onClick:$,class:"button"},"Назад")]),j.value?(a(),c("div",oe,[t("div",ie,[t("div",ne,[t("h2",ae,"Удаление "+l(e.object.name||"Безымянный клиента"),1)]),t("div",ce,[t("button",{onClick:s[0]||(s[0]=i=>w()),class:"minibutton"},"Подтвердить"),t("button",{onClick:y,class:"minibutton"},"Отменить")])])])):r("",!0)])]),t("div",le,[t("div",re,[(a(!0),c(E,null,M(I.value,i=>(a(),c("button",{key:i.name,class:q([{active:u.value===i.name},"tab-button"]),onClick:h=>u.value=i.name},l(i.label),11,de))),128))]),u.value?(a(),c("div",ue,[u.value==="details"?(a(),c("div",me,[e.object.object_type=="account"?(a(),c("div",be,[s[4]||(s[4]=t("span",{class:"detail-tab-label"},"Аккаунт:",-1)),d(" "+l(e.object.account?e.object.account.str:"Нет итога"),1)])):r("",!0),t("div",_e,[s[5]||(s[5]=t("span",{class:"detail-tab-label"},"Категории:",-1)),d(" "+l(e.object.categories.length>0?e.object.categories.map(i=>i.name).join(", "):"Нет категорий"),1)]),t("div",ge,[s[6]||(s[6]=t("span",{class:"detail-tab-label"},"Создан:",-1)),d(" "+l(e.object.created?C(f)(e.object.created):"Нет данных о создании"),1)]),t("div",ve,[s[7]||(s[7]=t("span",{class:"detail-tab-label"},"Создатель:",-1)),d(" "+l(e.object.creator?e.object.creator:"Нет создателя"),1)]),t("div",pe,[s[8]||(s[8]=t("span",{class:"detail-tab-label"},"Изменён:",-1)),d(" "+l(e.object.changed?C(f)(e.object.changed):"Нет данных об изменениях"),1)]),t("div",je,[s[9]||(s[9]=t("span",{class:"detail-tab-label"},"Редактор:",-1)),d(" "+l(e.object.editor?e.object.editor:"Нет редактора"),1)])])):r("",!0),u.value==="accountsGroupObjectPermissions"?(a(),c("div",he,[A(F,{state:e,fetchObject:p,contentTypeModel:"client"},null,8,["state"])])):r("",!0),u.value==="accountObjectPermissions"?(a(),c("div",ke,[A(R,{state:e,fetchObject:p,contentTypeModel:"client"},null,8,["state"])])):r("",!0)])):r("",!0)])])):e.object.id?r("",!0):(a(),c("div",Pe,[...s[10]||(s[10]=[t("div",{class:"none-card"},[t("div",null,"Объект не найден.")],-1)])]))])):(a(),c("div",ye,[...s[11]||(s[11]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),c("div",Ce,[...s[12]||(s[12]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{De as default};
