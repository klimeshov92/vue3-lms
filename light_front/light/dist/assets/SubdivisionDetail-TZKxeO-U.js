import{r as k,a as L,B as G,k as B,C,o as x,c,b as d,d as o,t as l,m as r,e as N,w as T,F as z,G as E,D as f,H as y,f as A,i as v,h as _,j as g,g as M,q,u as J,l as a,I as F}from"./index-CfAZEXlX.js";import{_ as R,a as U}from"./AccountsGroupObjectPermissions-CPURZp_t.js";import"./EditorComponent-DbrmzM8Y.js";const H={key:0},K={key:0,class:"detail-page"},Q={key:0},W={class:"detail-card"},X={class:"detail-card-info"},Y={class:"detail-header"},Z={class:"detail-header-title"},ee={class:"detail-card-text"},se={class:"detail-card-text-elem"},oe={class:"detail-card-text-elem"},te={class:"detail-menu button-group"},ie={key:0,class:"modal-overlay"},ne={class:"modal"},ae={class:"modal-header"},ce={class:"modal-header-h2"},le={class:"minibutton-group modal-menu"},re={class:"detail-tabs"},de={class:"tabs-header"},ue=["onClick"],be={key:0,class:"tabs-content"},me={key:0,class:"detail-tab"},ve={class:"detail-tab-elem"},_e={class:"detail-tab-elem"},ge={class:"detail-tab-elem"},pe={class:"detail-tab-elem"},je={class:"detail-tab-elem"},Pe={class:"detail-tab-elem"},ke={class:"detail-tab-elem"},he={key:1,class:"table-tab"},Se={key:2,class:"table-tab"},fe={key:1,class:"none-container"},ye={key:1,class:"loading"},Ae={key:1,class:"loading"},Ie={__name:"SubdivisionDetail",setup(Oe){const b=B(),m=J(),h=k(!1),e=L({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewSubdivision:!1,canEditSubdivision:!1,canDeleteSubdivision:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),p=async()=>{const t=b.params.id;let s=localStorage.getItem("access_token");const i=v(s);s&&!i&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const n=await _.get(`${g}/subdivisions/${t}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные подоразделения:",n.data),e.object=n.data}catch(n){console.error("Ошибка при получении данных подоразделения:",n)}},j=k(!1),O=()=>{j.value=!0},S=()=>{j.value=!1},D=async()=>{let t=localStorage.getItem("access_token");const s=v(t);if(t&&!s){m.push({name:"Login"});return}const i=b.params.id;try{await _.delete(`${g}/subdivisions/${i}/`,{headers:{Authorization:`Bearer ${t}`}}),S(),m.push({name:"SubdivisionList"})}catch(n){console.error("Ошибка удаления подразделения:",n)}},w=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let s=localStorage.getItem("access_token");const i=v(s);if(!(!s||!i))try{(await _.get(`${g}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(n){console.error("Ошибка проверки версии прав:",n),localStorage.removeItem("userPermissions")}},V=async()=>{let t=localStorage.getItem("access_token");const s=v(t);t&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{let i=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",i),Object.keys(i).length>0&&(console.log("ID пользователя в разрешениях из памяти:",i.user_id),!s&&i.user_id!==1||s&&s.user_id!==i.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),i={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(i).length===0){const P=await _.get(`${g}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",P.data),i=P.data,localStorage.setItem("userPermissions",JSON.stringify(i))}e.globalPermissionsList=i.global_permissions||[],e.objectPermissionsDict=i.object_permissions||{};const n=b.params.id;console.log("ID объекта:",n),e.canViewSubdivision=e.globalPermissionsList.includes("core.view_subdivision")||e.objectPermissionsDict["core.view_subdivision"]&&e.objectPermissionsDict["core.view_subdivision"].includes(Number(n)),console.log("Права на просмотр подразделений:",e.canViewSubdivision),e.canEditSubdivision=e.globalPermissionsList.includes("core.change_subdivision")||Array.isArray(e.objectPermissionsDict["core.change_subdivision"])&&e.objectPermissionsDict["core.change_subdivision"].includes(Number(n)),console.log("Права на редактирование подразделений:",e.canEditSubdivision),e.canDeleteSubdivision=e.globalPermissionsList.includes("core.delete_subdivision")||Array.isArray(e.objectPermissionsDict["core.delete_subdivision"])&&e.objectPermissionsDict["core.delete_subdivision"].includes(Number(n)),console.log("Права на удаление подразделений:",e.canDeleteSubdivision),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(i){console.error("Ошибка при загрузке разрешений пользователя:",i)}},I=()=>{q(m)},$=G(()=>[{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),u=k(b.query.tab||localStorage.getItem(`activeSubdivisionTab-${b.params.id}`)||"details");return C(u,t=>{localStorage.setItem(`activeSubdivisionTab-${b.params.id}`,t),m.push({query:{tab:t}}),console.log("Загружен таб:",t)}),x(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await p(),await w(),await V(),h.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,s)=>{const i=M("router-link");return h.value?(a(),c("div",H,[e.canViewSubdivision?(a(),c("div",K,[e.object.id?(a(),c("div",Q,[o("div",W,[o("div",X,[o("div",Y,[o("div",Z,[o("h1",null,l(e.object.name||"Безымянное подразделение"),1)])]),o("div",ee,[o("div",se,[s[1]||(s[1]=o("span",{class:"detail-card-text-label"},"Организация:",-1)),r(" "+l(e.object.organization?e.object.organization.legal_name:"Нет организации"),1)]),o("div",oe,[s[2]||(s[2]=o("span",{class:"detail-card-text-label"},"Родительское подразделение:",-1)),r(" "+l(e.object.parent_subdivision?e.object.parent_subdivision.name:"Нет родительского подразделения"),1)])]),o("div",te,[e.canEditSubdivision?(a(),N(i,{key:0,to:{name:"SubdivisionEdit",params:{id:e.object.id}},class:"button"},{default:T(()=>[...s[3]||(s[3]=[r(" Изменить ",-1)])]),_:1},8,["to"])):d("",!0),e.canDeleteSubdivision?(a(),c("button",{key:1,onClick:O,class:"button"}," Удалить ")):d("",!0),o("button",{type:"button",onClick:I,class:"button"},"Назад")]),j.value?(a(),c("div",ie,[o("div",ne,[o("div",ae,[o("h2",ce,"Удаление "+l(e.object.name||"Безымянное подразделение"),1)]),o("div",le,[o("button",{onClick:s[0]||(s[0]=n=>D()),class:"minibutton"},"Подтвердить"),o("button",{onClick:S,class:"minibutton"},"Отменить")])])])):d("",!0)])]),o("div",re,[o("div",de,[(a(!0),c(z,null,E($.value,n=>(a(),c("button",{key:n.name,class:F([{active:u.value===n.name},"tab-button"]),onClick:P=>u.value=n.name},l(n.label),11,ue))),128))]),u.value?(a(),c("div",be,[u.value==="details"?(a(),c("div",me,[o("div",ve,[s[4]||(s[4]=o("span",{class:"detail-tab-label"},"Название:",-1)),r(" "+l(e.object.name||"Нет названия"),1)]),o("div",_e,[s[5]||(s[5]=o("span",{class:"detail-tab-label"},"Организация:",-1)),r(" "+l(e.object.organization?e.object.organization.legal_name:"Нет организации"),1)]),o("div",ge,[s[6]||(s[6]=o("span",{class:"detail-tab-label"},"Родительское подразделение:",-1)),r(" "+l(e.object.parent_subdivision?e.object.parent_subdivision.name:"Нет родительского подразделения"),1)]),o("div",pe,[s[7]||(s[7]=o("span",{class:"detail-tab-label"},"Создан:",-1)),r(" "+l(e.object.created?f(y)(e.object.created):"Нет данных о создании"),1)]),o("div",je,[s[8]||(s[8]=o("span",{class:"detail-tab-label"},"Создатель:",-1)),r(" "+l(e.object.creator?e.object.creator:"Нет создателя"),1)]),o("div",Pe,[s[9]||(s[9]=o("span",{class:"detail-tab-label"},"Изменён:",-1)),r(" "+l(e.object.changed?f(y)(e.object.changed):"Нет данных об изменениях"),1)]),o("div",ke,[s[10]||(s[10]=o("span",{class:"detail-tab-label"},"Редактор:",-1)),r(" "+l(e.object.editor?e.object.editor:"Нет редактора"),1)])])):d("",!0),u.value==="accountsGroupObjectPermissions"?(a(),c("div",he,[A(R,{state:e,fetchObject:p,contentTypeModel:"subdivision"},null,8,["state"])])):d("",!0),u.value==="accountObjectPermissions"?(a(),c("div",Se,[A(U,{state:e,fetchObject:p,contentTypeModel:"subdivision"},null,8,["state"])])):d("",!0)])):d("",!0)])])):e.object.id?d("",!0):(a(),c("div",fe,[...s[11]||(s[11]=[o("div",{class:"none-card"},[o("div",null,"Объект не найден.")],-1)])]))])):(a(),c("div",ye,[...s[12]||(s[12]=[o("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),c("div",Ae,[...s[13]||(s[13]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{Ie as default};
