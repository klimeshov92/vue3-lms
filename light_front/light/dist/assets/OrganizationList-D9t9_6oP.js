import{a as I,r as v,k as A,o as B,c,d as t,b as y,p as V,v as C,f as F,C as D,n as T,F as J,E as U,t as _,e as M,w as N,i as z,h as S,j as O,u as E,g as R,l as r,m as P}from"./index-DiAkfKiX.js";import{s as G}from"./custom-multiselect-DIP0QmFu.js";const H={key:0},K={key:0,class:"list-page"},Q={class:"filters-inner"},W={class:"filters-field"},X={class:"filters-field"},Y={class:"filters-field"},Z={class:"filters-menu button-group"},ee={key:1,class:"list-items"},se={class:"list-grid"},te={class:"list-card-header"},oe={class:"list-card-header-title"},le={class:"list-card-text"},ae={class:"list-card-text-elem"},ne={class:"list-card-menu minibutton-group"},ie={class:"list-pagination"},re=["disabled"],ce=["disabled"],de={key:2,class:"none-card"},ue={key:3,class:"list-menu button-group"},ge={key:1,class:"loading"},me={key:1,class:"loading"},be={__name:"OrganizationList",setup(ve){const d=A(),p=E(),a=I({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddOrganization:!1,canViewOrganization:!1}),h=v(!1),b=[{label:"Юридическое название: по возрастанию",value:"legal_name"},{label:"Юридическое название: по убыванию",value:"-legal_name"}],i=I({legal_name:d.query.legal_name||"",tin:d.query.tin||null,order:b.find(s=>s.value===d.query.order||"legal_name")}),$=()=>{const s=localStorage.getItem("organizationFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(i,JSON.parse(s)))},n=v(Number(d.query.page)||1),f=v(1),j=()=>{const s=localStorage.getItem("organizationPage");s&&(console.log("Загруженная странциа:",s),n.value=parseInt(s,10))},g=async(s,e)=>{console.log("Загрузка аккаунтов с фильтрами:",s,"для страницы:",e);let o=localStorage.getItem("access_token");const l=z(o);o&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null),p.push({name:"OrganizationList",query:{legal_name:s.legal_name||"",tin:s.tin||"",order:s.order.value,page:n.value}}),localStorage.setItem("organizationFilters",JSON.stringify(s));try{const u=await S.get(`${O}/organizations/`,{headers:{...o&&{Authorization:`Bearer ${o}`}},params:{page:e,page_size:12,legal_name:s.legal_name,tin:s.tin,ordering:s.order.value}});console.log("Список аккаунтов загружен:",u.data),a.items=u.data.results,f.value=Math.ceil(u.data.count/12)}catch(u){console.error("Ошибка при загрузке списка аккаунтов:",u)}},w=s=>{console.log("Смена страницы на:",s),n.value=s,p.push({name:"OrganizationList",query:{...d.query,page:n.value}}),localStorage.setItem("organizationPage",n.value),g(i,s)},m=v(!1),k=()=>{m.value=!m.value,console.log("Текущий статус показа фильтров:",m.value)},q=()=>{console.log("Сбрасываем фильтры"),i.legal_name="",i.tin="",i.order=b.find(s=>s.value==="legal_name"),localStorage.removeItem("organizationFilters"),localStorage.removeItem("organizationPage"),n.value=1,p.push({name:"OrganizationList",query:{legal_name:"",tin:"",page:n.value}}),g(i,n.value)},x=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const o=z(e);if(!(!e||!o))try{(await S.get(`${O}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(l){console.error("Ошибка проверки версии прав:",l),localStorage.removeItem("userPermissions")}},L=async()=>{let s=localStorage.getItem("access_token");const e=z(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!e&&o.user_id!==1||e&&e.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const l=await S.get(`${O}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",l.data),o=l.data,localStorage.setItem("userPermissions",JSON.stringify(o))}a.globalPermissionsList=o.global_permissions||[],a.objectPermissionsDict=o.object_permissions||{},a.canAddOrganization=a.globalPermissionsList.includes("core.add_organization"),console.log("Права на добавление организаций:",a.canAddOrganization),a.canViewOrganization=a.globalPermissionsList.includes("core.view_organization")||!!a.objectPermissionsDict["core.view_organization"],console.log("Права на просмотр организаций:",a.canViewOrganization)}catch(o){console.error("Ошибка при получении разрешений пользователя:",o)}};return B(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await $(),await j(),await x(),await L(),await g(i,n.value),h.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const o=R("router-link");return h.value?(r(),c("div",H,[a.canViewOrganization?(r(),c("div",K,[e[14]||(e[14]=t("div",{class:"list-header"},[t("h1",null,"Организации")],-1)),t("div",{class:"list-settings"},[t("button",{onClick:k,class:"list-settings-button"}," Параметры ")]),m.value?(r(),c("div",{key:0,class:"filters-overlay",onClick:k},[t("div",{class:"filters-outer",onClick:e[4]||(e[4]=T(()=>{},["stop"]))},[t("div",{class:"filters-close_button-inner"},[t("button",{onClick:k,class:"filters-close_button"}," × ")]),t("div",Q,[t("div",W,[e[7]||(e[7]=t("label",{class:"filters-label"},"Юридическое название:",-1)),V(t("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>i.legal_name=l),class:"filters-input",placeholder:"Введите юридическое название"},null,512),[[C,i.legal_name]])]),t("div",X,[e[8]||(e[8]=t("label",{class:"filters-label"},"ИНН:",-1)),V(t("input",{"onUpdate:modelValue":e[1]||(e[1]=l=>i.tin=l),class:"filters-input",placeholder:"Введите ИНН"},null,512),[[C,i.tin]])]),t("div",Y,[e[9]||(e[9]=t("label",{class:"filters-label"},"Сортировка:",-1)),F(D(G),{modelValue:i.order,"onUpdate:modelValue":e[2]||(e[2]=l=>i.order=l),options:b,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),t("div",Z,[t("button",{onClick:e[3]||(e[3]=l=>g(i,n.value.value)),class:"button"},"Применить"),t("button",{onClick:q,class:"button"},"Сбросить")])])])):y("",!0),a.items.length!==0?(r(),c("div",ee,[t("div",se,[(r(!0),c(J,null,U(a.items,l=>(r(),c("div",{key:l.id,class:"list-card"},[t("div",te,[t("div",oe,[t("h2",null,_(l.legal_name||"Нет юридического названия"),1)])]),t("div",le,[t("div",ae,[e[10]||(e[10]=t("span",{class:"list-card-text-label"},"ИНН:",-1)),P(" "+_(l.tin||"Нет ИНН"),1)])]),t("div",ne,[F(o,{to:{name:"OrganizationDetail",params:{id:l.id},query:{tab:"details"}},class:"minibutton"},{default:N(()=>[...e[11]||(e[11]=[P(" Подробнее ",-1)])]),_:1},8,["to"])])]))),128))]),t("div",ie,[t("button",{disabled:n.value===1,onClick:e[5]||(e[5]=l=>w(n.value-1)),class:"list-settings-button"}," Назад ",8,re),t("span",null,"Страница "+_(n.value)+" из "+_(f.value),1),t("button",{disabled:n.value===f.value,onClick:e[6]||(e[6]=l=>w(n.value+1)),class:"list-settings-button"}," Вперед ",8,ce)])])):(r(),c("div",de,[...e[12]||(e[12]=[t("div",null,"Список пуст",-1)])])),a.canAddOrganization?(r(),c("div",ue,[a.canAddOrganization?(r(),M(o,{key:0,to:{name:"OrganizationCreate"},class:"button"},{default:N(()=>[...e[13]||(e[13]=[P(" Создать ",-1)])]),_:1})):y("",!0)])):y("",!0)])):(r(),c("div",ge,[...e[15]||(e[15]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(r(),c("div",me,[...e[16]||(e[16]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{be as default};
