import{a as L,r as v,k as G,o as H,c as n,d as e,b as f,p as K,v as Q,f as C,w as _,C as x,n as W,F as X,E as Y,t as g,e as Z,i as y,h as S,j as w,u as ss,g as es,l as o,m as d,G as ts}from"./index-DyUQrffO.js";import{s as B}from"./custom-multiselect-J6sEttNg.js";const ls={key:0},as={key:0,class:"list-page"},os={class:"filters-inner"},ns={class:"filters-field"},is={class:"filters-field"},rs={class:"filters-field"},cs={class:"filters-menu button-group"},ds={key:1,class:"list-items"},us={class:"list-grid"},gs={class:"list-card-icons"},ms={key:0,class:"list-card-icon-grey"},vs={key:1,class:"list-card-icon-progress"},ps={key:2,class:"list-card-icon-progress"},ks={key:3,class:"list-card-icon-progress"},bs={key:4,class:"list-card-icon-completed"},fs={key:5,class:"list-card-icon-attention"},_s={key:6,class:"list-card-icon-grey"},ys={class:"list-card-header"},Ss={class:"list-card-header-title"},ws={class:"list-card-text"},Ps={class:"list-card-text-elem"},Ts={class:"list-card-text-elem"},Is={class:"list-card-text-elem"},hs={class:"list-card-menu minibutton-group"},Vs={class:"list-pagination"},Cs=["disabled"],xs=["disabled"],$s={key:2,class:"none-card"},js={key:3,class:"list-menu button-group"},qs={key:1,class:"loading"},Fs={key:1,class:"loading"},Ls={__name:"TaskList",setup(Ns){const m=G(),P=ss(),i=L({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddTask:!1,canViewTask:!1}),$=v(!1),T=[{label:"Планируемое завершение: по возрастанию",value:"planned_end"},{label:"Планируемое завершение: по убыванию",value:"-planned_end"},{label:"Название плана: по возрастанию",value:"plan__name"},{label:"Название плана: по убыванию",value:"-plan__name"},{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"}],I=v([]),D=async()=>{let t=localStorage.getItem("access_token");const s=y(t);t&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const a=await S.get(`${w}/categories/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});I.value=a.data.results||[],console.log("Категории загружены:",I.value)}catch(a){console.error("Ошибка при загрузке категорий:",a.response?a.response.data:a.message)}},c=L({name:m.query.name||"",categories:m.query.categories?m.query.categories.map(t=>({id:parseInt(t,10)})):[],order:T.find(t=>t.value===m.query.order||"plan__name")}),z=()=>{const t=localStorage.getItem("taskFilters");t&&(console.log("Загруженные фильры:",t),Object.assign(c,JSON.parse(t)))},r=v(Number(m.query.page)||1),h=v(1),J=()=>{const t=localStorage.getItem("taskPage");t&&(console.log("Загруженная странциа:",t),r.value=parseInt(t,10))},p=async(t,s)=>{console.log("Загрузка задач с фильтрами:",t,"для страницы:",s);let a=localStorage.getItem("access_token");const l=y(a);a&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),a=null),P.push({name:"TaskList",query:{name:t.name||"",categories:t.categories.map(u=>u.id)||[],order:t.order.value,page:r.value}}),localStorage.setItem("taskFilters",JSON.stringify(t));try{const u=await S.get(`${w}/tasks/`,{headers:{...a&&{Authorization:`Bearer ${a}`}},params:{page:s,page_size:12,name:t.name,categories:t.categories.map(b=>b.id),ordering:t.order.value}});console.log("Список задач загружен:",u.data),i.items=u.data.results,h.value=Math.ceil(u.data.count/12)}catch(u){console.error("Ошибка при загрузке списка задач:",u)}},j=t=>{console.log("Смена страницы на:",t),r.value=t,P.push({name:"TaskList",query:{...m.query,page:r.value}}),localStorage.setItem("taskPage",r.value),p(c,t)},k=v(!1),V=()=>{k.value=!k.value,console.log("Текущий статус показа фильтров:",k.value)},U=()=>{console.log("Сбрасываем фильтры"),c.name="",c.categories=[],c.order=T.find(t=>t.value==="plan__name"),localStorage.removeItem("taskFilters"),localStorage.removeItem("taskPage"),r.value=1,P.push({name:"TaskList",query:{name:"",categories:[],page:r.value}}),p(c,r.value)},M=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let s=localStorage.getItem("access_token");const a=y(s);if(!(!s||!a))try{(await S.get(`${w}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(l){console.error("Ошибка проверки версии прав:",l),localStorage.removeItem("userPermissions")}},R=async()=>{let t=localStorage.getItem("access_token");const s=y(t);t&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{let a=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",a),Object.keys(a).length>0&&(console.log("ID пользователя в разрешениях из памяти:",a.user_id),!s&&a.user_id!==1||s&&s.user_id!==a.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),a={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(a).length===0){const l=await S.get(`${w}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",l.data),a=l.data,localStorage.setItem("userPermissions",JSON.stringify(a))}i.globalPermissionsList=a.global_permissions||[],i.objectPermissionsDict=a.object_permissions||{},i.canAddTask=i.globalPermissionsList.includes("bpms.add_task"),console.log("Права на добавление задач:",i.canAddTask),i.canViewTask=i.globalPermissionsList.includes("bpms.view_task")||!!i.objectPermissionsDict["bpms.view_task"],console.log("Права на просмотр задач:",i.canViewTask)}catch(a){console.error("Ошибка при получении разрешений пользователя:",a)}};return H(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await z(),await J(),await D(),await M(),await R(),await p(c,r.value),$.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,s)=>{const a=es("router-link");return $.value?(o(),n("div",ls,[i.canViewTask?(o(),n("div",as,[s[25]||(s[25]=e("div",{class:"list-header"},[e("h1",null,"Задачи")],-1)),e("div",{class:"list-settings"},[e("button",{onClick:V,class:"list-settings-button"}," Параметры ")]),k.value?(o(),n("div",{key:0,class:"filters-overlay",onClick:V},[e("div",{class:"filters-outer",onClick:s[4]||(s[4]=W(()=>{},["stop"]))},[e("div",{class:"filters-close_button-inner"},[e("button",{onClick:V,class:"filters-close_button"}," × ")]),e("div",os,[e("div",ns,[s[7]||(s[7]=e("label",{class:"filters-label"},"Название:",-1)),K(e("input",{"onUpdate:modelValue":s[0]||(s[0]=l=>c.name=l),class:"filters-input",placeholder:"Введите название"},null,512),[[Q,c.name]])]),e("div",is,[s[10]||(s[10]=e("label",{class:"filters-label"},"Категории:",-1)),C(x(B),{modelValue:c.categories,"onUpdate:modelValue":s[1]||(s[1]=l=>c.categories=l),options:I.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:_(()=>[...s[8]||(s[8]=[e("span",null,"Список пуст",-1)])]),noResult:_(()=>[...s[9]||(s[9]=[e("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),e("div",rs,[s[11]||(s[11]=e("label",{class:"filters-label"},"Сортировка:",-1)),C(x(B),{modelValue:c.order,"onUpdate:modelValue":s[2]||(s[2]=l=>c.order=l),options:T,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),e("div",cs,[e("button",{onClick:s[3]||(s[3]=l=>p(c,r.value.value)),class:"button"},"Применить"),e("button",{onClick:U,class:"button"},"Сбросить")])])])):f("",!0),i.items.length!==0?(o(),n("div",ds,[e("div",us,[(o(!0),n(X,null,Y(i.items,l=>{var u,b,q,F,N,O,A;return o(),n("div",{key:l.id,class:"list-card"},[e("div",gs,[((u=l.result)==null?void 0:u.status)=="waiting"?(o(),n("div",ms,[...s[12]||(s[12]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-lock"})],-1),d(" В ожидании ",-1)])])):((b=l.result)==null?void 0:b.status)=="assigned"?(o(),n("div",vs,[...s[13]||(s[13]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-thumbtack"})],-1),d(" Назначено ",-1)])])):((q=l.result)==null?void 0:q.status)=="in_progress"?(o(),n("div",ps,[...s[14]||(s[14]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-hourglass-half"})],-1),d(" В процессе ",-1)])])):((F=l.result)==null?void 0:F.status)=="under_review"?(o(),n("div",ks,[...s[15]||(s[15]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-magnifying-glass"})],-1),d(" На проверке ",-1)])])):((N=l.result)==null?void 0:N.status)=="completed"?(o(),n("div",bs,[...s[16]||(s[16]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-circle-check"})],-1),d(" Выполнено ",-1)])])):((O=l.result)==null?void 0:O.status)=="failed"?(o(),n("div",fs,[...s[17]||(s[17]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-circle-xmark"})],-1),d(" Провалено ",-1)])])):((A=l.result)==null?void 0:A.status)=="canceled"?(o(),n("div",_s,[...s[18]||(s[18]=[e("span",{class:"list-card-icon"},[e("i",{class:"fa-solid fa-ban"})],-1),d(" Отменено ",-1)])])):f("",!0)]),e("div",ys,[e("div",Ss,[e("h2",null,g(l.plan?l.plan.name+" - ":"")+g(l.item?l.item+" - ":"")+g(l.name||"Нет названия"),1)])]),e("div",ws,[e("div",Ps,[s[19]||(s[19]=e("span",{class:"list-card-text-label"},"Тип задачи:",-1)),d(" "+g(l.task_type_display||"Нет типа задачи"),1)]),e("div",Ts,[s[20]||(s[20]=e("span",{class:"list-card-text-label"},"Срок завершения:",-1)),d(" "+g(l.planned_end?x(ts)(l.planned_end):"Нет срока"),1)]),e("div",Is,[s[21]||(s[21]=e("span",{class:"list-card-text-label"},"Категории:",-1)),d(" "+g(l.categories.length>0?l.categories.map(E=>E.name).join(", "):"Нет категорий"),1)])]),e("div",hs,[C(a,{to:{name:"TaskDetail",params:{id:l.id},query:{tab:"desc"}},class:"minibutton"},{default:_(()=>[...s[22]||(s[22]=[d(" Подробнее ",-1)])]),_:1},8,["to"])])])}),128))]),e("div",Vs,[e("button",{disabled:r.value===1,onClick:s[5]||(s[5]=l=>j(r.value-1)),class:"list-settings-button"}," Назад ",8,Cs),e("span",null,"Страница "+g(r.value)+" из "+g(h.value),1),e("button",{disabled:r.value===h.value,onClick:s[6]||(s[6]=l=>j(r.value+1)),class:"list-settings-button"}," Вперед ",8,xs)])])):(o(),n("div",$s,[...s[23]||(s[23]=[e("div",null,"Список пуст",-1)])])),i.canAddTask?(o(),n("div",js,[i.canAddTask?(o(),Z(a,{key:0,to:{name:"TaskCreate"},class:"button"},{default:_(()=>[...s[24]||(s[24]=[d(" Создать ",-1)])]),_:1})):f("",!0)])):f("",!0)])):(o(),n("div",qs,[...s[26]||(s[26]=[e("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),n("div",Fs,[...s[27]||(s[27]=[e("div",null,"Загрузка данных...",-1)])]))}}};export{Ls as default};
