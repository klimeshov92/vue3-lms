import{r as g,a as Y,A as Z,k as ee,B as te,o as se,c as a,b as r,d as s,t as l,m as c,e as k,w as j,F as I,E as C,C as M,G as N,f as x,i as y,h,j as f,g as oe,u as ae,l as o,H as ie}from"./index-Bpv6Iqa1.js";import{_ as ne,a as le}from"./AccountsGroupObjectPermissions-BMVJ1UeL.js";import{_ as ce}from"./TopicMessages-C2ljvnc_.js";import"./EditorComponent-DqOSmE5w.js";const de={key:0},re={key:0,class:"detail-page"},ue={key:0},me={class:"detail-card"},be={class:"detail-card-image-outer"},_e={key:0,class:"detail-card-image-inner"},ve=["src"],pe={key:1,class:"detail-card-image-none"},ge={class:"detail-card-info"},ke={class:"detail-header"},je={class:"detail-header-title"},ye={class:"detail-card-text"},he={class:"detail-card-text-elem"},fe={class:"detail-card-text-elem"},Te={class:"detail-card-text-elem"},Pe={class:"detail-card-text-elem"},we={class:"detail-card-text-elem"},Ae={class:"detail-menu button-group"},Se={key:0,class:"modal-overlay"},De={class:"modal"},Oe={class:"modal-header"},$e={class:"modal-header-h2"},Ve={class:"minibutton-group modal-menu"},Ie={class:"detail-tabs"},Ce={class:"tabs-header"},xe=["onClick"],Ee={key:0,class:"tabs-content"},Le={key:0,class:"desc-tab"},Be={key:0},Ge={key:1},Me={key:1,class:"detail-tab"},Ne={class:"detail-tab-elem"},ze={class:"detail-tab-elem"},qe={class:"detail-tab-elem"},Qe={class:"detail-tab-elem"},Je={class:"detail-tab-elem"},Fe={class:"detail-tab-elem"},Re={class:"detail-tab-elem"},Ue={class:"detail-tab-elem"},He={class:"detail-tab-elem"},Ke={class:"detail-tab-elem"},We={class:"detail-tab-elem"},Xe={class:"detail-tab-elem"},Ye={class:"detail-tab-elem"},Ze={key:2,class:"test-section-tab"},et={key:0},tt={key:0,class:"test-section-tab-flex"},st={class:"test-section-tab-item-top"},ot={class:"test-section-tab-item-title"},at={class:"test-section-tab-item-detail"},it={class:"test-section-tab-item-detail-elem"},nt={key:0,class:"test-section-table_container"},lt={key:0,class:"test-section-table-outer"},ct={class:"test-section-table-inner"},dt={key:0},rt={class:"test-section-menu"},ut=["onClick"],mt={key:1},bt={key:1},_t={key:1,class:"test-section-tab-item-menu-outer"},vt={class:"test-section-tab-item-menu-inner"},pt=["onClick"],gt={key:2},kt={key:0,class:"modal-overlay"},jt={class:"modal"},yt={class:"modal-header"},ht={class:"modal-header-h2"},ft={class:"minibutton-group modal-menu"},Tt={key:1,class:"modal-overlay"},Pt={class:"modal"},wt={class:"modal-header"},At={class:"modal-header-h2"},St={class:"minibutton-group modal-menu"},Dt={key:1},Ot={key:1},$t={key:2,class:"tab-menu minibutton-group"},Vt={key:3,class:"topic-tab"},It={key:4,class:"table-tab"},Ct={key:5,class:"table-tab"},xt={key:1,class:"none-container"},Et={key:1,class:"loading"},Lt={key:1,class:"loading"},Qt={__name:"TestDetail",setup(Bt){const T=ee(),v=ae(),E=g(!1),e=Y({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewTest:!1,canSelfAssignment:!1,canEditTest:!1,canDeleteTest:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),P=async()=>{const i=T.params.id;let t=localStorage.getItem("access_token");const u=y(t);t&&!u&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const d=await h.get(`${f}/tests/${i}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные теста:",d.data),e.object=d.data}catch(d){console.error("Ошибка при получении данных теста:",d)}},S=g(!1),z=()=>{S.value=!0},L=()=>{S.value=!1},q=async()=>{let i=localStorage.getItem("access_token");const t=y(i);if(i&&!t){v.push({name:"Login"});return}const u=T.params.id;try{await h.delete(`${f}/tests/${u}/`,{headers:{Authorization:`Bearer ${i}`}}),L(),v.push({name:"TestList"})}catch(d){console.error("Ошибка удаления теста:",d)}},D=g(!1),O=g(null),Q=i=>{O.value=i,D.value=!0},B=()=>{D.value=!1},J=async i=>{let t=localStorage.getItem("access_token");const u=y(t);if(t&&!u){v.push({name:"Login"});return}try{await h.delete(`${f}/test_sections/${i}/`,{headers:{Authorization:`Bearer ${t}`}}),await P(),B()}catch(d){console.error("Ошибка удаления раздела теста:",d)}},$=g(!1),V=g(null),F=i=>{V.value=i,$.value=!0},G=()=>{$.value=!1},R=async i=>{let t=localStorage.getItem("access_token");const u=y(t);if(t&&!u){v.push({name:"Login"});return}try{await h.delete(`${f}/test_section_questions/${i}/`,{headers:{Authorization:`Bearer ${t}`}}),await P(),G()}catch(d){console.error("Ошибка удаления вопроса раздела теста:",d)}},U=async i=>{let t=localStorage.getItem("access_token");const u=y(t);if(t&&!u){v.push({name:"Login"});return}try{const d=await h.post(`${f}/self_assignment/${i}/`,{},{headers:{Authorization:`Bearer ${t}`}});console.log("Самоназначение:",d.data),v.push({name:"TaskDetail",params:{id:d.data.id}})}catch(d){console.error("Ошибка самоназначения:",d)}},H=async()=>{console.log("Проверяем версию прав");const i=JSON.parse(localStorage.getItem("userPermissions"));if(!(i!=null&&i.permissions_version))return;console.log("Текущая версия прав:",i.permissions_version);let t=localStorage.getItem("access_token");const u=y(t);if(!(!t||!u))try{(await h.get(`${f}/user_permissions_version/${i.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(d){console.error("Ошибка проверки версии прав:",d),localStorage.removeItem("userPermissions")}},K=async()=>{var u,d,w,A;let i=localStorage.getItem("access_token");const t=y(i);i&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),i=null);try{let m=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",m),Object.keys(m).length>0&&(console.log("ID пользователя в разрешениях из памяти:",m.user_id),!t&&m.user_id!==1||t&&t.user_id!==m.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),m={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(m).length===0){const n=await h.get(`${f}/user_permissions/`,{headers:{...i&&{Authorization:`Bearer ${i}`}}});console.log("Разрешения пользователя загружены:",n.data),m=n.data,localStorage.setItem("userPermissions",JSON.stringify(m))}e.globalPermissionsList=m.global_permissions||[],e.objectPermissionsDict=m.object_permissions||{};const p=T.params.id;console.log("ID объекта:",p),e.canViewTest=e.globalPermissionsList.includes("tests.view_test")||e.objectPermissionsDict["tests.view_test"]&&e.objectPermissionsDict["tests.view_test"].includes(Number(p)),console.log("Права на просмотр аккаунтов:",e.canViewTest),e.canSelfAssignment=e.canViewTest&&e.object.self_assignment_task_template&&e.object.self_assignment_task_template&&(!e.object.last_task||((d=(u=e.object.last_task)==null?void 0:u.result)==null?void 0:d.status)=="failed"||((A=(w=e.object.last_task)==null?void 0:w.result)==null?void 0:A.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditTest=e.globalPermissionsList.includes("tests.change_test")||Array.isArray(e.objectPermissionsDict["tests.change_test"])&&e.objectPermissionsDict["tests.change_test"].includes(Number(p)),console.log("Права на редактирование аккаунтов:",e.canEditTest),e.canDeleteTest=e.globalPermissionsList.includes("tests.delete_test")||Array.isArray(e.objectPermissionsDict["tests.delete_test"])&&e.objectPermissionsDict["tests.delete_test"].includes(Number(p)),console.log("Права на удаление аккаунтов:",e.canDeleteTest),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(m){console.error("Ошибка при загрузке разрешений пользователя:",m)}},W=()=>{v.back()},X=Z(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canEditTest?{name:"test_sections",label:"Раздел теста"}:null,e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=g(T.query.tab||localStorage.getItem(`activeTestTab-${T.params.id}`)||"details");return te(b,i=>{localStorage.setItem(`activeTestTab-${T.params.id}`,i),v.push({query:{tab:i}}),console.log("Загружен таб:",i)}),se(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await P(),await H(),await K(),E.value=!0}catch(i){console.error("Ошибка при загрузке данных:",i)}}),(i,t)=>{var d,w,A,m,p;const u=oe("router-link");return E.value?(o(),a("div",de,[e.canViewTest?(o(),a("div",re,[e.object.id?(o(),a("div",ue,[s("div",me,[s("div",be,[e.object.avatar?(o(),a("div",_e,[s("img",{src:e.object.avatar||"/default-avatar.png",alt:"Аватар"},null,8,ve)])):(o(),a("div",pe,[...t[4]||(t[4]=[s("span",{class:"none-text"},"Нет аватара",-1)])]))]),s("div",ge,[s("div",ke,[s("div",je,[s("h1",null,l(e.object.name||"Безымянный тест"),1)])]),s("div",ye,[s("div",he,[t[5]||(t[5]=s("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),c(" "+l((d=e.object.last_task)!=null&&d.result?(w=e.object.last_task)==null?void 0:w.result.status_display:"Не назначено"),1)]),s("div",fe,[t[6]||(t[6]=s("span",{class:"detail-card-text-label"},"Проходной балл:",-1)),c(" "+l(e.object.passing_score||"Нет проходного балла"),1)]),s("div",Te,[t[7]||(t[7]=s("span",{class:"detail-card-text-label"},"Время на выполнение (минут):",-1)),c(" "+l(e.object.time_to_complete||"Нет времени на выполнение"),1)]),s("div",Pe,[t[8]||(t[8]=s("span",{class:"detail-card-text-label"},"Попытки:",-1)),c(" "+l(e.object.attempts||"Нет попыток"),1)]),s("div",we,[t[9]||(t[9]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),c(" "+l(e.object.categories.length>0?e.object.categories.map(n=>n.name).join(", "):"Нет категорий"),1)])]),s("div",Ae,[e.object.last_task?(o(),k(u,{key:0,to:{name:"TestAttempt",params:{id:e.object.last_task.id}},class:"button"},{default:j(()=>[...t[10]||(t[10]=[c(" Пройти ",-1)])]),_:1},8,["to"])):r("",!0),e.object.last_task?(o(),k(u,{key:1,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:j(()=>[...t[11]||(t[11]=[c(" Задача ",-1)])]),_:1},8,["to"])):r("",!0),e.canSelfAssignment?(o(),a("button",{key:2,onClick:t[0]||(t[0]=n=>U(e.object.self_assignment_task_template)),class:"button"}," Самоназначение ")):r("",!0),e.canEditTest?(o(),k(u,{key:3,to:{name:"TestEdit",params:{id:e.object.id}},class:"button"},{default:j(()=>[...t[12]||(t[12]=[c(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canDeleteTest?(o(),a("button",{key:4,onClick:z,class:"button"}," Удалить ")):r("",!0),s("button",{type:"button",onClick:W,class:"button"},"Назад")]),S.value?(o(),a("div",Se,[s("div",De,[s("div",Oe,[s("h2",$e,"Удаление "+l(e.object.username||"Безымянная учетная запись"),1)]),s("div",Ve,[s("button",{onClick:t[1]||(t[1]=n=>q()),class:"minibutton"},"Подтвердить"),s("button",{onClick:L,class:"minibutton"},"Отменить")])])])):r("",!0)])]),s("div",Ie,[s("div",Ce,[(o(!0),a(I,null,C(X.value,n=>(o(),a("button",{key:n.name,class:ie([{active:b.value===n.name},"tab-button"]),onClick:_=>b.value=n.name},l(n.label),11,xe))),128))]),b.value?(o(),a("div",Ee,[b.value==="desc"?(o(),a("div",Le,[e.object.desc?(o(),a("div",Be,l(e.object.desc),1)):(o(),a("div",Ge,[...t[13]||(t[13]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):r("",!0),b.value==="details"?(o(),a("div",Me,[s("div",Ne,[t[14]||(t[14]=s("span",{class:"detail-tab-label"},"Статус задачи:",-1)),c(" "+l((A=e.object.last_task)!=null&&A.result?(m=e.object.last_task)==null?void 0:m.result.status_display:"Не назначено"),1)]),s("div",ze,[t[15]||(t[15]=s("span",{class:"detail-tab-label"},"Категории:",-1)),c(" "+l(e.object.categories.length>0?e.object.categories.map(n=>n.name).join(", "):"Нет категорий"),1)]),s("div",qe,[t[16]||(t[16]=s("span",{class:"detail-tab-label"},"Проходной балл:",-1)),c(" "+l(e.object.passing_score||"Нет проходного балла"),1)]),s("div",Qe,[t[17]||(t[17]=s("span",{class:"detail-tab-label"},"Время на выполнение (минут):",-1)),c(" "+l(e.object.time_to_complete||"Нет времени на выполнение"),1)]),s("div",Je,[t[18]||(t[18]=s("span",{class:"detail-tab-label"},"Попытки:",-1)),c(" "+l(e.object.attempts||"Нет попыток"),1)]),s("div",Fe,[t[19]||(t[19]=s("span",{class:"detail-tab-label"},"Случайный порядок вопросов:",-1)),c(" "+l(e.object.random_questions?"Да":"Нет"),1)]),s("div",Re,[t[20]||(t[20]=s("span",{class:"detail-tab-label"},"Случайный порядок ответов:",-1)),c(" "+l(e.object.random_answers?"Да":"Нет"),1)]),s("div",Ue,[t[21]||(t[21]=s("span",{class:"detail-tab-label"},"Показывать результаты вопросов:",-1)),c(" "+l(e.object.show_questions_results?"Да":"Нет"),1)]),s("div",He,[t[22]||(t[22]=s("span",{class:"detail-tab-label"},"Показывать результаты ответов:",-1)),c(" "+l(e.object.show_answers_results?"Да":"Нет"),1)]),s("div",Ke,[t[23]||(t[23]=s("span",{class:"detail-tab-label"},"Создан:",-1)),c(" "+l(e.object.created?M(N)(e.object.created):"Нет данных о создании"),1)]),s("div",We,[t[24]||(t[24]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),c(" "+l(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",Xe,[t[25]||(t[25]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),c(" "+l(e.object.changed?M(N)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Ye,[t[26]||(t[26]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),c(" "+l(e.object.editor?e.object.editor:"Нет редактора"),1)])])):r("",!0),b.value==="test_sections"?(o(),a("div",Ze,[e.canEditTest?(o(),a("div",et,[e.object.test_sections&&e.object.test_sections.length>0?(o(),a("div",tt,[(o(!0),a(I,null,C(e.object.test_sections,n=>(o(),a("div",{key:n.id,class:"test-section-tab-item"},[s("div",st,[s("div",ot,[s("h2",null,l(n.item?n.item:"Нет данных")+" - "+l(n.name?n.name:"Нет имени"),1)])]),s("div",at,[s("div",it,[t[27]||(t[27]=s("span",{class:"test-section-tab-item-detail-label"},"Размер выборки:",-1)),c(" "+l(n.sample_size?n.sample_size:"Нет данных"),1)])]),e.canViewTest?(o(),a("div",nt,[n.test_section_questions&&n.test_section_questions.length>0?(o(),a("div",lt,[s("div",ct,[s("table",null,[t[29]||(t[29]=s("thead",null,[s("tr",null,[s("th",null,"Порядок"),s("th",null,"Вопрос"),s("th",null," Действия ")])],-1)),s("tbody",null,[(o(!0),a(I,null,C(n.test_section_questions,_=>(o(),a("tr",{key:_.id},[s("td",null,l(_.item?_.item:"-"),1),s("td",null,l(_.question.text?_.question.text:"-"),1),s("td",null,[e.canViewTest?(o(),a("div",dt,[s("div",rt,[e.canEditTest?(o(),k(u,{key:0,to:{name:"TestSectionQuestionEdit",params:{id:_.id},query:{testSectionId:n.id,testId:e.object.id}},class:"test-section-button"},{default:j(()=>[...t[28]||(t[28]=[c(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canEditTest?(o(),a("button",{key:1,onClick:Gt=>F(_),class:"test-section-button"}," Удалить ",8,ut)):r("",!0)])])):(o(),a("div",mt," - "))])]))),128))])])])])):(o(),a("div",bt,[...t[30]||(t[30]=[s("div",{class:"none-border-mini"},"Нет вопросов теста",-1)])]))])):r("",!0),e.canViewTest?(o(),a("div",_t,[s("div",vt,[e.canEditTest?(o(),k(u,{key:0,to:{name:"TestSectionQuestionCreate",query:{testSectionId:n.id,testId:e.object.id}},class:"test-section-button"},{default:j(()=>[...t[31]||(t[31]=[c(" Создать ",-1)])]),_:1},8,["to"])):r("",!0),e.canEditTest?(o(),k(u,{key:1,to:{name:"TestSectionEdit",params:{id:n.id},query:{testId:e.object.id}},class:"test-section-button"},{default:j(()=>[...t[32]||(t[32]=[c(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canEditTest?(o(),a("button",{key:2,onClick:_=>Q(n),class:"test-section-button"}," Удалить ",8,pt)):r("",!0)])])):(o(),a("div",gt," - "))]))),128)),D.value?(o(),a("div",kt,[s("div",jt,[s("div",yt,[s("h2",ht,"Удаление "+l(O.value.str||"Безымянная подзадача"),1)]),s("div",ft,[s("button",{onClick:t[2]||(t[2]=n=>J(O.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:B,class:"minibutton"},"Отменить")])])])):r("",!0),$.value?(o(),a("div",Tt,[s("div",Pt,[s("div",wt,[s("h2",At,"Удаление "+l(V.value.str||"Безымянная подзадача"),1)]),s("div",St,[s("button",{onClick:t[3]||(t[3]=n=>R(V.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:G,class:"minibutton"},"Отменить")])])])):r("",!0)])):(o(),a("div",Dt,[...t[33]||(t[33]=[s("div",{class:"none-border"},"Нет разделов теста",-1)])]))])):(o(),a("div",Ot,[...t[34]||(t[34]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])])),e.canEditTest?(o(),a("div",$t,[e.canEditTest?(o(),k(u,{key:0,to:{name:"TestSectionCreate",query:{testId:e.object.id}},class:"minibutton"},{default:j(()=>[...t[35]||(t[35]=[c(" Создать ",-1)])]),_:1},8,["to"])):r("",!0)])):r("",!0)])):r("",!0),b.value==="messages"?(o(),a("div",Vt,[x(ce,{topic_id:(p=e.object)==null?void 0:p.topic.id},null,8,["topic_id"])])):r("",!0),b.value==="accountsGroupObjectPermissions"?(o(),a("div",It,[x(ne,{state:e,fetchObject:P,contentTypeModel:"test"},null,8,["state"])])):r("",!0),b.value==="accountObjectPermissions"?(o(),a("div",Ct,[x(le,{state:e,fetchObject:P,contentTypeModel:"test"},null,8,["state"])])):r("",!0)])):r("",!0)])])):e.object.id?r("",!0):(o(),a("div",xt,[...t[36]||(t[36]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),a("div",Et,[...t[37]||(t[37]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),a("div",Lt,[...t[38]||(t[38]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Qt as default};
