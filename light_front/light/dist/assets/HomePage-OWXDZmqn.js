import{r as k,a as b,o as y,c as i,b as l,d as a,t as f,e as H,f as j,w as _,g as S,i as c,u as w,h as d,j as m,k as I,l as n,m as p}from"./index-BX9avzZ8.js";const A={key:0},V={key:0,class:"detail-page"},L={key:0},N={class:"detail-card"},B={class:"detail-card-info"},E={class:"detail-header"},T={class:"detail-header-title"},$={class:"material-content"},D=["innerHTML"],O={key:0,class:"detail-menu button-group"},x={key:1,class:"none-container"},C={key:0,class:"detail-menu button-group none-menu-padding"},z={key:1,class:"loading"},J={key:1,class:"loading"},U={__name:"HomePage",setup(M){I();const g=w(),u=k(!1),s=b({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewHomePage:!1,canEditHomePage:!1,canAddHomePage:!1}),v=async()=>{let t=localStorage.getItem("access_token");const e=c(t);if(t&&!e){g.push({name:"Login"});return}try{const o=await d.get(`${m}/home_page_content/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные результата:",o.data),s.object=o.data}catch(o){console.error("Ошибка при получении данных страницы:",o)}},h=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let e=localStorage.getItem("access_token");const o=c(e);if(!(!e||!o))try{(await d.get(`${m}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(r){console.error("Ошибка проверки версии прав:",r),localStorage.removeItem("userPermissions")}},P=async()=>{let t=localStorage.getItem("access_token");const e=c(t);if(t&&!e){g.push({name:"Login"});return}try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!e&&o.user_id!==1||e&&e.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const r=await d.get(`${m}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",r.data),o=r.data,localStorage.setItem("userPermissions",JSON.stringify(o))}s.globalPermissionsList=o.global_permissions||[],s.objectPermissionsDict=o.object_permissions||{},s.canViewHomePage=!0,s.canAddHomePage=s.globalPermissionsList.includes("core.add_home_page"),console.log("Права на добавление страницы:",s.canAddHomePage),s.canEditHomePage=s.globalPermissionsList.includes("core.change_home_page")||Array.isArray(s.objectPermissionsDict["core.change_home_page"])&&s.objectPermissionsDict["core.change_home_page"].includes(Number(id)),console.log("Права на редактирование страницы:",s.canEditHomePage)}catch(o){console.error("Ошибка при загрузке разрешений пользователя:",o)}};return y(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await v(),await h(),await P(),u.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,e)=>{const o=S("router-link");return u.value?(n(),i("div",A,[s.canViewHomePage?(n(),i("div",V,[s.object.id?(n(),i("div",L,[a("div",N,[a("div",B,[a("div",E,[a("div",T,[a("h1",null,f(s.object.title||"Безымянный материал"),1)])]),a("div",$,[a("div",{innerHTML:s.object.content,class:"tiptap"},null,8,D)]),s.canEditHomePage?(n(),i("div",O,[s.canEditHomePage?(n(),H(o,{key:0,to:{name:"HomePageEdit",params:{id:s.object.id}},class:"button"},{default:_(()=>[...e[0]||(e[0]=[p(" Изменить ",-1)])]),_:1},8,["to"])):l("",!0)])):l("",!0),e[1]||(e[1]=a("div",null,null,-1))])])])):s.object.id?l("",!0):(n(),i("div",x,[e[3]||(e[3]=a("div",{class:"none-card"},[a("div",null,"Объект не найден.")],-1)),s.canAddHomePage?(n(),i("div",C,[j(o,{to:{name:"HomePageCreate"},class:"button"},{default:_(()=>[...e[2]||(e[2]=[p(" Создать ",-1)])]),_:1})])):l("",!0)]))])):(n(),i("div",z,[...e[4]||(e[4]=[a("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),i("div",J,[...e[5]||(e[5]=[a("div",null,"Загрузка данных...",-1)])]))}}};export{U as default};
