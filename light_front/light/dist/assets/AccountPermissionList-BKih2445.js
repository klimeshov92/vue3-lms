import{a as T,r as v,k as W,o as X,c as a,d as s,b as k,p as Y,v as Z,f as x,w,D as z,n as ee,F as se,G as te,t as d,i as A,u as oe,h as f,j as P,g as le,l as n,m as u}from"./index-CAPuKB9Y.js";import{s as J}from"./custom-multiselect-BiCJycwk.js";const ae={key:0},ne={key:0,class:"list-page"},ie={class:"filters-inner"},re={class:"filters-field"},ce={class:"filters-field"},de={class:"filters-field"},ue={class:"filters-menu button-group"},me={key:1,class:"list-items"},ve={class:"list-grid"},ge={class:"list-card-header"},be={class:"list-card-header-title"},pe={class:"list-card-text"},_e={key:0},ye={class:"list-card-text-elem"},ke={key:1},fe={class:"list-card-text-elem"},Pe={key:2},he={class:"list-card-text-elem"},xe={class:"list-card-text-elem"},we={key:3},Ae={key:0,class:"list-card-text-elem"},Se={class:"list-card-text-elem"},$e={class:"list-card-text-elem"},je={class:"list-card-menu minibutton-group"},Ce={key:0},Ie={key:1},Ve={key:2},De=["onClick"],Le={key:3},qe=["onClick"],Fe={key:0,class:"modal-overlay"},Ne={class:"modal"},Oe={class:"modal-header"},Be={class:"modal-header-h2"},Me={class:"minibutton-group modal-menu"},Te={class:"list-pagination"},ze=["disabled"],Je=["disabled"],Ue={key:2,class:"none-card"},Re={key:1,class:"loading"},Ge={key:1,class:"loading"},Qe={__name:"AccountPermissionList",setup(Ee){const g=W(),b=oe(),c=T({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddAccountPermission:!1,canViewAccountPermission:!1}),V=v(!1),S=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"}],$=v([]),U=async()=>{let o=localStorage.getItem("access_token");const e=A(o);if(o&&!e){b.push({name:"Login"});return}try{const l=await f.get(`${P}/accounts/`,{headers:{Authorization:`Bearer ${o}`}});$.value=l.data.results||[],console.log("Аккаунты загружены:",$.value)}catch(l){console.error("Ошибка при загрузке групп:",l.response?l.response.data:l.message)}},r=T({name:g.query.name||"",account:g.query.account||"",order:S.find(o=>o.value===g.query.order||"name")}),R=()=>{const o=localStorage.getItem("permissionFilters");o&&(console.log("Загруженные фильры:",o),Object.assign(r,JSON.parse(o)))},i=v(Number(g.query.page)||1),j=v(1),G=()=>{const o=localStorage.getItem("permissionPage");o&&(console.log("Загруженная странциа:",o),i.value=parseInt(o,10))},p=async(o,e)=>{var y;console.log("Загрузка прав с фильтрами:",o,"для страницы:",e);let l=localStorage.getItem("access_token");const t=A(l);l&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),l=null),b.push({name:"AccountPermissionList",query:{name:o.name||"",account:o.account||"",order:o.order.value,page:i.value}}),localStorage.setItem("permissionFilters",JSON.stringify(o));try{const m=await f.get(`${P}/users_permissions/`,{headers:{...l&&{Authorization:`Bearer ${l}`}},params:{page:e,page_size:12,name:o.name,account:(y=o.account)==null?void 0:y.id,ordering:o.order.value}});console.log("Список прав загружен:",m.data),c.items=m.data.results,j.value=Math.ceil(m.data.count/12)}catch(m){console.error("Ошибка при загрузке списка прав:",m)}},D=o=>{console.log("Смена страницы на:",o),i.value=o,b.push({name:"AccountPermissionList",query:{...g.query,page:i.value}}),localStorage.setItem("permissionPage",i.value),p(r,o)},h=v(!1),C=()=>{h.value=!h.value,console.log("Текущий статус показа фильтров:",h.value)},E=()=>{console.log("Сбрасываем фильтры"),r.name="",r.account=null,r.order=S.find(o=>o.value==="name"),localStorage.removeItem("permissionFilters"),localStorage.removeItem("permissionPage"),i.value=1,b.push({name:"AccountPermissionList",query:{name:"",account:null,page:i.value}}),p(r,i.value)},I=v(!1),_=v(null),L=o=>{_.value=o,I.value=!0},q=()=>{I.value=!1},H=async o=>{let e=localStorage.getItem("access_token");const l=A(e);if(e&&!l){b.push({name:"Login"});return}if(_.value.type=="object_group")try{await f.delete(`${P}/accounts_group_object_permissions/${o}/`,{headers:{Authorization:`Bearer ${e}`}})}catch(t){console.error("Ошибка удаления права:",t)}if(_.value.type=="object_direct")try{await f.delete(`${P}/account_object_permissions/${o}/`,{headers:{Authorization:`Bearer ${e}`}})}catch(t){console.error("Ошибка удаления права:",t)}await p(r,i.value),q()},K=async()=>{let o=localStorage.getItem("access_token");const e=A(o);o&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!e&&l.user_id!==1||e&&e.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const t=await f.get(`${P}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",t.data),l=t.data,localStorage.setItem("userPermissions",JSON.stringify(l))}c.globalPermissionsList=l.global_permissions||[],c.objectPermissionsDict=l.object_permissions||{},c.canAddAccountPermission=c.globalPermissionsList.includes("auth.add_permission"),console.log("Права на добавление прав:",c.canAddAccountPermission),c.canViewAccountPermission=c.globalPermissionsList.includes("auth.view_permission")||!!c.objectPermissionsDict["auth.view_permission"],console.log("Права на просмотр прав:",c.canViewAccountPermission)}catch(l){console.error("Ошибка при получении разрешений пользователя:",l)}};return X(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await U(),await R(),await G(),await K(),await p(r,i.value),V.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,e)=>{const l=le("router-link");return V.value?(n(),a("div",ae,[c.canViewAccountPermission?(n(),a("div",ne,[e[26]||(e[26]=s("div",{class:"list-header"},[s("h1",null,"Права пользователей")],-1)),s("div",{class:"list-settings"},[s("button",{onClick:C,class:"list-settings-button"}," Параметры ")]),h.value?(n(),a("div",{key:0,class:"filters-overlay",onClick:C},[s("div",{class:"filters-outer",onClick:e[4]||(e[4]=ee(()=>{},["stop"]))},[s("div",{class:"filters-close_button-inner"},[s("button",{onClick:C,class:"filters-close_button"}," × ")]),s("div",ie,[s("div",re,[e[8]||(e[8]=s("label",{class:"filters-label"},"Название:",-1)),Y(s("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>r.name=t),class:"filters-input",placeholder:"Введите название"},null,512),[[Z,r.name]])]),s("div",ce,[e[11]||(e[11]=s("label",{class:"filters-label"},"Пользователь:",-1)),x(z(J),{modelValue:r.account,"onUpdate:modelValue":e[1]||(e[1]=t=>r.account=t),options:$.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:w(()=>[...e[9]||(e[9]=[s("span",null,"Список пуст",-1)])]),noResult:w(()=>[...e[10]||(e[10]=[s("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),s("div",de,[e[12]||(e[12]=s("label",{class:"filters-label"},"Сортировка:",-1)),x(z(J),{modelValue:r.order,"onUpdate:modelValue":e[2]||(e[2]=t=>r.order=t),options:S,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),s("div",ue,[s("button",{onClick:e[3]||(e[3]=t=>p(r,i.value.value)),class:"button"},"Применить"),s("button",{onClick:E,class:"button"},"Сбросить")])])])):k("",!0),c.items.length!==0?(n(),a("div",me,[s("div",ve,[(n(!0),a(se,null,te(c.items,t=>{var y,m,F,N,O,B,M;return n(),a("div",{key:`${t.user.id}-${t.type}-${t.permission.id}`,class:"list-card"},[s("div",ge,[s("div",be,[s("h2",null,d(((y=t.user)==null?void 0:y.username)||"Нет имени пользователя")+" | "+d(((m=t.permission)==null?void 0:m.name)||"Нет названия права"),1)])]),s("div",pe,[t.type==="direct"?(n(),a("div",_e,[s("div",ye,[e[13]||(e[13]=s("span",{class:"list-card-text-label"},"Тип права:",-1)),u(" "+d(t.user.is_superuser?"Администратор":"Назначенное"),1)])])):t.type==="group"?(n(),a("div",ke,[e[15]||(e[15]=s("div",{class:"list-card-text-elem"},[s("span",{class:"list-card-text-label"},"Тип права:"),u(" Групповое ")],-1)),s("div",fe,[e[14]||(e[14]=s("span",{class:"list-card-text-label"},"Группа:",-1)),u(" "+d(((F=t.group)==null?void 0:F.name)||"Нет имени группы"),1)])])):t.type==="object_direct"?(n(),a("div",Pe,[e[18]||(e[18]=s("div",{class:"list-card-text-elem"},[s("span",{class:"list-card-text-label"},"Тип права:"),u(" Прямое объектное ")],-1)),s("div",he,[e[16]||(e[16]=s("span",{class:"list-card-text-label"},"Тип объекта:",-1)),u(" "+d(((N=t.content_type)==null?void 0:N.verbose_name)||"Нет типа объекта"),1)]),s("div",xe,[e[17]||(e[17]=s("span",{class:"list-card-text-label"},"Объект:",-1)),u(" "+d(((O=t.object)==null?void 0:O.str)||"Нет объекта"),1)])])):t.type==="object_group"?(n(),a("div",we,[e[22]||(e[22]=s("div",{class:"list-card-text-elem"},[s("span",{class:"list-card-text-label"},"Тип права:"),u(" Групповое объектное ")],-1)),t.group?(n(),a("div",Ae,[e[19]||(e[19]=s("span",{class:"list-card-text-label"},"Группа:",-1)),u(" "+d(t.group.name),1)])):k("",!0),s("div",Se,[e[20]||(e[20]=s("span",{class:"list-card-text-label"},"Тип объекта:",-1)),u(" "+d(((B=t.content_type)==null?void 0:B.verbose_name)||"Нет типа объекта"),1)]),s("div",$e,[e[21]||(e[21]=s("span",{class:"list-card-text-label"},"Объект:",-1)),u(" "+d(((M=t.object)==null?void 0:M.str)||"Нет объекта"),1)])])):k("",!0)]),s("div",je,[t.type==="direct"?(n(),a("div",Ce,[x(l,{to:{name:"AccountDetail",params:{id:t.user.id},query:{tab:"details"}},class:"minibutton"},{default:w(()=>[...e[23]||(e[23]=[u(" Пользователь ",-1)])]),_:1},8,["to"])])):t.type==="group"?(n(),a("div",Ie,[x(l,{to:{name:"AccountGroupDetail",params:{id:t.group.id},query:{tab:"details"}},class:"minibutton"},{default:w(()=>[...e[24]||(e[24]=[u(" Группа ",-1)])]),_:1},8,["to"])])):t.type==="object_direct"?(n(),a("div",Ve,[s("button",{onClick:Q=>L(t),class:"minibutton"}," Удалить",8,De)])):t.type==="object_group"?(n(),a("div",Le,[s("button",{onClick:Q=>L(t),class:"minibutton"}," Удалить",8,qe)])):k("",!0)])])}),128))]),I.value?(n(),a("div",Fe,[s("div",Ne,[s("div",Oe,[s("h2",Be,"Удаление "+d(_.value.permission.name||"Безымянный исполнитель очереди"),1)]),s("div",Me,[s("button",{onClick:e[5]||(e[5]=t=>H(_.value.object_perm_id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:q,class:"minibutton"},"Отменить")])])])):k("",!0),s("div",Te,[s("button",{disabled:i.value===1,onClick:e[6]||(e[6]=t=>D(i.value-1)),class:"list-settings-button"}," Назад ",8,ze),s("span",null,"Страница "+d(i.value)+" из "+d(j.value),1),s("button",{disabled:i.value===j.value,onClick:e[7]||(e[7]=t=>D(i.value+1)),class:"list-settings-button"}," Вперед ",8,Je)])])):(n(),a("div",Ue,[...e[25]||(e[25]=[s("div",null,"Список пуст",-1)])]))])):(n(),a("div",Re,[...e[27]||(e[27]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),a("div",Ge,[...e[28]||(e[28]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Qe as default};
