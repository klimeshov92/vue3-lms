import{r as v,a as J,A as F,k as R,B as L,o as U,c as i,b as a,d as s,t as c,m as l,e as H,w as K,F as Q,E as W,C as G,G as C,f,i as y,h as k,j as g,g as X,u as Y,l as o,H as Z}from"./index-C8MToAQO.js";import{_ as ee}from"./TopicMessages-PNxrdwPk.js";import{_ as te,a as se}from"./AccountsGroupObjectPermissions-Cp9WDQYa.js";import"./EditorComponent-CNY1fJ-z.js";const oe={key:0},ie={key:0,class:"detail-page"},ce={key:0},ae={class:"detail-card"},le={class:"detail-card-info"},ne={class:"detail-header"},re={key:0,class:"detail-header-title"},de={key:1,class:"detail-header-title"},be={key:2,class:"detail-header-title"},pe={key:3,class:"detail-header-title"},ue={key:4,class:"detail-header-title"},_e={key:5,class:"detail-header-title"},me={key:6,class:"detail-header-title"},je={key:7,class:"detail-header-title"},ve={key:8,class:"detail-header-title"},ye={key:9,class:"detail-header-title"},ke={key:10,class:"detail-header-title"},ge={class:"detail-card-text"},he={class:"detail-card-text-elem"},Pe={key:0,class:"detail-card-text-elem"},fe={key:1,class:"detail-card-text-elem"},Ae={key:2,class:"detail-card-text-elem"},we={key:3,class:"detail-card-text-elem"},Te={key:4,class:"detail-card-text-elem"},Oe={key:5,class:"detail-card-text-elem"},xe={key:6,class:"detail-card-text-elem"},De={key:7,class:"detail-card-text-elem"},Se={key:8,class:"detail-card-text-elem"},Ve={key:9,class:"detail-card-text-elem"},$e={class:"detail-card-text-elem"},Ie={class:"detail-menu button-group"},Le={key:0,class:"modal-overlay"},Ge={class:"modal"},Ce={class:"modal-header"},qe={class:"modal-header-h2"},Be={class:"minibutton-group modal-menu"},Ne={class:"detail-tabs"},Ee={class:"tabs-header"},Me=["onClick"],ze={key:0,class:"tabs-content"},Je={key:0,class:"desc-tab"},Fe={key:0},Re={key:1},Ue={key:1,class:"detail-tab"},He={class:"detail-tab-elem"},Ke={key:0,class:"detail-tab-elem"},Qe={key:1,class:"detail-tab-elem"},We={key:2,class:"detail-tab-elem"},Xe={key:3,class:"detail-tab-elem"},Ye={key:4,class:"detail-tab-elem"},Ze={key:5,class:"detail-tab-elem"},et={key:6,class:"detail-tab-elem"},tt={key:7,class:"detail-tab-elem"},st={key:8,class:"detail-tab-elem"},ot={key:9,class:"detail-tab-elem"},it={class:"detail-tab-elem"},ct={class:"detail-tab-elem"},at={class:"detail-tab-elem"},lt={class:"detail-tab-elem"},nt={class:"detail-tab-elem"},rt={key:2,class:"topic-tab"},dt={key:3,class:"table-tab"},bt={key:4,class:"table-tab"},pt={key:1,class:"none-container"},ut={key:1,class:"loading"},_t={key:1,class:"loading"},ht={__name:"TopicDetail",setup(mt){const u=R(),m=Y(),A=v(!1),e=J({object:null,globalPermissionsList:[],objectPermissionsDict:{},canAddTopic:!1,canViewTopic:!1,canEditTopic:!1,canDeleteTopic:!1,canDeleteMessageGlobal:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),h=v(null),j=async()=>{const n=u.params.id;let t=localStorage.getItem("access_token");const r=y(t);t&&!r&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const d=await k.get(`${g}/topics/${n}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные топика:",d.data),e.object=d.data,h.value=e.object.id,console.log("ID топика:",h.value)}catch(d){console.error("Ошибка при получении данных топика:",d)}},P=v(!1),q=()=>{P.value=!0},w=()=>{P.value=!1},B=async()=>{let n=localStorage.getItem("access_token");const t=y(n);if(n&&!t){m.push({name:"Login"});return}const r=u.params.id;try{await k.delete(`${g}/topics/${r}/`,{headers:{Authorization:`Bearer ${n}`}}),w(),m.push({name:"TopicList"})}catch(d){console.error("Ошибка удаления задачи:",d)}},N=async()=>{console.log("Проверяем версию прав");const n=JSON.parse(localStorage.getItem("userPermissions"));if(!(n!=null&&n.permissions_version))return;console.log("Текущая версия прав:",n.permissions_version);let t=localStorage.getItem("access_token");const r=y(t);if(!(!t||!r))try{(await k.get(`${g}/user_permissions_version/${n.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(d){console.error("Ошибка проверки версии прав:",d),localStorage.removeItem("userPermissions")}},E=async()=>{let n=localStorage.getItem("access_token");const t=y(n);n&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),n=null);try{let r=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",r),Object.keys(r).length>0&&(console.log("ID пользователя в разрешениях из памяти:",r.user_id),!t&&r.user_id!==1||t&&t.user_id!==r.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),r={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(r).length===0){const _=await k.get(`${g}/user_permissions/`,{headers:{...n&&{Authorization:`Bearer ${n}`}}});console.log("Разрешения пользователя загружены:",_.data),r=_.data,localStorage.setItem("userPermissions",JSON.stringify(r))}e.globalPermissionsList=r.global_permissions||[],e.objectPermissionsDict=r.object_permissions||{};const d=u.params.id;console.log("ID объекта:",d),e.canAddTopic=e.globalPermissionsList.includes("comments.add_topic"),console.log("Права на добавление топик:",e.canAddTopic),e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(d)),console.log("Права на просмотр топика:",e.canViewTopic),e.canEditTopic=e.globalPermissionsList.includes("comments.change_topic")||Array.isArray(e.objectPermissionsDict["comments.change_topic"])&&e.objectPermissionsDict["comments.change_topic"].includes(Number(d)),console.log("Права на редактирование топика:",e.canEditTopic),e.canDeleteTopic=e.globalPermissionsList.includes("comments.delete_topic")||Array.isArray(e.objectPermissionsDict["comments.delete_topic"])&&e.objectPermissionsDict["comments.delete_topic"].includes(Number(d)),console.log("Права на удаление топика:",e.canDeleteTopic),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(r){console.error("Ошибка при загрузке разрешений пользователя:",r)}},M=()=>{m.back()},z=F(()=>[{name:"desc",label:"Описание"},{name:"messages",label:"Содержание"},{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=v(u.query.tab||localStorage.getItem(`activeTopicTab-${u.params.id}`)||"desc");return L(b,n=>{localStorage.setItem(`activeTopicTab-${u.params.id}`,n),m.push({query:{tab:n}}),console.log("Загружен таб:",n)}),U(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await j(),await N(),await E(),A.value=!0}catch(n){console.error("Ошибка при загрузке данных:",n)}}),L(()=>u.params.id,async n=>{console.log("Параметр id изменился на:",n),await j()}),(n,t)=>{var d,_,T,O,x,D,S,V,$,I;const r=X("router-link");return A.value?(o(),i("div",oe,[e.canViewTopic?(o(),i("div",ie,[e.object.id?(o(),i("div",ce,[s("div",ae,[s("div",le,[s("div",ne,[e.object.topic_type=="common_topic"?(o(),i("div",re,[s("h1",null,c(e.object.name||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="task_topic"?(o(),i("div",de,[s("h1",null,c(((d=e.object.task)==null?void 0:d.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="queue_topic"?(o(),i("div",be,[s("h1",null,c(((_=e.object.queue)==null?void 0:_.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="public_plan_topic"?(o(),i("div",pe,[s("h1",null,c(((T=e.object.public_plan)==null?void 0:T.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="public_task_topic"?(o(),i("div",ue,[s("h1",null,c(((O=e.object.public_task)==null?void 0:O.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="new_topic"?(o(),i("div",_e,[s("h1",null,c(((x=e.object.new)==null?void 0:x.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="material_topic"?(o(),i("div",me,[s("h1",null,c(((D=e.object.material)==null?void 0:D.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="course_topic"?(o(),i("div",je,[s("h1",null,c(((S=e.object.course)==null?void 0:S.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="test_topic"?(o(),i("div",ve,[s("h1",null,c(((V=e.object.test)==null?void 0:V.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="event_template_topic"?(o(),i("div",ye,[s("h1",null,c((($=e.object.event_template)==null?void 0:$.str)||"Безымянный топик"),1)])):a("",!0),e.object.topic_type=="event_slot_topic"?(o(),i("div",ke,[s("h1",null,c(((I=e.object.event_slot)==null?void 0:I.str)||"Безымянный топик"),1)])):a("",!0)]),s("div",ge,[s("div",he,[t[1]||(t[1]=s("span",{class:"detail-card-text-label"},"Тип топика:",-1)),l(" "+c(e.object.topic_type_display||"Нет типа топика"),1)]),e.object.topic_type=="task_topic"?(o(),i("div",Pe,[t[2]||(t[2]=s("span",{class:"detail-card-text-label"},"Задача:",-1)),l(" "+c(e.object.task?e.object.task.str:"Нет задачи"),1)])):a("",!0),e.object.topic_type=="queue_topic"?(o(),i("div",fe,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Очередь:",-1)),l(" "+c(e.object.queue?e.object.queue.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="public_plan_topic"?(o(),i("div",Ae,[t[4]||(t[4]=s("span",{class:"detail-card-text-label"},"План:",-1)),l(" "+c(e.object.public_plan?e.object.public_plan.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="public_task_topic"?(o(),i("div",we,[t[5]||(t[5]=s("span",{class:"detail-card-text-label"},"Задание:",-1)),l(" "+c(e.object.public_task?e.object.public_task.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="new_topic"?(o(),i("div",Te,[t[6]||(t[6]=s("span",{class:"detail-card-text-label"},"Новость:",-1)),l(" "+c(e.object.new?e.object.new.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="material_topic"?(o(),i("div",Oe,[t[7]||(t[7]=s("span",{class:"detail-card-text-label"},"Материал:",-1)),l(" "+c(e.object.material?e.object.material.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="course_topic"?(o(),i("div",xe,[t[8]||(t[8]=s("span",{class:"detail-card-text-label"},"Курс:",-1)),l(" "+c(e.object.course?e.object.course.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="test_topic"?(o(),i("div",De,[t[9]||(t[9]=s("span",{class:"detail-card-text-label"},"Тест:",-1)),l(" "+c(e.object.test?e.object.test.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="event_template_topic"?(o(),i("div",Se,[t[10]||(t[10]=s("span",{class:"detail-card-text-label"},"Мероприятия:",-1)),l(" "+c(e.object.event_template?e.object.event_template.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="event_slot_topic"?(o(),i("div",Ve,[t[11]||(t[11]=s("span",{class:"detail-card-text-label"},"Слот мероприятия:",-1)),l(" "+c(e.object.event_slot?e.object.event_slot.str:"Нет очереди"),1)])):a("",!0),s("div",$e,[t[12]||(t[12]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),l(" "+c(e.object.categories.length>0?e.object.categories.map(p=>p.name).join(", "):"Нет категорий"),1)])]),s("div",Ie,[e.canEditTopic?(o(),H(r,{key:0,to:{name:"TopicEdit",params:{id:e.object.id}},class:"button"},{default:K(()=>[...t[13]||(t[13]=[l(" Изменить ",-1)])]),_:1},8,["to"])):a("",!0),e.canDeleteTopic?(o(),i("button",{key:1,onClick:q,class:"button"}," Удалить ")):a("",!0),s("button",{type:"button",onClick:M,class:"button"},"Назад")]),P.value?(o(),i("div",Le,[s("div",Ge,[s("div",Ce,[s("h2",qe,"Удаление "+c(e.object.name||"Безымянный топик"),1)]),s("div",Be,[s("button",{onClick:t[0]||(t[0]=p=>B()),class:"minibutton"},"Подтвердить"),s("button",{onClick:w,class:"minibutton"},"Отменить")])])])):a("",!0)])]),s("div",Ne,[s("div",Ee,[(o(!0),i(Q,null,W(z.value,p=>(o(),i("button",{key:p.name,class:Z([{active:b.value===p.name},"tab-button"]),onClick:jt=>b.value=p.name},c(p.label),11,Me))),128))]),b.value?(o(),i("div",ze,[b.value==="desc"?(o(),i("div",Je,[e.object.desc?(o(),i("div",Fe,c(e.object.desc),1)):(o(),i("div",Re,[...t[14]||(t[14]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):a("",!0),b.value==="details"?(o(),i("div",Ue,[s("div",He,[t[15]||(t[15]=s("span",{class:"detail-tab-label"},"Тип топика:",-1)),l(" "+c(e.object.topic_type_display||"Нет типа топика"),1)]),e.object.topic_type=="task_topic"?(o(),i("div",Ke,[t[16]||(t[16]=s("span",{class:"detail-tab-label"},"Задача:",-1)),l(" "+c(e.object.task?e.object.task.str:"Нет задачи"),1)])):a("",!0),e.object.topic_type=="queue_topic"?(o(),i("div",Qe,[t[17]||(t[17]=s("span",{class:"detail-tab-label"},"Очередь:",-1)),l(" "+c(e.object.queue?e.object.queue.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="public_plan_topic"?(o(),i("div",We,[t[18]||(t[18]=s("span",{class:"detail-tab-label"},"План:",-1)),l(" "+c(e.object.public_plan?e.object.public_plan.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="public_task_topic"?(o(),i("div",Xe,[t[19]||(t[19]=s("span",{class:"detail-tab-label"},"Задание:",-1)),l(" "+c(e.object.public_task?e.object.public_task.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="new_topic"?(o(),i("div",Ye,[t[20]||(t[20]=s("span",{class:"detail-tab-label"},"Новость:",-1)),l(" "+c(e.object.new?e.object.new.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="material_topic"?(o(),i("div",Ze,[t[21]||(t[21]=s("span",{class:"detail-tab-label"},"Материал:",-1)),l(" "+c(e.object.material?e.object.material.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="course_topic"?(o(),i("div",et,[t[22]||(t[22]=s("span",{class:"detail-tab-label"},"Курс:",-1)),l(" "+c(e.object.course?e.object.course.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="test_topic"?(o(),i("div",tt,[t[23]||(t[23]=s("span",{class:"detail-tab-label"},"Тест:",-1)),l(" "+c(e.object.test?e.object.test.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="event_template_topic"?(o(),i("div",st,[t[24]||(t[24]=s("span",{class:"detail-tab-label"},"Мероприятия:",-1)),l(" "+c(e.object.event_template?e.object.event_template.str:"Нет очереди"),1)])):a("",!0),e.object.topic_type=="event_slot_topic"?(o(),i("div",ot,[t[25]||(t[25]=s("span",{class:"detail-tab-label"},"Слот мероприятия:",-1)),l(" "+c(e.object.event_slot?e.object.event_slot.str:"Нет очереди"),1)])):a("",!0),s("div",it,[t[26]||(t[26]=s("span",{class:"detail-tab-label"},"Категории:",-1)),l(" "+c(e.object.categories.length>0?e.object.categories.map(p=>p.name).join(", "):"Нет категорий"),1)]),s("div",ct,[t[27]||(t[27]=s("span",{class:"detail-tab-label"},"Создан:",-1)),l(" "+c(e.object.created?G(C)(e.object.created):"Нет данных о создании"),1)]),s("div",at,[t[28]||(t[28]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),l(" "+c(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",lt,[t[29]||(t[29]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),l(" "+c(e.object.changed?G(C)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",nt,[t[30]||(t[30]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),l(" "+c(e.object.editor?e.object.editor:"Нет редактора"),1)])])):a("",!0),b.value==="messages"?(o(),i("div",rt,[f(ee,{topic_id:h.value},null,8,["topic_id"])])):a("",!0),b.value==="accountsGroupObjectPermissions"?(o(),i("div",dt,[f(te,{state:e,fetchObject:j,contentTypeModel:"topic"},null,8,["state"])])):a("",!0),b.value==="accountObjectPermissions"?(o(),i("div",bt,[f(se,{state:e,fetchObject:j,contentTypeModel:"topic"},null,8,["state"])])):a("",!0)])):a("",!0)])])):e.object.id?a("",!0):(o(),i("div",pt,[...t[31]||(t[31]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),i("div",ut,[...t[32]||(t[32]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),i("div",_t,[...t[33]||(t[33]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{ht as default};
