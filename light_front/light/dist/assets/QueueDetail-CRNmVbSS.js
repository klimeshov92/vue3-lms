import{r as v,a as M,A as z,k as J,B as F,o as R,c as n,b as u,d as s,t as r,m as d,e as h,w as y,F as w,E as A,C as q,G as T,f as x,i as g,h as p,j as k,g as U,u as H,l as o,H as K}from"./index-_TMNgkFu.js";import{_ as W,a as X}from"./AccountsGroupObjectPermissions-DLwhg3DR.js";import{_ as Y}from"./TopicMessages-CkuMyK9b.js";import"./EditorComponent-BJSxZEvv.js";const Z={key:0},ee={key:0,class:"detail-page"},se={key:0},te={class:"detail-card"},oe={class:"detail-card-info"},ne={class:"detail-header"},ae={class:"detail-header-title"},ie={class:"detail-card-text"},le={class:"detail-card-text-elem"},ce={class:"detail-card-text-elem"},ue={class:"detail-menu button-group"},re={key:0,class:"modal-overlay"},de={class:"modal"},be={class:"modal-header"},me={class:"modal-header-h2"},_e={class:"minibutton-group modal-menu"},ve={class:"detail-tabs"},ge={class:"tabs-header"},pe=["onClick"],ke={key:0,class:"tabs-content"},je={key:0,class:"desc-tab"},he={key:0},ye={key:1},Pe={key:1,class:"detail-tab"},Qe={class:"detail-tab-elem"},fe={class:"detail-tab-elem"},we={class:"detail-tab-elem"},Ae={class:"detail-tab-elem"},xe={class:"detail-tab-elem"},Ee={class:"detail-tab-elem"},De={key:2,class:"table-tab"},Oe={key:0},Ve={key:0,class:"table-tab-table-outer"},qe={class:"table-tab-table-inner"},Te={key:0},$e={class:"table-tab-menu"},Le=["onClick"],Se={key:2,class:"modal-overlay"},Ie={class:"modal"},Ce={class:"modal-header"},Ge={class:"modal-header-h2"},Be={class:"minibutton-group modal-menu"},Ne={key:1},Me={key:1},ze={key:1},Je={key:2,class:"tab-menu minibutton-group"},Fe={key:3,class:"table-tab"},Re={key:0},Ue={key:0,class:"table-tab-table-outer"},He={class:"table-tab-table-inner"},Ke={key:1},We={key:1},Xe={key:2,class:"tab-menu minibutton-group"},Ye={key:4,class:"topic-tab"},Ze={key:5,class:"table-tab"},es={key:6,class:"table-tab"},ss={key:1,class:"none-container"},ts={key:1,class:"loading"},os={key:1,class:"loading"},us={__name:"QueueDetail",setup(ns){const m=J(),_=H(),E=v(!1),e=M({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewQueue:!1,canEditQueue:!1,canDeleteQueue:!1,canAddQueueExecutor:!1,canViewQueueExecutor:!1,canEditQueueExecutor:!1,canDeleteQueueExecutor:!1,canAddQueueTask:!1,canViewQueueTask:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),j=async()=>{const a=m.params.id;let t=localStorage.getItem("access_token");const l=g(t);t&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const c=await p.get(`${k}/queues/${a}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные задачи:",c.data),e.object=c.data}catch(c){console.error("Ошибка при получении данных задачи:",c)}},P=v(!1),$=()=>{P.value=!0},D=()=>{P.value=!1},L=async()=>{let a=localStorage.getItem("access_token");const t=g(a);if(a&&!t){_.push({name:"Login"});return}const l=m.params.id;try{await p.delete(`${k}/queues/${l}/`,{headers:{Authorization:`Bearer ${a}`}}),D(),_.push({name:"QueueList"})}catch(c){console.error("Ошибка удаления задачи:",c)}},Q=v(!1),f=v(null),S=a=>{f.value=a,Q.value=!0},O=()=>{Q.value=!1},I=async a=>{let t=localStorage.getItem("access_token");const l=g(t);if(t&&!l){_.push({name:"Login"});return}try{await p.delete(`${k}/queue_executors/${a}/`,{headers:{Authorization:`Bearer ${t}`}}),await j(),O()}catch(c){console.error("Ошибка удаления аккаунта:",c)}},C=async()=>{console.log("Проверяем версию прав");const a=JSON.parse(localStorage.getItem("userPermissions"));if(!(a!=null&&a.permissions_version))return;console.log("Текущая версия прав:",a.permissions_version);let t=localStorage.getItem("access_token");const l=g(t);if(!(!t||!l))try{(await p.get(`${k}/user_permissions_version/${a.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(c){console.error("Ошибка проверки версии прав:",c),localStorage.removeItem("userPermissions")}},G=async()=>{let a=localStorage.getItem("access_token");const t=g(a);a&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),a=null);try{let l=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",l),Object.keys(l).length>0&&(console.log("ID пользователя в разрешениях из памяти:",l.user_id),!t&&l.user_id!==1||t&&t.user_id!==l.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),l={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(l).length===0){const i=await p.get(`${k}/user_permissions/`,{headers:{...a&&{Authorization:`Bearer ${a}`}}});console.log("Разрешения пользователя загружены:",i.data),l=i.data,localStorage.setItem("userPermissions",JSON.stringify(l))}e.globalPermissionsList=l.global_permissions||[],e.objectPermissionsDict=l.object_permissions||{};const c=m.params.id;console.log("ID объекта:",c),e.canViewQueue=e.globalPermissionsList.includes("bpms.view_queue")||e.objectPermissionsDict["bpms.view_queue"]&&e.objectPermissionsDict["bpms.view_queue"].includes(Number(c)),console.log("Права на просмотр очередей:",e.canViewQueue),e.canEditQueue=e.globalPermissionsList.includes("bpms.change_queue")||Array.isArray(e.objectPermissionsDict["bpms.change_queue"])&&e.objectPermissionsDict["bpms.change_queue"].includes(Number(c)),console.log("Права на редактирование очередей:",e.canEditQueue),e.canDeleteQueue=e.globalPermissionsList.includes("bpms.delete_queue")||Array.isArray(e.objectPermissionsDict["bpms.delete_queue"])&&e.objectPermissionsDict["bpms.delete_queue"].includes(Number(c)),console.log("Права на удаление очередей:",e.canDeleteQueue),e.canAddQueueExecutor=e.globalPermissionsList.includes("bpms.add_queue_executor"),console.log("Права на добавление исполнителей:",e.canAddQueueExecutor),e.canViewQueueExecutor=e.globalPermissionsList.includes("bpms.view_queue_executor"),console.log("Права на просмотр исполнителей:",e.canViewQueueExecutor),e.canEditQueueExecutor=e.globalPermissionsList.includes("bpms.change_queue_executor"),console.log("Права на редактирование исполнителей:",e.canEditQueueExecutor),e.canDeleteQueueExecutor=e.globalPermissionsList.includes("bpms.delete_queue_executor"),console.log("Права на удаление исполнителей:",e.canDeleteQueueExecutor),e.canAddQueueTask=e.globalPermissionsList.includes("bpms.add_queue_task"),console.log("Права на добавление задач:",e.canAddQueueTask),e.canViewQueueTask=e.globalPermissionsList.includes("bpms.view_queue_task"),console.log("Права на просмотр задач:",e.canViewQueueTask),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(l){console.error("Ошибка при загрузке разрешений пользователя:",l)}},B=()=>{_.back()},N=z(()=>[{name:"details",label:"Детали"},{name:"desc",label:"Описание"},{name:"queue_executors",label:"Исполнители очереди"},{name:"queue_tasks",label:"Задачи очереди"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),b=v(m.query.tab||localStorage.getItem(`activeQueueTab-${m.params.id}`)||"details");return F(b,a=>{localStorage.setItem(`activeQueueTab-${m.params.id}`,a),_.push({query:{tab:a}}),console.log("Загружен таб:",a)}),R(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await j(),await C(),await G(),E.value=!0}catch(a){console.error("Ошибка при загрузке данных:",a)}}),(a,t)=>{var c;const l=U("router-link");return E.value?(o(),n("div",Z,[e.canViewQueue?(o(),n("div",ee,[e.object.id?(o(),n("div",se,[s("div",te,[s("div",oe,[s("div",ne,[s("div",ae,[s("h1",null,r(e.object.name||"Безымянная очередь"),1)])]),s("div",ie,[s("div",le,[t[2]||(t[2]=s("span",{class:"detail-card-text-label"},"Автоназначение исполнителя:",-1)),d(" "+r(e.object.auto_assignment?"Да":"Нет"),1)]),s("div",ce,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),d(" "+r(e.object.categories.length>0?e.object.categories.map(i=>i.name).join(", "):"Нет категорий"),1)])]),s("div",ue,[e.canEditQueue?(o(),h(l,{key:0,to:{name:"QueueEdit",params:{id:e.object.id}},class:"button"},{default:y(()=>[...t[4]||(t[4]=[d(" Изменить ",-1)])]),_:1},8,["to"])):u("",!0),e.canDeleteQueue?(o(),n("button",{key:1,onClick:$,class:"button"}," Удалить ")):u("",!0),s("button",{type:"button",onClick:B,class:"button"},"Назад")]),P.value?(o(),n("div",re,[s("div",de,[s("div",be,[s("h2",me,"Удаление "+r(e.object.name||"Безымянная очередь"),1)]),s("div",_e,[s("button",{onClick:t[0]||(t[0]=i=>L()),class:"minibutton"},"Подтвердить"),s("button",{onClick:D,class:"minibutton"},"Отменить")])])])):u("",!0)])]),s("div",ve,[s("div",ge,[(o(!0),n(w,null,A(N.value,i=>(o(),n("button",{key:i.name,class:K([{active:b.value===i.name},"tab-button"]),onClick:V=>b.value=i.name},r(i.label),11,pe))),128))]),b.value?(o(),n("div",ke,[b.value==="desc"?(o(),n("div",je,[e.object.desc?(o(),n("div",he,r(e.object.desc),1)):(o(),n("div",ye,[...t[5]||(t[5]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):u("",!0),b.value==="details"?(o(),n("div",Pe,[s("div",Qe,[t[6]||(t[6]=s("span",{class:"detail-tab-label"},"Автоназначение исполнителя:",-1)),d(" "+r(e.object.auto_assignment?"Да":"Нет"),1)]),s("div",fe,[t[7]||(t[7]=s("span",{class:"detail-tab-label"},"Категории:",-1)),d(" "+r(e.object.categories.length>0?e.object.categories.map(i=>i.name).join(", "):"Нет категорий"),1)]),s("div",we,[t[8]||(t[8]=s("span",{class:"detail-tab-label"},"Создан:",-1)),d(" "+r(e.object.created?q(T)(e.object.created):"Нет данных о создании"),1)]),s("div",Ae,[t[9]||(t[9]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),d(" "+r(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",xe,[t[10]||(t[10]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),d(" "+r(e.object.changed?q(T)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Ee,[t[11]||(t[11]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),d(" "+r(e.object.editor?e.object.editor:"Нет редактора"),1)])])):u("",!0),b.value==="queue_executors"?(o(),n("div",De,[e.canViewQueueExecutor?(o(),n("div",Oe,[e.object.queue_executors&&e.object.queue_executors.length>0?(o(),n("div",Ve,[s("div",qe,[s("table",null,[t[13]||(t[13]=s("thead",null,[s("tr",null,[s("th",null,"Пункт"),s("th",null,"Исполнитель"),s("th",null," Действия ")])],-1)),s("tbody",null,[(o(!0),n(w,null,A(e.object.queue_executors,i=>(o(),n("tr",{key:i.id},[s("td",null,r(i.item?i.item:"Нет данных"),1),s("td",null,r(i.executor?i.executor.str:"Нет данных"),1),s("td",null,[e.canEditQueueExecutor||e.canDeleteQueueExecutor?(o(),n("div",Te,[s("div",$e,[e.canEditQueueExecutor?(o(),h(l,{key:0,to:{name:"QueueExecutorEdit",params:{id:i.id},query:{queueId:e.object.id}},class:"table-tab-button"},{default:y(()=>[...t[12]||(t[12]=[d(" Изменить ",-1)])]),_:1},8,["to"])):u("",!0),e.canDeleteQueueExecutor?(o(),n("button",{key:1,onClick:V=>S(i),class:"table-tab-button"}," Удалить ",8,Le)):u("",!0),Q.value?(o(),n("div",Se,[s("div",Ie,[s("div",Ce,[s("h2",Ge,"Удаление "+r(f.value.str||"Безымянный исполнитель очереди"),1)]),s("div",Be,[s("button",{onClick:t[1]||(t[1]=V=>I(f.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:O,class:"minibutton"},"Отменить")])])])):u("",!0)])])):(o(),n("div",Ne," - "))])]))),128))])])])])):(o(),n("div",Me,[...t[14]||(t[14]=[s("div",{class:"none-border"},"Нет исполнителей",-1)])]))])):(o(),n("div",ze,[...t[15]||(t[15]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])])),e.canAddQueueExecutor?(o(),n("div",Je,[e.canAddQueueExecutor?(o(),h(l,{key:0,to:{name:"CreateQueueExecutor",query:{queueId:e.object.id}},class:"minibutton"},{default:y(()=>[...t[16]||(t[16]=[d(" Создать ",-1)])]),_:1},8,["to"])):u("",!0)])):u("",!0)])):u("",!0),b.value==="queue_tasks"?(o(),n("div",Fe,[e.canViewQueueTask?(o(),n("div",Re,[e.object.queue_tasks&&e.object.queue_tasks.length>0?(o(),n("div",Ue,[s("div",He,[s("table",null,[t[17]||(t[17]=s("thead",null,[s("tr",null,[s("th",null,"Пункт"),s("th",null,"Задача"),s("th",null,"Исполнитель")])],-1)),s("tbody",null,[(o(!0),n(w,null,A(e.object.queue_tasks,i=>(o(),n("tr",{key:i.id},[s("td",null,r(i.item?i.item:"Нет данных"),1),s("td",null,r(i.task?i.task.str:"Нет данных"),1),s("td",null,r(i.task?i.executor.str:"Нет данных"),1)]))),128))])])])])):(o(),n("div",Ke,[...t[18]||(t[18]=[s("div",{class:"none-border"},"Нет задач",-1)])]))])):(o(),n("div",We,[...t[19]||(t[19]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])])),e.canAddQueueTask?(o(),n("div",Xe,[e.canAddQueueTask?(o(),h(l,{key:0,to:{name:"CreateQueueTask",query:{queueId:e.object.id}},class:"minibutton"},{default:y(()=>[...t[20]||(t[20]=[d(" Создать ",-1)])]),_:1},8,["to"])):u("",!0)])):u("",!0)])):u("",!0),b.value==="messages"?(o(),n("div",Ye,[x(Y,{topic_id:(c=e.object)==null?void 0:c.topic.id},null,8,["topic_id"])])):u("",!0),b.value==="accountsGroupObjectPermissions"?(o(),n("div",Ze,[x(W,{state:e,fetchObject:j,contentTypeModel:"queue"},null,8,["state"])])):u("",!0),b.value==="accountObjectPermissions"?(o(),n("div",es,[x(X,{state:e,fetchObject:j,contentTypeModel:"queue"},null,8,["state"])])):u("",!0)])):u("",!0)])])):e.object.id?u("",!0):(o(),n("div",ss,[...t[21]||(t[21]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),n("div",ts,[...t[22]||(t[22]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),n("div",os,[...t[23]||(t[23]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{us as default};
