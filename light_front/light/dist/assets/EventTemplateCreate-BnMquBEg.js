import{a as B,r as v,B as F,o as z,c as i,d as o,n as I,b as m,f as _,C,t as f,w as b,p as g,v as k,i as T,u as L,h as y,j as w,k as N,l as d}from"./index-_TMNgkFu.js";import{s as U}from"./custom-multiselect-M3BzxD5H.js";import"./EditorComponent-BJSxZEvv.js";const M={key:0},P={class:"form-page"},q={class:"form-field"},J={class:"form-field"},G={key:0,class:"error"},H={class:"form-field"},K={class:"form-field"},Q={key:0,class:"error"},W={key:0,class:"form-field"},X={key:0,class:"error"},Y={key:1,class:"form-field"},Z={key:0,class:"error"},ee={class:"form-field"},ae={key:0,class:"error"},oe={class:"form-field"},le={key:1,class:"loading"},ie={__name:"EventTemplateCreate",setup(se){N();const u=L(),a=B({format:"",categories:[],name:"",link:"",location:"",admins:[],desc:""}),$=v(!1),S=[{label:"Очное мероприятие",value:"face_to_face"},{label:"Вебинар",value:"webinar"},{label:"Смешанный формат",value:"mixed"}],x=v([]),j=async()=>{let l=localStorage.getItem("access_token");const e=T(l);if(l&&!e){u.push({name:"Login"});return}try{const t=await y.get(`${w}/categories/`,{headers:{Authorization:`Bearer ${l}`}});x.value=t.data.results||[],console.log("Категории загружены:",x.value)}catch(t){console.error("Ошибка при загрузке категорий:",t.response?t.response.data:t.message)}},V=v([]),D=async()=>{let l=localStorage.getItem("access_token");const e=T(l);if(l&&!e){u.push({name:"Login"});return}try{const t=await y.get(`${w}/accounts/`,{headers:{Authorization:`Bearer ${l}`}});V.value=t.data.results||[],console.log("Аккаунты загружены:",V.value)}catch(t){console.error("Ошибка при загрузке сотрудников:",t.response?t.response.data:t.message)}},h=v(null),O=l=>{const e=l.target.files[0];e&&(h.value=e)},R=()=>{u.push({name:"EventTemplateList"})};F(()=>a.format,l=>{l.value!="face_to_face"&&l.value!="mixed"&&(a.location=null),l.value!="webinar"&&l.value!="mixed"&&(a.link=null)});const s=B({}),A=()=>(s.format=a.format.value?"":"Формат обязателен!",a.format.value=="face_to_face"&&(s.location=a.location?"":"Локация обязательна!"),a.format.value=="webinar"&&(s.link=a.link?"":"Ссылка обязательна!"),a.format.value=="mixed"&&(s.link=a.link?"":"Ссылка обязательна!",s.location=a.location?"":"Локация обязательна!"),s.name=a.name?"":"Название обязательно!",s.admins=a.admins&&a.admins.length>0?"":"Ведущие обязательны!",Object.values(s).every(l=>!l)),E=async()=>{if(!A()){console.error("Форма содержит ошибки:",s);return}try{console.log("Отправляем данные для создания объекта:",a);const l={format:a.format.value,categories:a.categories.map(n=>n.id),name:a.name,link:a.link,location:a.location,admins:a.admins.map(n=>n.id),desc:a.desc};console.log("JSON данные перед отправкой:",l);let e=localStorage.getItem("access_token");const t=T(e);if(e&&!t){u.push({name:"Login"});return}const c=await y.post(`${w}/event_templates/`,l,{headers:{Authorization:`Bearer ${e}`}});if(console.log("Объект создан:",c.data),h.value){const n=new FormData;n.append("avatar",h.value);const p=`${w}/event_templates/${c.data.id}/`,r=await y.patch(p,n,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/form-data"}});console.log("Аватар успешно обновлен:",r.data)}localStorage.removeItem("userPermissions"),u.push({name:"EventTemplateDetail",params:{id:c.data.id}})}catch(l){l.response&&l.response.data?(Object.assign(s,l.response.data),console.error("Ошибка при создании объекта:",l.response.data)):console.error("Ошибка при создании объекта:",l.message)}};return z(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await j(),await D(),$.value=!0}catch(l){console.error("Ошибка при загрузке данных:",l)}}),(l,e)=>{var t,c,n,p;return $.value?(d(),i("div",M,[o("div",P,[e[20]||(e[20]=o("div",{class:"form-header"},[o("h1",null,"Создание мероприятия")],-1)),o("form",{onSubmit:I(E,["prevent"]),class:"form",id:"form"},[o("div",q,[e[7]||(e[7]=o("label",{for:"avatar",class:"form-label"},"Аватар:",-1)),o("input",{type:"file",id:"avatar",onChange:O,class:"form-input"},null,32)]),o("div",J,[e[8]||(e[8]=o("label",{class:"form-label"},"Формат:",-1)),_(C(U),{modelValue:a.format,"onUpdate:modelValue":e[0]||(e[0]=r=>a.format=r),options:S,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите формат",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),s.format?(d(),i("span",G,f(s.format),1)):m("",!0)]),o("div",H,[e[11]||(e[11]=o("label",{class:"form-label"},"Категории:",-1)),_(C(U),{modelValue:a.categories,"onUpdate:modelValue":e[1]||(e[1]=r=>a.categories=r),options:x.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:b(()=>[...e[9]||(e[9]=[o("span",null,"Список пуст",-1)])]),noResult:b(()=>[...e[10]||(e[10]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),o("div",K,[e[12]||(e[12]=o("label",{for:"name",class:"form-label"},"Название:",-1)),g(o("input",{"onUpdate:modelValue":e[2]||(e[2]=r=>a.name=r),id:"name",type:"text",class:"form-input",placeholder:"Введите название",required:""},null,512),[[k,a.name]]),s.name?(d(),i("span",Q,f(s.name),1)):m("",!0)]),((t=a.format)==null?void 0:t.value)=="face_to_face"||((c=a.format)==null?void 0:c.value)=="mixed"?(d(),i("div",W,[e[13]||(e[13]=o("label",{for:"location",class:"form-label"},"Локация:",-1)),g(o("textarea",{"onUpdate:modelValue":e[3]||(e[3]=r=>a.location=r),id:"location",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[k,a.location]]),s.location?(d(),i("span",X,f(s.location),1)):m("",!0)])):m("",!0),((n=a.format)==null?void 0:n.value)=="webinar"||((p=a.format)==null?void 0:p.value)=="mixed"?(d(),i("div",Y,[e[14]||(e[14]=o("label",{for:"link",class:"form-label"},"Ссылка:",-1)),g(o("textarea",{"onUpdate:modelValue":e[4]||(e[4]=r=>a.link=r),id:"link",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[k,a.link]]),s.link?(d(),i("span",Z,f(s.link),1)):m("",!0)])):m("",!0),o("div",ee,[e[17]||(e[17]=o("label",{class:"form-label"},"Ведущие:",-1)),_(C(U),{modelValue:a.admins,"onUpdate:modelValue":e[5]||(e[5]=r=>a.admins=r),options:V.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите админов",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:b(()=>[...e[15]||(e[15]=[o("span",null,"Список пуст",-1)])]),noResult:b(()=>[...e[16]||(e[16]=[o("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),s.admins?(d(),i("span",ae,f(s.admins),1)):m("",!0)]),o("div",oe,[e[18]||(e[18]=o("label",{for:"desc",class:"form-label"},"Описание:",-1)),g(o("textarea",{"onUpdate:modelValue":e[6]||(e[6]=r=>a.desc=r),id:"desc",class:"form-input",rows:"3",placeholder:"Введите описание"},null,512),[[k,a.desc]])])],32),o("div",{class:"form-menu button-group"},[e[19]||(e[19]=o("button",{type:"submit",class:"button",form:"form"},"Сохранить",-1)),o("button",{type:"button",onClick:R,class:"button"},"Отмена")])])])):(d(),i("div",le,[...e[21]||(e[21]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{ie as default};
