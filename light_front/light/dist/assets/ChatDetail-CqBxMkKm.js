import{k as K,u as X,r as v,a as U,B as E,C as q,o as Y,R as le,c as l,l as n,b,d as s,p as ie,v as ce,F as Z,G as ee,I as se,t as _,e as te,D as z,H as T,f as N,n as re,i as V,m as $,w as de,h as I,j as L,g as ue,q as me}from"./index-CadGroRP.js";import{E as Q}from"./EditorComponent-Cj7qhH0h.js";import{_ as be,a as _e}from"./AccountsGroupObjectPermissions-J55HqjLf.js";const ge={key:0,class:"chat"},ve={key:0,class:"tab-search-field"},he={key:0,class:"messages-list"},pe={class:"message-top"},ke={class:"message-title"},fe={class:"message-detail"},ye=["innerHTML"],je={class:"chat-menu-outer"},Ce={class:"chat-menu-inner"},Pe=["onClick"],$e=["onClick"],we=["onClick"],Oe=["onClick"],Se={key:4,class:"modal-overlay"},De={class:"modal"},Me={class:"modal-header"},Ae={class:"modal-header-h2"},Ve={class:"minibutton-group modal-menu"},Ie={class:"tab-pagination"},Le=["disabled"],Ee=["disabled"],Ne={key:1},Te={class:"form-field form-field-full_width"},Be={key:0,class:"error"},Ge={key:1,class:"loading"},A=10,xe={__name:"ChatMessages",props:{chat_id:Number},setup(R){K();const f=X(),C=v(!1),D=R;console.log("Chat ID:",D.chat_id);const e=v(null),g=v([]),w=a=>{var t;return((t=a.sender)==null?void 0:t.id)===e.value?"message-sent":"message-received"},j=U({newMessage:""}),k=v(null);let u=null;const B=()=>{if(u&&u.readyState!==WebSocket.CLOSED)return;const a=D.chat_id;let t=localStorage.getItem("access_token");const m=V(t);t&&!m?f.push({name:"Login"}):(e.value=m.user_id,console.log("ID пользователя:",e.value));const p=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws/chat_rooms/${a}/?token=${t}`;u=new WebSocket(p),u.onopen=()=>{console.log("WebSocket подключен"),W()},u.onmessage=i=>{G(i)},u.onerror=i=>{console.error("WebSocket ошибка:",i),alert("Ошибка при подключении к чату. Пожалуйста, попробуйте позже.")},u.onclose=()=>{console.log("WebSocket отключен")}},G=a=>{try{const t=JSON.parse(a.data);if(t.action==="message_edited"){const m=g.value.find(p=>p.id===t.message_id);m&&(m.content=t.new_content,m.changed=t.changed)}if(t.action==="message_deleted"){g.value=g.value.filter(p=>p.id!==t.message_id);const m=Math.ceil(g.value.length/A);y.value=m>0?m:1}if(t.old_messages){console.log("Загруженные старые сообщения:",t.old_messages),g.value=t.old_messages;const m=Math.ceil(g.value.length/A);y.value=m>0?m:1}t.message&&g.value.push({sender:t.sender,content:t.message,changed:t.changed})}catch(t){console.error("Ошибка при обработке сообщения WebSocket:",t)}},P=U({}),x=()=>(P.newMessage=j.newMessage.trim()?"":"Содержание обязательно!",Object.values(P).every(a=>!a)),W=()=>{u&&u.readyState===WebSocket.OPEN&&u.send(JSON.stringify({action:"load_old_messages"}))},h=()=>{if(!x()){console.error("Форма содержит ошибки:",P);return}if(!u||u.readyState!==WebSocket.OPEN){alert("Соединение с чатом потеряно. Пожалуйста, перезагрузите страницу.");return}const a={action:"send_message",message:j.newMessage};console.log("Отправляемое сообщение:",a),u.send(JSON.stringify(a)),k.value.clearContent()},c=a=>{a.isEditing=!0,a.editedContent=a.content},o=a=>{a.editedContent.trim()&&(u.send(JSON.stringify({action:"edit_message",message_id:a.id,new_content:a.editedContent})),a.isEditing=!1)},d=v(!1),r=v(null),M=a=>{r.value=a,d.value=!0},F=()=>{d.value=!1},oe=async a=>{u.send(JSON.stringify({action:"delete_message",message_id:a})),F()},ae=a=>{k.value&&(console.log("Ответ на сообщение:",a),k.value.editor.chain().focus().toggleBlockquote().run(),k.value.insertContent(`${a.sender.str} - ${T(a.changed)}`),k.value.insertContent(a.content),k.value.editor.chain().focus().splitBlock().run(),k.value.editor.chain().focus().setParagraph().run())},O=v(""),y=v(1),J=E(()=>O.value?g.value.filter(a=>{var t,m,p;return((m=(t=a.sender)==null?void 0:t.str)==null?void 0:m.toLowerCase().includes(O.value.toLowerCase()))||((p=a.content)==null?void 0:p.toLowerCase().includes(O.value.toLowerCase()))}):g.value),H=E(()=>Math.ceil(J.value.length/A)),ne=E(()=>{const a=(y.value-1)*A,t=a+A;return J.value.slice(a,t)});return q(O,()=>{y.value=1}),Y(async()=>{console.log("Компонент для чата смонтирован, начинаем подключение к WebSocket..."),await B(),C.value=!0}),le(()=>{u&&u.close()}),(a,t)=>{var m,p;return C.value?(n(),l("div",ge,[((m=g.value)==null?void 0:m.length)>0?(n(),l("div",ve,[ie(s("input",{"onUpdate:modelValue":t[0]||(t[0]=i=>O.value=i),type:"text",placeholder:"Поиск",class:"tab-search-input"},null,512),[[ce,O.value]])])):b("",!0),s("div",null,[((p=J.value)==null?void 0:p.length)>0?(n(),l("div",he,[(n(!0),l(Z,null,ee(ne.value,i=>(n(),l("div",{key:i.id,class:se(["message",w(i)])},[s("div",pe,[s("div",ke,[s("h2",null,_(i.sender.str?i.sender.str:"Без отправителя"),1)])]),s("div",fe,[i.isEditing?(n(),te(Q,{key:0,modelValue:i.editedContent,"onUpdate:modelValue":S=>i.editedContent=S},null,8,["modelValue","onUpdate:modelValue"])):(n(),l("div",{key:1,innerHTML:i.content,class:"tiptap"},null,8,ye)),s("div",null,[s("p",null,_(i.changed?z(T)(i.changed):"Без даты и времени"),1)])]),s("div",je,[s("div",Ce,[i.isEditing?b("",!0):(n(),l("button",{key:0,class:"table-tab-button",onClick:S=>ae(i)},"Ответить",8,Pe)),!i.isEditing&&e.value&&i.sender.id==e.value?(n(),l("button",{key:1,class:"table-tab-button",onClick:S=>c(i)},"Редактировать",8,$e)):b("",!0),i.isEditing?(n(),l("button",{key:2,class:"table-tab-button",onClick:S=>o(i)},"Сохранить",8,we)):b("",!0),e.value&&i.sender.id==e.value?(n(),l("button",{key:3,onClick:S=>M(i),class:"table-tab-button"}," Удалить",8,Oe)):b("",!0),d.value?(n(),l("div",Se,[s("div",De,[s("div",Me,[s("h2",Ae,"Удаление "+_(r.value.sender.str||"Безымянный исполнитель очереди"),1)]),s("div",Ve,[s("button",{onClick:t[1]||(t[1]=S=>oe(r.value.id)),class:"minibutton"},"Подтвердить"),s("button",{onClick:F,class:"minibutton"},"Отменить")])])])):b("",!0)])])],2))),128)),s("div",Ie,[s("button",{disabled:y.value===1,onClick:t[2]||(t[2]=i=>y.value--),class:"tab-settings-button"}," Назад ",8,Le),s("span",null,"Страница "+_(y.value)+" из "+_(H.value),1),s("button",{disabled:y.value===H.value,onClick:t[3]||(t[3]=i=>y.value++),class:"tab-settings-button"}," Вперед ",8,Ee)])])):(n(),l("div",Ne,[...t[5]||(t[5]=[s("div",{class:"none-border"},"Нет сообщений",-1)])]))]),s("form",{onSubmit:re(h,["prevent"]),class:"form",id:"form"},[s("div",Te,[t[6]||(t[6]=s("label",{for:"desc",class:"form-label"},"Сообщение:",-1)),N(Q,{ref_key:"editorRef",ref:k,modelValue:j.newMessage,"onUpdate:modelValue":t[4]||(t[4]=i=>j.newMessage=i)},null,8,["modelValue"]),P.newMessage?(n(),l("span",Be,_(P.newMessage),1)):b("",!0)])],32),t[7]||(t[7]=s("div",{class:"tab-menu minibutton-group"},[s("button",{type:"submit",class:"minibutton",form:"form"},"Отправить")],-1))])):(n(),l("div",Ge,[...t[8]||(t[8]=[s("div",null,"Загрузка данных...",-1)])]))}}},We={key:0},Je={key:0,class:"detail-page"},Ue={key:0},qe={class:"detail-card"},ze={class:"detail-card-info"},Re={class:"detail-header"},Fe={class:"detail-header-title"},He={class:"detail-card-text"},Qe={class:"detail-card-text-elem"},Ke={class:"detail-menu button-group"},Xe={key:0,class:"modal-overlay"},Ye={class:"modal"},Ze={class:"modal-header"},es={class:"modal-header-h2"},ss={class:"minibutton-group modal-menu"},ts={class:"detail-tabs"},os={class:"tabs-header"},as=["onClick"],ns={key:0,class:"tabs-content"},ls={key:0,class:"desc-tab"},is={key:0},cs={key:1},rs={key:1,class:"detail-tab"},ds={class:"detail-tab-elem"},us={class:"detail-tab-elem"},ms={class:"detail-tab-elem"},bs={class:"detail-tab-elem"},_s={class:"detail-tab-elem"},gs={key:2,class:"chat-tab"},vs={key:3,class:"table-tab"},hs={key:4,class:"table-tab"},ps={key:1,class:"none-container"},ks={key:1,class:"loading"},fs={key:1,class:"loading"},Ps={__name:"ChatDetail",setup(R){const f=K(),C=X(),D=v(!1),e=U({object:null,globalPermissionsList:[],objectPermissionsDict:{},canAddChat:!1,canViewChat:!1,canEditChat:!1,canDeleteChat:!1,canDeleteMessageGlobal:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),g=v(null),w=async()=>{const c=f.params.id;let o=localStorage.getItem("access_token");const d=V(o);o&&!d&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{const r=await I.get(`${L}/chats/${c}/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Данные чата:",r.data),e.object=r.data,g.value=e.object.id,console.log("ID чата:",g.value)}catch(r){console.error("Ошибка при получении данных чата:",r)}},j=v(!1),k=()=>{j.value=!0},u=()=>{j.value=!1},B=async()=>{let c=localStorage.getItem("access_token");const o=V(c);if(c&&!o){C.push({name:"Login"});return}const d=f.params.id;try{await I.delete(`${L}/chats/${d}/`,{headers:{Authorization:`Bearer ${c}`}}),u(),C.push({name:"ChatList"})}catch(r){console.error("Ошибка удаления задачи:",r)}},G=async()=>{console.log("Проверяем версию прав");const c=JSON.parse(localStorage.getItem("userPermissions"));if(!(c!=null&&c.permissions_version))return;console.log("Текущая версия прав:",c.permissions_version);let o=localStorage.getItem("access_token");const d=V(o);if(!(!o||!d))try{(await I.get(`${L}/user_permissions_version/${c.permissions_version}/`,{headers:{Authorization:`Bearer ${o}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(r){console.error("Ошибка проверки версии прав:",r),localStorage.removeItem("userPermissions")}},P=async()=>{let c=localStorage.getItem("access_token");const o=V(c);c&&!o&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),c=null);try{let d=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",d),Object.keys(d).length>0&&(console.log("ID пользователя в разрешениях из памяти:",d.user_id),!o&&d.user_id!==1||o&&o.user_id!==d.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),d={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(d).length===0){const M=await I.get(`${L}/user_permissions/`,{headers:{...c&&{Authorization:`Bearer ${c}`}}});console.log("Разрешения пользователя загружены:",M.data),d=M.data,localStorage.setItem("userPermissions",JSON.stringify(d))}e.globalPermissionsList=d.global_permissions||[],e.objectPermissionsDict=d.object_permissions||{};const r=f.params.id;console.log("ID объекта:",r),e.canAddChat=e.globalPermissionsList.includes("chats.add_chat"),console.log("Права на добавление чат:",e.canAddChat),e.canViewChat=e.globalPermissionsList.includes("chats.view_chat")||e.objectPermissionsDict["chats.view_chat"]&&e.objectPermissionsDict["chats.view_chat"].includes(Number(r)),console.log("Права на просмотр чата:",e.canViewChat),e.canEditChat=e.globalPermissionsList.includes("chats.change_chat")||Array.isArray(e.objectPermissionsDict["chats.change_chat"])&&e.objectPermissionsDict["chats.change_chat"].includes(Number(r)),console.log("Права на редактирование чата:",e.canEditChat),e.canDeleteChat=e.globalPermissionsList.includes("chats.delete_chat")||Array.isArray(e.objectPermissionsDict["chats.delete_chat"])&&e.objectPermissionsDict["chats.delete_chat"].includes(Number(r)),console.log("Права на удаление чата:",e.canDeleteChat),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(d){console.error("Ошибка при загрузке разрешений пользователя:",d)}},x=()=>{me(C)},W=E(()=>[{name:"desc",label:"Описание"},{name:"messages",label:"Содержание"},{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),h=v(f.query.tab||localStorage.getItem(`activeChatTab-${f.params.id}`)||"desc");return q(h,c=>{localStorage.setItem(`activeChatTab-${f.params.id}`,c),C.push({query:{tab:c}}),console.log("Загружен таб:",c)}),Y(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await w(),await G(),await P(),D.value=!0}catch(c){console.error("Ошибка при загрузке данных:",c)}}),q(()=>f.params.id,async c=>{console.log("Параметр id изменился на:",c),await w()}),(c,o)=>{const d=ue("router-link");return D.value?(n(),l("div",We,[e.canViewChat?(n(),l("div",Je,[e.object.id?(n(),l("div",Ue,[s("div",qe,[s("div",ze,[s("div",Re,[s("div",Fe,[s("h1",null,_(e.object.name||"Безымянный чат"),1)])]),s("div",He,[s("div",Qe,[o[1]||(o[1]=s("span",{class:"detail-card-text-label"},"Категории:",-1)),$(" "+_(e.object.categories.length>0?e.object.categories.map(r=>r.name).join(", "):"Нет категорий"),1)])]),s("div",Ke,[e.canEditChat?(n(),te(d,{key:0,to:{name:"ChatEdit",params:{id:e.object.id}},class:"button"},{default:de(()=>[...o[2]||(o[2]=[$(" Изменить ",-1)])]),_:1},8,["to"])):b("",!0),e.canDeleteChat?(n(),l("button",{key:1,onClick:k,class:"button"}," Удалить ")):b("",!0),s("button",{type:"button",onClick:x,class:"button"},"Назад")]),j.value?(n(),l("div",Xe,[s("div",Ye,[s("div",Ze,[s("h2",es,"Удаление "+_(e.object.name||"Безымянный чат"),1)]),s("div",ss,[s("button",{onClick:o[0]||(o[0]=r=>B()),class:"minibutton"},"Подтвердить"),s("button",{onClick:u,class:"minibutton"},"Отменить")])])])):b("",!0)])]),s("div",ts,[s("div",os,[(n(!0),l(Z,null,ee(W.value,r=>(n(),l("button",{key:r.name,class:se([{active:h.value===r.name},"tab-button"]),onClick:M=>h.value=r.name},_(r.label),11,as))),128))]),h.value?(n(),l("div",ns,[h.value==="desc"?(n(),l("div",ls,[e.object.desc?(n(),l("div",is,_(e.object.desc),1)):(n(),l("div",cs,[...o[3]||(o[3]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):b("",!0),h.value==="details"?(n(),l("div",rs,[s("div",ds,[o[4]||(o[4]=s("span",{class:"detail-tab-label"},"Категории:",-1)),$(" "+_(e.object.categories.length>0?e.object.categories.map(r=>r.name).join(", "):"Нет категорий"),1)]),s("div",us,[o[5]||(o[5]=s("span",{class:"detail-tab-label"},"Создан:",-1)),$(" "+_(e.object.created?z(T)(e.object.created):"Нет данных о создании"),1)]),s("div",ms,[o[6]||(o[6]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),$(" "+_(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",bs,[o[7]||(o[7]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),$(" "+_(e.object.changed?z(T)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",_s,[o[8]||(o[8]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),$(" "+_(e.object.editor?e.object.editor:"Нет редактора"),1)])])):b("",!0),h.value==="messages"?(n(),l("div",gs,[N(xe,{chat_id:g.value},null,8,["chat_id"])])):b("",!0),h.value==="accountsGroupObjectPermissions"?(n(),l("div",vs,[N(be,{state:e,fetchObject:w,contentTypeModel:"chat"},null,8,["state"])])):b("",!0),h.value==="accountObjectPermissions"?(n(),l("div",hs,[N(_e,{state:e,fetchObject:w,contentTypeModel:"chat"},null,8,["state"])])):b("",!0)])):b("",!0)])])):e.object.id?b("",!0):(n(),l("div",ps,[...o[9]||(o[9]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(n(),l("div",ks,[...o[10]||(o[10]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),l("div",fs,[...o[11]||(o[11]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Ps as default};
