import{r as A,a as R,A as U,k as M,B as J,o as q,c,b as r,d as t,t as d,m as u,e as C,w as O,F,E as H,C as V,G as L,f as D,i as f,h as y,j as h,g as K,u as Q,l as a,H as W}from"./index-BX9avzZ8.js";import{_ as X,a as Y}from"./AccountsGroupObjectPermissions-B8CJ2U9q.js";import{_ as Z}from"./TopicMessages-DavIC_7n.js";import"./EditorComponent-CwwB65pP.js";const ee={key:0},se={key:0,class:"detail-page"},te={key:0},oe={class:"detail-card"},ae={class:"detail-card-image-outer"},ne={key:0,class:"detail-card-image-inner"},ce=["src"],ie={key:1,class:"detail-card-image-none"},le={class:"detail-card-info"},re={class:"detail-header"},de={class:"detail-header-title"},ue={class:"detail-card-text"},me={class:"detail-card-text-elem"},be={class:"detail-card-text-elem"},_e={class:"detail-card-text-elem"},ge={class:"detail-menu button-group"},pe={key:0,class:"modal-overlay"},je={class:"modal"},ve={class:"modal-header"},ke={class:"modal-header-h2"},fe={class:"minibutton-group modal-menu"},ye={class:"detail-tabs"},he={class:"tabs-header"},Pe=["onClick"],we={key:0,class:"tabs-content"},Ae={key:0,class:"desc-tab"},Ce={key:0},Oe={key:1},De={key:1,class:"detail-tab"},Se={class:"detail-tab-elem"},$e={class:"detail-tab-elem"},Ve={class:"detail-tab-elem"},Le={class:"detail-tab-elem"},Ie={class:"detail-tab-elem"},Te={class:"detail-tab-elem"},xe={class:"detail-tab-elem"},Be={key:2,class:"topic-tab"},Ge={key:3,class:"table-tab"},Ne={key:4,class:"table-tab"},Ee={key:1,class:"none-container"},ze={key:1,class:"loading"},Re={key:1,class:"loading"},Ke={__name:"CourseDetail",setup(Ue){const k=M(),v=Q(),S=A(!1),e=R({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewCourse:!1,canSelfAssignment:!1,canEditCourse:!1,canDeleteCourse:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),I=async()=>{var n,j;const o=(n=e.object)==null?void 0:n.id,s=((j=e.object)==null?void 0:j.name)||"downloaded_course";if(!o){console.warn("ID курса не найден.");return}const l=localStorage.getItem("access_token");if(!l||!f(l)){console.warn("Токен невалиден, переход на логин"),v.push({name:"Login"});return}try{const b=`${h}/download_scorm/${o}/`;console.log(`Скачивание с URL: ${b}`);const i=await y.get(b,{responseType:"blob",headers:{Authorization:`Bearer ${l}`}});if(i.status===200){const p=new Blob([i.data],{type:i.headers["content-type"]}),m=document.createElement("a");m.href=window.URL.createObjectURL(p),m.setAttribute("download",s),document.body.appendChild(m),m.click(),m.remove(),window.URL.revokeObjectURL(m.href),console.log("Файл успешно скачан")}else console.error(`Ошибка при скачивании файла. Код: ${i.status}`)}catch(b){console.error("Ошибка при скачивании файла:",b)}},P=async()=>{const o=k.params.id;let s=localStorage.getItem("access_token");const l=f(s);s&&!l&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const n=await y.get(`${h}/courses/${o}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные курса:",n.data),e.object=n.data}catch(n){console.error("Ошибка при получении данных курса:",n)}},w=A(!1),T=()=>{w.value=!0},$=()=>{w.value=!1},x=async()=>{let o=localStorage.getItem("access_token");const s=f(o);if(o&&!s){v.push({name:"Login"});return}const l=k.params.id;try{await y.delete(`${h}/courses/${l}/`,{headers:{Authorization:`Bearer ${o}`}}),$(),v.push({name:"CourseList"})}catch(n){console.error("Ошибка удаления курса:",n)}},B=async o=>{let s=localStorage.getItem("access_token");const l=f(s);if(s&&!l){v.push({name:"Login"});return}try{const n=await y.post(`${h}/self_assignment/${o}/`,{},{headers:{Authorization:`Bearer ${s}`}});console.log("Самоназначение:",n.data),v.push({name:"TaskDetail",params:{id:n.data.id}})}catch(n){console.error("Ошибка самоназначения:",n)}},G=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let s=localStorage.getItem("access_token");const l=f(s);if(!(!s||!l))try{(await y.get(`${h}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(n){console.error("Ошибка проверки версии прав:",n),localStorage.removeItem("userPermissions")}},N=async()=>{var l,n,j,b;let o=localStorage.getItem("access_token");const s=f(o);o&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null);try{let i=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",i),Object.keys(i).length>0&&(console.log("ID пользователя в разрешениях из памяти:",i.user_id),!s&&i.user_id!==1||s&&s.user_id!==i.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),i={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(i).length===0){const m=await y.get(`${h}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",m.data),i=m.data,localStorage.setItem("userPermissions",JSON.stringify(i))}e.globalPermissionsList=i.global_permissions||[],e.objectPermissionsDict=i.object_permissions||{};const p=k.params.id;console.log("ID объекта:",p),e.canViewCourse=e.globalPermissionsList.includes("courses.view_course")||e.objectPermissionsDict["courses.view_course"]&&e.objectPermissionsDict["courses.view_course"].includes(Number(p)),console.log("Права на просмотр курсов:",e.canViewCourse),e.canSelfAssignment=e.canViewCourse&&e.object.self_assignment_task_template&&e.object.self_assignment_task_template&&(!e.object.last_task||((n=(l=e.object.last_task)==null?void 0:l.result)==null?void 0:n.status)=="failed"||((b=(j=e.object.last_task)==null?void 0:j.result)==null?void 0:b.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditCourse=e.globalPermissionsList.includes("courses.change_course")||Array.isArray(e.objectPermissionsDict["courses.change_course"])&&e.objectPermissionsDict["courses.change_course"].includes(Number(p)),console.log("Права на редактирование курсов:",e.canEditCourse),e.canDeleteCourse=e.globalPermissionsList.includes("courses.delete_course")||Array.isArray(e.objectPermissionsDict["courses.delete_course"])&&e.objectPermissionsDict["courses.delete_course"].includes(Number(p)),console.log("Права на удаление курсов:",e.canDeleteCourse),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(i){console.error("Ошибка при загрузке разрешений пользователя:",i)}},E=()=>{v.back()},z=U(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),g=A(k.query.tab||localStorage.getItem(`activeCourseTab-${k.params.id}`)||"details");return J(g,o=>{localStorage.setItem(`activeCourseTab-${k.params.id}`,o),v.push({query:{tab:o}}),console.log("Загружен таб:",o)}),q(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await P(),await G(),await N(),S.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,s)=>{var n,j,b,i,p,m;const l=K("router-link");return S.value?(a(),c("div",ee,[e.canViewCourse?(a(),c("div",se,[e.object.id?(a(),c("div",te,[t("div",oe,[t("div",ae,[e.object.avatar?(a(),c("div",ne,[t("img",{src:e.object.avatar||"/default-avatar.png",alt:"Аватар"},null,8,ce)])):(a(),c("div",ie,[...s[2]||(s[2]=[t("span",{class:"none-text"},"Нет аватара",-1)])]))]),t("div",le,[t("div",re,[t("div",de,[t("h1",null,d(e.object.name||"Безымянный курс"),1)])]),t("div",ue,[t("div",me,[s[3]||(s[3]=t("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),u(" "+d((n=e.object.last_task)!=null&&n.result?(j=e.object.last_task)==null?void 0:j.result.status_display:"Не назначено"),1)]),t("div",be,[s[4]||(s[4]=t("span",{class:"detail-card-text-label"},"Тип курса:",-1)),u(" "+d(e.object.constructor_type_display||"Нет типа курса"),1)]),t("div",_e,[s[5]||(s[5]=t("span",{class:"detail-card-text-label"},"Категории:",-1)),u(" "+d(e.object.categories.length>0?e.object.categories.map(_=>_.name).join(", "):"Нет категорий"),1)])]),t("div",ge,[e.object.last_task?(a(),C(l,{key:0,to:{name:"ScormContent",params:{id:e.object.last_task.id}},target:"_blank",rel:"noopener noreferrer",class:"button"},{default:O(()=>[...s[6]||(s[6]=[u(" Пройти ",-1)])]),_:1},8,["to"])):r("",!0),e.object.last_task?(a(),C(l,{key:1,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:O(()=>[...s[7]||(s[7]=[u(" Задача ",-1)])]),_:1},8,["to"])):r("",!0),e.canSelfAssignment?(a(),c("button",{key:2,onClick:s[0]||(s[0]=_=>B(e.object.self_assignment_task_template)),class:"button"}," Самоназначение ")):r("",!0),(b=e.object)!=null&&b.upload_file?(a(),c("button",{key:3,onClick:I,class:"button"}," Скачать ")):r("",!0),e.canEditCourse?(a(),C(l,{key:4,to:{name:"CourseEdit",params:{id:e.object.id}},class:"button"},{default:O(()=>[...s[8]||(s[8]=[u(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canDeleteCourse?(a(),c("button",{key:5,onClick:T,class:"button"}," Удалить ")):r("",!0),t("button",{type:"button",onClick:E,class:"button"},"Назад")]),w.value?(a(),c("div",pe,[t("div",je,[t("div",ve,[t("h2",ke,"Удаление "+d(e.object.name||"Безымянный курс"),1)]),t("div",fe,[t("button",{onClick:s[1]||(s[1]=_=>x()),class:"minibutton"},"Подтвердить"),t("button",{onClick:$,class:"minibutton"},"Отменить")])])])):r("",!0)])]),t("div",ye,[t("div",he,[(a(!0),c(F,null,H(z.value,_=>(a(),c("button",{key:_.name,class:W([{active:g.value===_.name},"tab-button"]),onClick:Me=>g.value=_.name},d(_.label),11,Pe))),128))])]),g.value?(a(),c("div",we,[g.value==="desc"?(a(),c("div",Ae,[e.object.desc?(a(),c("div",Ce,d(e.object.desc),1)):(a(),c("div",Oe,[...s[9]||(s[9]=[t("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):r("",!0),g.value==="details"?(a(),c("div",De,[t("div",Se,[s[10]||(s[10]=t("span",{class:"detail-tab-label"},"Статус задачи:",-1)),u(" "+d((i=e.object.last_task)!=null&&i.result?(p=e.object.last_task)==null?void 0:p.result.status_display:"Не назначено"),1)]),t("div",$e,[s[11]||(s[11]=t("span",{class:"detail-tab-label"},"Тип курса:",-1)),u(" "+d(e.object.constructor_type_display||"Нет типа курса"),1)]),t("div",Ve,[s[12]||(s[12]=t("span",{class:"detail-tab-label"},"Категории:",-1)),u(" "+d(e.object.categories.length>0?e.object.categories.map(_=>_.name).join(", "):"Нет категорий"),1)]),t("div",Le,[s[13]||(s[13]=t("span",{class:"detail-tab-label"},"Создан:",-1)),u(" "+d(e.object.created?V(L)(e.object.created):"Нет данных о создании"),1)]),t("div",Ie,[s[14]||(s[14]=t("span",{class:"detail-tab-label"},"Создатель:",-1)),u(" "+d(e.object.creator?e.object.creator:"Нет создателя"),1)]),t("div",Te,[s[15]||(s[15]=t("span",{class:"detail-tab-label"},"Изменён:",-1)),u(" "+d(e.object.changed?V(L)(e.object.changed):"Нет данных об изменениях"),1)]),t("div",xe,[s[16]||(s[16]=t("span",{class:"detail-tab-label"},"Редактор:",-1)),u(" "+d(e.object.editor?e.object.editor:"Нет редактора"),1)])])):r("",!0),g.value==="messages"?(a(),c("div",Be,[D(Z,{topic_id:(m=e.object)==null?void 0:m.topic.id},null,8,["topic_id"])])):r("",!0),g.value==="accountsGroupObjectPermissions"?(a(),c("div",Ge,[D(X,{state:e,fetchObject:P,contentTypeModel:"course"},null,8,["state"])])):r("",!0),g.value==="accountObjectPermissions"?(a(),c("div",Ne,[D(Y,{state:e,fetchObject:P,contentTypeModel:"course"},null,8,["state"])])):r("",!0)])):r("",!0)])):e.object.id?r("",!0):(a(),c("div",Ee,[...s[17]||(s[17]=[t("div",{class:"none-card"},[t("div",null,"Объект не найден.")],-1)])]))])):(a(),c("div",ze,[...s[18]||(s[18]=[t("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(a(),c("div",Re,[...s[19]||(s[19]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{Ke as default};
