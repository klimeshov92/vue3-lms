import{r as h,a as L,A as E,B as se,o as oe,Q as ne,c as a,b as _,d as s,t as d,F as k,E as y,m as C,C as R,G as ae,k as ie,i as j,u as le,h as x,j as I,l as i,p as $,Y as ce,y as re,v as B,f as de,w as z}from"./index-Bpv6Iqa1.js";import{s as ue}from"./custom-multiselect-rCMWLb_h.js";const _e={key:0},ve={key:0,class:"detail-page"},pe={key:0},fe={class:"testing"},me={class:"testing-area"},be={key:0,class:"question-area"},ge={key:0,class:"question-image-outer"},he={class:"question-image-inner"},ke=["src"],ye={class:"question-text"},we={class:"question-manual"},qe={key:1,class:"feedback_for_correct"},je={key:2,class:"feedback_for_incorrect"},xe={key:3,class:"answers"},Ie={key:0,class:"answer-image-outer"},Pe={class:"answer-image-inner"},$e=["src"],Se={class:"answer-field"},Ae=["name","value","disabled"],Ve={key:1,class:"feedback_for_correct"},Te={key:2,class:"feedback_for_incorrect"},Ce={key:4,class:"answers"},Ue={key:0,class:"answer-image-outer"},Be={class:"answer-image-inner"},Oe=["src"],Qe={class:"answer-field"},De=["onUpdate:modelValue","disabled"],Me={key:1,class:"feedback_for_correct"},Ne={key:2,class:"feedback_for_incorrect"},Le={key:5,class:"answers"},Ee={key:0,class:"answer-image-outer"},Re={class:"answer-image-inner"},ze=["src"],Fe=["onUpdate:modelValue","disabled"],Je={key:1,class:"feedback_for_correct"},Ge={key:2,class:"feedback_for_incorrect"},Ye={key:6,class:"answers"},He={key:0,class:"answer-image-outer"},Ke={class:"answer-image-inner"},We=["src"],Xe={key:1,class:"feedback_for_correct"},Ze={key:2,class:"feedback_for_incorrect"},et={key:7,class:"answers"},tt={key:0,class:"answer-image-outer"},st={class:"answer-image-inner"},ot=["src"],nt=["onUpdate:modelValue","disabled"],at={key:1,class:"feedback_for_correct"},it={key:2,class:"feedback_for_incorrect"},lt={key:8,class:"answers"},ct={key:0,class:"answer-image-outer"},rt={class:"answer-image-inner"},dt=["src"],ut=["onUpdate:modelValue","disabled"],_t={key:1,class:"feedback_for_correct"},vt={key:2,class:"feedback_for_incorrect"},pt={class:"question-index"},ft={class:"question-menu"},mt=["disabled"],bt=["disabled"],gt={class:"test-info-area"},ht={class:"test-info-container"},kt={class:"test-header"},yt={class:"test-info-text"},wt={class:"test-info-text-elem"},qt={class:"test-info-text-elem"},jt={key:0,class:"test-info-text-elem countdown-timer"},xt={key:1,class:"test-info-text-elem countdown-timer"},It={key:0,class:"test-info-menu button-group"},Pt={class:"test-info-container test-info-container-gray-light"},$t={key:0,class:"test-info-table-outer"},St={class:"test-info-table-inner"},At={class:"test-info-table-menu"},Vt=["onClick"],Tt={key:1},Ct={class:"tab-pagination"},Ut=["disabled"],Bt=["disabled"],Ot={key:1,class:"none-container"},Qt={key:1,class:"loading"},Dt={key:1,class:"loading"},S=10,Et={__name:"TestAttempt",setup(Mt){const U=ie(),P=le(),O=h(!1),l=L({object:null,globalPermissionsList:[],objectPermissionsDict:{},canPerform:!1,canCompleted:!1}),b=h(1),F=async()=>{const o=U.params.id;let e=localStorage.getItem("access_token");const r=j(e);if(e&&!r){P.push({name:"Login"});return}try{const c=await x.get(`${I}/test_attempt_open/${o}/`,{headers:{...e&&{Authorization:`Bearer ${e}`}}});console.log("Данные открытой попытки:",c.data),l.object=c.data;const p=Math.ceil(l.object.question_results.length/S);b.value=p>0?p:1}catch(c){console.error("Ошибка при получении данных попытки:",c)}},J=async()=>{const o=U.params.id;let e=localStorage.getItem("access_token");const r=j(e);if(e&&!r){P.push({name:"Login"});return}try{const c=await x.post(`${I}/test_attempt_create/${o}/`,{},{headers:{...e&&{Authorization:`Bearer ${e}`}}});console.log("Данные созданной попытки:",c.data),l.object=c.data;const p=Math.ceil(l.object.question_results.length/S);b.value=p>0?p:1}catch(c){console.error("Ошибка при получении данных попытки:",c)}},Q=E(()=>Math.ceil(l.object.question_results.length/S)),G=E(()=>{const o=(b.value-1)*S,e=o+S;return l.object.question_results.slice(o,e)}),A=h(""),V=h("");let g=null;const D=async()=>{var e;if(!((e=l.object)!=null&&e.plan_end_time))return;g&&(clearInterval(g),g=null),A.value="",V.value="",console.log("Старт таймера");const o=new Date(l.object.plan_end_time).getTime();g=setInterval(()=>{const r=new Date().getTime(),c=o-r;if(c<=0){clearInterval(g),console.log("⏰ Время вышло!"),X();return}const p=String(Math.floor(c/(1e3*60))).padStart(2,"0"),u=String(Math.floor(c%(1e3*60)/1e3)).padStart(2,"0");A.value=`${p}`,V.value=`${u}`},1e3)},n=h(null),M=async()=>{const o=l.object.question_results||[];console.log("Результаты вопросов:",o);let e=o.find(r=>r.status!=="completed"&&r.status!=="failed");console.log("Первый незавершенный вопрос:",o),!e&&o.length&&(e=o[0],console.log("Первый вопрос по порядку:",o)),n.value=e||null,e&&(console.log("Выбран текущий вопрос:",e),N(e))},w=o=>{n.value=o,N(o),console.log("Выбран текущий вопрос:",n.value)},v=L({}),T=h([]),N=o=>{for(const e in v)delete v[e];if(o.question.question_type==="single_selection"){const e=o.answer_results.find(r=>r.selected_answer);v.selectedAnswerId=e?e.id:null}else if(o.question.question_type==="multiple_choice")o.answer_results.forEach(e=>{v[e.id]=e.selected_answer||!1});else if(o.question.question_type==="sorting")o.answer_results.forEach(e=>{v[e.id]=e.selected_position||0});else if(o.question.question_type==="text_input")o.answer_results.forEach(e=>{v[e.id]=e.selected_text_input||""});else if(o.question.question_type==="numeric_input")o.answer_results.forEach(e=>{v[e.id]=e.selected_numeric_input||0});else if(o.question.question_type==="compliance"){const e=o.question.answers.map(c=>c.relevant_point).filter(Boolean);console.log("Создан список всех соотвествующих пунктов:",e);const r=Array.from(new Map(e.map(c=>[c.id,c])).values());console.log("Создан список соотвествующих пунктов:",r),T.value=r,console.log("Получено значение соотвествующих пунктов:",T.value),o.answer_results.forEach(c=>{v[c.id]=T.value.find(p=>p.id===c.selected_relevant_point)||null})}console.log("Создана форма:",v)},q=h(0);se(n,()=>{if(!n.value)return;const o=l.object.question_results.findIndex(e=>e.id===n.value.id);o!==-1&&(q.value=o)});const Y=()=>{const o=q.value+1;o<l.object.question_results.length&&w(l.object.question_results[o]),console.log("Следующий вопрос:",l.object.question_results[o])},H=()=>{const o=q.value-1;o>=0&&w(l.object.question_results[o]),console.log("Предидущий вопрос:",l.object.question_results[o])},K=o=>{w(o),console.log("Выбранный вопрос:",o)},W=async()=>{if(n.value)try{const o=n.value.id;let e=localStorage.getItem("access_token");const r=j(e);if(e&&!r){P.push({name:"Login"});return}let c={};n.value.question.question_type==="single_selection"?c={answer_results:n.value.answer_results.map(u=>({id:u.id,selected_answer:v.selectedAnswerId==u.id}))}:n.value.question.question_type==="multiple_choice"?c={answer_results:n.value.answer_results.map(u=>({id:u.id,selected_answer:!!v[u.id]}))}:n.value.question.question_type==="sorting"?c={answer_results:n.value.answer_results.map(u=>({id:u.id,selected_position:v[u.id]}))}:n.value.question.question_type==="text_input"?c={answer_results:n.value.answer_results.map(u=>({id:u.id,selected_text_input:v[u.id]}))}:n.value.question.question_type==="numeric_input"?c={answer_results:n.value.answer_results.map(u=>({id:u.id,selected_numeric_input:v[u.id]}))}:n.value.question.question_type==="compliance"&&(c={answer_results:n.value.answer_results.map(u=>({id:u.id,selected_relevant_point:v[u.id].id}))}),console.log("JSON данные перед отправкой:",c);const p=await x.patch(`${I}/send_answers/${o}/`,c,{headers:{Authorization:`Bearer ${e}`}});if(console.log("Объект создан:",p.data),p.data.type==="question_result"){const u=p.data.data,t=l.object.question_results.findIndex(f=>f.id===u.id);t!==-1&&l.object.question_results.splice(t,1,u),n.value.id===u.id&&w(u)}else if(p.data.type==="test_attempt"){const u=p.data.data;Object.assign(l.object,u);const t=u.question_results.find(f=>f.id===n.value.id);w(t)}}catch(o){o.response&&o.response.data?(Object.assign(errors,o.response.data),console.error("Ошибка при сохранении изменений:",o.response.data)):console.error("Ошибка при сохранении изменений:",o.message)}},X=async()=>{if(l.object)try{const o=l.object.id;let e=localStorage.getItem("access_token");const r=j(e);if(e&&!r){P.push({name:"Login"});return}const c=await x.post(`${I}/test_finish/${o}/`,{},{headers:{Authorization:`Bearer ${e}`}});console.log("Тест завершен:",c.data);const p=c.data.data;Object.assign(l.object,p);const u=p.question_results.find(t=>t.id===n.value.id);w(u)}catch(o){o.response&&o.response.data?(Object.assign(errors,o.response.data),console.error("Ошибка при сохранении изменений:",o.response.data)):console.error("Ошибка при сохранении изменений:",o.message)}},Z=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let e=localStorage.getItem("access_token");const r=j(e);if(!(!e||!r))try{(await x.get(`${I}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(c){console.error("Ошибка проверки версии прав:",c),localStorage.removeItem("userPermissions")}},ee=async()=>{let o=localStorage.getItem("access_token");const e=j(o);if(o&&!e){P.push({name:"Login"});return}try{let r=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",r),Object.keys(r).length>0&&(console.log("ID пользователя в разрешениях из памяти:",r.user_id),!e&&r.user_id!==1||e&&e.user_id!==r.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),r={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(r).length===0){const p=await x.get(`${I}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",p.data),r=p.data,localStorage.setItem("userPermissions",JSON.stringify(r))}l.globalPermissionsList=r.global_permissions||[],l.objectPermissionsDict=r.object_permissions||{};const c=U.params.id;console.log("ID объекта:",c),l.canPerform=!0}catch(r){console.error("Ошибка при загрузке разрешений пользователя:",r)}},te=async()=>{await J(),await D(),await M()};return oe(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await F(),await M(),await D(),await Z(),await ee(),O.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),ne(()=>{g&&clearInterval(g)}),(o,e)=>{var r,c,p,u;return O.value?(i(),a("div",_e,[l.canPerform?(i(),a("div",ve,[l.object.id?(i(),a("div",pe,[s("div",fe,[s("div",me,[n.value?(i(),a("div",be,[(r=n.value.question)!=null&&r.picture?(i(),a("div",ge,[s("div",he,[s("img",{src:n.value.question.picture||"/default-avatar.png",alt:"Картинка"},null,8,ke)])])):_("",!0),s("div",ye,[s("h1",null,d(n.value.question.text),1)]),s("div",we,d(n.value.question.manual),1),((c=n.value)==null?void 0:c.status)=="completed"?(i(),a("div",qe,d(n.value.question.feedback_for_correct),1)):_("",!0),((p=n.value)==null?void 0:p.status)=="failed"?(i(),a("div",je,d(n.value.question.feedback_for_incorrect),1)):_("",!0),n.value.question.question_type==="single_selection"?(i(),a("div",xe,[(i(!0),a(k,null,y(n.value.answer_results,t=>{var f;return i(),a("div",{key:t.id,class:"answer"},[(f=t.answer)!=null&&f.picture?(i(),a("div",Ie,[s("div",Pe,[s("img",{src:t.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,$e)])])):_("",!0),s("label",Se,[$(s("input",{type:"radio",class:"answer-input",name:"single_"+n.value.id,value:t.id,"onUpdate:modelValue":e[0]||(e[0]=m=>v.selectedAnswerId=m),disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,Ae),[[ce,v.selectedAnswerId]]),s("span",null,d(t.answer.text),1)]),t.status=="completed"?(i(),a("div",Ve,d(t.answer.feedback_for_correct),1)):_("",!0),t.status=="failed"?(i(),a("div",Te,d(t.answer.feedback_for_incorrect),1)):_("",!0)])}),128))])):_("",!0),n.value.question.question_type==="multiple_choice"?(i(),a("div",Ce,[(i(!0),a(k,null,y(n.value.answer_results,t=>{var f;return i(),a("div",{key:t.id,class:"answer"},[(f=t.answer)!=null&&f.picture?(i(),a("div",Ue,[s("div",Be,[s("img",{src:t.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,Oe)])])):_("",!0),s("label",Qe,[$(s("input",{class:"answer-input",type:"checkbox","onUpdate:modelValue":m=>v[t.id]=m,disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,De),[[re,v[t.id]]]),s("span",null,d(t.answer.text),1)]),t.status=="completed"?(i(),a("div",Me,d(t.answer.feedback_for_correct),1)):_("",!0),t.status=="failed"?(i(),a("div",Ne,d(t.answer.feedback_for_incorrect),1)):_("",!0)])}),128))])):_("",!0),n.value.question.question_type==="sorting"?(i(),a("div",Le,[(i(!0),a(k,null,y(n.value.answer_results,t=>{var f;return i(),a("div",{key:t.id,class:"answer"},[(f=t.answer)!=null&&f.picture?(i(),a("div",Ee,[s("div",Re,[s("img",{src:t.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,ze)])])):_("",!0),s("div",null,d(t.answer.text),1),s("label",null,[$(s("input",{class:"answer-input",type:"number",placeholder:"Введите правильный порядок","onUpdate:modelValue":m=>v[t.id]=m,disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,Fe),[[B,v[t.id]]])]),t.status=="completed"?(i(),a("div",Je,d(t.answer.feedback_for_correct),1)):_("",!0),t.status=="failed"?(i(),a("div",Ge,d(t.answer.feedback_for_incorrect),1)):_("",!0)])}),128))])):_("",!0),n.value.question.question_type==="compliance"?(i(),a("div",Ye,[(i(!0),a(k,null,y(n.value.answer_results,t=>{var f;return i(),a("div",{key:t.id,class:"answer"},[(f=t.answer)!=null&&f.picture?(i(),a("div",He,[s("div",Ke,[s("img",{src:t.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,We)])])):_("",!0),s("label",null,d(t.answer.text),1),de(R(ue),{modelValue:v[t.id],"onUpdate:modelValue":m=>v[t.id]=m,options:T.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите план",label:"text","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:n.value.status=="completed"||n.value.status=="failed"},{noOptions:z(()=>[...e[4]||(e[4]=[s("span",null,"Список пуст",-1)])]),noResult:z(()=>[...e[5]||(e[5]=[s("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","onUpdate:modelValue","options","disabled"]),t.status=="completed"?(i(),a("div",Xe,d(t.answer.feedback_for_correct),1)):_("",!0),t.status=="failed"?(i(),a("div",Ze,d(t.answer.feedback_for_incorrect),1)):_("",!0)])}),128))])):_("",!0),n.value.question.question_type==="text_input"?(i(),a("div",et,[(i(!0),a(k,null,y(n.value.answer_results,t=>{var f;return i(),a("div",{key:t.id,class:"answer"},[(f=t.answer)!=null&&f.picture?(i(),a("div",tt,[s("div",st,[s("img",{src:t.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,ot)])])):_("",!0),s("div",null,d(t.answer.text),1),s("label",null,[$(s("input",{class:"answer-input",type:"text",placeholder:"Введите правильный ответ","onUpdate:modelValue":m=>v[t.id]=m,disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,nt),[[B,v[t.id]]])]),t.status=="completed"?(i(),a("div",at,d(t.answer.feedback_for_correct),1)):_("",!0),t.status=="failed"?(i(),a("div",it,d(t.answer.feedback_for_incorrect),1)):_("",!0)])}),128))])):_("",!0),n.value.question.question_type==="numeric_input"?(i(),a("div",lt,[(i(!0),a(k,null,y(n.value.answer_results,t=>{var f;return i(),a("div",{key:t.id,class:"answer"},[(f=t.answer)!=null&&f.picture?(i(),a("div",ct,[s("div",rt,[s("img",{src:t.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,dt)])])):_("",!0),s("div",null,d(t.answer.text),1),s("label",null,[$(s("input",{class:"answer-input",type:"number",placeholder:"Введите правильный ответ","onUpdate:modelValue":m=>v[t.id]=m,disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,ut),[[B,v[t.id]]])]),t.status=="completed"?(i(),a("div",_t,d(t.answer.feedback_for_correct),1)):_("",!0),t.status=="failed"?(i(),a("div",vt,d(t.answer.feedback_for_incorrect),1)):_("",!0)])}),128))])):_("",!0),s("div",pt,"Вопрос "+d(q.value+1)+" из "+d(l.object.question_results.length),1),s("div",ft,[s("button",{type:"button",onClick:H,disabled:q.value===0,class:"test-nav-button"}," Назад ",8,mt),n.value.status!="completed"&&n.value.status!="failed"?(i(),a("button",{key:0,type:"button",onClick:W,class:"button"}," Ответить ")):_("",!0),s("button",{type:"button",onClick:Y,disabled:q.value===l.object.question_results.length-1,class:"test-nav-button"}," Далее ",8,bt)])])):_("",!0),s("div",gt,[s("div",ht,[s("div",kt,[s("h2",null,'Выполнение теста "'+d(l.object.test_name)+'"',1)]),e[10]||(e[10]=s("div",{class:"test-manual"},[s("span",null,"Ответье на вопрсоы теста за отведенное время")],-1)),s("div",yt,[s("div",wt,[e[6]||(e[6]=s("span",{class:"test-info-text-label"},"Номер попытки:",-1)),C(" "+d(l.object.number?l.object.number:"Нет номера попытки")+" из "+d(l.object.test_attempts?l.object.test_attempts:"Нет числа попыток"),1)]),s("div",qt,[e[7]||(e[7]=s("span",{class:"test-info-text-label"},"Статус попытки:",-1)),C(" "+d(l.object.status_display?l.object.status_display:"Нет статуса"),1)]),A.value&&V.value&&!((u=l.object)!=null&&u.end_time)?(i(),a("div",jt,[e[8]||(e[8]=s("span",{class:"test-info-text-label"},"Время попытки:",-1)),C(" "+d(A.value)+" : "+d(V.value),1)])):(i(),a("div",xt,[e[9]||(e[9]=s("span",{class:"test-info-text-label"},"Попытка завершена:",-1)),C(" "+d(l.object.test_result.end_time?R(ae)(l.object.test_result.end_time):"Нет данных"),1)]))])]),(l.object.status=="completed"||l.object.status=="failed")&&!l.object.test_result.finished?(i(),a("div",It,[s("button",{type:"button",onClick:e[1]||(e[1]=t=>te()),class:"button"}," Начать заново ")])):_("",!0),s("div",Pt,[l.object.question_results.length!==0?(i(),a("div",$t,[s("div",St,[s("table",null,[e[11]||(e[11]=s("thead",null,[s("tr",null,[s("th",null,"Вопрос"),s("th",null,"Статус"),s("th",null," Действия ")])],-1)),s("tbody",null,[(i(!0),a(k,null,y(G.value,t=>(i(),a("tr",{key:t.id},[s("td",null,d(t.question.text?t.question.text:"-"),1),s("td",null,d(t.status_display?t.status_display:"-"),1),s("td",null,[s("div",At,[s("button",{type:"button",onClick:f=>K(t),class:"test-info-button"}," Открыть ",8,Vt)])])]))),128))])])])])):(i(),a("div",Tt,[...e[12]||(e[12]=[s("div",{class:"none-border-mini"},"Нет вопросов теста",-1)])])),s("div",Ct,[s("button",{disabled:b.value===1,onClick:e[2]||(e[2]=t=>b.value--),class:"tab-settings-button"}," Назад ",8,Ut),s("span",null,"Страница "+d(b.value)+" из "+d(Q.value),1),s("button",{disabled:b.value===Q.value,onClick:e[3]||(e[3]=t=>b.value++),class:"tab-settings-button"}," Вперед ",8,Bt)])])])])])])):l.object.id?_("",!0):(i(),a("div",Ot,[...e[13]||(e[13]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(i(),a("div",Qt,[...e[14]||(e[14]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),a("div",Dt,[...e[15]||(e[15]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Et as default};
