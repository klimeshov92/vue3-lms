import{r as p,a as y,B as N,o as R,c,d as t,b,f as w,D as h,t as V,w as B,n as T,k as U,i as j,u as z,h as q,j as x,q as A,l as d}from"./index-Czc3v3Gw.js";import{s as O}from"./custom-multiselect-B58g3l4X.js";const E={key:0},I={key:0,class:"form-page"},L={class:"form-field"},M={key:0,class:"error"},F={key:0,class:"form-field"},J={key:0,class:"error"},P={key:1,class:"none-card"},G={key:1,class:"loading"},W={__name:"PlanResultUpdate",setup(H){const k=U(),m=z(),l=p(null),u=y({task:null,status:"",outcome:null}),g=p(!1),f=p([]),o=p(),S=async()=>{var i;const r=k.params.id;let e=localStorage.getItem("access_token");const s=j(e);if(e&&!s){m.push({name:"Login"});return}try{const a=await q.get(`${x}/plan_result_update/${r}/`,{headers:{Authorization:`Bearer ${e}`}});l.value=a.data,console.log("Объект успешно загружен:",l.value),f.value=l.value.outcomes,console.log("Итоги задачи:",f.value),l.value.task.controllers.some(v=>v==s.user_id)?o.value="controller":(l.value.task.executor==s.user_id||l.value.task.co_executors.some(v=>v.id==s.user_id))&&(o.value="executor"),console.log("Роль:",o.value),l.value.status=_.value.find(v=>v.value===l.value.status),console.log("Объект нормализован:",l.value),Object.assign(u,l.value)}catch(a){console.error("Ошибка загрузки объекта:",((i=a.response)==null?void 0:i.data)||a.message)}},_=N(()=>[!l.value.task.require_review||o.value=="controller"?{label:"В ожидании",value:"waiting"}:null,!l.value.task.require_review||o.value=="controller"?{label:"Назначено",value:"assigned"}:null,{label:"В процессе",value:"in_progress"},{label:"На проверке",value:"under_review"},!l.value.task.require_review||o.value=="controller"?{label:"Выполнено",value:"completed"}:null,!l.value.task.require_review||o.value=="controller"?{label:"Провалено",value:"failed"}:null,!l.value.task.require_review||o.value=="controller"?{label:"Отменено",value:"canceled"}:null,!l.value.task.require_review||o.value=="controller"?{name:"desc",label:"Описание"}:null].filter(Boolean)),n=y({}),$=()=>(n.status=u.status.value?"":"Статус задачи обязателен!",Object.values(n).every(r=>!r)),C=async()=>{var e;const r=k.params.id;if(!$()){console.error("Форма содержит ошибки:",n);return}try{let s=localStorage.getItem("access_token");const i=j(s);if(s&&!i){m.push({name:"Login"});return}const a={status:u.status.value,outcome:((e=u.outcome)==null?void 0:e.id)||null};console.log("JSON данные перед отправкой:",a),await q.patch(`${x}/plan_result_update/${r}/`,a,{headers:{Authorization:`Bearer ${s}`}}),console.log("Данные обновлены"),m.push({name:"TaskDetail",params:{id:r}})}catch(s){s.response&&s.response.data?(Object.assign(n,s.response.data),console.error("Ошибка при сохранении изменений:",s.response.data)):console.error("Ошибка при сохранении изменений:",s.message)}},D=()=>{A(m)};return R(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await S(),g.value=!0}catch(r){console.error("Ошибка при загрузке данных:",r)}}),(r,e)=>{var s,i;return g.value?(d(),c("div",E,[l.value?(d(),c("div",I,[e[7]||(e[7]=t("div",{class:"form-header"},[t("h1",null,"Результат плана")],-1)),t("form",{onSubmit:T(C,["prevent"]),class:"modal-form",id:"edit-form"},[t("div",L,[e[2]||(e[2]=t("label",{class:"form-label"},"Статус:",-1)),w(h(O),{modelValue:u.status,"onUpdate:modelValue":e[0]||(e[0]=a=>u.status=a),options:_.value,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите статус",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue","options"]),n.status?(d(),c("span",M,V(n.status),1)):b("",!0)]),(i=(s=l.value)==null?void 0:s.task)!=null&&i.task_outcome?(d(),c("div",F,[e[5]||(e[5]=t("label",{class:"form-label"},"Итог задачи:",-1)),w(h(O),{modelValue:u.outcome,"onUpdate:modelValue":e[1]||(e[1]=a=>u.outcome=a),options:f.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите итог задачи",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:B(()=>[...e[3]||(e[3]=[t("span",null,"Список пуст",-1)])]),noResult:B(()=>[...e[4]||(e[4]=[t("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),n.outcome?(d(),c("span",J,V(n.outcome),1)):b("",!0)])):b("",!0)],32),t("div",{class:"button-group modal-menu"},[e[6]||(e[6]=t("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),t("button",{type:"button",onClick:D,class:"button"},"Отмена")])])):(d(),c("div",P,[...e[8]||(e[8]=[t("div",null,"Объект не найден",-1)])]))])):(d(),c("div",G,[...e[9]||(e[9]=[t("div",null,"Загрузка данных...",-1)])]))}}};export{W as default};
