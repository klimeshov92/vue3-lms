import{r as D,a as X,A as Y,k as Z,B as ee,o as te,c as a,b as r,d as s,t as i,m as d,C as k,G as f,e as $,w as E,F as z,E as M,f as V,i as y,h,j as P,u as se,g as oe,l as o,H as ae}from"./index-dWaDSvEZ.js";import{_ as ne,a as le}from"./AccountsGroupObjectPermissions-znzMgBhx.js";import{_ as ie}from"./TopicMessages-DIWwjUUy.js";import"./EditorComponent-Dgh5e3c2.js";const ce={key:0},re={key:0,class:"detail-page"},de={key:0},ue={class:"detail-card"},be={class:"detail-card-image-outer"},me={key:0,class:"detail-card-image-inner"},_e=["src"],ve={key:1,class:"detail-card-image-none"},pe={class:"detail-card-info"},ge={class:"detail-header"},je={class:"detail-header-title"},ke={class:"detail-card-text"},fe={class:"detail-card-text-elem"},ye={class:"detail-card-text-elem"},he={class:"detail-card-text-elem"},Pe={class:"detail-card-text-elem"},Ae={class:"detail-card-text-elem"},Se={key:0,class:"detail-card-text-elem"},we={class:"detail-menu button-group"},Oe=["href"],De={key:0,class:"modal-overlay"},$e={class:"modal"},Ee={class:"modal-header"},Ve={class:"modal-header-h2"},Te={class:"minibutton-group modal-menu"},xe={class:"detail-tabs"},Ie={class:"tabs-header"},Ce=["onClick"],Le={key:0,class:"tabs-content"},Be={key:0,class:"desc-tab"},Ge={key:0},Ne={key:1},ze={key:1,class:"detail-tab"},Me={class:"detail-tab-elem"},qe={class:"detail-tab-elem"},Je={class:"detail-tab-elem"},Fe={class:"detail-tab-elem"},Re={class:"detail-tab-elem"},Ue={class:"detail-tab-elem"},He={class:"detail-tab-elem"},Ke={key:0,class:"detail-tab-elem"},Qe={class:"detail-tab-elem"},We={class:"detail-tab-elem"},Xe={class:"detail-tab-elem"},Ye={class:"detail-tab-elem"},Ze={key:2,class:"table-tab"},et={key:0},tt={key:0,class:"table-tab-table-outer"},st={class:"table-tab-table-inner"},ot={key:0},at={class:"table-tab-menu"},nt=["onClick"],lt=["onClick"],it={key:1},ct={key:1},rt={key:1},dt={key:2,class:"tab-menu minibutton-group"},ut={key:3,class:"topic-tab"},bt={key:4,class:"table-tab"},mt={key:5,class:"table-tab"},_t={key:1,class:"none-container"},vt={key:1,class:"loading"},pt={key:1,class:"loading"},ht={__name:"EventSlotDetail",setup(gt){const A=Z(),p=se(),T=D(!1),e=X({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewEventSlot:!1,canAdmin:!1,canSelfAssignment:!1,canEditEventSlot:!1,canDeleteEventSlot:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1,canViewTopic:!1}),S=async()=>{const n=A.params.id;let t=localStorage.getItem("access_token");const c=y(t);t&&!c&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{const l=await h.get(`${P}/event_slots/${n}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные мероприятия:",l.data),e.object=l.data}catch(l){console.error("Ошибка при получении данных мероприятия:",l)}},w=D(!1),q=()=>{w.value=!0},x=()=>{w.value=!1},J=async()=>{let n=localStorage.getItem("access_token");const t=y(n);if(n&&!t){p.push({name:"Login"});return}const c=A.params.id;try{await h.delete(`${P}/event_slots/${c}/`,{headers:{Authorization:`Bearer ${n}`}}),x(),p.push({name:"EventSlotList"})}catch(l){console.error("Ошибка удаления мероприятияа:",l)}},F=async n=>{let t=localStorage.getItem("access_token");const c=y(t);if(t&&!c){p.push({name:"Login"});return}try{const l=await h.post(`${P}/self_assignment/${n}/`,{},{headers:{Authorization:`Bearer ${t}`}});console.log("Самоназначение:",l.data),p.push({name:"TaskDetail",params:{id:l.data.id}})}catch(l){console.error("Ошибка самоназначения:",l)}},R=async()=>{let n=localStorage.getItem("access_token");const t=y(n);if(n&&!t){p.push({name:"Login"});return}const c=e.object.last_task.id;try{const l=await h.patch(`${P}/confirm_participation/${c}/`,{},{headers:{Authorization:`Bearer ${n}`}});console.log("Ответ об отметки об участии:",l.data),e.object.last_task.result.confirmed=l.data.confirmed;const _=e.object.tasks.find(m=>m.id===c);_.result.confirmed=l.data.confirmed}catch(l){console.error("При отметке об участии:",l)}},I=async(n,t)=>{let c=localStorage.getItem("access_token");const l=y(c);if(c&&!l){p.push({name:"Login"});return}try{const _=await h.patch(`${P}/mark_completion/${n}/${t}/`,{},{headers:{Authorization:`Bearer ${c}`}});console.log("Ответ об отметки об участии:",_.data);const m=e.object.tasks.find(u=>u.id===n);m&&m.result&&(m.result.status=t,m.result.status_display=t==="completed"?"Выполнена":t==="failed"?"Провалена":m.result.status_display)}catch(_){console.error("При отметке об участии:",_)}},U=async()=>{console.log("Проверяем версию прав");const n=JSON.parse(localStorage.getItem("userPermissions"));if(!(n!=null&&n.permissions_version))return;console.log("Текущая версия прав:",n.permissions_version);let t=localStorage.getItem("access_token");const c=y(t);if(!(!t||!c))try{(await h.get(`${P}/user_permissions_version/${n.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(l){console.error("Ошибка проверки версии прав:",l),localStorage.removeItem("userPermissions")}},H=async()=>{var c,l,_,m;let n=localStorage.getItem("access_token");const t=y(n);n&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),n=null);try{let u=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",u),Object.keys(u).length>0&&(console.log("ID пользователя в разрешениях из памяти:",u.user_id),!t&&u.user_id!==1||t&&t.user_id!==u.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),u={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(u).length===0){const j=await h.get(`${P}/user_permissions/`,{headers:{...n&&{Authorization:`Bearer ${n}`}}});console.log("Разрешения пользователя загружены:",j.data),u=j.data,localStorage.setItem("userPermissions",JSON.stringify(u))}e.globalPermissionsList=u.global_permissions||[],e.objectPermissionsDict=u.object_permissions||{};const g=A.params.id;console.log("ID объекта:",g),e.canViewEventSlot=e.globalPermissionsList.includes("events.view_event_slot")||e.objectPermissionsDict["events.view_event_slot"]&&e.objectPermissionsDict["events.view_event_slot"].includes(Number(g)),console.log("Права на просмотр аккаунтов:",e.canViewEventSlot),e.canAdmin=Array.isArray(e.object.event_template.admins)&&e.object.event_template.admins.some(j=>j.id===u.user_id),console.log("Права на администрирование:",e.canAdmin),e.canSelfAssignment=e.canViewEventSlot&&e.object.self_assignment_task_template&&(!e.object.last_task||((l=(c=e.object.last_task)==null?void 0:c.result)==null?void 0:l.status)=="failed"||((m=(_=e.object.last_task)==null?void 0:_.result)==null?void 0:m.status)=="canceled"),console.log("Права на самоназначение:",e.canSelfAssignment),e.canEditEventSlot=e.globalPermissionsList.includes("events.change_event_slot")||Array.isArray(e.objectPermissionsDict["events.change_event_slot"])&&e.objectPermissionsDict["events.change_event_slot"].includes(Number(g)),console.log("Права на редактирование аккаунтов:",e.canEditEventSlot),e.canDeleteEventSlot=e.globalPermissionsList.includes("events.delete_event_slot")||Array.isArray(e.objectPermissionsDict["events.delete_event_slot"])&&e.objectPermissionsDict["events.delete_event_slot"].includes(Number(g)),console.log("Права на удаление аккаунтов:",e.canDeleteEventSlot),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission),e.object.topic&&(e.canViewTopic=e.globalPermissionsList.includes("comments.view_topic")||e.objectPermissionsDict["comments.view_topic"]&&e.objectPermissionsDict["comments.view_topic"].includes(Number(e.object.topic.id)),console.log("Права на просмотр топика:",e.canViewTopic))}catch(u){console.error("Ошибка при загрузке разрешений пользователя:",u)}},K=()=>{p.back()},Q=Y(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},{name:"tasks",label:"Участники"},e.canViewTopic?{name:"messages",label:"Комментарии"}:null,e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),v=D(A.query.tab||localStorage.getItem(`activeEventSlotTab-${A.params.id}`)||"details");return ee(v,n=>{localStorage.setItem(`activeEventSlotTab-${A.params.id}`,n),p.push({query:{tab:n}}),console.log("Загружен таб:",n)}),te(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await S(),await U(),await H(),T.value=!0}catch(n){console.error("Ошибка при загрузке данных:",n)}}),(n,t)=>{var l,_,m,u,g,j,C,L;const c=oe("router-link");return T.value?(o(),a("div",ce,[e.canViewEventSlot?(o(),a("div",re,[e.object.id?(o(),a("div",de,[s("div",ue,[s("div",be,[e.object.event_template.avatar?(o(),a("div",me,[s("img",{src:e.object.event_template.avatar||"/default-avatar.png",alt:"Аватар"},null,8,_e)])):(o(),a("div",ve,[...t[2]||(t[2]=[s("span",{class:"none-text"},"Нет аватара",-1)])]))]),s("div",pe,[s("div",ge,[s("div",je,[s("h1",null,i(e.object.str||"Безымянный мероприятия"),1)])]),s("div",ke,[s("div",fe,[t[3]||(t[3]=s("span",{class:"detail-card-text-label"},"Статус:",-1)),d(" "+i(e.object.status_display||"Нет статуса"),1)]),s("div",ye,[t[4]||(t[4]=s("span",{class:"detail-card-text-label"},"Статус задачи:",-1)),d(" "+i((l=e.object.last_task)!=null&&l.result?(_=e.object.last_task)==null?void 0:_.result.status_display:"Не назначено"),1)]),s("div",he,[t[5]||(t[5]=s("span",{class:"detail-card-text-label"},"Количество участников:",-1)),d(" "+i(e.object.number_of_participants||"Нет количества участников"),1)]),s("div",Pe,[t[6]||(t[6]=s("span",{class:"detail-card-text-label"},"Регистрация открыта:",-1)),d(" "+i(e.object.registration?"Да":"Нет"),1)]),s("div",Ae,[t[7]||(t[7]=s("span",{class:"detail-card-text-label"},"Начало по плану:",-1)),d(" "+i(e.object.planned_start?k(f)(e.object.planned_start):"Нет данных о начале"),1)]),e.object.deadline?(o(),a("div",Se,[t[8]||(t[8]=s("span",{class:"detail-card-text-label"},"Завершение по плану:",-1)),d(" "+i(e.object.planned_end?k(f)(e.object.planned_end):"Нет данных о завершении"),1)])):r("",!0)]),s("div",we,[e.object.last_task?(o(),a("a",{key:0,href:e.object.event_template.link,target:"_blank",rel:"noopener noreferrer",class:"button"}," Открыть слот ",8,Oe)):r("",!0),e.object.last_task?(o(),a("button",{key:1,onClick:R,class:"button"},i((g=(u=(m=e.object)==null?void 0:m.last_task)==null?void 0:u.result)!=null&&g.confirmed?"Отменить участие":"Подтвердить участие"),1)):r("",!0),e.object.last_task?(o(),$(c,{key:2,to:{name:"TaskDetail",params:{id:e.object.last_task.id}},class:"button"},{default:E(()=>[...t[9]||(t[9]=[d(" Задача ",-1)])]),_:1},8,["to"])):r("",!0),e.canSelfAssignment?(o(),a("button",{key:3,onClick:t[0]||(t[0]=b=>F(e.object.self_assignment_task_template)),class:"button"}," Самоназначение ")):r("",!0),e.canEditEventSlot?(o(),$(c,{key:4,to:{name:"EventSlotEdit",params:{id:e.object.id}},class:"button"},{default:E(()=>[...t[10]||(t[10]=[d(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canDeleteEventSlot?(o(),a("button",{key:5,onClick:q,class:"button"}," Удалить ")):r("",!0),s("button",{type:"button",onClick:K,class:"button"},"Назад")]),w.value?(o(),a("div",De,[s("div",$e,[s("div",Ee,[s("h2",Ve,"Удаление "+i(e.object.name||"Безымянного мероприятия"),1)]),s("div",Te,[s("button",{onClick:t[1]||(t[1]=b=>J()),class:"minibutton"},"Подтвердить"),s("button",{onClick:x,class:"minibutton"},"Отменить")])])])):r("",!0)])]),s("div",xe,[s("div",Ie,[(o(!0),a(z,null,M(Q.value,b=>(o(),a("button",{key:b.name,class:ae([{active:v.value===b.name},"tab-button"]),onClick:O=>v.value=b.name},i(b.label),11,Ce))),128))]),v.value?(o(),a("div",Le,[v.value==="desc"?(o(),a("div",Be,[e.object.desc?(o(),a("div",Ge,i(e.object.desc),1)):(o(),a("div",Ne,[...t[11]||(t[11]=[s("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):r("",!0),v.value==="details"?(o(),a("div",ze,[s("div",Me,[t[12]||(t[12]=s("span",{class:"detail-tab-label"},"Статус задачи:",-1)),d(" "+i((j=e.object.last_task)!=null&&j.result?(C=e.object.last_task)==null?void 0:C.result.status_display:"Не назначено"),1)]),s("div",qe,[t[13]||(t[13]=s("span",{class:"detail-tab-label"},"Статус:",-1)),d(" "+i(e.object.status_display||"Нет статуса"),1)]),s("div",Je,[t[14]||(t[14]=s("span",{class:"detail-tab-label"},"Мероприятие:",-1)),d(" "+i(e.object.event_template.str||"Нет мероприятия"),1)]),s("div",Fe,[t[15]||(t[15]=s("span",{class:"detail-tab-label"},"Количество участников:",-1)),d(" "+i(e.object.number_of_participants||"Нет количества участников"),1)]),s("div",Re,[t[16]||(t[16]=s("span",{class:"detail-tab-label"},"Регистрация открыта:",-1)),d(" "+i(e.object.registration?"Да":"Нет"),1)]),s("div",Ue,[t[17]||(t[17]=s("span",{class:"detail-tab-label"},"Сроки:",-1)),d(" "+i(e.object.deadline?"Да":"Нет"),1)]),s("div",He,[t[18]||(t[18]=s("span",{class:"detail-tab-label"},"Начало по плану:",-1)),d(" "+i(e.object.planned_start?k(f)(e.object.planned_start):"Нет данных о начале"),1)]),e.object.deadline?(o(),a("div",Ke,[t[19]||(t[19]=s("span",{class:"detail-tab-label"},"Завершение по плану:",-1)),d(" "+i(e.object.planned_end?k(f)(e.object.planned_end):"Нет данных о завершении"),1)])):r("",!0),s("div",Qe,[t[20]||(t[20]=s("span",{class:"detail-tab-label"},"Создан:",-1)),d(" "+i(e.object.created?k(f)(e.object.created):"Нет данных о создании"),1)]),s("div",We,[t[21]||(t[21]=s("span",{class:"detail-tab-label"},"Создатель:",-1)),d(" "+i(e.object.creator?e.object.creator:"Нет создателя"),1)]),s("div",Xe,[t[22]||(t[22]=s("span",{class:"detail-tab-label"},"Изменён:",-1)),d(" "+i(e.object.changed?k(f)(e.object.changed):"Нет данных об изменениях"),1)]),s("div",Ye,[t[23]||(t[23]=s("span",{class:"detail-tab-label"},"Редактор:",-1)),d(" "+i(e.object.editor?e.object.editor:"Нет редактора"),1)])])):r("",!0),v.value==="tasks"?(o(),a("div",Ze,[e.canAdmin?(o(),a("div",et,[e.object.tasks&&e.object.tasks.length>0?(o(),a("div",tt,[s("div",st,[s("table",null,[t[24]||(t[24]=s("thead",null,[s("tr",null,[s("th",null,"Участник"),s("th",null,"Зарегистрирован"),s("th",null,"Подтверждение участия"),s("th",null,"Статус"),s("th",null," Действия ")])],-1)),s("tbody",null,[(o(!0),a(z,null,M(e.object.tasks,b=>{var O,B,G,N;return o(),a("tr",{key:b.id},[s("td",null,i(b.executor?b.executor:"Нет данных"),1),s("td",null,i(b.created?k(f)(b.created):"Нет данных"),1),s("td",null,i((O=b.result)!=null&&O.confirmed?"Да":"Нет"),1),s("td",null,i((B=b.result)!=null&&B.status_display?b.result.status_display:"Нет данных"),1),s("td",null,[e.canAdmin?(o(),a("div",ot,[s("div",at,[e.canAdmin&&((G=b.result)==null?void 0:G.status)!="completed"?(o(),a("button",{key:0,onClick:W=>I(b.id,"completed"),class:"table-tab-button"}," Выполнено ",8,nt)):r("",!0),e.canAdmin&&((N=b.result)==null?void 0:N.status)!="failed"?(o(),a("button",{key:1,onClick:W=>I(b.id,"failed"),class:"table-tab-button"}," Провалено ",8,lt)):r("",!0)])])):(o(),a("div",it," - "))])])}),128))])])])])):(o(),a("div",ct,[...t[25]||(t[25]=[s("div",{class:"none-border"},"Нет подзадач",-1)])]))])):(o(),a("div",rt,[...t[26]||(t[26]=[s("div",{class:"none-border"},"У вас нет разрешения на просмотр",-1)])])),e.canAddTask?(o(),a("div",dt,[e.canAddTask?(o(),$(c,{key:0,to:{name:"TaskCreate",query:{planId:e.object.id}},class:"minibutton"},{default:E(()=>[...t[27]||(t[27]=[d(" Создать ",-1)])]),_:1},8,["to"])):r("",!0)])):r("",!0)])):r("",!0),v.value==="messages"?(o(),a("div",ut,[V(ie,{topic_id:(L=e.object)==null?void 0:L.topic.id},null,8,["topic_id"])])):r("",!0),v.value==="accountsGroupObjectPermissions"?(o(),a("div",bt,[V(ne,{state:e,fetchObject:S,contentTypeModel:"eventslot"},null,8,["state"])])):r("",!0),v.value==="accountObjectPermissions"?(o(),a("div",mt,[V(le,{state:e,fetchObject:S,contentTypeModel:"eventslot"},null,8,["state"])])):r("",!0)])):r("",!0)])])):e.object.id?r("",!0):(o(),a("div",_t,[...t[28]||(t[28]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(o(),a("div",vt,[...t[29]||(t[29]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(o(),a("div",pt,[...t[30]||(t[30]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{ht as default};
