import{r as m,a as C,B as N,o as D,c as n,d as l,b,f as k,C as j,t as $,w as p,n as E,i as f,u as M,h as v,j as g,k as F,l as r}from"./index-_TMNgkFu.js";import{s as _}from"./custom-multiselect-M3BzxD5H.js";import"./EditorComponent-BJSxZEvv.js";const J={key:0},q={key:0,class:"form-page"},G={class:"form-field"},H={key:0,class:"error"},K={key:0,class:"form-field"},P={key:0,class:"error"},Q={key:1,class:"form-field"},W={key:0,class:"error"},X={class:"form-field"},Y={key:1,class:"none-card"},Z={key:1,class:"loading"},le={__name:"InteractionEdit",setup(ee){const B=F(),c=M(),i=m(null),s=C({object_type:"",client:null,account:null,categories:[]}),O=m(!1),S=[{label:"Клиент",value:"client"},{label:"Аккаунт",value:"account"}],h=m([]),I=async()=>{let o=localStorage.getItem("access_token");const e=f(o);if(o&&!e){c.push({name:"Login"});return}try{const t=await v.get(`${g}/clients/`,{headers:{Authorization:`Bearer ${o}`}});h.value=t.data.results||[],console.log("Новости загружены:",h.value)}catch(t){console.error("Ошибка при загрузке новостей:",t.response?t.response.data:t.message)}},V=m([]),A=async()=>{let o=localStorage.getItem("access_token");const e=f(o);if(o&&!e){c.push({name:"Login"});return}try{const t=await v.get(`${g}/accounts/`,{headers:{Authorization:`Bearer ${o}`}});V.value=t.data.results||[],console.log("Аккаунты загружены:",V.value)}catch(t){console.error("Ошибка при загрузке сотрудников:",t.response?t.response.data:t.message)}},w=m([]),T=async()=>{let o=localStorage.getItem("access_token");const e=f(o);if(o&&!e){c.push({name:"Login"});return}try{const t=await v.get(`${g}/categories/`,{headers:{Authorization:`Bearer ${o}`}});w.value=t.data.results||[],console.log("Категории загружены:",w.value)}catch(t){console.error("Ошибка при загрузке категорий:",t.response?t.response.data:t.message)}},z=async()=>{var u;const o=B.params.id;let e=localStorage.getItem("access_token");const t=f(e);if(e&&!t){c.push({name:"Login"});return}try{const d=await v.get(`${g}/interactions/${o}/`,{headers:{Authorization:`Bearer ${e}`}});i.value=d.data,console.log("Объект успешно загружен:",i.value),i.value.object_type=S.find(y=>y.value===i.value.object_type),console.log("Объект нормализован:",i.value),Object.assign(s,i.value)}catch(d){console.error("Ошибка загрузки объекта:",((u=d.response)==null?void 0:u.data)||d.message)}};N(()=>s.object_type,o=>{o.value!="client"&&(s.client=null),o.value!="account"&&(s.account=null)});const a=C({}),L=()=>(s.object_type.value=="client"&&(a.client=s.client?"":"Клиент обязателен!"),s.object_type.value=="account"&&(a.account=s.account?"":"Акккаунт обязателен!"),Object.values(a).every(o=>!o)),R=async()=>{var o,e;if(!L()){console.error("Форма содержит ошибки:",a);return}try{const t=B.params.id;let u=localStorage.getItem("access_token");const d=f(u);if(u&&!d){c.push({name:"Login"});return}const y={object_type:s.object_type.value,client:((o=s.client)==null?void 0:o.id)||null,account:((e=s.account)==null?void 0:e.id)||null,categories:s.categories.map(x=>x.id)};console.log("JSON данные перед отправкой:",y),await v.patch(`${g}/interactions/${t}/`,y,{headers:{Authorization:`Bearer ${u}`}}),console.log("Данные обновлены"),c.push({name:"InteractionDetail",params:{id:t}})}catch(t){t.response&&t.response.data?(Object.assign(a,t.response.data),console.error("Ошибка при сохранении изменений:",t.response.data)):console.error("Ошибка при сохранении изменений:",t.message)}},U=()=>{c.back()};return D(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await I(),await A(),await T(),await z(),O.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),(o,e)=>O.value?(r(),n("div",J,[i.value?(r(),n("div",q,[e[15]||(e[15]=l("div",{class:"form-header"},[l("h1",null,"Редактирование взаимодействия")],-1)),l("form",{onSubmit:E(R,["prevent"]),class:"form",id:"edit-form"},[l("div",G,[e[4]||(e[4]=l("label",{class:"form-label"},"Тип взаимодействия:",-1)),k(j(_),{modelValue:s.object_type,"onUpdate:modelValue":e[0]||(e[0]=t=>s.object_type=t),options:S,searchable:!1,multiple:!1,"close-on-select":!0,"clear-on-select":!0,placeholder:"Выберите тип взаимодействия",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},null,8,["modelValue"]),a.object_type?(r(),n("span",H,$(a.object_type),1)):b("",!0)]),s.object_type.value=="client"?(r(),n("div",K,[e[7]||(e[7]=l("label",{class:"form-label"},"Клиент:",-1)),k(j(_),{modelValue:s.client,"onUpdate:modelValue":e[1]||(e[1]=t=>s.client=t),options:h.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите новость",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[5]||(e[5]=[l("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[6]||(e[6]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.client?(r(),n("span",P,$(a.client),1)):b("",!0)])):b("",!0),s.object_type.value=="account"?(r(),n("div",Q,[e[10]||(e[10]=l("label",{class:"form-label"},"Аккаунт:",-1)),k(j(_),{modelValue:s.account,"onUpdate:modelValue":e[2]||(e[2]=t=>s.account=t),options:V.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите исполнителя",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[8]||(e[8]=[l("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[9]||(e[9]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"]),a.account?(r(),n("span",W,$(a.account),1)):b("",!0)])):b("",!0),l("div",X,[e[13]||(e[13]=l("label",{class:"form-label"},"Категории:",-1)),k(j(_),{modelValue:s.categories,"onUpdate:modelValue":e[3]||(e[3]=t=>s.categories=t),options:w.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите категории",label:"name","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[11]||(e[11]=[l("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[12]||(e[12]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])])],32),l("div",{class:"form-menu button-group"},[e[14]||(e[14]=l("button",{type:"submit",class:"button",form:"edit-form"},"Сохранить",-1)),l("button",{type:"button",onClick:U,class:"button"},"Отмена")])])):(r(),n("div",Y,[...e[16]||(e[16]=[l("div",null,"Объект не найден",-1)])]))])):(r(),n("div",Z,[...e[17]||(e[17]=[l("div",null,"Загрузка данных...",-1)])]))}};export{le as default};
