import{a as j,r as g,k as z,o as J,c,d as l,b as w,p as U,v as M,f as I,w as p,D as q,n as R,F as E,G,t as f,e as H,i as b,h as k,j as _,u as K,g as Q,l as n,m as V}from"./index-CzP8FZvf.js";import{s as N}from"./custom-multiselect-CPXnysGl.js";const W={key:0},X={key:0,class:"list-page"},Y={class:"filters-inner"},Z={class:"filters-field"},ee={class:"filters-field"},se={class:"filters-field"},le={class:"filters-menu button-group"},oe={key:1,class:"list-items"},te={class:"list-grid"},ae={class:"list-card-header"},ie={class:"list-card-header-title"},re={class:"list-card-text"},ne={class:"list-card-text-elem"},ce={class:"list-card-menu minibutton-group"},de={class:"list-pagination"},ue=["disabled"],ge=["disabled"],me={key:2,class:"none-card"},ve={key:3,class:"list-menu button-group"},pe={key:1,class:"loading"},fe={key:1,class:"loading"},ye={__name:"FileList",setup(be){const u=z(),y=K(),a=j({items:[],globalPermissionsList:[],objectPermissionsDict:{},canAddFile:!1,canViewFile:!1}),C=g(!1),S=[{label:"Название: по возрастанию",value:"name"},{label:"Название: по убыванию",value:"-name"}],F=g([]),O=async()=>{let s=localStorage.getItem("access_token");const e=b(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const o=await k.get(`${_}/categories/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});F.value=o.data.results||[],console.log("Категории загружены:",F.value)}catch(o){console.error("Ошибка при загрузке категорий:",o.response?o.response.data:o.message)}},r=j({name:u.query.name||"",categories:u.query.categories?u.query.categories.map(s=>({id:parseInt(s,10)})):[],order:S.find(s=>s.value===u.query.order||"name")}),x=()=>{const s=localStorage.getItem("fileFilters");s&&(console.log("Загруженные фильры:",s),Object.assign(r,JSON.parse(s)))},i=g(Number(u.query.page)||1),P=g(1),A=()=>{const s=localStorage.getItem("filePage");s&&(console.log("Загруженная странциа:",s),i.value=parseInt(s,10))},m=async(s,e)=>{console.log("Загрузка файлов с фильтрами:",s,"для страницы:",e);let o=localStorage.getItem("access_token");const t=b(o);o&&!t&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),o=null),y.push({name:"FileList",query:{name:s.name||"",categories:s.categories.map(d=>d.id)||[],order:s.order.value,page:i.value}}),localStorage.setItem("fileFilters",JSON.stringify(s));try{const d=await k.get(`${_}/files/`,{headers:{...o&&{Authorization:`Bearer ${o}`}},params:{page:e,page_size:12,name:s.name,categories:s.categories.map(T=>T.id),ordering:s.order.value}});console.log("Список файлов загружен:",d.data),a.items=d.data.results,P.value=Math.ceil(d.data.count/12)}catch(d){console.error("Ошибка при загрузке списка файлов:",d)}},$=s=>{console.log("Смена страницы на:",s),i.value=s,y.push({name:"FileList",query:{...u.query,page:i.value}}),localStorage.setItem("filePage",i.value),m(r,s)},v=g(!1),h=()=>{v.value=!v.value,console.log("Текущий статус показа фильтров:",v.value)},L=()=>{console.log("Сбрасываем фильтры"),r.name="",r.categories=[],r.order=S.find(s=>s.value==="name"),localStorage.removeItem("fileFilters"),localStorage.removeItem("filePage"),i.value=1,y.push({name:"FileList",query:{name:"",categories:[],page:i.value}}),m(r,i.value)},B=async()=>{console.log("Проверяем версию прав");const s=JSON.parse(localStorage.getItem("userPermissions"));if(!(s!=null&&s.permissions_version))return;console.log("Текущая версия прав:",s.permissions_version);let e=localStorage.getItem("access_token");const o=b(e);if(!(!e||!o))try{(await k.get(`${_}/user_permissions_version/${s.permissions_version}/`,{headers:{Authorization:`Bearer ${e}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(t){console.error("Ошибка проверки версии прав:",t),localStorage.removeItem("userPermissions")}},D=async()=>{let s=localStorage.getItem("access_token");const e=b(s);s&&!e&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{let o=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",o),Object.keys(o).length>0&&(console.log("ID пользователя в разрешениях из памяти:",o.user_id),!e&&o.user_id!==1||e&&e.user_id!==o.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),o={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(o).length===0){const t=await k.get(`${_}/user_permissions/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Разрешения пользователя загружены:",t.data),o=t.data,localStorage.setItem("userPermissions",JSON.stringify(o))}a.globalPermissionsList=o.global_permissions||[],a.objectPermissionsDict=o.object_permissions||{},a.canAddFile=a.globalPermissionsList.includes("files.add_file"),console.log("Права на добавление файлов:",a.canAddFile),a.canViewFile=a.globalPermissionsList.includes("files.view_file")||!!a.objectPermissionsDict["files.view_file"],console.log("Права на просмотр файлов:",a.canViewFile)}catch(o){console.error("Ошибка при получении разрешений пользователя:",o)}};return J(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await x(),await A(),await O(),await B(),await D(),await m(r,i.value),C.value=!0}catch(s){console.error("Ошибка при загрузке данных:",s)}}),(s,e)=>{const o=Q("router-link");return C.value?(n(),c("div",W,[a.canViewFile?(n(),c("div",X,[e[16]||(e[16]=l("div",{class:"list-header"},[l("h1",null,"Файлы")],-1)),l("div",{class:"list-settings"},[l("button",{onClick:h,class:"list-settings-button"}," Параметры ")]),v.value?(n(),c("div",{key:0,class:"filters-overlay",onClick:h},[l("div",{class:"filters-outer",onClick:e[4]||(e[4]=R(()=>{},["stop"]))},[l("div",{class:"filters-close_button-inner"},[l("button",{onClick:h,class:"filters-close_button"}," × ")]),l("div",Y,[l("div",Z,[e[7]||(e[7]=l("label",{class:"filters-label"},"Название:",-1)),U(l("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>r.name=t),class:"filters-input",placeholder:"Введите название"},null,512),[[M,r.name]])]),l("div",ee,[e[10]||(e[10]=l("label",{class:"filters-label"},"Категории:",-1)),I(q(N),{modelValue:r.categories,"onUpdate:modelValue":e[1]||(e[1]=t=>r.categories=t),options:F.value,multiple:!0,"close-on-select":!1,"clear-on-select":!1,"preserve-search":!1,placeholder:"Выберите",label:"str","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":""},{noOptions:p(()=>[...e[8]||(e[8]=[l("span",null,"Список пуст",-1)])]),noResult:p(()=>[...e[9]||(e[9]=[l("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","options"])]),l("div",se,[e[11]||(e[11]=l("label",{class:"filters-label"},"Сортировка:",-1)),I(q(N),{modelValue:r.order,"onUpdate:modelValue":e[2]||(e[2]=t=>r.order=t),options:S,searchable:!1,multiple:!1,"close-on-select":!1,"clear-on-select":!1,placeholder:"Выберите",label:"label","track-by":"value","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"","allow-empty":!1},null,8,["modelValue"])])]),l("div",le,[l("button",{onClick:e[3]||(e[3]=t=>m(r,i.value.value)),class:"button"},"Применить"),l("button",{onClick:L,class:"button"},"Сбросить")])])])):w("",!0),a.items.length!==0?(n(),c("div",oe,[l("div",te,[(n(!0),c(E,null,G(a.items,t=>(n(),c("div",{key:t.id,class:"list-card"},[l("div",ae,[l("div",ie,[l("h2",null,f(t.name||"Нет названия"),1)])]),l("div",re,[l("div",ne,[e[12]||(e[12]=l("span",{class:"list-card-text-label"},"Категории:",-1)),V(" "+f(t.categories.length>0?t.categories.map(d=>d.name).join(", "):"Нет категорий"),1)])]),l("div",ce,[I(o,{to:{name:"FileDetail",params:{id:t.id},query:{tab:"details"}},class:"minibutton"},{default:p(()=>[...e[13]||(e[13]=[V(" Подробнее ",-1)])]),_:1},8,["to"])])]))),128))]),l("div",de,[l("button",{disabled:i.value===1,onClick:e[5]||(e[5]=t=>$(i.value-1)),class:"list-settings-button"}," Назад ",8,ue),l("span",null,"Страница "+f(i.value)+" из "+f(P.value),1),l("button",{disabled:i.value===P.value,onClick:e[6]||(e[6]=t=>$(i.value+1)),class:"list-settings-button"}," Вперед ",8,ge)])])):(n(),c("div",me,[...e[14]||(e[14]=[l("div",null,"Список пуст",-1)])])),a.canAddFile?(n(),c("div",ve,[a.canAddFile?(n(),H(o,{key:0,to:{name:"FileCreate"},class:"button"},{default:p(()=>[...e[15]||(e[15]=[V(" Создать ",-1)])]),_:1})):w("",!0)])):w("",!0)])):(n(),c("div",pe,[...e[17]||(e[17]=[l("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(n(),c("div",fe,[...e[18]||(e[18]=[l("div",null,"Загрузка данных...",-1)])]))}}};export{ye as default};
