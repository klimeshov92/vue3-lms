import{r as P,a as $,B as L,k as G,C as B,o as N,c as n,b as r,d as o,t as l,m as u,e as T,w as x,F as E,G as M,D as f,H as A,f as C,i as g,h as _,j as y,g as z,q,u as J,l as i,I as F}from"./index-yfpLmCCm.js";import{_ as R,a as U}from"./AccountsGroupObjectPermissions-BCp0jPRO.js";import"./EditorComponent-sX0RyEc9.js";const H={key:0},K={key:0,class:"detail-page"},Q={key:0},W={class:"detail-card"},X={class:"detail-card-info"},Y={class:"detail-header"},Z={class:"detail-header-title"},ee={class:"detail-card-text"},se={class:"detail-card-text-elem"},oe={class:"detail-menu button-group"},te={key:0,class:"modal-overlay"},ae={class:"modal"},ce={class:"modal-header"},ie={class:"modal-header-h2"},ne={class:"minibutton-group modal-menu"},le={class:"detail-tabs"},re={class:"tabs-header"},de=["onClick"],ue={key:0,class:"tabs-content"},me={key:0,class:"desc-tab"},be={key:0},ge={key:1},_e={key:1,class:"detail-tab"},ye={class:"detail-tab-elem"},ve={class:"detail-tab-elem"},pe={class:"detail-tab-elem"},je={class:"detail-tab-elem"},Pe={class:"detail-tab-elem"},he={key:2,class:"table-tab"},ke={key:3,class:"table-tab"},fe={key:1,class:"none-card"},Ae={key:1,class:"loading"},Ce={key:1,class:"loading"},Ve={__name:"CategoryDetail",setup(Oe){const m=G(),b=J(),h=P(!1),e=$({object:null,globalPermissionsList:[],objectPermissionsDict:{},canViewCategory:!1,canEditCategory:!1,canDeleteCategory:!1,canViewAccountObjectPermission:!1,canAddAccountObjectPermission:!1,canDeleteAccountObjectPermission:!1,canViewAccountsGroupObjectPermission:!1,canAddAccountsGroupObjectPermission:!1,canDeleteAccountsGroupObjectPermission:!1}),v=async()=>{const t=m.params.id;let s=localStorage.getItem("access_token");const a=g(s);s&&!a&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),s=null);try{const c=await _.get(`${y}/categories/${t}/`,{headers:{...s&&{Authorization:`Bearer ${s}`}}});console.log("Данные категории:",c.data),e.object=c.data}catch(c){console.error("Ошибка при получении данных категории:",c)}},p=P(!1),O=()=>{p.value=!0},k=()=>{p.value=!1},D=async()=>{let t=localStorage.getItem("access_token");const s=g(t);if(t&&!s){b.push({name:"Login"});return}const a=m.params.id;try{await _.delete(`${y}/categories/${a}/`,{headers:{Authorization:`Bearer ${t}`}}),k(),b.push({name:"CategoryList"})}catch(c){console.error("Ошибка удаления категории:",c)}},w=async()=>{console.log("Проверяем версию прав");const t=JSON.parse(localStorage.getItem("userPermissions"));if(!(t!=null&&t.permissions_version))return;console.log("Текущая версия прав:",t.permissions_version);let s=localStorage.getItem("access_token");const a=g(s);if(!(!s||!a))try{(await _.get(`${y}/user_permissions_version/${t.permissions_version}/`,{headers:{Authorization:`Bearer ${s}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(c){console.error("Ошибка проверки версии прав:",c),localStorage.removeItem("userPermissions")}},S=async()=>{let t=localStorage.getItem("access_token");const s=g(t);t&&!s&&(localStorage.removeItem("access_token"),console.log("Токен удален из localStorage и очищен в переменной"),t=null);try{let a=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",a),Object.keys(a).length>0&&(console.log("ID пользователя в разрешениях из памяти:",a.user_id),!s&&a.user_id!==1||s&&s.user_id!==a.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),a={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(a).length===0){const j=await _.get(`${y}/user_permissions/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Разрешения пользователя загружены:",j.data),a=j.data,localStorage.setItem("userPermissions",JSON.stringify(a))}e.globalPermissionsList=a.global_permissions||[],e.objectPermissionsDict=a.object_permissions||{};const c=m.params.id;console.log("ID объекта:",c),e.canViewCategory=e.globalPermissionsList.includes("core.view_category")||e.objectPermissionsDict["core.view_category"]&&e.objectPermissionsDict["core.view_category"].includes(Number(c)),console.log("Права на просмотр категорий:",e.canViewCategory),e.canEditCategory=e.globalPermissionsList.includes("core.change_category")||Array.isArray(e.objectPermissionsDict["core.change_category"])&&e.objectPermissionsDict["core.change_category"].includes(Number(c)),console.log("Права на редактирование категорий:",e.canEditCategory),e.canDeleteCategory=e.globalPermissionsList.includes("core.delete_category")||Array.isArray(e.objectPermissionsDict["core.delete_category"])&&e.objectPermissionsDict["core.delete_category"].includes(Number(c)),console.log("Права на удаление категорий:",e.canDeleteCategory),e.canViewAccountObjectPermission=e.globalPermissionsList.includes("core.view_account_object_permission"),console.log("Права на просмотр объектных прав аккаунтов:",e.canViewAccountObjectPermission),e.canAddAccountObjectPermission=e.globalPermissionsList.includes("core.add_account_object_permission"),console.log("Права на добавление объектных прав аккаунтов:",e.canAddAccountObjectPermission),e.canDeleteAccountObjectPermission=e.globalPermissionsList.includes("core.delete_account_object_permission"),console.log("Права на удаление объектных прав аккаунтов:",e.canDeleteAccountObjectPermission),e.canViewAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.view_accounts_group_object_permission"),console.log("Права на просмотр объектных прав групп:",e.canViewAccountsGroupObjectPermission),e.canAddAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.add_accounts_group_object_permission"),console.log("Права на добавление объектных прав групп:",e.canAddAccountsGroupObjectPermission),e.canDeleteAccountsGroupObjectPermission=e.globalPermissionsList.includes("core.delete_accounts_group_object_permission"),console.log("Права на удаление объектных прав групп:",e.canDeleteAccountsGroupObjectPermission)}catch(a){console.error("Ошибка при загрузке разрешений пользователя:",a)}},V=()=>{q(b)},I=L(()=>[{name:"desc",label:"Описание"},{name:"details",label:"Детали"},e.canViewAccountsGroupObjectPermission?{name:"accountsGroupObjectPermissions",label:"Объектные права групп"}:null,e.canViewAccountObjectPermission?{name:"accountObjectPermissions",label:"Объектные права аккаунтов"}:null].filter(Boolean)),d=P(m.query.tab||localStorage.getItem(`activeCategoryTab-${m.params.id}`)||"desc");return B(d,t=>{localStorage.setItem(`activeCategoryTab-${m.params.id}`,t),b.push({query:{tab:t}}),console.log("Загружен таб:",t)}),N(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await v(),await w(),await S(),h.value=!0}catch(t){console.error("Ошибка при загрузке данных:",t)}}),(t,s)=>{const a=z("router-link");return h.value?(i(),n("div",H,[e.canViewCategory?(i(),n("div",K,[e.object.id?(i(),n("div",Q,[o("div",W,[o("div",X,[o("div",Y,[o("div",Z,[o("h1",null,l(e.object.name||"Безымянная категория"),1)])]),o("div",ee,[o("div",se,[s[1]||(s[1]=o("span",{class:"detail-card-text-label"},"Родительская категория:",-1)),u(" "+l(e.object.parent_category?e.object.parent_category.name:"Нет родительской категории"),1)])]),o("div",oe,[e.canEditCategory?(i(),T(a,{key:0,to:{name:"CategoryEdit",params:{id:e.object.id}},class:"button"},{default:x(()=>[...s[2]||(s[2]=[u(" Изменить ",-1)])]),_:1},8,["to"])):r("",!0),e.canDeleteCategory?(i(),n("button",{key:1,onClick:O,class:"button"}," Удалить ")):r("",!0),o("button",{type:"button",onClick:V,class:"button"},"Назад")]),p.value?(i(),n("div",te,[o("div",ae,[o("div",ce,[o("h2",ie,"Удаление "+l(e.object.name||"Безымянная категория"),1)]),o("div",ne,[o("button",{onClick:s[0]||(s[0]=c=>D()),class:"minibutton"},"Подтвердить"),o("button",{onClick:k,class:"minibutton"},"Отменить")])])])):r("",!0)])]),o("div",le,[o("div",re,[(i(!0),n(E,null,M(I.value,c=>(i(),n("button",{key:c.name,class:F([{active:d.value===c.name},"tab-button"]),onClick:j=>d.value=c.name},l(c.label),11,de))),128))]),d.value?(i(),n("div",ue,[d.value==="desc"?(i(),n("div",me,[e.object.desc?(i(),n("div",be,l(e.object.desc),1)):(i(),n("div",ge,[...s[3]||(s[3]=[o("div",{class:"none-border"},"Описание отсуствует",-1)])]))])):r("",!0),d.value==="details"?(i(),n("div",_e,[o("div",ye,[s[4]||(s[4]=o("span",{class:"detail-tab-label"},"Родительская категория:",-1)),u(" "+l(e.object.parent_category?e.object.parent_category.name:"Нет родительской категории"),1)]),o("div",ve,[s[5]||(s[5]=o("span",{class:"detail-tab-label"},"Создан:",-1)),u(" "+l(e.object.created?f(A)(e.object.created):"Нет данных о создании"),1)]),o("div",pe,[s[6]||(s[6]=o("span",{class:"detail-tab-label"},"Создатель:",-1)),u(" "+l(e.object.creator?e.object.creator:"Нет создателя"),1)]),o("div",je,[s[7]||(s[7]=o("span",{class:"detail-tab-label"},"Изменён:",-1)),u(" "+l(e.object.changed?f(A)(e.object.changed):"Нет данных об изменениях"),1)]),o("div",Pe,[s[8]||(s[8]=o("span",{class:"detail-tab-label"},"Редактор:",-1)),u(" "+l(e.object.editor?e.object.editor:"Нет редактора"),1)])])):r("",!0),d.value==="accountsGroupObjectPermissions"?(i(),n("div",he,[C(R,{state:e,fetchObject:v,contentTypeModel:"category"},null,8,["state"])])):r("",!0),d.value==="accountObjectPermissions"?(i(),n("div",ke,[C(U,{state:e,fetchObject:v,contentTypeModel:"category"},null,8,["state"])])):r("",!0)])):r("",!0)])])):e.object.id?r("",!0):(i(),n("div",fe,[...s[9]||(s[9]=[o("div",null,"Объект не найден",-1)])]))])):(i(),n("div",Ae,[...s[10]||(s[10]=[o("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),n("div",Ce,[...s[11]||(s[11]=[o("div",null,"Загрузка данных...",-1)])]))}}};export{Ve as default};
