import{r as b,a as N,A as L,B as te,o as se,Q as oe,c as a,b as u,d as s,t as d,F as g,E as h,m as A,C as E,G as ne,k as ae,i as w,u as ie,h as q,j,l as i,p as I,Y as le,y as ce,v as U,f as re,w as R}from"./index-d8W6jLUk.js";import{s as de}from"./custom-multiselect-Ct24ewwm.js";const ue={key:0},_e={key:0,class:"detail-page"},ve={key:0},pe={class:"testing"},fe={class:"testing-area"},me={key:0,class:"question-area"},be={key:0,class:"question-image-outer"},ge={class:"question-image-inner"},he=["src"],ke={class:"question-text"},ye={class:"question-manual"},we={key:1,class:"feedback_for_correct"},qe={key:2,class:"feedback_for_incorrect"},je={key:3,class:"answers"},xe={key:0,class:"answer-image-outer"},Ie={class:"answer-image-inner"},Pe=["src"],$e={class:"answer-field"},Se=["name","value","disabled"],Ae={key:1,class:"feedback_for_correct"},Ve={key:2,class:"feedback_for_incorrect"},Te={key:4,class:"answers"},Ce={key:0,class:"answer-image-outer"},Ue={class:"answer-image-inner"},Be=["src"],Oe={class:"answer-field"},Qe=["onUpdate:modelValue","disabled"],De={key:1,class:"feedback_for_correct"},Me={key:2,class:"feedback_for_incorrect"},Ne={key:5,class:"answers"},Le={key:0,class:"answer-image-outer"},Ee={class:"answer-image-inner"},Re=["src"],ze=["onUpdate:modelValue","disabled"],Fe={key:1,class:"feedback_for_correct"},Je={key:2,class:"feedback_for_incorrect"},Ge={key:6,class:"answers"},Ye={key:0,class:"answer-image-outer"},He={class:"answer-image-inner"},Ke=["src"],We={key:1,class:"feedback_for_correct"},Xe={key:2,class:"feedback_for_incorrect"},Ze={key:7,class:"answers"},et={key:0,class:"answer-image-outer"},tt={class:"answer-image-inner"},st=["src"],ot=["onUpdate:modelValue","disabled"],nt={key:1,class:"feedback_for_correct"},at={key:2,class:"feedback_for_incorrect"},it={key:8,class:"answers"},lt={key:0,class:"answer-image-outer"},ct={class:"answer-image-inner"},rt=["src"],dt=["onUpdate:modelValue","disabled"],ut={key:1,class:"feedback_for_correct"},_t={key:2,class:"feedback_for_incorrect"},vt={class:"question-index"},pt={class:"question-menu"},ft=["disabled"],mt=["disabled"],bt={class:"test-info-area"},gt={class:"test-info-container"},ht={class:"test-header"},kt={class:"test-info-text"},yt={class:"test-info-text-elem"},wt={class:"test-info-text-elem"},qt={key:0,class:"test-info-text-elem countdown-timer"},jt={key:1,class:"test-info-text-elem countdown-timer"},xt={key:0,class:"test-info-menu button-group"},It={class:"test-info-container test-info-container-gray-light"},Pt={key:0,class:"test-info-table-outer"},$t={class:"test-info-table-inner"},St={class:"test-info-table-menu"},At=["onClick"],Vt={key:1},Tt={class:"tab-pagination"},Ct=["disabled"],Ut=["disabled"],Bt={key:1,class:"none-container"},Ot={key:1,class:"loading"},Qt={key:1,class:"loading"},P=10,Lt={__name:"TestAttempt",setup(Dt){const V=ae(),x=ie(),B=b(!1),l=N({object:null,globalPermissionsList:[],objectPermissionsDict:{},canPerform:!1,canCompleted:!1}),m=b(1),z=async()=>{const o=V.params.id;let t=localStorage.getItem("access_token");const r=w(t);if(t&&!r){x.push({name:"Login"});return}try{const c=await q.get(`${j}/test_attempt_open/${o}/`,{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные открытой попытки:",c.data),l.object=c.data;const p=Math.ceil(l.object.question_results.length/P);m.value=p>0?p:1}catch(c){console.error("Ошибка при получении данных попытки:",c)}},F=async()=>{const o=V.params.id;let t=localStorage.getItem("access_token");const r=w(t);if(t&&!r){x.push({name:"Login"});return}try{const c=await q.post(`${j}/test_attempt_create/${o}/`,{},{headers:{...t&&{Authorization:`Bearer ${t}`}}});console.log("Данные созданной попытки:",c.data),l.object=c.data;const p=Math.ceil(l.object.question_results.length/P);m.value=p>0?p:1}catch(c){console.error("Ошибка при получении данных попытки:",c)}},O=L(()=>Math.ceil(l.object.question_results.length/P)),J=L(()=>{const o=(m.value-1)*P,t=o+P;return l.object.question_results.slice(o,t)}),T=b(""),C=b("");let $=null;const Q=async()=>{var t;if(!((t=l.object)!=null&&t.plan_end_time))return;console.log("Старт таймера");const o=new Date(l.object.plan_end_time).getTime();$=setInterval(()=>{const r=new Date().getTime(),c=o-r;if(c<=0){clearInterval($),console.log("⏰ Время вышло!"),W();return}const p=String(Math.floor(c/(1e3*60))).padStart(2,"0"),e=String(Math.floor(c%(1e3*60)/1e3)).padStart(2,"0");T.value=`${p}`,C.value=`${e}`},1e3)},n=b(null),D=async()=>{const o=l.object.question_results||[];console.log("Результаты вопросов:",o);let t=o.find(r=>r.status!=="completed"&&r.status!=="failed");console.log("Первый незавершенный вопрос:",o),!t&&o.length&&(t=o[0],console.log("Первый вопрос по порядку:",o)),n.value=t||null,t&&(console.log("Выбран текущий вопрос:",t),M(t))},k=o=>{n.value=o,M(o),console.log("Выбран текущий вопрос:",n.value)},_=N({}),S=b([]),M=o=>{for(const t in _)delete _[t];if(o.question.question_type==="single_selection"){const t=o.answer_results.find(r=>r.selected_answer);_.selectedAnswerId=t?t.id:null}else if(o.question.question_type==="multiple_choice")o.answer_results.forEach(t=>{_[t.id]=t.selected_answer||!1});else if(o.question.question_type==="sorting")o.answer_results.forEach(t=>{_[t.id]=t.selected_position||0});else if(o.question.question_type==="text_input")o.answer_results.forEach(t=>{_[t.id]=t.selected_text_input||""});else if(o.question.question_type==="numeric_input")o.answer_results.forEach(t=>{_[t.id]=t.selected_numeric_input||0});else if(o.question.question_type==="compliance"){const t=o.question.answers.map(c=>c.relevant_point).filter(Boolean);console.log("Создан список всех соотвествующих пунктов:",t);const r=Array.from(new Map(t.map(c=>[c.id,c])).values());console.log("Создан список соотвествующих пунктов:",r),S.value=r,console.log("Получено значение соотвествующих пунктов:",S.value),o.answer_results.forEach(c=>{_[c.id]=S.value.find(p=>p.id===c.selected_relevant_point)||null})}console.log("Создана форма:",_)},y=b(0);te(n,()=>{if(!n.value)return;const o=l.object.question_results.findIndex(t=>t.id===n.value.id);o!==-1&&(y.value=o)});const G=()=>{const o=y.value+1;o<l.object.question_results.length&&k(l.object.question_results[o]),console.log("Следующий вопрос:",l.object.question_results[o])},Y=()=>{const o=y.value-1;o>=0&&k(l.object.question_results[o]),console.log("Предидущий вопрос:",l.object.question_results[o])},H=o=>{k(o),console.log("Выбранный вопрос:",o)},K=async()=>{if(n.value)try{const o=n.value.id;let t=localStorage.getItem("access_token");const r=w(t);if(t&&!r){x.push({name:"Login"});return}let c={};n.value.question.question_type==="single_selection"?c={answer_results:n.value.answer_results.map(e=>({id:e.id,selected_answer:_.selectedAnswerId==e.id}))}:n.value.question.question_type==="multiple_choice"?c={answer_results:n.value.answer_results.map(e=>({id:e.id,selected_answer:!!_[e.id]}))}:n.value.question.question_type==="sorting"?c={answer_results:n.value.answer_results.map(e=>({id:e.id,selected_position:_[e.id]}))}:n.value.question.question_type==="text_input"?c={answer_results:n.value.answer_results.map(e=>({id:e.id,selected_text_input:_[e.id]}))}:n.value.question.question_type==="numeric_input"?c={answer_results:n.value.answer_results.map(e=>({id:e.id,selected_numeric_input:_[e.id]}))}:n.value.question.question_type==="compliance"&&(c={answer_results:n.value.answer_results.map(e=>({id:e.id,selected_relevant_point:_[e.id].id}))}),console.log("JSON данные перед отправкой:",c);const p=await q.patch(`${j}/send_answers/${o}/`,c,{headers:{Authorization:`Bearer ${t}`}});if(console.log("Объект создан:",p.data),p.data.type==="question_result"){const e=p.data.data,v=l.object.question_results.findIndex(f=>f.id===e.id);v!==-1&&l.object.question_results.splice(v,1,e),n.value.id===e.id&&k(e)}else if(p.data.type==="test_attempt"){const e=p.data.data;Object.assign(l.object,e);const v=e.question_results.find(f=>f.id===n.value.id);k(v)}}catch(o){o.response&&o.response.data?(Object.assign(errors,o.response.data),console.error("Ошибка при сохранении изменений:",o.response.data)):console.error("Ошибка при сохранении изменений:",o.message)}},W=async()=>{if(l.object)try{const o=l.object.id;let t=localStorage.getItem("access_token");const r=w(t);if(t&&!r){x.push({name:"Login"});return}const c=await q.post(`${j}/test_finish/${o}/`,{},{headers:{Authorization:`Bearer ${t}`}});console.log("Тест завершен:",c.data);const p=c.data.data;Object.assign(l.object,p);const e=p.question_results.find(v=>v.id===n.value.id);k(e)}catch(o){o.response&&o.response.data?(Object.assign(errors,o.response.data),console.error("Ошибка при сохранении изменений:",o.response.data)):console.error("Ошибка при сохранении изменений:",o.message)}},X=async()=>{console.log("Проверяем версию прав");const o=JSON.parse(localStorage.getItem("userPermissions"));if(!(o!=null&&o.permissions_version))return;console.log("Текущая версия прав:",o.permissions_version);let t=localStorage.getItem("access_token");const r=w(t);if(!(!t||!r))try{(await q.get(`${j}/user_permissions_version/${o.permissions_version}/`,{headers:{Authorization:`Bearer ${t}`}})).data.actual?console.log("Версия прав актуальна"):(console.log("Версия прав устарела — очищаем память"),localStorage.removeItem("userPermissions"))}catch(c){console.error("Ошибка проверки версии прав:",c),localStorage.removeItem("userPermissions")}},Z=async()=>{let o=localStorage.getItem("access_token");const t=w(o);if(o&&!t){x.push({name:"Login"});return}try{let r=JSON.parse(localStorage.getItem("userPermissions"))||{};if(console.log("Разрешения пользователя из памяти",r),Object.keys(r).length>0&&(console.log("ID пользователя в разрешениях из памяти:",r.user_id),!t&&r.user_id!==1||t&&t.user_id!==r.user_id?(console.log("Разрешения пользователя из памяти не соотвествуют пользователю и будут обнулены"),localStorage.removeItem("userPermissions"),r={}):console.log("Разрешения пользователя из памяти соотвествуют пользователю")),Object.keys(r).length===0){const p=await q.get(`${j}/user_permissions/`,{headers:{...o&&{Authorization:`Bearer ${o}`}}});console.log("Разрешения пользователя загружены:",p.data),r=p.data,localStorage.setItem("userPermissions",JSON.stringify(r))}l.globalPermissionsList=r.global_permissions||[],l.objectPermissionsDict=r.object_permissions||{};const c=V.params.id;console.log("ID объекта:",c),l.canPerform=!0}catch(r){console.error("Ошибка при загрузке разрешений пользователя:",r)}},ee=async()=>{await F(),await Q(),await D()};return se(async()=>{console.log("Компонент смонтирован, начинаем загрузку данных...");try{await z(),await D(),await Q(),await X(),await Z(),B.value=!0}catch(o){console.error("Ошибка при загрузке данных:",o)}}),oe(()=>{$&&clearInterval($)}),(o,t)=>{var r,c,p;return B.value?(i(),a("div",ue,[l.canPerform?(i(),a("div",_e,[l.object.id?(i(),a("div",ve,[s("div",pe,[s("div",fe,[n.value?(i(),a("div",me,[(r=n.value.question)!=null&&r.picture?(i(),a("div",be,[s("div",ge,[s("img",{src:n.value.question.picture||"/default-avatar.png",alt:"Картинка"},null,8,he)])])):u("",!0),s("div",ke,[s("h1",null,d(n.value.question.text),1)]),s("div",ye,d(n.value.question.manual),1),((c=n.value)==null?void 0:c.status)=="completed"?(i(),a("div",we,d(n.value.question.feedback_for_correct),1)):u("",!0),((p=n.value)==null?void 0:p.status)=="failed"?(i(),a("div",qe,d(n.value.question.feedback_for_incorrect),1)):u("",!0),n.value.question.question_type==="single_selection"?(i(),a("div",je,[(i(!0),a(g,null,h(n.value.answer_results,e=>{var v;return i(),a("div",{key:e.id,class:"answer"},[(v=e.answer)!=null&&v.picture?(i(),a("div",xe,[s("div",Ie,[s("img",{src:e.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,Pe)])])):u("",!0),s("label",$e,[I(s("input",{type:"radio",class:"answer-input",name:"single_"+n.value.id,value:e.id,"onUpdate:modelValue":t[0]||(t[0]=f=>_.selectedAnswerId=f),disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,Se),[[le,_.selectedAnswerId]]),s("span",null,d(e.answer.text),1)]),e.status=="completed"?(i(),a("div",Ae,d(e.answer.feedback_for_correct),1)):u("",!0),e.status=="failed"?(i(),a("div",Ve,d(e.answer.feedback_for_incorrect),1)):u("",!0)])}),128))])):u("",!0),n.value.question.question_type==="multiple_choice"?(i(),a("div",Te,[(i(!0),a(g,null,h(n.value.answer_results,e=>{var v;return i(),a("div",{key:e.id,class:"answer"},[(v=e.answer)!=null&&v.picture?(i(),a("div",Ce,[s("div",Ue,[s("img",{src:e.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,Be)])])):u("",!0),s("label",Oe,[I(s("input",{class:"answer-input",type:"checkbox","onUpdate:modelValue":f=>_[e.id]=f,disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,Qe),[[ce,_[e.id]]]),s("span",null,d(e.answer.text),1)]),e.status=="completed"?(i(),a("div",De,d(e.answer.feedback_for_correct),1)):u("",!0),e.status=="failed"?(i(),a("div",Me,d(e.answer.feedback_for_incorrect),1)):u("",!0)])}),128))])):u("",!0),n.value.question.question_type==="sorting"?(i(),a("div",Ne,[(i(!0),a(g,null,h(n.value.answer_results,e=>{var v;return i(),a("div",{key:e.id,class:"answer"},[(v=e.answer)!=null&&v.picture?(i(),a("div",Le,[s("div",Ee,[s("img",{src:e.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,Re)])])):u("",!0),s("div",null,d(e.answer.text),1),s("label",null,[I(s("input",{class:"answer-input",type:"number",placeholder:"Введите правильный порядок","onUpdate:modelValue":f=>_[e.id]=f,disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,ze),[[U,_[e.id]]])]),e.status=="completed"?(i(),a("div",Fe,d(e.answer.feedback_for_correct),1)):u("",!0),e.status=="failed"?(i(),a("div",Je,d(e.answer.feedback_for_incorrect),1)):u("",!0)])}),128))])):u("",!0),n.value.question.question_type==="compliance"?(i(),a("div",Ge,[(i(!0),a(g,null,h(n.value.answer_results,e=>{var v;return i(),a("div",{key:e.id,class:"answer"},[(v=e.answer)!=null&&v.picture?(i(),a("div",Ye,[s("div",He,[s("img",{src:e.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,Ke)])])):u("",!0),s("label",null,d(e.answer.text),1),re(E(de),{modelValue:_[e.id],"onUpdate:modelValue":f=>_[e.id]=f,options:S.value,multiple:!1,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Выберите план",label:"text","track-by":"id","preselect-first":!1,"select-label":"","deselect-label":"","selected-label":"",disabled:n.value.status=="completed"||n.value.status=="failed"},{noOptions:R(()=>[...t[4]||(t[4]=[s("span",null,"Список пуст",-1)])]),noResult:R(()=>[...t[5]||(t[5]=[s("span",null,"Ничего не найдено",-1)])]),_:1},8,["modelValue","onUpdate:modelValue","options","disabled"]),e.status=="completed"?(i(),a("div",We,d(e.answer.feedback_for_correct),1)):u("",!0),e.status=="failed"?(i(),a("div",Xe,d(e.answer.feedback_for_incorrect),1)):u("",!0)])}),128))])):u("",!0),n.value.question.question_type==="text_input"?(i(),a("div",Ze,[(i(!0),a(g,null,h(n.value.answer_results,e=>{var v;return i(),a("div",{key:e.id,class:"answer"},[(v=e.answer)!=null&&v.picture?(i(),a("div",et,[s("div",tt,[s("img",{src:e.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,st)])])):u("",!0),s("div",null,d(e.answer.text),1),s("label",null,[I(s("input",{class:"answer-input",type:"text",placeholder:"Введите правильный ответ","onUpdate:modelValue":f=>_[e.id]=f,disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,ot),[[U,_[e.id]]])]),e.status=="completed"?(i(),a("div",nt,d(e.answer.feedback_for_correct),1)):u("",!0),e.status=="failed"?(i(),a("div",at,d(e.answer.feedback_for_incorrect),1)):u("",!0)])}),128))])):u("",!0),n.value.question.question_type==="numeric_input"?(i(),a("div",it,[(i(!0),a(g,null,h(n.value.answer_results,e=>{var v;return i(),a("div",{key:e.id,class:"answer"},[(v=e.answer)!=null&&v.picture?(i(),a("div",lt,[s("div",ct,[s("img",{src:e.answer.picture||"/default-avatar.png",alt:"Картинка"},null,8,rt)])])):u("",!0),s("div",null,d(e.answer.text),1),s("label",null,[I(s("input",{class:"answer-input",type:"number",placeholder:"Введите правильный ответ","onUpdate:modelValue":f=>_[e.id]=f,disabled:n.value.status=="completed"||n.value.status=="failed"},null,8,dt),[[U,_[e.id]]])]),e.status=="completed"?(i(),a("div",ut,d(e.answer.feedback_for_correct),1)):u("",!0),e.status=="failed"?(i(),a("div",_t,d(e.answer.feedback_for_incorrect),1)):u("",!0)])}),128))])):u("",!0),s("div",vt,"Вопрос "+d(y.value+1)+" из "+d(l.object.question_results.length),1),s("div",pt,[s("button",{type:"button",onClick:Y,disabled:y.value===0,class:"test-nav-button"}," Назад ",8,ft),n.value.status!="completed"&&n.value.status!="failed"?(i(),a("button",{key:0,type:"button",onClick:K,class:"button"}," Ответить ")):u("",!0),s("button",{type:"button",onClick:G,disabled:y.value===l.object.question_results.length-1,class:"test-nav-button"}," Далее ",8,mt)])])):u("",!0),s("div",bt,[s("div",gt,[s("div",ht,[s("h2",null,'Выполнение теста "'+d(l.object.test_name)+'"',1)]),t[10]||(t[10]=s("div",{class:"test-manual"},[s("span",null,"Ответье на вопрсоы теста за отведенное время")],-1)),s("div",kt,[s("div",yt,[t[6]||(t[6]=s("span",{class:"test-info-text-label"},"Номер попытки:",-1)),A(" "+d(l.object.number?l.object.number:"Нет номера попытки")+" из "+d(l.object.test_attempts?l.object.test_attempts:"Нет числа попыток"),1)]),s("div",wt,[t[7]||(t[7]=s("span",{class:"test-info-text-label"},"Статус попытки:",-1)),A(" "+d(l.object.status_display?l.object.status_display:"Нет статуса"),1)]),T.value&&C.value?(i(),a("div",qt,[t[8]||(t[8]=s("span",{class:"test-info-text-label"},"Время попытки:",-1)),A(" "+d(T.value)+" : "+d(C.value),1)])):(i(),a("div",jt,[t[9]||(t[9]=s("span",{class:"test-info-text-label"},"Попытка завершена:",-1)),A(" "+d(l.object.test_result.end_time?E(ne)(l.object.test_result.end_time):"Нет данных"),1)]))])]),(l.object.status=="completed"||l.object.status=="failed")&&!l.object.test_result.finished?(i(),a("div",xt,[s("button",{type:"button",onClick:t[1]||(t[1]=e=>ee()),class:"button"}," Начать заново ")])):u("",!0),s("div",It,[l.object.question_results.length!==0?(i(),a("div",Pt,[s("div",$t,[s("table",null,[t[11]||(t[11]=s("thead",null,[s("tr",null,[s("th",null,"Вопрос"),s("th",null,"Статус"),s("th",null," Действия ")])],-1)),s("tbody",null,[(i(!0),a(g,null,h(J.value,e=>(i(),a("tr",{key:e.id},[s("td",null,d(e.question.text?e.question.text:"-"),1),s("td",null,d(e.status_display?e.status_display:"-"),1),s("td",null,[s("div",St,[s("button",{type:"button",onClick:v=>H(e),class:"test-info-button"}," Открыть ",8,At)])])]))),128))])])])])):(i(),a("div",Vt,[...t[12]||(t[12]=[s("div",{class:"none-border-mini"},"Нет вопросов теста",-1)])])),s("div",Tt,[s("button",{disabled:m.value===1,onClick:t[2]||(t[2]=e=>m.value--),class:"tab-settings-button"}," Назад ",8,Ct),s("span",null,"Страница "+d(m.value)+" из "+d(O.value),1),s("button",{disabled:m.value===O.value,onClick:t[3]||(t[3]=e=>m.value++),class:"tab-settings-button"}," Вперед ",8,Ut)])])])])])])):l.object.id?u("",!0):(i(),a("div",Bt,[...t[13]||(t[13]=[s("div",{class:"none-card"},[s("div",null,"Объект не найден.")],-1)])]))])):(i(),a("div",Ot,[...t[14]||(t[14]=[s("div",null,"У вас нет разрешения на просмотр",-1)])]))])):(i(),a("div",Qt,[...t[15]||(t[15]=[s("div",null,"Загрузка данных...",-1)])]))}}};export{Lt as default};
